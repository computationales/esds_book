<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 13 Supervised Deep Learning II | Environmental Systems Data Science</title>
  <meta name="description" content="Text book and exercises for the course Environmental System Data Science at ETH Zürich." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 13 Supervised Deep Learning II | Environmental Systems Data Science" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Text book and exercises for the course Environmental System Data Science at ETH Zürich." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 13 Supervised Deep Learning II | Environmental Systems Data Science" />
  
  <meta name="twitter:description" content="Text book and exercises for the course Environmental System Data Science at ETH Zürich." />
  

<meta name="author" content="Loïc Pellissier, Joshua Payne, Benjamin Stocker" />


<meta name="date" content="2021-03-25" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="ch-12.html"/>
<link rel="next" href="references.html"/>
<script src="libs/header-attrs-2.6/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Prerequisites</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#course-description"><i class="fa fa-check"></i>Course Description</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#course-objectives"><i class="fa fa-check"></i>Course Objectives</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#content"><i class="fa fa-check"></i>Content</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#useful-prerequisites"><i class="fa fa-check"></i>Useful Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="ch-01.html"><a href="ch-01.html"><i class="fa fa-check"></i><b>1</b> Primers</a>
<ul>
<li class="chapter" data-level="1.1" data-path="ch-01.html"><a href="ch-01.html#introduction"><i class="fa fa-check"></i><b>1.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="ch-01.html"><a href="ch-01.html#important-points-from-the-lecture"><i class="fa fa-check"></i><b>1.1.1</b> Important points from the lecture</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="ch-01.html"><a href="ch-01.html#tutorial"><i class="fa fa-check"></i><b>1.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="ch-01.html"><a href="ch-01.html#working-with-jupyter-notebook"><i class="fa fa-check"></i><b>1.2.1</b> Working with Jupyter notebook</a></li>
<li class="chapter" data-level="1.2.2" data-path="ch-01.html"><a href="ch-01.html#using-git-for-version-control"><i class="fa fa-check"></i><b>1.2.2</b> Using Git for version control</a></li>
<li class="chapter" data-level="1.2.3" data-path="ch-01.html"><a href="ch-01.html#basics-of-r-code"><i class="fa fa-check"></i><b>1.2.3</b> Basics of R code</a></li>
<li class="chapter" data-level="1.2.4" data-path="ch-01.html"><a href="ch-01.html#reading-data-into-r"><i class="fa fa-check"></i><b>1.2.4</b> Reading data into R</a></li>
<li class="chapter" data-level="1.2.5" data-path="ch-01.html"><a href="ch-01.html#r-objects"><i class="fa fa-check"></i><b>1.2.5</b> R Objects</a></li>
<li class="chapter" data-level="1.2.6" data-path="ch-01.html"><a href="ch-01.html#data-visualisation"><i class="fa fa-check"></i><b>1.2.6</b> Data visualisation</a></li>
<li class="chapter" data-level="1.2.7" data-path="ch-01.html"><a href="ch-01.html#example-code-loops"><i class="fa fa-check"></i><b>1.2.7</b> Example code: Loops</a></li>
<li class="chapter" data-level="1.2.8" data-path="ch-01.html"><a href="ch-01.html#where-to-find-help"><i class="fa fa-check"></i><b>1.2.8</b> Where to find Help</a></li>
<li class="chapter" data-level="1.2.9" data-path="ch-01.html"><a href="ch-01.html#further-reading"><i class="fa fa-check"></i><b>1.2.9</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="ch-01.html"><a href="ch-01.html#exercise"><i class="fa fa-check"></i><b>1.3</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="ch-02.html"><a href="ch-02.html"><i class="fa fa-check"></i><b>2</b> Data wrangling</a>
<ul>
<li class="chapter" data-level="2.1" data-path="ch-02.html"><a href="ch-02.html#introduction-1"><i class="fa fa-check"></i><b>2.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="ch-02.html"><a href="ch-02.html#data-transformation-with-dplyr"><i class="fa fa-check"></i><b>2.1.1</b> Data transformation with dplyr</a></li>
<li class="chapter" data-level="2.1.2" data-path="ch-02.html"><a href="ch-02.html#data-visualisation-with-ggplot2"><i class="fa fa-check"></i><b>2.1.2</b> Data visualisation with ggplot2</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="ch-02.html"><a href="ch-02.html#tutorial-1"><i class="fa fa-check"></i><b>2.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="ch-02.html"><a href="ch-02.html#dataset-1-half-hourly-flux-data"><i class="fa fa-check"></i><b>2.2.1</b> Dataset 1 (half-hourly flux data)</a></li>
<li class="chapter" data-level="2.2.2" data-path="ch-02.html"><a href="ch-02.html#dataset-2-daily-flux-data"><i class="fa fa-check"></i><b>2.2.2</b> Dataset 2 (daily flux data)</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="ch-02.html"><a href="ch-02.html#exercise-1"><i class="fa fa-check"></i><b>2.3</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="ch-03.html"><a href="ch-03.html"><i class="fa fa-check"></i><b>3</b> Data variety</a>
<ul>
<li class="chapter" data-level="3.1" data-path="ch-03.html"><a href="ch-03.html#introduction-2"><i class="fa fa-check"></i><b>3.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="ch-03.html"><a href="ch-03.html#overview"><i class="fa fa-check"></i><b>3.1.1</b> Overview</a></li>
<li class="chapter" data-level="3.1.2" data-path="ch-03.html"><a href="ch-03.html#learning-objectives"><i class="fa fa-check"></i><b>3.1.2</b> Learning objectives</a></li>
<li class="chapter" data-level="3.1.3" data-path="ch-03.html"><a href="ch-03.html#key-points-of-the-lecture"><i class="fa fa-check"></i><b>3.1.3</b> Key points of the lecture</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="ch-03.html"><a href="ch-03.html#tutorial-2"><i class="fa fa-check"></i><b>3.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="ch-03.html"><a href="ch-03.html#overview-1"><i class="fa fa-check"></i><b>3.2.1</b> Overview</a></li>
<li class="chapter" data-level="3.2.2" data-path="ch-03.html"><a href="ch-03.html#modis-remote-download"><i class="fa fa-check"></i><b>3.2.2</b> MODIS remote download</a></li>
<li class="chapter" data-level="3.2.3" data-path="ch-03.html"><a href="ch-03.html#points-on-the-globe"><i class="fa fa-check"></i><b>3.2.3</b> Points on the globe</a></li>
<li class="chapter" data-level="3.2.4" data-path="ch-03.html"><a href="ch-03.html#shapefiles"><i class="fa fa-check"></i><b>3.2.4</b> Shapefiles</a></li>
<li class="chapter" data-level="3.2.5" data-path="ch-03.html"><a href="ch-03.html#rasters"><i class="fa fa-check"></i><b>3.2.5</b> Rasters</a></li>
<li class="chapter" data-level="3.2.6" data-path="ch-03.html"><a href="ch-03.html#key-points-of-the-tutorial"><i class="fa fa-check"></i><b>3.2.6</b> Key points of the tutorial</a></li>
<li class="chapter" data-level="3.2.7" data-path="ch-03.html"><a href="ch-03.html#bonus-species-occurrence-trait-data-and-pcas"><i class="fa fa-check"></i><b>3.2.7</b> Bonus: Species Occurrence, Trait Data and PCAs</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="ch-03.html"><a href="ch-03.html#exercise-2"><i class="fa fa-check"></i><b>3.3</b> Exercise</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="ch-03.html"><a href="ch-03.html#part-1-plotting-elevation-differences"><i class="fa fa-check"></i><b>3.3.1</b> Part 1: Plotting Elevation differences</a></li>
<li class="chapter" data-level="3.3.2" data-path="ch-03.html"><a href="ch-03.html#part-2-temperature-and-elevation-correlations"><i class="fa fa-check"></i><b>3.3.2</b> Part 2: Temperature and Elevation Correlations</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="ch-04.html"><a href="ch-04.html"><i class="fa fa-check"></i><b>4</b> Data Scraping</a>
<ul>
<li class="chapter" data-level="4.1" data-path="ch-04.html"><a href="ch-04.html#introduction-3"><i class="fa fa-check"></i><b>4.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="ch-04.html"><a href="ch-04.html#theory"><i class="fa fa-check"></i><b>4.1.1</b> Theory</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="ch-04.html"><a href="ch-04.html#tutorial-3"><i class="fa fa-check"></i><b>4.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="ch-04.html"><a href="ch-04.html#r-packages-and-functions"><i class="fa fa-check"></i><b>4.2.1</b> R-Packages and Functions</a></li>
<li class="chapter" data-level="4.2.2" data-path="ch-04.html"><a href="ch-04.html#the-fishbase-website"><i class="fa fa-check"></i><b>4.2.2</b> The FishBase website</a></li>
<li class="chapter" data-level="4.2.3" data-path="ch-04.html"><a href="ch-04.html#accessing-fishbase"><i class="fa fa-check"></i><b>4.2.3</b> Accessing FishBase</a></li>
<li class="chapter" data-level="4.2.4" data-path="ch-04.html"><a href="ch-04.html#scraping-numbers"><i class="fa fa-check"></i><b>4.2.4</b> Scraping Numbers</a></li>
<li class="chapter" data-level="4.2.5" data-path="ch-04.html"><a href="ch-04.html#scraping-text-snippetrs"><i class="fa fa-check"></i><b>4.2.5</b> Scraping Text Snippetrs</a></li>
<li class="chapter" data-level="4.2.6" data-path="ch-04.html"><a href="ch-04.html#scraping-tables"><i class="fa fa-check"></i><b>4.2.6</b> Scraping Tables</a></li>
<li class="chapter" data-level="4.2.7" data-path="ch-04.html"><a href="ch-04.html#the-fishbase-package"><i class="fa fa-check"></i><b>4.2.7</b> The Fishbase Package</a></li>
<li class="chapter" data-level="4.2.8" data-path="ch-04.html"><a href="ch-04.html#summary"><i class="fa fa-check"></i><b>4.2.8</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="ch-04.html"><a href="ch-04.html#case-study"><i class="fa fa-check"></i><b>4.3</b> Case Study</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="ch-04.html"><a href="ch-04.html#creating-list-of-species"><i class="fa fa-check"></i><b>4.3.1</b> Creating List of Species</a></li>
<li class="chapter" data-level="4.3.2" data-path="ch-04.html"><a href="ch-04.html#extracting-iucn-status-for-all-species"><i class="fa fa-check"></i><b>4.3.2</b> Extracting IUCN Status for all species</a></li>
<li class="chapter" data-level="4.3.3" data-path="ch-04.html"><a href="ch-04.html#proportion-of-species-in-netherlands"><i class="fa fa-check"></i><b>4.3.3</b> Proportion of species in Netherlands</a></li>
<li class="chapter" data-level="4.3.4" data-path="ch-04.html"><a href="ch-04.html#cleaning-data-with-iucn-status"><i class="fa fa-check"></i><b>4.3.4</b> Cleaning data with IUCN Status</a></li>
<li class="chapter" data-level="4.3.5" data-path="ch-04.html"><a href="ch-04.html#maps-of-species-richness-and-red-list-species-proportions"><i class="fa fa-check"></i><b>4.3.5</b> Maps of species richness and Red List species proportions</a></li>
<li class="chapter" data-level="4.3.6" data-path="ch-04.html"><a href="ch-04.html#relation-of-basin-size-and-species-richness"><i class="fa fa-check"></i><b>4.3.6</b> Relation of basin size and species richness</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="ch-04.html"><a href="ch-04.html#exercise-3"><i class="fa fa-check"></i><b>4.4</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="ch-05.html"><a href="ch-05.html"><i class="fa fa-check"></i><b>5</b> Catch-up</a>
<ul>
<li class="chapter" data-level="5.1" data-path="ch-05.html"><a href="ch-05.html#loops-in-r"><i class="fa fa-check"></i><b>5.1</b> Loops in R</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="ch-05.html"><a href="ch-05.html#some-simple-examples"><i class="fa fa-check"></i><b>5.1.1</b> Some simple examples</a></li>
<li class="chapter" data-level="5.1.2" data-path="ch-05.html"><a href="ch-05.html#nested-loops"><i class="fa fa-check"></i><b>5.1.2</b> Nested loops</a></li>
<li class="chapter" data-level="5.1.3" data-path="ch-05.html"><a href="ch-05.html#exercise-4"><i class="fa fa-check"></i><b>5.1.3</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="ch-05.html"><a href="ch-05.html#functional-programming-using-purr"><i class="fa fa-check"></i><b>5.2</b> Functional programming using purr</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="ch-05.html"><a href="ch-05.html#shortcuts-in-a-purrr-function"><i class="fa fa-check"></i><b>5.2.1</b> Shortcuts in a <code>purrr</code> function</a></li>
<li class="chapter" data-level="5.2.2" data-path="ch-05.html"><a href="ch-05.html#workflow-nested-data-map-and-mutate"><i class="fa fa-check"></i><b>5.2.2</b> Workflow: nested data, map and mutate</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="ch-05.html"><a href="ch-05.html#string-manipulations"><i class="fa fa-check"></i><b>5.3</b> String Manipulations</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="ch-05.html"><a href="ch-05.html#introduction-to-strings"><i class="fa fa-check"></i><b>5.3.1</b> Introduction to strings</a></li>
<li class="chapter" data-level="5.3.2" data-path="ch-05.html"><a href="ch-05.html#matching-and-extracting-patterns"><i class="fa fa-check"></i><b>5.3.2</b> Matching and extracting patterns</a></li>
<li class="chapter" data-level="5.3.3" data-path="ch-05.html"><a href="ch-05.html#advanced-example"><i class="fa fa-check"></i><b>5.3.3</b> Advanced example</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="ch-05.html"><a href="ch-05.html#web-scraping-in-a-nut-shell"><i class="fa fa-check"></i><b>5.4</b> Web-scraping in a nut-shell</a></li>
<li class="chapter" data-level="5.5" data-path="ch-05.html"><a href="ch-05.html#tidyverses-filter-and-select"><i class="fa fa-check"></i><b>5.5</b> Tidyverse’s filter and select</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="ch-05.html"><a href="ch-05.html#introduction-4"><i class="fa fa-check"></i><b>5.5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.5.2" data-path="ch-05.html"><a href="ch-05.html#select"><i class="fa fa-check"></i><b>5.5.2</b> Select()</a></li>
<li class="chapter" data-level="5.5.3" data-path="ch-05.html"><a href="ch-05.html#filter"><i class="fa fa-check"></i><b>5.5.3</b> Filter()</a></li>
<li class="chapter" data-level="5.5.4" data-path="ch-05.html"><a href="ch-05.html#exercises"><i class="fa fa-check"></i><b>5.5.4</b> Exercises</a></li>
<li class="chapter" data-level="5.5.5" data-path="ch-05.html"><a href="ch-05.html#solutions"><i class="fa fa-check"></i><b>5.5.5</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="ch-05.html"><a href="ch-05.html#preparing-data-for-ggplot"><i class="fa fa-check"></i><b>5.6</b> Preparing data for ggplot()</a></li>
<li class="chapter" data-level="5.7" data-path="ch-05.html"><a href="ch-05.html#base-r-functions"><i class="fa fa-check"></i><b>5.7</b> Base R functions</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="ch-06.html"><a href="ch-06.html"><i class="fa fa-check"></i><b>6</b> Supervised Machine Learning I</a>
<ul>
<li class="chapter" data-level="6.1" data-path="ch-06.html"><a href="ch-06.html#introduction-5"><i class="fa fa-check"></i><b>6.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="ch-06.html"><a href="ch-06.html#learning-objectives-1"><i class="fa fa-check"></i><b>6.1.1</b> Learning objectives</a></li>
<li class="chapter" data-level="6.1.2" data-path="ch-06.html"><a href="ch-06.html#important-points-from-the-lecture-1"><i class="fa fa-check"></i><b>6.1.2</b> Important points from the lecture</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="ch-06.html"><a href="ch-06.html#tutorial-4"><i class="fa fa-check"></i><b>6.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="ch-06.html"><a href="ch-06.html#linear-regression"><i class="fa fa-check"></i><b>6.2.1</b> Linear regression</a></li>
<li class="chapter" data-level="6.2.2" data-path="ch-06.html"><a href="ch-06.html#k-nearest-neighbours"><i class="fa fa-check"></i><b>6.2.2</b> K-nearest neighbours</a></li>
<li class="chapter" data-level="6.2.3" data-path="ch-06.html"><a href="ch-06.html#essential-methods-for-the-modelling-process"><i class="fa fa-check"></i><b>6.2.3</b> Essential methods for the modelling process</a></li>
<li class="chapter" data-level="6.2.4" data-path="ch-06.html"><a href="ch-06.html#bonus"><i class="fa fa-check"></i><b>6.2.4</b> Bonus</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="ch-06.html"><a href="ch-06.html#exercise-5"><i class="fa fa-check"></i><b>6.3</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="ch-07.html"><a href="ch-07.html"><i class="fa fa-check"></i><b>7</b> Supervised Machine Learning II</a>
<ul>
<li class="chapter" data-level="7.1" data-path="ch-07.html"><a href="ch-07.html#introduction-6"><i class="fa fa-check"></i><b>7.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="ch-07.html"><a href="ch-07.html#leaerning-objectives"><i class="fa fa-check"></i><b>7.1.1</b> Leaerning objectives</a></li>
<li class="chapter" data-level="7.1.2" data-path="ch-07.html"><a href="ch-07.html#key-points-from-the-lecture"><i class="fa fa-check"></i><b>7.1.2</b> Key points from the lecture</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="ch-07.html"><a href="ch-07.html#tutorial-5"><i class="fa fa-check"></i><b>7.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="ch-07.html"><a href="ch-07.html#model-training-and-the-loss-function"><i class="fa fa-check"></i><b>7.2.1</b> Model training and the loss function</a></li>
<li class="chapter" data-level="7.2.2" data-path="ch-07.html"><a href="ch-07.html#putting-it-all-together"><i class="fa fa-check"></i><b>7.2.2</b> Putting it all together</a></li>
<li class="chapter" data-level="7.2.3" data-path="ch-07.html"><a href="ch-07.html#model-evaluation"><i class="fa fa-check"></i><b>7.2.3</b> Model evaluation</a></li>
<li class="chapter" data-level="7.2.4" data-path="ch-07.html"><a href="ch-07.html#model-interpretation"><i class="fa fa-check"></i><b>7.2.4</b> Model interpretation</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="ch-07.html"><a href="ch-07.html#exercise-6"><i class="fa fa-check"></i><b>7.3</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="ch-08.html"><a href="ch-08.html"><i class="fa fa-check"></i><b>8</b> Application 1: Variable selection</a>
<ul>
<li class="chapter" data-level="8.1" data-path="ch-08.html"><a href="ch-08.html#introduction-7"><i class="fa fa-check"></i><b>8.1</b> Introduction</a></li>
<li class="chapter" data-level="8.2" data-path="ch-08.html"><a href="ch-08.html#application"><i class="fa fa-check"></i><b>8.2</b> Application</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="ch-08.html"><a href="ch-08.html#warm-up-1-nested-for-loop"><i class="fa fa-check"></i><b>8.2.1</b> Warm-up 1: Nested for-loop</a></li>
<li class="chapter" data-level="8.2.2" data-path="ch-08.html"><a href="ch-08.html#warm-up-2-find-the-best-single-predictor"><i class="fa fa-check"></i><b>8.2.2</b> Warm-up 2: Find the best single predictor</a></li>
<li class="chapter" data-level="8.2.3" data-path="ch-08.html"><a href="ch-08.html#full-stepwise-regression"><i class="fa fa-check"></i><b>8.2.3</b> Full stepwise regression</a></li>
<li class="chapter" data-level="8.2.4" data-path="ch-08.html"><a href="ch-08.html#bonus-stepwise-regression-out-of-the-box"><i class="fa fa-check"></i><b>8.2.4</b> Bonus: Stepwise regression out-of-the-box</a></li>
<li class="chapter" data-level="8.2.5" data-path="ch-08.html"><a href="ch-08.html#bonus-best-subset-selection"><i class="fa fa-check"></i><b>8.2.5</b> Bonus: Best Subset Selection</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="ch-09.html"><a href="ch-09.html"><i class="fa fa-check"></i><b>9</b> Supervised Neural Networks I</a>
<ul>
<li class="chapter" data-level="9.1" data-path="ch-09.html"><a href="ch-09.html#introduction-8"><i class="fa fa-check"></i><b>9.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="ch-09.html"><a href="ch-09.html#learning-objectives-2"><i class="fa fa-check"></i><b>9.1.1</b> Learning objectives</a></li>
<li class="chapter" data-level="9.1.2" data-path="ch-09.html"><a href="ch-09.html#important-points-from-the-lecture-2"><i class="fa fa-check"></i><b>9.1.2</b> Important points from the lecture</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="ch-09.html"><a href="ch-09.html#tutorial-6"><i class="fa fa-check"></i><b>9.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="ch-09.html"><a href="ch-09.html#set-up"><i class="fa fa-check"></i><b>9.2.1</b> Set-up</a></li>
<li class="chapter" data-level="9.2.2" data-path="ch-09.html"><a href="ch-09.html#keras-for-linear-models"><i class="fa fa-check"></i><b>9.2.2</b> Keras for linear models</a></li>
<li class="chapter" data-level="9.2.3" data-path="ch-09.html"><a href="ch-09.html#tuning-learning-rate"><i class="fa fa-check"></i><b>9.2.3</b> Tuning learning rate</a></li>
<li class="chapter" data-level="9.2.4" data-path="ch-09.html"><a href="ch-09.html#logistic-regression"><i class="fa fa-check"></i><b>9.2.4</b> Logistic Regression</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="ch-09.html"><a href="ch-09.html#exercise-7"><i class="fa fa-check"></i><b>9.3</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="ch-10.html"><a href="ch-10.html"><i class="fa fa-check"></i><b>10</b> Supervised Neural Networks II</a>
<ul>
<li class="chapter" data-level="10.1" data-path="ch-10.html"><a href="ch-10.html#introduction-9"><i class="fa fa-check"></i><b>10.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="ch-10.html"><a href="ch-10.html#learning-objectives-3"><i class="fa fa-check"></i><b>10.1.1</b> Learning objectives</a></li>
<li class="chapter" data-level="10.1.2" data-path="ch-10.html"><a href="ch-10.html#important-points-from-the-lecture-3"><i class="fa fa-check"></i><b>10.1.2</b> Important points from the lecture</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="ch-10.html"><a href="ch-10.html#tutorial-7"><i class="fa fa-check"></i><b>10.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="ch-10.html"><a href="ch-10.html#import-libraries-1"><i class="fa fa-check"></i><b>10.2.1</b> Import libraries</a></li>
<li class="chapter" data-level="10.2.2" data-path="ch-10.html"><a href="ch-10.html#construct-a-toy-dataset"><i class="fa fa-check"></i><b>10.2.2</b> Construct a toy dataset</a></li>
<li class="chapter" data-level="10.2.3" data-path="ch-10.html"><a href="ch-10.html#build-and-train-nn"><i class="fa fa-check"></i><b>10.2.3</b> Build and train NN</a></li>
<li class="chapter" data-level="10.2.4" data-path="ch-10.html"><a href="ch-10.html#model-performance"><i class="fa fa-check"></i><b>10.2.4</b> Model performance</a></li>
<li class="chapter" data-level="10.2.5" data-path="ch-10.html"><a href="ch-10.html#influence-of-nn-architecture"><i class="fa fa-check"></i><b>10.2.5</b> Influence of NN architecture</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="ch-10.html"><a href="ch-10.html#exercise-8"><i class="fa fa-check"></i><b>10.3</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="ch-11.html"><a href="ch-11.html"><i class="fa fa-check"></i><b>11</b> Application 2: Neural Networks and Hyperparameter Tuning</a>
<ul>
<li class="chapter" data-level="11.1" data-path="ch-11.html"><a href="ch-11.html#introduction-10"><i class="fa fa-check"></i><b>11.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="ch-11.html"><a href="ch-11.html#learning-goals"><i class="fa fa-check"></i><b>11.1.1</b> Learning Goals</a></li>
<li class="chapter" data-level="11.1.2" data-path="ch-11.html"><a href="ch-11.html#key-points-from-previous-lectures"><i class="fa fa-check"></i><b>11.1.2</b> Key Points from Previous Lectures</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="ch-11.html"><a href="ch-11.html#application-1"><i class="fa fa-check"></i><b>11.2</b> Application</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="ch-11.html"><a href="ch-11.html#problem-statement"><i class="fa fa-check"></i><b>11.2.1</b> Problem Statement</a></li>
<li class="chapter" data-level="11.2.2" data-path="ch-11.html"><a href="ch-11.html#data-preparation"><i class="fa fa-check"></i><b>11.2.2</b> Data preparation</a></li>
<li class="chapter" data-level="11.2.3" data-path="ch-11.html"><a href="ch-11.html#center-and-scale"><i class="fa fa-check"></i><b>11.2.3</b> Center and scale</a></li>
<li class="chapter" data-level="11.2.4" data-path="ch-11.html"><a href="ch-11.html#building-a-simple-model-with-keras-subtask-1"><i class="fa fa-check"></i><b>11.2.4</b> Building a simple model with keras ( SubTask 1)</a></li>
<li class="chapter" data-level="11.2.5" data-path="ch-11.html"><a href="ch-11.html#cross-validation"><i class="fa fa-check"></i><b>11.2.5</b> Cross validation</a></li>
<li class="chapter" data-level="11.2.6" data-path="ch-11.html"><a href="ch-11.html#parameter-tuning"><i class="fa fa-check"></i><b>11.2.6</b> Parameter Tuning</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="ch-12.html"><a href="ch-12.html"><i class="fa fa-check"></i><b>12</b> Supervised Deep Learning I</a>
<ul>
<li class="chapter" data-level="12.1" data-path="ch-12.html"><a href="ch-12.html#introduction-11"><i class="fa fa-check"></i><b>12.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="ch-12.html"><a href="ch-12.html#learning-objectives-4"><i class="fa fa-check"></i><b>12.1.1</b> Learning objectives</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="ch-12.html"><a href="ch-12.html#tutorial-8"><i class="fa fa-check"></i><b>12.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="ch-12.html"><a href="ch-12.html#building-blocks-of-cnns"><i class="fa fa-check"></i><b>12.2.1</b> Building Blocks of CNNs</a></li>
<li class="chapter" data-level="12.2.2" data-path="ch-12.html"><a href="ch-12.html#build-the-model"><i class="fa fa-check"></i><b>12.2.2</b> Build the model</a></li>
<li class="chapter" data-level="12.2.3" data-path="ch-12.html"><a href="ch-12.html#compile-and-train-the-model"><i class="fa fa-check"></i><b>12.2.3</b> Compile and train the model</a></li>
<li class="chapter" data-level="12.2.4" data-path="ch-12.html"><a href="ch-12.html#reduce-overfitting"><i class="fa fa-check"></i><b>12.2.4</b> Reduce Overfitting</a></li>
<li class="chapter" data-level="12.2.5" data-path="ch-12.html"><a href="ch-12.html#visualizing-a-cnn"><i class="fa fa-check"></i><b>12.2.5</b> Visualizing a CNN</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="ch-12.html"><a href="ch-12.html#exercise-9"><i class="fa fa-check"></i><b>12.3</b> Exercise</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="ch-12.html"><a href="ch-12.html#import-libraries-and-data"><i class="fa fa-check"></i><b>12.3.1</b> Import libraries and data</a></li>
<li class="chapter" data-level="12.3.2" data-path="ch-12.html"><a href="ch-12.html#tasks"><i class="fa fa-check"></i><b>12.3.2</b> Tasks</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="ch-13.html"><a href="ch-13.html"><i class="fa fa-check"></i><b>13</b> Supervised Deep Learning II</a>
<ul>
<li class="chapter" data-level="13.1" data-path="ch-13.html"><a href="ch-13.html#introduction-12"><i class="fa fa-check"></i><b>13.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="ch-13.html"><a href="ch-13.html#learning-objectives-5"><i class="fa fa-check"></i><b>13.1.1</b> Learning objectives</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="ch-13.html"><a href="ch-13.html#tutorial-9"><i class="fa fa-check"></i><b>13.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="ch-13.html"><a href="ch-13.html#dataset"><i class="fa fa-check"></i><b>13.2.1</b> Dataset</a></li>
<li class="chapter" data-level="13.2.2" data-path="ch-13.html"><a href="ch-13.html#naive-models-old-world"><i class="fa fa-check"></i><b>13.2.2</b> Naive models (Old World)</a></li>
<li class="chapter" data-level="13.2.3" data-path="ch-13.html"><a href="ch-13.html#neural-networks-new-world"><i class="fa fa-check"></i><b>13.2.3</b> Neural Networks (New World)</a></li>
<li class="chapter" data-level="13.2.4" data-path="ch-13.html"><a href="ch-13.html#model-comparison"><i class="fa fa-check"></i><b>13.2.4</b> Model Comparison</a></li>
</ul></li>
<li class="chapter" data-level="13.3" data-path="ch-13.html"><a href="ch-13.html#exercise-10"><i class="fa fa-check"></i><b>13.3</b> Exercise</a>
<ul>
<li class="chapter" data-level="13.3.1" data-path="ch-13.html"><a href="ch-13.html#import-libraries-2"><i class="fa fa-check"></i><b>13.3.1</b> Import libraries</a></li>
<li class="chapter" data-level="13.3.2" data-path="ch-13.html"><a href="ch-13.html#load-data"><i class="fa fa-check"></i><b>13.3.2</b> Load data</a></li>
<li class="chapter" data-level="13.3.3" data-path="ch-13.html"><a href="ch-13.html#preprocess-ndvi-images"><i class="fa fa-check"></i><b>13.3.3</b> Preprocess NDVI images</a></li>
<li class="chapter" data-level="13.3.4" data-path="ch-13.html"><a href="ch-13.html#part-1"><i class="fa fa-check"></i><b>13.3.4</b> Part 1</a></li>
<li class="chapter" data-level="13.3.5" data-path="ch-13.html"><a href="ch-13.html#part-2"><i class="fa fa-check"></i><b>13.3.5</b> Part 2</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Environmental Systems Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ch-13" class="section level1" number="13">
<h1><span class="header-section-number">Chapter 13</span> Supervised Deep Learning II</h1>
<div id="introduction-12" class="section level2" number="13.1">
<h2><span class="header-section-number">13.1</span> Introduction</h2>
<p>In this tutorial, we will put into practice and apply many of the models seen earlier in the course, in order to achieve a simple goal: efficiently extrapolate an environmental dataset. For this, we will use satellite data (specifically NDVI) as an accurate and “cheap” predictor of a specific environmental variable (C0<sub>2</sub> - vegetation fluxes) that is measured scarcely by expensive physical devices (eddy covariance towers, see see Chapters <a href="ch-02.html#ch-02">2</a> and <a href="ch-03.html#ch-03">3</a>). Sit down and relax. This tutorial invites you to take a step back, and reflect on all the knowledge you have acquired on modelling so far.</p>
<div id="learning-objectives-5" class="section level3" number="13.1.1">
<h3><span class="header-section-number">13.1.1</span> Learning objectives</h3>
<ul>
<li>Understand the link between research objective, data type and machine learning methods.</li>
<li>Develop critical judgement, assess the relevance of a method for a particular modelling objective.</li>
<li>Be able to cite examples of possible applications of various machine learning methods to problems in environmental systems science.</li>
<li>Build intuitions for future machine learning applications in own projects.</li>
<li>Understand the difference between forward Neural Networks, CNN and embeddings.</li>
<li>Appreciate similarities and differences between simpler statistical models and NN.</li>
</ul>
<p><strong>Important points from the lecture</strong></p>
<ul>
<li>Several types of models are commonly used in the Environmental Sciences. Those include linear models, general linear models, random forests, and neural networks.</li>
<li>Linear models are suited for obtaining <em>simple</em> relationships between predictors and variables (for those with a normally distributed response variable): <span class="math inline">\(y = \beta_0 + \beta_1 x + \epsilon, \quad \epsilon \sim \mathcal{N} (0,\sigma^2)\)</span></li>
<li>Generalized linear models are similar to linear models. However, they allow for less restrictive assumptions on the distribution of the predicted variable (e.g., can be binomial for predicting presence/absence).</li>
<li>Randoms forests can be used for classification or label predictions.</li>
<li>Neural Networks can be used for capturing more <em>complex</em> relationships between predictors and variable. This comes at the cost of interpretability. Convolutional Neural Networks are a special type of neural network which is suited to for example capturing the effect of the spatial structure of the predictors.</li>
<li>Neural Networks can be combined with mechanistic models to reduce the dimensionality of a problem.</li>
</ul>
</div>
</div>
<div id="tutorial-9" class="section level2" number="13.2">
<h2><span class="header-section-number">13.2</span> Tutorial</h2>
<p>Using the eddy-covariance technique, it is possible to measure the CO<sub>2</sub> gas exchange fluxes between the vegetation and the atmosphere at high temporal resolution and throughout the year (see Figure <a href="ch-13.html#fig:eddytower">13.1</a>. This is a key scientific measurement, for studying as an example the CO<sub>2</sub> cycle. Technical details on the measurement can be found <a href="https://en.wikipedia.org/wiki/Eddy_covariance">here</a>.</p>
<div class="figure" style="text-align: center"><span id="fig:eddytower"></span>
<img src="figures/13_eddytower.jpg" alt="Close-up of measuring device for $CO_2$ and other environmental parameters that is attached to eddy covariance towers. Image taken from [Wikipedia](https://upload.wikimedia.org/wikipedia/commons/5/52/Eddy_Covariance_IRGA_Sonic.jpg)." width="25%" />
<p class="caption">
Figure 13.1: Close-up of measuring device for <span class="math inline">\(CO_2\)</span> and other environmental parameters that is attached to eddy covariance towers. Image taken from <a href="https://upload.wikimedia.org/wikipedia/commons/5/52/Eddy_Covariance_IRGA_Sonic.jpg">Wikipedia</a>.
</p>
</div>
<p>Vegetation-atmosphere CO<sub>2</sub> fluxes are driven by photosynthesis and respiration. The latter is responsible for ecosystem-level CO<sub>2</sub> uptake, and the latter reverses the uptake flux. As a reminder, the equation of the reactions that happens during photosynthesis is the following:</p>
<p><span class="math display">\[
\begin{array}{rcl}
&amp; 6 \, CO_2 \, &amp;+ \, &amp;6 \, H_2O &amp;\xrightarrow{LIGHT} &amp; C_6H_{12}O_6 \, &amp;+ \,6 \, O_2  \\
 &amp; Carbon \, Dioxde &amp;+ &amp;Water &amp;\xrightarrow{ } &amp; Sugar &amp;+\, Oxygen
\end{array}
\]</span></p>
<p>Although photosynthesis is performed differently by different species, the process always begins when energy from light is absorbed by proteins called reaction centres that contain green chlorophyll pigments. The pigment absorbs visible light (from 0.4 to 0.7 µm) for use in photosynthesis. The cell structure of the leaves, on the other hand, strongly reflects near-infrared light (from 0.7 to 1.1 µm).</p>
<p><a href="https://en.wikipedia.org/wiki/Normalized_difference_vegetation_index">The Normalised Difference Vegetation Index</a> (NDVI) uses this property, by measuring the difference between the difference in reflectance between red light (<em>Red</em>) and near-infrared light (<em>NIR</em>) as:</p>
<p><span class="math display">\[
NDVI = \frac{NIR - Red}{NIR + Red}
\]</span></p>
<p>NDVI is a measure for live green foliage and is strongly related to the fraction of absorbed photosynthetically active radiation. In other words, it should scale (more or less linearly) with GPP. NDVI is easy to obtain at a fine spatial resolution, through satellite imagery. On the other hand, eddy covariance measurement sites are very scarce, and can only estimate CO<sub>2</sub> fluxes at a few geographical positions.</p>
<p>Our aim is to build a model that can estimate CO<sub>2</sub> exchange rates between the vegetation and the atmosphere, extending the range of measurements from the towers to the entire Earth system.
We will compare different approaches to find the function <span class="math inline">\(f\)</span> that best captures the relationship between NDVI (and other explanatory variables) to CO<sub>2</sub> fluxes (<span class="math inline">\(y_{CO2}\)</span>): <span class="math inline">\(y_{CO2} = f(x_{NDVI},...)\)</span></p>
<div id="dataset" class="section level3" number="13.2.1">
<h3><span class="header-section-number">13.2.1</span> Dataset</h3>
<p>As a first step of any modeling problem, we need to get and process the data to be used. Those steps have been detailed in Tutorial: <strong>Data scraping</strong>.</p>
<div id="fluxnet" class="section level4" number="13.2.1.1">
<h4><span class="header-section-number">13.2.1.1</span> FLUXNET</h4>
<p>We will once again be using the FLUXNET dataset, that you have gotten familiar with in the previous tutorials. We want to try to predict the variable <a href="https://fluxnet.org/data/fluxnet2015-dataset/fullset-data-product/"><code>NEE_CUT_REF</code></a>, which expresses the fluxes in gC <span class="math inline">\(m^{-2} d^{-1}\)</span>, using the ndvi value of the corresponding region. Figure <a href="ch-13.html#fig:map">13.2</a> shows a map of the locations of all 34 European towers available in our dataset:</p>
<div class="figure" style="text-align: center"><span id="fig:map"></span>
<img src="figures/location_of_towers.png" alt="Locations of all eddy covariance towers in Europe." width="50%" />
<p class="caption">
Figure 13.2: Locations of all eddy covariance towers in Europe.
</p>
</div>
</div>
<div id="ndvi-modis-product" class="section level4" number="13.2.1.2">
<h4><span class="header-section-number">13.2.1.2</span> NDVI (MODIS product)</h4>
<p>NASA offers a dataset obtained by the imaging sensor MODIS, which stands for <a href="https://en.wikipedia.org/wiki/Moderate_Resolution_Imaging_Spectroradiometer">Moderate Resolution Imaging Spectroradiometer</a>. This dataset contains NDVI values measured in 16-day intervals and at multiple spatial resolutions, in order to allow consistent spatial and temporal comparisons of vegetation. For this application, we use the <a href="https://lpdaac.usgs.gov/products/mod13a3v006/">MOD13A3</a> MODIS product which provides a spatial resolution of 1km monthly NDVI. In other words, each pixel of our NDVI images defines the NDVI value for a region of 1 <span class="math inline">\(km^{2}\)</span> for the respective month. Our dataset consists of NDVI images which take into account a 30km buffer around each tower. To avoid confusion and put it simply each tower is in the centre of a square that’s sides are 60km long. Therefore, each of our NDVI images contains <span class="math inline">\(66\times 66\)</span> pixels.</p>
<p>Note that the choice for considering such a wide area around the tower is not one made by our scientific understanding of the controls on CO2 gas exchange, but rather one that allows us to apply a large variety methods for data preparation and types of models for predicting fluxes. The “footprint” of eddy covariance towers, that is, the area around each tower that influence the gas exchange at the point of measurements above the canopy, is typically on the order of a few hundred metres (and not 30 km).</p>
<p>Each MODIS product gives a tile with the desired information. From this tile a region around each tower is extracted. The following picture shows you an example of such a tile and the area around the CH Oensingen tower. Extracted Region (black square) around the Tower of CH Oensingen (red cross) in the given Modis tile in Figure <a href="ch-13.html#fig:Oe2">13.3</a>.</p>
<div class="figure" style="text-align: center"><span id="fig:Oe2"></span>
<img src="figures/extracted_region_CH_Oe2.jpg" alt="Left: MODIS tile with extracted region in black and location of eddy covariance tower in CH Oensingen as red cross. Right: Monthly NDVI vs $CO_{2}$ Flux of CH Oensingen Tower in 2014." width="49%" /><img src="figures/ndvi_vs_CO2.gif" alt="Left: MODIS tile with extracted region in black and location of eddy covariance tower in CH Oensingen as red cross. Right: Monthly NDVI vs $CO_{2}$ Flux of CH Oensingen Tower in 2014." width="49%" />
<p class="caption">
Figure 13.3: Left: MODIS tile with extracted region in black and location of eddy covariance tower in CH Oensingen as red cross. Right: Monthly NDVI vs <span class="math inline">\(CO_{2}\)</span> Flux of CH Oensingen Tower in 2014.
</p>
</div>
<p>The square region around the tower is our model input and the CO<sub>2</sub> flux value (<code>NEE_CUT_REF</code>) of the red cross is our model output.</p>
<p>This might all seems a little abstract, so let’s visualise it! The two animations below show (i) our monthly inputs (NDVI images) and (ii) the corresponding monthly outputs (CO<sub>2</sub> flux plot) for the CH Oensingen tower in the year 2014.</p>
<p>What do you observe? Can you see any emerging patterns? Do you see any link between the input (NDVI image) and the output (CO<sub>2</sub> flux)?</p>
<p>First we need to load the libraries required for our modelling task. We’ll be using the <a href="https://keras.io">Keras</a> library for the neural networks.</p>
<div class="sourceCode" id="cb1038"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1038-1"><a href="ch-13.html#cb1038-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import libraries</span></span>
<span id="cb1038-2"><a href="ch-13.html#cb1038-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(imputeTS)   <span class="co"># Library for Imputation</span></span>
<span id="cb1038-3"><a href="ch-13.html#cb1038-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1038-4"><a href="ch-13.html#cb1038-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1038-5"><a href="ch-13.html#cb1038-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb1038-6"><a href="ch-13.html#cb1038-6" aria-hidden="true" tabindex="-1"></a><span class="fu">use_condaenv</span>()</span>
<span id="cb1038-7"><a href="ch-13.html#cb1038-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)      <span class="co"># Python library for deep learning</span></span>
<span id="cb1038-8"><a href="ch-13.html#cb1038-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow) <span class="co"># Google API for Machine Learning</span></span>
<span id="cb1038-9"><a href="ch-13.html#cb1038-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1038-10"><a href="ch-13.html#cb1038-10" aria-hidden="true" tabindex="-1"></a><span class="co"># set plot size </span></span>
<span id="cb1038-11"><a href="ch-13.html#cb1038-11" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width =</span> <span class="dv">10</span>, <span class="at">repr.plot.height =</span> <span class="dv">5</span>)</span></code></pre></div>
<p>Before we start on the modelling part, it would be good to check how much data is available at each tower for the desired time (2000-2014). Take a look at the plots in Figure <a href="ch-13.html#fig:tower-data">13.4</a>, showing the monthly available data for each tower over the years. Blue shows data is available, while red shows data is unavailable.</p>
<div class="figure" style="text-align: center"><span id="fig:tower-data"></span>
<img src="figures/data_available_1.png" alt="Available data for all towers in data set from years 2000 to 2014. On the y- and x-axis with have the year, respectively the month of that year. Each plot denotes one of the total 34 towers in the data set." width="49%" /><img src="figures/data_available_2.png" alt="Available data for all towers in data set from years 2000 to 2014. On the y- and x-axis with have the year, respectively the month of that year. Each plot denotes one of the total 34 towers in the data set." width="49%" />
<p class="caption">
Figure 13.4: Available data for all towers in data set from years 2000 to 2014. On the y- and x-axis with have the year, respectively the month of that year. Each plot denotes one of the total 34 towers in the data set.
</p>
</div>
</div>
<div id="read-in-the-data" class="section level4" number="13.2.1.3">
<h4><span class="header-section-number">13.2.1.3</span> Read in the Data</h4>
<p>We split the data into
- a training set: this data will be used to fit the function parameters <span class="math inline">\(f\)</span>
- a validation set: this data will be used to tune the model hyperpameters and as an indication for training end for the neural network models
- a test set: this data will be used for model assessment on a held out dataset</p>
<p>We keep 70%, 15% and 15% of the data for training, validation and test set respectively. Note that is essential that we ensure that each tower is represented in each of the datasets to not have skewed or biased results.</p>
<div class="sourceCode" id="cb1039"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1039-1"><a href="ch-13.html#cb1039-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read data of tower features</span></span>
<span id="cb1039-2"><a href="ch-13.html#cb1039-2" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;./data/SDL_II/train/towers_feature/features.rds&quot;</span>)</span>
<span id="cb1039-3"><a href="ch-13.html#cb1039-3" aria-hidden="true" tabindex="-1"></a>val   <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;./data/SDL_II/validation/towers_feature/features.rds&quot;</span>)</span>
<span id="cb1039-4"><a href="ch-13.html#cb1039-4" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;./data/SDL_II/test/towers_feature/features.rds&quot;</span>)</span>
<span id="cb1039-5"><a href="ch-13.html#cb1039-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1039-6"><a href="ch-13.html#cb1039-6" aria-hidden="true" tabindex="-1"></a><span class="co"># have a look at the data</span></span>
<span id="cb1039-7"><a href="ch-13.html#cb1039-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(train)</span></code></pre></div>
<pre><code>##      tower year month        co2
## 112 BE_Bra 2009     5 -2.5946352
## 126 BE_Bra 2010     7 -2.1514027
## 138 BE_Bra 2011     7 -3.1261510
## 54  BE_Bra 2004     7 -2.1701580
## 104 BE_Bra 2008     9 -0.5906272
## 161 BE_Bra 2013     6 -4.0140262</code></pre>
<div class="sourceCode" id="cb1041"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1041-1"><a href="ch-13.html#cb1041-1" aria-hidden="true" tabindex="-1"></a><span class="co"># take CO2 flux</span></span>
<span id="cb1041-2"><a href="ch-13.html#cb1041-2" aria-hidden="true" tabindex="-1"></a>y_train <span class="ot">&lt;-</span> train<span class="sc">$</span>co2</span>
<span id="cb1041-3"><a href="ch-13.html#cb1041-3" aria-hidden="true" tabindex="-1"></a>y_val <span class="ot">&lt;-</span> val<span class="sc">$</span>co2</span>
<span id="cb1041-4"><a href="ch-13.html#cb1041-4" aria-hidden="true" tabindex="-1"></a>y_test <span class="ot">&lt;-</span>  test<span class="sc">$</span>co2</span>
<span id="cb1041-5"><a href="ch-13.html#cb1041-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1041-6"><a href="ch-13.html#cb1041-6" aria-hidden="true" tabindex="-1"></a><span class="co"># take ndvi images</span></span>
<span id="cb1041-7"><a href="ch-13.html#cb1041-7" aria-hidden="true" tabindex="-1"></a>ndvi_train <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;./data/SDL_II/train/NDVI/ndvi_train.rds&quot;</span>)</span>
<span id="cb1041-8"><a href="ch-13.html#cb1041-8" aria-hidden="true" tabindex="-1"></a>ndvi_val   <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;./data/SDL_II/validation/NDVI/ndvi_val.rds&quot;</span>)</span>
<span id="cb1041-9"><a href="ch-13.html#cb1041-9" aria-hidden="true" tabindex="-1"></a>ndvi_test  <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;./data/SDL_II/test/NDVI/ndvi_test.rds&quot;</span>)</span>
<span id="cb1041-10"><a href="ch-13.html#cb1041-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1041-11"><a href="ch-13.html#cb1041-11" aria-hidden="true" tabindex="-1"></a><span class="co"># print some statistics of the data</span></span>
<span id="cb1041-12"><a href="ch-13.html#cb1041-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Size of training set is &quot;</span>, <span class="fu">length</span>(y_train), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb1041-13"><a href="ch-13.html#cb1041-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Size of test set is &quot;</span>, <span class="fu">length</span>(y_test))</span></code></pre></div>
<pre><code>## Size of training set is  3366 
##  Size of test set is  648</code></pre>
Let ’s have a look at the distribution of CO<sub>2</sub> flux by tower displayed in Figure <a href="ch-13.html#fig:tower-dist">13.5</a>.
<div class="figure" style="text-align: center"><span id="fig:tower-dist"></span>
<img src="figures/Distribution_per_Tower.png" alt="Distribution of CO~2~ Flux by Tower." width="75%" />
<p class="caption">
Figure 13.5: Distribution of CO<sub>2</sub> Flux by Tower.
</p>
</div>
</div>
</div>
<div id="naive-models-old-world" class="section level3" number="13.2.2">
<h3><span class="header-section-number">13.2.2</span> Naive models (Old World)</h3>
<div id="linear-model" class="section level4" number="13.2.2.1">
<h4><span class="header-section-number">13.2.2.1</span> Linear Model</h4>
<p>We first build a linear model, which assumes a linear relationship between <em>label</em> (output) and <em>feature</em> (input) $ y = f(x) +$. That is, <span class="math inline">\(f\)</span> is of the form <span class="math inline">\(f(x) = \beta_1 x + \beta_0\)</span> with <span class="math inline">\(\beta_0,\beta_1 \in \mathbb{R}\)</span>.</p>
<p>However, it seems reasonable to simply average the NDVI values per image, and use it as a predictor for the CO<sub>2</sub> flux. To this end we can make use of the function <code>extract_features</code> which extracts the average value from the NDVI image as a feature and then uses this as the input.</p>
<div class="sourceCode" id="cb1043"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1043-1"><a href="ch-13.html#cb1043-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a function that extracts average value of set of ndvi images</span></span>
<span id="cb1043-2"><a href="ch-13.html#cb1043-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1043-3"><a href="ch-13.html#cb1043-3" aria-hidden="true" tabindex="-1"></a>extract_features <span class="ot">&lt;-</span> <span class="cf">function</span>(ndvi){</span>
<span id="cb1043-4"><a href="ch-13.html#cb1043-4" aria-hidden="true" tabindex="-1"></a>  x_avg <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb1043-5"><a href="ch-13.html#cb1043-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> ( i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(ndvi)[<span class="dv">1</span>]){</span>
<span id="cb1043-6"><a href="ch-13.html#cb1043-6" aria-hidden="true" tabindex="-1"></a>    x_avg <span class="ot">&lt;-</span> <span class="fu">c</span>(x_avg,<span class="fu">mean</span>(ndvi[i,,],<span class="at">na.rm =</span> T))</span>
<span id="cb1043-7"><a href="ch-13.html#cb1043-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1043-8"><a href="ch-13.html#cb1043-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">avg_ndvi =</span> x_avg))</span>
<span id="cb1043-9"><a href="ch-13.html#cb1043-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1043-10"><a href="ch-13.html#cb1043-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1043-11"><a href="ch-13.html#cb1043-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract average</span></span>
<span id="cb1043-12"><a href="ch-13.html#cb1043-12" aria-hidden="true" tabindex="-1"></a>train_features <span class="ot">&lt;-</span> <span class="fu">extract_features</span>(ndvi_train)</span>
<span id="cb1043-13"><a href="ch-13.html#cb1043-13" aria-hidden="true" tabindex="-1"></a>val_features <span class="ot">&lt;-</span> <span class="fu">extract_features</span>(ndvi_val)</span>
<span id="cb1043-14"><a href="ch-13.html#cb1043-14" aria-hidden="true" tabindex="-1"></a>test_features <span class="ot">&lt;-</span> <span class="fu">extract_features</span>(ndvi_test)</span></code></pre></div>
<p>A specific built in function <code>lm</code> can be used to estimate <span class="math inline">\(f\)</span></p>
<div class="sourceCode" id="cb1044"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1044-1"><a href="ch-13.html#cb1044-1" aria-hidden="true" tabindex="-1"></a><span class="co">#create dataframes</span></span>
<span id="cb1044-2"><a href="ch-13.html#cb1044-2" aria-hidden="true" tabindex="-1"></a>df_train <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y_train, train_features)</span>
<span id="cb1044-3"><a href="ch-13.html#cb1044-3" aria-hidden="true" tabindex="-1"></a>df_val   <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y_val, val_features)</span>
<span id="cb1044-4"><a href="ch-13.html#cb1044-4" aria-hidden="true" tabindex="-1"></a>df_test  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y_test, test_features)</span>
<span id="cb1044-5"><a href="ch-13.html#cb1044-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1044-6"><a href="ch-13.html#cb1044-6" aria-hidden="true" tabindex="-1"></a><span class="co">#have a look</span></span>
<span id="cb1044-7"><a href="ch-13.html#cb1044-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_train)</span></code></pre></div>
<pre><code>##            y avg_ndvi
## 1 -2.5946352 6236.160
## 2 -2.1514027 6416.719
## 3 -3.1261510 6944.201
## 4 -2.1701580 7000.009
## 5 -0.5906272 6793.311
## 6 -4.0140262 6385.099</code></pre>
<div class="sourceCode" id="cb1046"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1046-1"><a href="ch-13.html#cb1046-1" aria-hidden="true" tabindex="-1"></a><span class="co">#create linear model</span></span>
<span id="cb1046-2"><a href="ch-13.html#cb1046-2" aria-hidden="true" tabindex="-1"></a>lm_fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> ., <span class="at">data =</span> df_train) </span>
<span id="cb1046-3"><a href="ch-13.html#cb1046-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm_fit)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ ., data = df_train)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -14.5365  -1.1799   0.3275   1.6075   8.3551 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  1.618e+00  1.333e-01   12.13   &lt;2e-16 ***
## avg_ndvi    -4.713e-04  2.273e-05  -20.74   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 2.341 on 3364 degrees of freedom
## Multiple R-squared:  0.1134, Adjusted R-squared:  0.1131 
## F-statistic: 430.1 on 1 and 3364 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>According to p-value which is less than 0.05 , the average NDVI value is important for the CO<sub>2</sub> flux.
Let’s also create a plot of the linear model:</p>
<div class="sourceCode" id="cb1048"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1048-1"><a href="ch-13.html#cb1048-1" aria-hidden="true" tabindex="-1"></a>y_lab <span class="ot">&lt;-</span> <span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">&quot;CO2 flux (gC m&quot;</span><span class="sc">^-</span><span class="dv">2</span>, <span class="st">&quot;d&quot;</span><span class="sc">^-</span><span class="dv">1</span>, <span class="st">&quot;)&quot;</span>))</span>
<span id="cb1048-2"><a href="ch-13.html#cb1048-2" aria-hidden="true" tabindex="-1"></a>df_train <span class="sc">%&gt;%</span></span>
<span id="cb1048-3"><a href="ch-13.html#cb1048-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> avg_ndvi, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb1048-4"><a href="ch-13.html#cb1048-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb1048-5"><a href="ch-13.html#cb1048-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>,<span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">se =</span> F) <span class="sc">+</span></span>
<span id="cb1048-6"><a href="ch-13.html#cb1048-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_gray</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb1048-7"><a href="ch-13.html#cb1048-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&#39;Average NDVI&#39;</span>, <span class="at">y =</span> y_lab )</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-552-1.png" width="50%" style="display: block; margin: auto;" /></p>
<p><strong>Checkpoint</strong>
Can you build a multi-variate linear model, using other statistical summary of NDVI values, such as standard deviation, minimum and maximum value?</p>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb1049"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1049-1"><a href="ch-13.html#cb1049-1" aria-hidden="true" tabindex="-1"></a>extract_features_ <span class="ot">&lt;-</span> <span class="cf">function</span>(ndvi){</span>
<span id="cb1049-2"><a href="ch-13.html#cb1049-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1049-3"><a href="ch-13.html#cb1049-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This is a function that extracts basic statistics from a set of ndvi images</span></span>
<span id="cb1049-4"><a href="ch-13.html#cb1049-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1049-5"><a href="ch-13.html#cb1049-5" aria-hidden="true" tabindex="-1"></a>  x_avg <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb1049-6"><a href="ch-13.html#cb1049-6" aria-hidden="true" tabindex="-1"></a>  x_std <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb1049-7"><a href="ch-13.html#cb1049-7" aria-hidden="true" tabindex="-1"></a>  x_max <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb1049-8"><a href="ch-13.html#cb1049-8" aria-hidden="true" tabindex="-1"></a>  x_min <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb1049-9"><a href="ch-13.html#cb1049-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> ( i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(ndvi)[<span class="dv">1</span>]){</span>
<span id="cb1049-10"><a href="ch-13.html#cb1049-10" aria-hidden="true" tabindex="-1"></a>    x_avg <span class="ot">&lt;-</span> <span class="fu">c</span>(x_avg,<span class="fu">mean</span>(ndvi[i,,],<span class="at">na.rm =</span> T))</span>
<span id="cb1049-11"><a href="ch-13.html#cb1049-11" aria-hidden="true" tabindex="-1"></a>    x_std <span class="ot">&lt;-</span> <span class="fu">c</span>(x_std,<span class="fu">sd</span>(ndvi[i,,],<span class="at">na.rm =</span> T))</span>
<span id="cb1049-12"><a href="ch-13.html#cb1049-12" aria-hidden="true" tabindex="-1"></a>    x_max <span class="ot">&lt;-</span> <span class="fu">c</span>(x_max,<span class="fu">max</span>(ndvi[i,,],<span class="at">na.rm =</span> T))</span>
<span id="cb1049-13"><a href="ch-13.html#cb1049-13" aria-hidden="true" tabindex="-1"></a>    x_min <span class="ot">&lt;-</span> <span class="fu">c</span>(x_min,<span class="fu">min</span>(ndvi[i,,],<span class="at">na.rm =</span> T))</span>
<span id="cb1049-14"><a href="ch-13.html#cb1049-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1049-15"><a href="ch-13.html#cb1049-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">avg =</span> x_avg, <span class="at">std =</span> x_std, <span class="at">maximum =</span> x_max, <span class="at">minimum =</span> x_min))</span>
<span id="cb1049-16"><a href="ch-13.html#cb1049-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1049-17"><a href="ch-13.html#cb1049-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1049-18"><a href="ch-13.html#cb1049-18" aria-hidden="true" tabindex="-1"></a>train_features_ <span class="ot">&lt;-</span> <span class="fu">extract_features_</span>(ndvi_train)</span>
<span id="cb1049-19"><a href="ch-13.html#cb1049-19" aria-hidden="true" tabindex="-1"></a>val_features_ <span class="ot">&lt;-</span> <span class="fu">extract_features_</span>(ndvi_val)</span>
<span id="cb1049-20"><a href="ch-13.html#cb1049-20" aria-hidden="true" tabindex="-1"></a>test_features_ <span class="ot">&lt;-</span> <span class="fu">extract_features_</span>(ndvi_test)</span>
<span id="cb1049-21"><a href="ch-13.html#cb1049-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1049-22"><a href="ch-13.html#cb1049-22" aria-hidden="true" tabindex="-1"></a>df_train_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y_train,train_features_)</span>
<span id="cb1049-23"><a href="ch-13.html#cb1049-23" aria-hidden="true" tabindex="-1"></a>df_val_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y_val,val_features_)</span>
<span id="cb1049-24"><a href="ch-13.html#cb1049-24" aria-hidden="true" tabindex="-1"></a>df_test_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y_test,test_features_)</span>
<span id="cb1049-25"><a href="ch-13.html#cb1049-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1049-26"><a href="ch-13.html#cb1049-26" aria-hidden="true" tabindex="-1"></a>lm_fit_ <span class="ot">&lt;-</span> <span class="fu">lm</span>(y<span class="sc">~</span> . ,df_train_)</span>
<span id="cb1049-27"><a href="ch-13.html#cb1049-27" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm_fit_)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ ., data = df_train_)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -14.2637  -1.2175   0.3733   1.5136   8.2443 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  1.853e+00  2.848e-01   6.507 8.83e-11 ***
## avg         -4.112e-04  3.453e-05 -11.908  &lt; 2e-16 ***
## std         -7.120e-04  1.187e-04  -5.999 2.19e-09 ***
## maximum      4.373e-05  5.178e-05   0.844    0.399    
## minimum     -2.432e-04  2.753e-05  -8.832  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 2.309 on 3361 degrees of freedom
## Multiple R-squared:  0.138,  Adjusted R-squared:  0.137 
## F-statistic: 134.5 on 4 and 3361 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div id="polynomial-model" class="section level4" number="13.2.2.2">
<h4><span class="header-section-number">13.2.2.2</span> Polynomial Model</h4>
<p>We can also fit a more complex model keeping the average NDVI value as the only input value. Let’s fit polynomial of the 2<sup>nd</sup> degree.</p>
<div class="sourceCode" id="cb1051"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1051-1"><a href="ch-13.html#cb1051-1" aria-hidden="true" tabindex="-1"></a><span class="co"># polynomial model degree 2</span></span>
<span id="cb1051-2"><a href="ch-13.html#cb1051-2" aria-hidden="true" tabindex="-1"></a>poly_fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> <span class="fu">poly</span>(avg_ndvi, <span class="dv">2</span>), <span class="at">data =</span> df_train)</span>
<span id="cb1051-3"><a href="ch-13.html#cb1051-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(poly_fit)    </span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ poly(avg_ndvi, 2), data = df_train)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -14.3897  -1.0114   0.2732   1.3512   8.8522 
## 
## Coefficients:
##                     Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)         -1.01755    0.03902  -26.08   &lt;2e-16 ***
## poly(avg_ndvi, 2)1 -48.55429    2.26366  -21.45   &lt;2e-16 ***
## poly(avg_ndvi, 2)2 -34.73258    2.26366  -15.34   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 2.264 on 3363 degrees of freedom
## Multiple R-squared:  0.1714, Adjusted R-squared:  0.1709 
## F-statistic: 347.8 on 2 and 3363 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb1053"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1053-1"><a href="ch-13.html#cb1053-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plotting</span></span>
<span id="cb1053-2"><a href="ch-13.html#cb1053-2" aria-hidden="true" tabindex="-1"></a>df_train <span class="sc">%&gt;%</span></span>
<span id="cb1053-3"><a href="ch-13.html#cb1053-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> avg_ndvi, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb1053-4"><a href="ch-13.html#cb1053-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb1053-5"><a href="ch-13.html#cb1053-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">formula =</span> y <span class="sc">~</span> <span class="fu">poly</span>(x, <span class="dv">2</span>) ,<span class="at">color =</span> <span class="st">&quot;red&quot;</span>,<span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">se =</span> F) <span class="sc">+</span></span>
<span id="cb1053-6"><a href="ch-13.html#cb1053-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_gray</span>(<span class="at">base_size =</span> <span class="dv">20</span>) <span class="sc">+</span> </span>
<span id="cb1053-7"><a href="ch-13.html#cb1053-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&#39;Average NDVI&#39;</span>, <span class="at">y =</span> y_lab )</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-554-1.png" width="50%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="neural-networks-new-world" class="section level3" number="13.2.3">
<h3><span class="header-section-number">13.2.3</span> Neural Networks (New World)</h3>
<div id="feed-forward-neural-network" class="section level4" number="13.2.3.1">
<h4><span class="header-section-number">13.2.3.1</span> Feed Forward Neural Network</h4>
<p>Instead of a Linear or Polynomial model, let’s see what happens when we approximate <span class="math inline">\(f\)</span> using a Feed Forward Neural Network with two hidden layers. Contrary to beforehand, we don’t have to extract statistical information from the NDVI dataset. Instead, we can directly feed every pixel in the function.</p>
<p>The first step and key step as always is preprocessing!</p>
<div class="sourceCode" id="cb1054"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1054-1"><a href="ch-13.html#cb1054-1" aria-hidden="true" tabindex="-1"></a><span class="co">#specify image size</span></span>
<span id="cb1054-2"><a href="ch-13.html#cb1054-2" aria-hidden="true" tabindex="-1"></a>IMAGE_WIDTH <span class="ot">&lt;-</span> <span class="fu">dim</span>(ndvi_train)[<span class="dv">2</span>]</span>
<span id="cb1054-3"><a href="ch-13.html#cb1054-3" aria-hidden="true" tabindex="-1"></a>IMAGE_HEIGHT <span class="ot">&lt;-</span> <span class="fu">dim</span>(ndvi_train)[<span class="dv">3</span>]</span>
<span id="cb1054-4"><a href="ch-13.html#cb1054-4" aria-hidden="true" tabindex="-1"></a>IMAGE_CHANNELS <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1054-5"><a href="ch-13.html#cb1054-5" aria-hidden="true" tabindex="-1"></a>IMAGE_SIZE <span class="ot">&lt;-</span> <span class="fu">c</span>(IMAGE_WIDTH,IMAGE_HEIGHT,IMAGE_CHANNELS)</span>
<span id="cb1054-6"><a href="ch-13.html#cb1054-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1054-7"><a href="ch-13.html#cb1054-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1054-8"><a href="ch-13.html#cb1054-8" aria-hidden="true" tabindex="-1"></a><span class="co">#fill missing values , rescale images to [0,1] , reshape to be a valid input for NN</span></span>
<span id="cb1054-9"><a href="ch-13.html#cb1054-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1054-10"><a href="ch-13.html#cb1054-10" aria-hidden="true" tabindex="-1"></a>preprocess_images <span class="ot">&lt;-</span> <span class="cf">function</span>(ndvi){</span>
<span id="cb1054-11"><a href="ch-13.html#cb1054-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1054-12"><a href="ch-13.html#cb1054-12" aria-hidden="true" tabindex="-1"></a>  min_ndvi <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2000</span></span>
<span id="cb1054-13"><a href="ch-13.html#cb1054-13" aria-hidden="true" tabindex="-1"></a>  max_ndvi <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb1054-14"><a href="ch-13.html#cb1054-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1054-15"><a href="ch-13.html#cb1054-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#fill missing values</span></span>
<span id="cb1054-16"><a href="ch-13.html#cb1054-16" aria-hidden="true" tabindex="-1"></a>  nd <span class="ot">&lt;-</span> <span class="fu">apply</span>(ndvi,<span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>),<span class="cf">function</span>(i) <span class="fu">na_interpolation</span>(i))</span>
<span id="cb1054-17"><a href="ch-13.html#cb1054-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1054-18"><a href="ch-13.html#cb1054-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#rescale to [0,1]</span></span>
<span id="cb1054-19"><a href="ch-13.html#cb1054-19" aria-hidden="true" tabindex="-1"></a>  nd <span class="ot">&lt;-</span> (nd<span class="sc">-</span>min_ndvi)<span class="sc">/</span>(max_ndvi<span class="sc">-</span>min_ndvi)</span>
<span id="cb1054-20"><a href="ch-13.html#cb1054-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1054-21"><a href="ch-13.html#cb1054-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#reshape adding an extra dimension</span></span>
<span id="cb1054-22"><a href="ch-13.html#cb1054-22" aria-hidden="true" tabindex="-1"></a>  nd <span class="ot">&lt;-</span> <span class="fu">array_reshape</span>(nd,dim<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,IMAGE_SIZE))</span>
<span id="cb1054-23"><a href="ch-13.html#cb1054-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1054-24"><a href="ch-13.html#cb1054-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (nd)</span>
<span id="cb1054-25"><a href="ch-13.html#cb1054-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1054-26"><a href="ch-13.html#cb1054-26" aria-hidden="true" tabindex="-1"></a>             </span>
<span id="cb1054-27"><a href="ch-13.html#cb1054-27" aria-hidden="true" tabindex="-1"></a><span class="co">#take preprocessed images</span></span>
<span id="cb1054-28"><a href="ch-13.html#cb1054-28" aria-hidden="true" tabindex="-1"></a>ndvi_train_pr <span class="ot">&lt;-</span> <span class="fu">preprocess_images</span>(ndvi_train)</span>
<span id="cb1054-29"><a href="ch-13.html#cb1054-29" aria-hidden="true" tabindex="-1"></a>ndvi_val_pr <span class="ot">&lt;-</span> <span class="fu">preprocess_images</span>(ndvi_val)</span>
<span id="cb1054-30"><a href="ch-13.html#cb1054-30" aria-hidden="true" tabindex="-1"></a>ndvi_test_pr <span class="ot">&lt;-</span> <span class="fu">preprocess_images</span>(ndvi_test)</span></code></pre></div>
<p>Then we define the <code>model</code> (our function <span class="math inline">\(f\)</span>), as follows with:
- an input layer, with dimensions the size of the NDVI image
- a hidden layer, with <code>relu</code> activation, with a size of 64
- a hidden layer, with <code>relu</code> activation, with a size of 32
- an ouput layer, of size 1 with <code>linear</code> activation</p>
<div class="sourceCode" id="cb1055"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1055-1"><a href="ch-13.html#cb1055-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ffnn</span></span>
<span id="cb1055-2"><a href="ch-13.html#cb1055-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb1055-3"><a href="ch-13.html#cb1055-3" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">layer_flatten</span>(<span class="at">input_shape =</span> IMAGE_SIZE) <span class="sc">%&gt;%</span> </span>
<span id="cb1055-4"><a href="ch-13.html#cb1055-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">64</span>,<span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1055-5"><a href="ch-13.html#cb1055-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">32</span>,<span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1055-6"><a href="ch-13.html#cb1055-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>We can also have a look at the number of trainable parameters of the model.</p>
<div class="sourceCode" id="cb1056"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1056-1"><a href="ch-13.html#cb1056-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code></pre></div>
<div class="sourceCode" id="cb1057"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1057-1"><a href="ch-13.html#cb1057-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Model: &quot;sequential&quot;</span></span>
<span id="cb1057-2"><a href="ch-13.html#cb1057-2" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb1057-3"><a href="ch-13.html#cb1057-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Layer (type)                        Output Shape                    Param #     </span></span>
<span id="cb1057-4"><a href="ch-13.html#cb1057-4" aria-hidden="true" tabindex="-1"></a><span class="do">## ================================================================================</span></span>
<span id="cb1057-5"><a href="ch-13.html#cb1057-5" aria-hidden="true" tabindex="-1"></a><span class="do">## flatten (Flatten)                   (None, 4356)                    0           </span></span>
<span id="cb1057-6"><a href="ch-13.html#cb1057-6" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb1057-7"><a href="ch-13.html#cb1057-7" aria-hidden="true" tabindex="-1"></a><span class="do">## dense (Dense)                       (None, 64)                      278848      </span></span>
<span id="cb1057-8"><a href="ch-13.html#cb1057-8" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb1057-9"><a href="ch-13.html#cb1057-9" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_1 (Dense)                     (None, 32)                      2080        </span></span>
<span id="cb1057-10"><a href="ch-13.html#cb1057-10" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb1057-11"><a href="ch-13.html#cb1057-11" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_2 (Dense)                     (None, 1)                       33          </span></span>
<span id="cb1057-12"><a href="ch-13.html#cb1057-12" aria-hidden="true" tabindex="-1"></a><span class="do">## ================================================================================</span></span>
<span id="cb1057-13"><a href="ch-13.html#cb1057-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Total params: 280,961</span></span>
<span id="cb1057-14"><a href="ch-13.html#cb1057-14" aria-hidden="true" tabindex="-1"></a><span class="do">## Trainable params: 280,961</span></span>
<span id="cb1057-15"><a href="ch-13.html#cb1057-15" aria-hidden="true" tabindex="-1"></a><span class="do">## Non-trainable params: 0</span></span>
<span id="cb1057-16"><a href="ch-13.html#cb1057-16" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span></code></pre></div>
<p>Hmm, remember for the linear model we just had 1 parameter to train. Here we have 281.000. The difference is huge!</p>
<p>It’s time to train the model.</p>
<div class="sourceCode" id="cb1058"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1058-1"><a href="ch-13.html#cb1058-1" aria-hidden="true" tabindex="-1"></a><span class="co">#optimizer</span></span>
<span id="cb1058-2"><a href="ch-13.html#cb1058-2" aria-hidden="true" tabindex="-1"></a>opt <span class="ot">&lt;-</span> <span class="fu">optimizer_adam</span>(<span class="at">lr =</span> <span class="fl">0.01</span>) </span>
<span id="cb1058-3"><a href="ch-13.html#cb1058-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1058-4"><a href="ch-13.html#cb1058-4" aria-hidden="true" tabindex="-1"></a><span class="co">#compile</span></span>
<span id="cb1058-5"><a href="ch-13.html#cb1058-5" aria-hidden="true" tabindex="-1"></a><span class="fu">compile</span>(model, <span class="at">loss =</span> <span class="st">&#39;mse&#39;</span>, <span class="at">optimizer =</span> opt, <span class="at">metrics =</span> <span class="fu">list</span>(<span class="st">&#39;mse&#39;</span>))</span>
<span id="cb1058-6"><a href="ch-13.html#cb1058-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1058-7"><a href="ch-13.html#cb1058-7" aria-hidden="true" tabindex="-1"></a><span class="co">#file path for ffnn</span></span>
<span id="cb1058-8"><a href="ch-13.html#cb1058-8" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="st">&#39;saved_models&#39;</span>)</span>
<span id="cb1058-9"><a href="ch-13.html#cb1058-9" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="fu">file.path</span>(<span class="st">&#39;saved_models&#39;</span>,<span class="st">&#39;FFNN&#39;</span>))</span>
<span id="cb1058-10"><a href="ch-13.html#cb1058-10" aria-hidden="true" tabindex="-1"></a>save_path_ffnn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">&#39;/saved_models&#39;</span>,<span class="st">&#39;FFNN&#39;</span>)</span>
<span id="cb1058-11"><a href="ch-13.html#cb1058-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1058-12"><a href="ch-13.html#cb1058-12" aria-hidden="true" tabindex="-1"></a><span class="co">#callbacks for FFNN</span></span>
<span id="cb1058-13"><a href="ch-13.html#cb1058-13" aria-hidden="true" tabindex="-1"></a>callbacks_ffnn <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1058-14"><a href="ch-13.html#cb1058-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">callback_model_checkpoint</span>(<span class="fu">file.path</span>(save_path_ffnn,<span class="st">&quot;model_ffnn.h5&quot;</span>),</span>
<span id="cb1058-15"><a href="ch-13.html#cb1058-15" aria-hidden="true" tabindex="-1"></a>                            <span class="at">monitor =</span><span class="st">&#39;val_loss&#39;</span>, <span class="at">save_best_only =</span> T, <span class="at">mode =</span> <span class="st">&#39;min&#39;</span>),</span>
<span id="cb1058-16"><a href="ch-13.html#cb1058-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">callback_reduce_lr_on_plateau</span>(<span class="at">monitor =</span> <span class="st">&quot;val_loss&quot;</span>, <span class="at">patience =</span> <span class="dv">5</span> , <span class="at">factor =</span> <span class="fl">0.1</span>),</span>
<span id="cb1058-17"><a href="ch-13.html#cb1058-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">callback_early_stopping</span>(<span class="at">monitor =</span><span class="st">&#39;val_loss&#39;</span>, <span class="at">patience =</span> <span class="dv">10</span>, <span class="at">mode =</span> <span class="st">&#39;min&#39;</span>)</span>
<span id="cb1058-18"><a href="ch-13.html#cb1058-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1058-19"><a href="ch-13.html#cb1058-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1058-20"><a href="ch-13.html#cb1058-20" aria-hidden="true" tabindex="-1"></a><span class="co"># train the model</span></span>
<span id="cb1058-21"><a href="ch-13.html#cb1058-21" aria-hidden="true" tabindex="-1"></a>history_ffnn <span class="ot">&lt;-</span> <span class="fu">fit</span>(model,<span class="at">x =</span> ndvi_train_pr,<span class="at">y =</span> y_train,<span class="at">batch_size =</span> <span class="dv">128</span>, <span class="at">epochs =</span> <span class="dv">200</span>,</span>
<span id="cb1058-22"><a href="ch-13.html#cb1058-22" aria-hidden="true" tabindex="-1"></a>                    <span class="at">shuffle =</span> T,<span class="at">validation_data =</span> <span class="fu">list</span>(ndvi_val_pr,y_val),<span class="at">callbacks =</span> callbacks_ffnn)</span></code></pre></div>
<p>Let’s see our model’s training history.</p>
<div class="sourceCode" id="cb1059"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1059-1"><a href="ch-13.html#cb1059-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load pretained models history</span></span>
<span id="cb1059-2"><a href="ch-13.html#cb1059-2" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;./data/SDL_II/saved_models/models_history.rds&quot;</span>)</span>
<span id="cb1059-3"><a href="ch-13.html#cb1059-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1059-4"><a href="ch-13.html#cb1059-4" aria-hidden="true" tabindex="-1"></a><span class="co"># plot ffnn history</span></span>
<span id="cb1059-5"><a href="ch-13.html#cb1059-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history<span class="sc">$</span>ffnn)</span></code></pre></div>
<p><img src="figures/output_46_1.png" /></p>
</div>
<div id="convolutional-neural-networks" class="section level4" number="13.2.3.2">
<h4><span class="header-section-number">13.2.3.2</span> Convolutional Neural Networks</h4>
<p><strong>Building Blocks of a CNN</strong></p>
<ul>
<li><p><code>Convolutional Layers</code>: Layers implementing the actual convolution. Their outputs are feature maps which are then passed through an activation function in order to introduce non-linearities into the system. Convolutional layers can be seen as extracting features that are passed on deeper into the model thus enabling the model to learn higher-level features that make the classification task easier.</p></li>
<li><p><code>Pooling Layers</code>: Downsampling or pooling layers concentrate the information so that deeper layers focus more on abstract/high-level patterns. A common choice is max-pooling, where only the maximum value occurring in a certain region is propagated to the output.</p></li>
<li><p><code>Dense Layers</code>: A dense or fully-connected layer connects every node in the input to every node in the output. This is the type of layer you already used in the previous tutorial. If the input dimension is large, the amount of learnable parameters introduced by using a dense layer can quickly explode. Hence, dense layers are usually added on deeper levels of the model, where the pooling operations have already reduced the dimensionality of the data. Typically, the dense layers are added last in a predictive model, performing the actual prediction on the features extracted by the convolutional layers.</p></li>
</ul>
<p>In image recognition, CNNs are widely used. They take advantage of the hierarchical patterns in data and assemble more complex patterns using smaller and simpler patterns. In our case, they can find the best way to combine the NDVI values around the point of interest, by relating one pixel value to the others. Furthermore, they can take into account local trends of small regions in comparison with the previous defined linear model which uses a global NVDI average of the whole region as the feature.</p>
<p>Note again, that the scale of the relevant eddy covariance tower footpring (a few hundred metres) is much smaller than the scale of the NDVI “scene” we’re using here. This is <em>a priori</em> knowledge about the system that we should absolutely and always use when building any type of empirical model. It saves us from deviating into a world of spurious results, that, when being surprising enough, make it into high-impact journals nonetheless. Let us, for just now, ignore this and carry on using the entire NDVI scene for predicting local fluxes with a CNN.</p>
<p>CNNs use relatively little pre-processing compared to other image classification algorithms. This means that the network learns the filters that in traditional algorithms were hand-engineered. This independence from prior knowledge and human effort in feature design is a major advantage of these networks.</p>
<div class="sourceCode" id="cb1060"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1060-1"><a href="ch-13.html#cb1060-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create CNN model</span></span>
<span id="cb1060-2"><a href="ch-13.html#cb1060-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1060-3"><a href="ch-13.html#cb1060-3" aria-hidden="true" tabindex="-1"></a>create_cnn <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb1060-4"><a href="ch-13.html#cb1060-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1060-5"><a href="ch-13.html#cb1060-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#input --&gt; ndvi images</span></span>
<span id="cb1060-6"><a href="ch-13.html#cb1060-6" aria-hidden="true" tabindex="-1"></a>  input_1 <span class="ot">&lt;-</span> <span class="fu">layer_input</span>(<span class="at">shape=</span>IMAGE_SIZE)</span>
<span id="cb1060-7"><a href="ch-13.html#cb1060-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1060-8"><a href="ch-13.html#cb1060-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cnn layer</span></span>
<span id="cb1060-9"><a href="ch-13.html#cb1060-9" aria-hidden="true" tabindex="-1"></a>  cnn_layer <span class="ot">&lt;-</span> <span class="fu">layer_conv_2d</span>(input_1,<span class="at">filters =</span> <span class="dv">4</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>), <span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>,<span class="at">padding =</span> <span class="st">&#39;same&#39;</span>)</span>
<span id="cb1060-10"><a href="ch-13.html#cb1060-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1060-11"><a href="ch-13.html#cb1060-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pool layer</span></span>
<span id="cb1060-12"><a href="ch-13.html#cb1060-12" aria-hidden="true" tabindex="-1"></a>  pool <span class="ot">&lt;-</span> <span class="fu">layer_max_pooling_2d</span>(cnn_layer,<span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>)) </span>
<span id="cb1060-13"><a href="ch-13.html#cb1060-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1060-14"><a href="ch-13.html#cb1060-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cnn layer</span></span>
<span id="cb1060-15"><a href="ch-13.html#cb1060-15" aria-hidden="true" tabindex="-1"></a>  cnn_layer_2 <span class="ot">&lt;-</span> <span class="fu">layer_conv_2d</span>(pool,<span class="at">filters =</span> <span class="dv">16</span>,<span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>),<span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>, <span class="at">padding =</span> <span class="st">&#39;same&#39;</span>)</span>
<span id="cb1060-16"><a href="ch-13.html#cb1060-16" aria-hidden="true" tabindex="-1"></a>                      </span>
<span id="cb1060-17"><a href="ch-13.html#cb1060-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pool layer</span></span>
<span id="cb1060-18"><a href="ch-13.html#cb1060-18" aria-hidden="true" tabindex="-1"></a>  pool_2 <span class="ot">&lt;-</span> <span class="fu">layer_max_pooling_2d</span>(cnn_layer_2,<span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb1060-19"><a href="ch-13.html#cb1060-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1060-20"><a href="ch-13.html#cb1060-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># drop some features to avoid overfitting</span></span>
<span id="cb1060-21"><a href="ch-13.html#cb1060-21" aria-hidden="true" tabindex="-1"></a>  drop_ft <span class="ot">&lt;-</span> <span class="fu">layer_dropout</span>(pool_2,<span class="at">rate =</span> <span class="fl">0.2</span>)</span>
<span id="cb1060-22"><a href="ch-13.html#cb1060-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1060-23"><a href="ch-13.html#cb1060-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># flatten the features</span></span>
<span id="cb1060-24"><a href="ch-13.html#cb1060-24" aria-hidden="true" tabindex="-1"></a>  flat <span class="ot">&lt;-</span> <span class="fu">layer_flatten</span>(drop_ft)</span>
<span id="cb1060-25"><a href="ch-13.html#cb1060-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1060-26"><a href="ch-13.html#cb1060-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mlp of the features --&gt; project to dim 64</span></span>
<span id="cb1060-27"><a href="ch-13.html#cb1060-27" aria-hidden="true" tabindex="-1"></a>  flat_proj <span class="ot">&lt;-</span> <span class="fu">layer_dense</span>(flat,<span class="at">units =</span> <span class="dv">64</span>,<span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>)</span>
<span id="cb1060-28"><a href="ch-13.html#cb1060-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1060-29"><a href="ch-13.html#cb1060-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">#output</span></span>
<span id="cb1060-30"><a href="ch-13.html#cb1060-30" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">layer_dense</span>(flat_proj,<span class="at">units =</span> <span class="dv">1</span>, <span class="at">activation =</span> <span class="st">&#39;linear&#39;</span>)</span>
<span id="cb1060-31"><a href="ch-13.html#cb1060-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1060-32"><a href="ch-13.html#cb1060-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">#create model</span></span>
<span id="cb1060-33"><a href="ch-13.html#cb1060-33" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">keras_model</span>(input_1,output)</span>
<span id="cb1060-34"><a href="ch-13.html#cb1060-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1060-35"><a href="ch-13.html#cb1060-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(model)</span>
<span id="cb1060-36"><a href="ch-13.html#cb1060-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1060-37"><a href="ch-13.html#cb1060-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1060-38"><a href="ch-13.html#cb1060-38" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">create_cnn</span>()</span>
<span id="cb1060-39"><a href="ch-13.html#cb1060-39" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code></pre></div>
<div class="sourceCode" id="cb1061"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1061-1"><a href="ch-13.html#cb1061-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Model: &quot;model&quot;</span></span>
<span id="cb1061-2"><a href="ch-13.html#cb1061-2" aria-hidden="true" tabindex="-1"></a><span class="do">## _________________________________________________________________________________________________</span></span>
<span id="cb1061-3"><a href="ch-13.html#cb1061-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Layer (type)                               Output Shape                           Param #        </span></span>
<span id="cb1061-4"><a href="ch-13.html#cb1061-4" aria-hidden="true" tabindex="-1"></a><span class="do">## =================================================================================================</span></span>
<span id="cb1061-5"><a href="ch-13.html#cb1061-5" aria-hidden="true" tabindex="-1"></a><span class="do">## input_1 (InputLayer)                       [(None, 66, 66, 1)]                    0              </span></span>
<span id="cb1061-6"><a href="ch-13.html#cb1061-6" aria-hidden="true" tabindex="-1"></a><span class="do">## _________________________________________________________________________________________________</span></span>
<span id="cb1061-7"><a href="ch-13.html#cb1061-7" aria-hidden="true" tabindex="-1"></a><span class="do">## conv2d (Conv2D)                            (None, 66, 66, 4)                      40             </span></span>
<span id="cb1061-8"><a href="ch-13.html#cb1061-8" aria-hidden="true" tabindex="-1"></a><span class="do">## _________________________________________________________________________________________________</span></span>
<span id="cb1061-9"><a href="ch-13.html#cb1061-9" aria-hidden="true" tabindex="-1"></a><span class="do">## max_pooling2d (MaxPooling2D)               (None, 22, 22, 4)                      0              </span></span>
<span id="cb1061-10"><a href="ch-13.html#cb1061-10" aria-hidden="true" tabindex="-1"></a><span class="do">## _________________________________________________________________________________________________</span></span>
<span id="cb1061-11"><a href="ch-13.html#cb1061-11" aria-hidden="true" tabindex="-1"></a><span class="do">## conv2d_1 (Conv2D)                          (None, 22, 22, 16)                     592            </span></span>
<span id="cb1061-12"><a href="ch-13.html#cb1061-12" aria-hidden="true" tabindex="-1"></a><span class="do">## _________________________________________________________________________________________________</span></span>
<span id="cb1061-13"><a href="ch-13.html#cb1061-13" aria-hidden="true" tabindex="-1"></a><span class="do">## max_pooling2d_1 (MaxPooling2D)             (None, 7, 7, 16)                       0              </span></span>
<span id="cb1061-14"><a href="ch-13.html#cb1061-14" aria-hidden="true" tabindex="-1"></a><span class="do">## _________________________________________________________________________________________________</span></span>
<span id="cb1061-15"><a href="ch-13.html#cb1061-15" aria-hidden="true" tabindex="-1"></a><span class="do">## dropout (Dropout)                          (None, 7, 7, 16)                       0              </span></span>
<span id="cb1061-16"><a href="ch-13.html#cb1061-16" aria-hidden="true" tabindex="-1"></a><span class="do">## _________________________________________________________________________________________________</span></span>
<span id="cb1061-17"><a href="ch-13.html#cb1061-17" aria-hidden="true" tabindex="-1"></a><span class="do">## flatten_2 (Flatten)                        (None, 784)                            0              </span></span>
<span id="cb1061-18"><a href="ch-13.html#cb1061-18" aria-hidden="true" tabindex="-1"></a><span class="do">## _________________________________________________________________________________________________</span></span>
<span id="cb1061-19"><a href="ch-13.html#cb1061-19" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_6 (Dense)                            (None, 64)                             50240          </span></span>
<span id="cb1061-20"><a href="ch-13.html#cb1061-20" aria-hidden="true" tabindex="-1"></a><span class="do">## _________________________________________________________________________________________________</span></span>
<span id="cb1061-21"><a href="ch-13.html#cb1061-21" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_7 (Dense)                            (None, 1)                              65             </span></span>
<span id="cb1061-22"><a href="ch-13.html#cb1061-22" aria-hidden="true" tabindex="-1"></a><span class="do">## =================================================================================================</span></span>
<span id="cb1061-23"><a href="ch-13.html#cb1061-23" aria-hidden="true" tabindex="-1"></a><span class="do">## Total params: 50,937</span></span>
<span id="cb1061-24"><a href="ch-13.html#cb1061-24" aria-hidden="true" tabindex="-1"></a><span class="do">## Trainable params: 50,937</span></span>
<span id="cb1061-25"><a href="ch-13.html#cb1061-25" aria-hidden="true" tabindex="-1"></a><span class="do">## Non-trainable params: 0</span></span>
<span id="cb1061-26"><a href="ch-13.html#cb1061-26" aria-hidden="true" tabindex="-1"></a><span class="do">## _________________________________________________________________________________________________</span></span></code></pre></div>
<p>The number of trainable parameters are still large but less than for the Feed Forward Neural Network. However, does this model achieve a better performance?</p>
<div class="sourceCode" id="cb1062"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1062-1"><a href="ch-13.html#cb1062-1" aria-hidden="true" tabindex="-1"></a><span class="co"># optimizer</span></span>
<span id="cb1062-2"><a href="ch-13.html#cb1062-2" aria-hidden="true" tabindex="-1"></a>opt <span class="ot">&lt;-</span> <span class="fu">optimizer_adam</span>(<span class="at">lr =</span> <span class="fl">0.01</span>) </span>
<span id="cb1062-3"><a href="ch-13.html#cb1062-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1062-4"><a href="ch-13.html#cb1062-4" aria-hidden="true" tabindex="-1"></a><span class="co"># file path for cnn</span></span>
<span id="cb1062-5"><a href="ch-13.html#cb1062-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="fu">file.path</span>(<span class="st">&#39;saved_models&#39;</span>,<span class="st">&#39;CNN&#39;</span>))</span>
<span id="cb1062-6"><a href="ch-13.html#cb1062-6" aria-hidden="true" tabindex="-1"></a>save_path_cnn <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">&#39;saved_models&#39;</span>,<span class="st">&#39;CNN&#39;</span>)</span>
<span id="cb1062-7"><a href="ch-13.html#cb1062-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1062-8"><a href="ch-13.html#cb1062-8" aria-hidden="true" tabindex="-1"></a><span class="co"># callback for CNN</span></span>
<span id="cb1062-9"><a href="ch-13.html#cb1062-9" aria-hidden="true" tabindex="-1"></a>callbacks_cnn <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1062-10"><a href="ch-13.html#cb1062-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">callback_model_checkpoint</span>(<span class="fu">file.path</span>(save_path_cnn,<span class="st">&quot;model_cnn.h5&quot;</span>), <span class="at">monitor=</span><span class="st">&#39;val_loss&#39;</span>,<span class="at">save_best_only =</span> T, <span class="at">mode =</span> <span class="st">&#39;min&#39;</span>),</span>
<span id="cb1062-11"><a href="ch-13.html#cb1062-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">callback_reduce_lr_on_plateau</span>(<span class="at">monitor =</span> <span class="st">&quot;val_loss&quot;</span>, <span class="at">patience =</span> <span class="dv">5</span> , <span class="at">factor =</span> <span class="fl">0.1</span>),</span>
<span id="cb1062-12"><a href="ch-13.html#cb1062-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">callback_early_stopping</span>(<span class="at">monitor=</span><span class="st">&#39;val_loss&#39;</span>, <span class="at">patience =</span> <span class="dv">10</span>, <span class="at">mode =</span> <span class="st">&#39;min&#39;</span>)</span>
<span id="cb1062-13"><a href="ch-13.html#cb1062-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1062-14"><a href="ch-13.html#cb1062-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1062-15"><a href="ch-13.html#cb1062-15" aria-hidden="true" tabindex="-1"></a><span class="co"># compile</span></span>
<span id="cb1062-16"><a href="ch-13.html#cb1062-16" aria-hidden="true" tabindex="-1"></a><span class="fu">compile</span>(model, <span class="at">loss =</span> <span class="st">&#39;mse&#39;</span>,<span class="at">optimizer =</span> opt, <span class="at">metrics =</span> <span class="fu">list</span>(<span class="st">&#39;mse&#39;</span>))</span>
<span id="cb1062-17"><a href="ch-13.html#cb1062-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1062-18"><a href="ch-13.html#cb1062-18" aria-hidden="true" tabindex="-1"></a><span class="co"># train the model</span></span>
<span id="cb1062-19"><a href="ch-13.html#cb1062-19" aria-hidden="true" tabindex="-1"></a>history_cnn <span class="ot">=</span> <span class="fu">fit</span>(model,<span class="at">x =</span> ndvi_train_pr,<span class="at">y =</span> y_train,<span class="at">batch_size =</span> <span class="dv">128</span>, <span class="at">epochs =</span> <span class="dv">200</span>,<span class="at">shuffle =</span> T,<span class="at">validation_data =</span> <span class="fu">list</span>(ndvi_val_pr,y_val),<span class="at">callbacks =</span> callbacks_cnn)</span>
<span id="cb1062-20"><a href="ch-13.html#cb1062-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1062-21"><a href="ch-13.html#cb1062-21" aria-hidden="true" tabindex="-1"></a><span class="co">#plot cnn history</span></span>
<span id="cb1062-22"><a href="ch-13.html#cb1062-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history<span class="sc">$</span>cnn)</span></code></pre></div>
<p><img src="figures/output_51_1.png" /></p>
<p><strong>Checkpoint</strong>
Can you name a major advantage of a CNN model in comparison with a FFNN model?</p>
<p><strong>Solution</strong></p>
<p>Of course the number of parameters. The CNN model outperforms the FFNN one and with much less trainable parameters.</p>
</div>
<div id="mixed-model-cnn-features-tower-location" class="section level4" number="13.2.3.3">
<h4><span class="header-section-number">13.2.3.3</span> Mixed Model: CNN Features + Tower Location</h4>
<p>One can also use CNN together with other features. In our case, the tower location seems relevant as a predictor. We treat the tower location as a categorical feature with 34 discrete categories (equal to the number of towers in our dataset).</p>
<p>However, to insert a categorical feature inside a neural network model, one needs to add it as an embedding layer.</p>
<ul>
<li><code>Embedding Layer</code>: each category of a categorical feature is given a certain user-specified number of trainable weights. After training those weights, each category captures a hidden concept.</li>
</ul>
<p>In other words what an embedding layer does is to take a categorical or discrete variable and map it to a continous number vector. This way embeddings in a NN can reduce the dimensionality, while still adequately representing the categories. Furthermore, in each category is given a unique token so that it can be encoded in the embedding layer. More on embeddings <a href="https://towardsdatascience.com/neural-network-embeddings-explained-4d028e6f0526">here</a>.</p>
<p>In our case, the embedding should capture the distribution of CO<sub>2</sub> flux for the specific tower location. So in essence, it can take into account the special distribution of CO<sub>2</sub> flux for each discrete place (country, city etc.).</p>
<p>Further, it would be of great interest to insert the month of each sample as a categorical feature so we can capture the seasonal trends in CO<sub>2</sub> flux.</p>
<p>The extracted feature of the CNN model is connected with the categorical tower features given by the embedding layer. Those concatenated features are given to a feed-forward neural network (i.e. dense layers) which is in charge to make the prediction.</p>
<p>A visual representation of the <em>mixed model</em> is given in Figure <a href="#fig:token"><strong>??</strong></a>.</p>
<div class="figure" style="text-align: center"><span id="fig:toke"></span>
<img src="figures/mixed_model.jpeg" alt="Visualization of adding a tokenization layer to a CNN." width="150%" />
<p class="caption">
Figure 13.6: Visualization of adding a tokenization layer to a CNN.
</p>
</div>
<div class="sourceCode" id="cb1063"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1063-1"><a href="ch-13.html#cb1063-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mixed model : CNN + tower location </span></span>
<span id="cb1063-2"><a href="ch-13.html#cb1063-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1063-3"><a href="ch-13.html#cb1063-3" aria-hidden="true" tabindex="-1"></a>create_mixed <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb1063-4"><a href="ch-13.html#cb1063-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1063-5"><a href="ch-13.html#cb1063-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># input --&gt; ndvi images</span></span>
<span id="cb1063-6"><a href="ch-13.html#cb1063-6" aria-hidden="true" tabindex="-1"></a>  input_1 <span class="ot">&lt;-</span> <span class="fu">layer_input</span>(<span class="at">shape =</span> IMAGE_SIZE)</span>
<span id="cb1063-7"><a href="ch-13.html#cb1063-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1063-8"><a href="ch-13.html#cb1063-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># input --&gt; tower </span></span>
<span id="cb1063-9"><a href="ch-13.html#cb1063-9" aria-hidden="true" tabindex="-1"></a>  input_2 <span class="ot">&lt;-</span> <span class="fu">layer_input</span>(<span class="at">shape=</span> <span class="fu">c</span>(<span class="dv">1</span>))</span>
<span id="cb1063-10"><a href="ch-13.html#cb1063-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1063-11"><a href="ch-13.html#cb1063-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cnn layer</span></span>
<span id="cb1063-12"><a href="ch-13.html#cb1063-12" aria-hidden="true" tabindex="-1"></a>  cnn_layer <span class="ot">&lt;-</span> <span class="fu">layer_conv_2d</span>(input_1,<span class="at">filters =</span> <span class="dv">4</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>), <span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>, <span class="at">padding =</span> <span class="st">&#39;same&#39;</span>)</span>
<span id="cb1063-13"><a href="ch-13.html#cb1063-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1063-14"><a href="ch-13.html#cb1063-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pool layer</span></span>
<span id="cb1063-15"><a href="ch-13.html#cb1063-15" aria-hidden="true" tabindex="-1"></a>  pool <span class="ot">&lt;-</span>  <span class="fu">layer_max_pooling_2d</span>(cnn_layer, <span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>)) </span>
<span id="cb1063-16"><a href="ch-13.html#cb1063-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1063-17"><a href="ch-13.html#cb1063-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cnn layer</span></span>
<span id="cb1063-18"><a href="ch-13.html#cb1063-18" aria-hidden="true" tabindex="-1"></a>  cnn_layer_2 <span class="ot">&lt;-</span> <span class="fu">layer_conv_2d</span>(pool, <span class="at">filters =</span> <span class="dv">16</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>), <span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>, <span class="at">padding =</span> <span class="st">&#39;same&#39;</span>)</span>
<span id="cb1063-19"><a href="ch-13.html#cb1063-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1063-20"><a href="ch-13.html#cb1063-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pool layer</span></span>
<span id="cb1063-21"><a href="ch-13.html#cb1063-21" aria-hidden="true" tabindex="-1"></a>  pool_2 <span class="ot">&lt;-</span>  <span class="fu">layer_max_pooling_2d</span>(cnn_layer_2, <span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb1063-22"><a href="ch-13.html#cb1063-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1063-23"><a href="ch-13.html#cb1063-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># drop some features to avoid overfitting</span></span>
<span id="cb1063-24"><a href="ch-13.html#cb1063-24" aria-hidden="true" tabindex="-1"></a>  drop_ft <span class="ot">&lt;-</span> <span class="fu">layer_dropout</span>(pool_2, <span class="at">rate =</span> <span class="fl">0.2</span>)</span>
<span id="cb1063-25"><a href="ch-13.html#cb1063-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1063-26"><a href="ch-13.html#cb1063-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># flatten the features</span></span>
<span id="cb1063-27"><a href="ch-13.html#cb1063-27" aria-hidden="true" tabindex="-1"></a>  flat <span class="ot">&lt;-</span> <span class="fu">layer_flatten</span>(drop_ft)</span>
<span id="cb1063-28"><a href="ch-13.html#cb1063-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1063-29"><a href="ch-13.html#cb1063-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mlp of the features --&gt; project to dim 64</span></span>
<span id="cb1063-30"><a href="ch-13.html#cb1063-30" aria-hidden="true" tabindex="-1"></a>  flat_proj <span class="ot">&lt;-</span> <span class="fu">layer_dense</span>(flat, <span class="at">units =</span> <span class="dv">64</span>, <span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>)</span>
<span id="cb1063-31"><a href="ch-13.html#cb1063-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1063-32"><a href="ch-13.html#cb1063-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1063-33"><a href="ch-13.html#cb1063-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># feature --&gt; tower </span></span>
<span id="cb1063-34"><a href="ch-13.html#cb1063-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1063-35"><a href="ch-13.html#cb1063-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tower embedding --&gt; input_dim &lt;- 34 (number of discrete towers), output_dim &lt;- 10 (number of requested trainable weights)</span></span>
<span id="cb1063-36"><a href="ch-13.html#cb1063-36" aria-hidden="true" tabindex="-1"></a>  tower_emb <span class="ot">&lt;-</span> <span class="fu">layer_embedding</span>(input_2, <span class="at">input_dim =</span> <span class="dv">34</span>, <span class="at">output_dim =</span> <span class="dv">10</span>)</span>
<span id="cb1063-37"><a href="ch-13.html#cb1063-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reshape</span></span>
<span id="cb1063-38"><a href="ch-13.html#cb1063-38" aria-hidden="true" tabindex="-1"></a>  tower_emb <span class="ot">&lt;-</span> <span class="fu">k_reshape</span>(tower_emb, shape <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">10</span>))</span>
<span id="cb1063-39"><a href="ch-13.html#cb1063-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1063-40"><a href="ch-13.html#cb1063-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># concatenate cnn feature + tower embedding  </span></span>
<span id="cb1063-41"><a href="ch-13.html#cb1063-41" aria-hidden="true" tabindex="-1"></a>  ft_concat<span class="ot">&lt;-</span> <span class="fu">k_concatenate</span>(<span class="fu">list</span>(flat_proj, tower_emb))</span>
<span id="cb1063-42"><a href="ch-13.html#cb1063-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1063-43"><a href="ch-13.html#cb1063-43" aria-hidden="true" tabindex="-1"></a>  <span class="co">#output</span></span>
<span id="cb1063-44"><a href="ch-13.html#cb1063-44" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span>  <span class="fu">layer_dense</span>(ft_concat, <span class="at">units =</span> <span class="dv">1</span>, <span class="at">activation =</span> <span class="st">&#39;linear&#39;</span>)</span>
<span id="cb1063-45"><a href="ch-13.html#cb1063-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1063-46"><a href="ch-13.html#cb1063-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">#create model</span></span>
<span id="cb1063-47"><a href="ch-13.html#cb1063-47" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">keras_model</span>(<span class="fu">list</span>(input_1, input_2), output)</span>
<span id="cb1063-48"><a href="ch-13.html#cb1063-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1063-49"><a href="ch-13.html#cb1063-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(model)</span>
<span id="cb1063-50"><a href="ch-13.html#cb1063-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1063-51"><a href="ch-13.html#cb1063-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1063-52"><a href="ch-13.html#cb1063-52" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">create_mixed</span>()</span>
<span id="cb1063-53"><a href="ch-13.html#cb1063-53" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code></pre></div>
<div class="sourceCode" id="cb1064"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1064-1"><a href="ch-13.html#cb1064-1" aria-hidden="true" tabindex="-1"></a><span class="do">##   Model: &quot;model_1&quot;</span></span>
<span id="cb1064-2"><a href="ch-13.html#cb1064-2" aria-hidden="true" tabindex="-1"></a><span class="do">##   ________________________________________________________________________________</span></span>
<span id="cb1064-3"><a href="ch-13.html#cb1064-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   Layer (type)              Output Shape      Param #  Connected to               </span></span>
<span id="cb1064-4"><a href="ch-13.html#cb1064-4" aria-hidden="true" tabindex="-1"></a><span class="do">##   ================================================================================</span></span>
<span id="cb1064-5"><a href="ch-13.html#cb1064-5" aria-hidden="true" tabindex="-1"></a><span class="do">##   input_2 (InputLayer)      [(None, 66, 66, 1 0                                   </span></span>
<span id="cb1064-6"><a href="ch-13.html#cb1064-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   ________________________________________________________________________________</span></span>
<span id="cb1064-7"><a href="ch-13.html#cb1064-7" aria-hidden="true" tabindex="-1"></a><span class="do">##   conv2d_2 (Conv2D)         (None, 66, 66, 4) 40       input_2[0][0]              </span></span>
<span id="cb1064-8"><a href="ch-13.html#cb1064-8" aria-hidden="true" tabindex="-1"></a><span class="do">##   ________________________________________________________________________________</span></span>
<span id="cb1064-9"><a href="ch-13.html#cb1064-9" aria-hidden="true" tabindex="-1"></a><span class="do">##   max_pooling2d_2 (MaxPooli (None, 22, 22, 4) 0        conv2d_2[0][0]             </span></span>
<span id="cb1064-10"><a href="ch-13.html#cb1064-10" aria-hidden="true" tabindex="-1"></a><span class="do">##   ________________________________________________________________________________</span></span>
<span id="cb1064-11"><a href="ch-13.html#cb1064-11" aria-hidden="true" tabindex="-1"></a><span class="do">##   conv2d_3 (Conv2D)         (None, 22, 22, 16 592      max_pooling2d_2[0][0]      </span></span>
<span id="cb1064-12"><a href="ch-13.html#cb1064-12" aria-hidden="true" tabindex="-1"></a><span class="do">##   ________________________________________________________________________________</span></span>
<span id="cb1064-13"><a href="ch-13.html#cb1064-13" aria-hidden="true" tabindex="-1"></a><span class="do">##   max_pooling2d_3 (MaxPooli (None, 7, 7, 16)  0        conv2d_3[0][0]             </span></span>
<span id="cb1064-14"><a href="ch-13.html#cb1064-14" aria-hidden="true" tabindex="-1"></a><span class="do">##   ________________________________________________________________________________</span></span>
<span id="cb1064-15"><a href="ch-13.html#cb1064-15" aria-hidden="true" tabindex="-1"></a><span class="do">##   input_3 (InputLayer)      [(None, 1)]       0                                   </span></span>
<span id="cb1064-16"><a href="ch-13.html#cb1064-16" aria-hidden="true" tabindex="-1"></a><span class="do">##   ________________________________________________________________________________</span></span>
<span id="cb1064-17"><a href="ch-13.html#cb1064-17" aria-hidden="true" tabindex="-1"></a><span class="do">##   dropout_1 (Dropout)       (None, 7, 7, 16)  0        max_pooling2d_3[0][0]      </span></span>
<span id="cb1064-18"><a href="ch-13.html#cb1064-18" aria-hidden="true" tabindex="-1"></a><span class="do">##   ________________________________________________________________________________</span></span>
<span id="cb1064-19"><a href="ch-13.html#cb1064-19" aria-hidden="true" tabindex="-1"></a><span class="do">##   tf_op_layer_strided_slice [(None,)]         0        input_3[0][0]              </span></span>
<span id="cb1064-20"><a href="ch-13.html#cb1064-20" aria-hidden="true" tabindex="-1"></a><span class="do">##   ________________________________________________________________________________</span></span>
<span id="cb1064-21"><a href="ch-13.html#cb1064-21" aria-hidden="true" tabindex="-1"></a><span class="do">##   flatten_2 (Flatten)       (None, 784)       0        dropout_1[0][0]            </span></span>
<span id="cb1064-22"><a href="ch-13.html#cb1064-22" aria-hidden="true" tabindex="-1"></a><span class="do">##   ________________________________________________________________________________</span></span>
<span id="cb1064-23"><a href="ch-13.html#cb1064-23" aria-hidden="true" tabindex="-1"></a><span class="do">##   embedding (Embedding)     (None, 10)        340      tf_op_layer_strided_slice[0</span></span>
<span id="cb1064-24"><a href="ch-13.html#cb1064-24" aria-hidden="true" tabindex="-1"></a><span class="do">##   ________________________________________________________________________________</span></span>
<span id="cb1064-25"><a href="ch-13.html#cb1064-25" aria-hidden="true" tabindex="-1"></a><span class="do">##   dense_5 (Dense)           (None, 64)        50240    flatten_2[0][0]            </span></span>
<span id="cb1064-26"><a href="ch-13.html#cb1064-26" aria-hidden="true" tabindex="-1"></a><span class="do">##   ________________________________________________________________________________</span></span>
<span id="cb1064-27"><a href="ch-13.html#cb1064-27" aria-hidden="true" tabindex="-1"></a><span class="do">##   tf_op_layer_Reshape (Tens [(None, 10)]      0        embedding[0][0]            </span></span>
<span id="cb1064-28"><a href="ch-13.html#cb1064-28" aria-hidden="true" tabindex="-1"></a><span class="do">##   ________________________________________________________________________________</span></span>
<span id="cb1064-29"><a href="ch-13.html#cb1064-29" aria-hidden="true" tabindex="-1"></a><span class="do">##   tf_op_layer_concat (Tenso [(None, 74)]      0        dense_5[0][0]              </span></span>
<span id="cb1064-30"><a href="ch-13.html#cb1064-30" aria-hidden="true" tabindex="-1"></a><span class="do">##                                                        tf_op_layer_Reshape[0][0]  </span></span>
<span id="cb1064-31"><a href="ch-13.html#cb1064-31" aria-hidden="true" tabindex="-1"></a><span class="do">##   ________________________________________________________________________________</span></span>
<span id="cb1064-32"><a href="ch-13.html#cb1064-32" aria-hidden="true" tabindex="-1"></a><span class="do">##   dense_6 (Dense)           (None, 1)         75       tf_op_layer_concat[0][0]   </span></span>
<span id="cb1064-33"><a href="ch-13.html#cb1064-33" aria-hidden="true" tabindex="-1"></a><span class="do">##   ================================================================================</span></span>
<span id="cb1064-34"><a href="ch-13.html#cb1064-34" aria-hidden="true" tabindex="-1"></a><span class="do">##   Total params: 51,287</span></span>
<span id="cb1064-35"><a href="ch-13.html#cb1064-35" aria-hidden="true" tabindex="-1"></a><span class="do">##   Trainable params: 51,287</span></span>
<span id="cb1064-36"><a href="ch-13.html#cb1064-36" aria-hidden="true" tabindex="-1"></a><span class="do">##   Non-trainable params: 0</span></span>
<span id="cb1064-37"><a href="ch-13.html#cb1064-37" aria-hidden="true" tabindex="-1"></a><span class="do">##   ________________________________________________________________________________</span></span></code></pre></div>
<p>We also have to create a function that tokenizes the categorical features. Each discrete category is represented with a unique number.</p>
<div class="sourceCode" id="cb1065"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1065-1"><a href="ch-13.html#cb1065-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create function which tokenizes tower</span></span>
<span id="cb1065-2"><a href="ch-13.html#cb1065-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1065-3"><a href="ch-13.html#cb1065-3" aria-hidden="true" tabindex="-1"></a>tokenize_data <span class="ot">&lt;-</span> <span class="cf">function</span>(data){</span>
<span id="cb1065-4"><a href="ch-13.html#cb1065-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1065-5"><a href="ch-13.html#cb1065-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tokenize tower</span></span>
<span id="cb1065-6"><a href="ch-13.html#cb1065-6" aria-hidden="true" tabindex="-1"></a>  tower_token <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(data<span class="sc">$</span>tower))</span>
<span id="cb1065-7"><a href="ch-13.html#cb1065-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1065-8"><a href="ch-13.html#cb1065-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> ( i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">unique</span>(data<span class="sc">$</span>tower))){</span>
<span id="cb1065-9"><a href="ch-13.html#cb1065-9" aria-hidden="true" tabindex="-1"></a>    ind_tow <span class="ot">&lt;-</span> <span class="fu">which</span>(data<span class="sc">$</span>tower <span class="sc">==</span> <span class="fu">unique</span>(data<span class="sc">$</span>tower)[i])</span>
<span id="cb1065-10"><a href="ch-13.html#cb1065-10" aria-hidden="true" tabindex="-1"></a>    tower_token[ind_tow] <span class="ot">=</span> i<span class="dv">-1</span></span>
<span id="cb1065-11"><a href="ch-13.html#cb1065-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1065-12"><a href="ch-13.html#cb1065-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1065-13"><a href="ch-13.html#cb1065-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (<span class="fu">as.matrix</span>(<span class="fu">data.frame</span>(<span class="at">tower_token =</span> tower_token)))</span>
<span id="cb1065-14"><a href="ch-13.html#cb1065-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1065-15"><a href="ch-13.html#cb1065-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1065-16"><a href="ch-13.html#cb1065-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1065-17"><a href="ch-13.html#cb1065-17" aria-hidden="true" tabindex="-1"></a><span class="co"># take tokens of tower </span></span>
<span id="cb1065-18"><a href="ch-13.html#cb1065-18" aria-hidden="true" tabindex="-1"></a>train_tokens <span class="ot">&lt;-</span> <span class="fu">tokenize_data</span>(train)</span>
<span id="cb1065-19"><a href="ch-13.html#cb1065-19" aria-hidden="true" tabindex="-1"></a>val_tokens <span class="ot">&lt;-</span> <span class="fu">tokenize_data</span>(val)</span>
<span id="cb1065-20"><a href="ch-13.html#cb1065-20" aria-hidden="true" tabindex="-1"></a>test_tokens <span class="ot">&lt;-</span> <span class="fu">tokenize_data</span>(test)</span></code></pre></div>
<div class="sourceCode" id="cb1066"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1066-1"><a href="ch-13.html#cb1066-1" aria-hidden="true" tabindex="-1"></a><span class="co"># optimizer</span></span>
<span id="cb1066-2"><a href="ch-13.html#cb1066-2" aria-hidden="true" tabindex="-1"></a>opt <span class="ot">&lt;-</span> <span class="fu">optimizer_adam</span>(<span class="at">lr =</span> <span class="fl">0.01</span>) </span>
<span id="cb1066-3"><a href="ch-13.html#cb1066-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1066-4"><a href="ch-13.html#cb1066-4" aria-hidden="true" tabindex="-1"></a><span class="co">#file path for mixed</span></span>
<span id="cb1066-5"><a href="ch-13.html#cb1066-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="fu">file.path</span>(<span class="st">&#39;/saved_models&#39;</span>,<span class="st">&#39;Mixed&#39;</span>))</span>
<span id="cb1066-6"><a href="ch-13.html#cb1066-6" aria-hidden="true" tabindex="-1"></a>save_path_mixed <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">&#39;/saved_models&#39;</span>,<span class="st">&#39;Mixed&#39;</span>)</span>
<span id="cb1066-7"><a href="ch-13.html#cb1066-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1066-8"><a href="ch-13.html#cb1066-8" aria-hidden="true" tabindex="-1"></a><span class="co"># callback for mixed</span></span>
<span id="cb1066-9"><a href="ch-13.html#cb1066-9" aria-hidden="true" tabindex="-1"></a>callbacks_mixed <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1066-10"><a href="ch-13.html#cb1066-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">callback_model_checkpoint</span>(<span class="fu">file.path</span>(save_path_mixed, <span class="st">&quot;model_mixed.h5&quot;</span>),</span>
<span id="cb1066-11"><a href="ch-13.html#cb1066-11" aria-hidden="true" tabindex="-1"></a>                            <span class="at">monitor =</span> <span class="st">&#39;val_loss&#39;</span>, <span class="at">save_best_only =</span> T, <span class="at">mode =</span> <span class="st">&#39;min&#39;</span>),</span>
<span id="cb1066-12"><a href="ch-13.html#cb1066-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">callback_reduce_lr_on_plateau</span>(<span class="at">monitor =</span> <span class="st">&quot;val_loss&quot;</span>, <span class="at">patience =</span> <span class="dv">5</span> , <span class="at">factor =</span> <span class="fl">0.1</span>),</span>
<span id="cb1066-13"><a href="ch-13.html#cb1066-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">callback_early_stopping</span>(<span class="at">monitor =</span> <span class="st">&#39;val_loss&#39;</span>, <span class="at">patience =</span> <span class="dv">10</span>, <span class="at">mode =</span> <span class="st">&#39;min&#39;</span>)</span>
<span id="cb1066-14"><a href="ch-13.html#cb1066-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1066-15"><a href="ch-13.html#cb1066-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1066-16"><a href="ch-13.html#cb1066-16" aria-hidden="true" tabindex="-1"></a><span class="co"># compile</span></span>
<span id="cb1066-17"><a href="ch-13.html#cb1066-17" aria-hidden="true" tabindex="-1"></a><span class="fu">compile</span>(model, <span class="at">loss =</span> <span class="st">&#39;mse&#39;</span>, <span class="at">optimizer =</span> opt,<span class="at">metrics =</span> <span class="fu">list</span>(<span class="st">&#39;mse&#39;</span>))</span>
<span id="cb1066-18"><a href="ch-13.html#cb1066-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1066-19"><a href="ch-13.html#cb1066-19" aria-hidden="true" tabindex="-1"></a><span class="co"># train the model</span></span>
<span id="cb1066-20"><a href="ch-13.html#cb1066-20" aria-hidden="true" tabindex="-1"></a>history_mixed <span class="ot">&lt;-</span> <span class="fu">fit</span>(model,<span class="at">x =</span> <span class="fu">list</span>(ndvi_train_pr,train_tokens),<span class="at">y =</span> y_train,<span class="at">batch_size =</span> <span class="dv">128</span>,</span>
<span id="cb1066-21"><a href="ch-13.html#cb1066-21" aria-hidden="true" tabindex="-1"></a>             <span class="at">epochs =</span> <span class="dv">200</span>,<span class="at">shuffle =</span> T,<span class="at">validation_data =</span> <span class="fu">list</span>(<span class="fu">list</span>(ndvi_val_pr,val_tokens),y_val),</span>
<span id="cb1066-22"><a href="ch-13.html#cb1066-22" aria-hidden="true" tabindex="-1"></a>             <span class="at">callbacks =</span> callbacks_mixed)</span>
<span id="cb1066-23"><a href="ch-13.html#cb1066-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1066-24"><a href="ch-13.html#cb1066-24" aria-hidden="true" tabindex="-1"></a><span class="co"># plot mixed history</span></span>
<span id="cb1066-25"><a href="ch-13.html#cb1066-25" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history<span class="sc">$</span>mixed)</span></code></pre></div>
<p><img src="figures/output_60_1.png" /></p>
</div>
</div>
<div id="model-comparison" class="section level3" number="13.2.4">
<h3><span class="header-section-number">13.2.4</span> Model Comparison</h3>
<p>Now we are ready to compare all the different modeling approaches. Namely, we compare the MSE of the validation and test set for each model.</p>
<div class="sourceCode" id="cb1067"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1067-1"><a href="ch-13.html#cb1067-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define mse</span></span>
<span id="cb1067-2"><a href="ch-13.html#cb1067-2" aria-hidden="true" tabindex="-1"></a>mse <span class="ot">&lt;-</span> <span class="cf">function</span>(model,x,y){</span>
<span id="cb1067-3"><a href="ch-13.html#cb1067-3" aria-hidden="true" tabindex="-1"></a>  pr <span class="ot">&lt;-</span> <span class="fu">predict</span>(model,x)</span>
<span id="cb1067-4"><a href="ch-13.html#cb1067-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (<span class="fu">round</span>(<span class="fu">mean</span>((pr<span class="sc">-</span>y)<span class="sc">^</span><span class="dv">2</span>),<span class="dv">2</span>))</span>
<span id="cb1067-5"><a href="ch-13.html#cb1067-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1067-6"><a href="ch-13.html#cb1067-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1067-7"><a href="ch-13.html#cb1067-7" aria-hidden="true" tabindex="-1"></a><span class="co">#load models</span></span>
<span id="cb1067-8"><a href="ch-13.html#cb1067-8" aria-hidden="true" tabindex="-1"></a>model_ffnn <span class="ot">&lt;-</span> <span class="fu">load_model_hdf5</span>(<span class="st">&quot;./data/SDL_II/saved_models/FFNN/model_ffnn.h5&quot;</span>)</span>
<span id="cb1067-9"><a href="ch-13.html#cb1067-9" aria-hidden="true" tabindex="-1"></a>model_cnn <span class="ot">&lt;-</span> <span class="fu">load_model_hdf5</span>(<span class="st">&quot;./data/SDL_II/saved_models/CNN/model_cnn.h5&quot;</span>)</span>
<span id="cb1067-10"><a href="ch-13.html#cb1067-10" aria-hidden="true" tabindex="-1"></a>model_mixed <span class="ot">&lt;-</span> <span class="fu">load_model_hdf5</span>(<span class="st">&quot;./data/SDL_II/saved_models/Mixed/model_mixed.h5&quot;</span>)</span>
<span id="cb1067-11"><a href="ch-13.html#cb1067-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1067-12"><a href="ch-13.html#cb1067-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Validation Mse</span></span>
<span id="cb1067-13"><a href="ch-13.html#cb1067-13" aria-hidden="true" tabindex="-1"></a>lm_val_mse <span class="ot">&lt;-</span> <span class="fu">mse</span>(lm_fit,df_val,y_val)</span>
<span id="cb1067-14"><a href="ch-13.html#cb1067-14" aria-hidden="true" tabindex="-1"></a>poly_val_mse <span class="ot">&lt;-</span> <span class="fu">mse</span>(poly_fit,df_val,y_val)</span>
<span id="cb1067-15"><a href="ch-13.html#cb1067-15" aria-hidden="true" tabindex="-1"></a>ffnn_val_mse <span class="ot">&lt;-</span> <span class="fu">mse</span>(model_ffnn,ndvi_val_pr,y_val)</span>
<span id="cb1067-16"><a href="ch-13.html#cb1067-16" aria-hidden="true" tabindex="-1"></a>cnn_val_mse <span class="ot">&lt;-</span> <span class="fu">mse</span>(model_cnn,ndvi_val_pr,y_val)</span>
<span id="cb1067-17"><a href="ch-13.html#cb1067-17" aria-hidden="true" tabindex="-1"></a>mixed_val_mse <span class="ot">&lt;-</span> <span class="fu">mse</span>(model_mixed,<span class="fu">list</span>(ndvi_val_pr,val_tokens),y_val)</span>
<span id="cb1067-18"><a href="ch-13.html#cb1067-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1067-19"><a href="ch-13.html#cb1067-19" aria-hidden="true" tabindex="-1"></a><span class="co">#test mse</span></span>
<span id="cb1067-20"><a href="ch-13.html#cb1067-20" aria-hidden="true" tabindex="-1"></a>lm_test_mse <span class="ot">&lt;-</span> <span class="fu">mse</span>(lm_fit,df_test,y_test)</span>
<span id="cb1067-21"><a href="ch-13.html#cb1067-21" aria-hidden="true" tabindex="-1"></a>poly_test_mse <span class="ot">&lt;-</span> <span class="fu">mse</span>(poly_fit,df_test,y_test)</span>
<span id="cb1067-22"><a href="ch-13.html#cb1067-22" aria-hidden="true" tabindex="-1"></a>ffnn_test_mse <span class="ot">&lt;-</span> <span class="fu">mse</span>(model_ffnn,ndvi_test_pr,y_test)</span>
<span id="cb1067-23"><a href="ch-13.html#cb1067-23" aria-hidden="true" tabindex="-1"></a>cnn_test_mse <span class="ot">&lt;-</span> <span class="fu">mse</span>(model_cnn,ndvi_test_pr,y_test)</span>
<span id="cb1067-24"><a href="ch-13.html#cb1067-24" aria-hidden="true" tabindex="-1"></a>mixed_test_mse <span class="ot">&lt;-</span> <span class="fu">mse</span>(model_mixed,<span class="fu">list</span>(ndvi_test_pr,test_tokens),y_test)</span>
<span id="cb1067-25"><a href="ch-13.html#cb1067-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1067-26"><a href="ch-13.html#cb1067-26" aria-hidden="true" tabindex="-1"></a><span class="co">#create dataframe with results</span></span>
<span id="cb1067-27"><a href="ch-13.html#cb1067-27" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Model =</span> <span class="fu">c</span>(<span class="st">&#39;Linear&#39;</span>,<span class="st">&#39;Polynomial&#39;</span>,<span class="st">&#39;FFNN&#39;</span>,<span class="st">&#39;CNN&#39;</span>,<span class="st">&#39;Mixed&#39;</span>),</span>
<span id="cb1067-28"><a href="ch-13.html#cb1067-28" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Val_MSE =</span> <span class="fu">c</span>(lm_val_mse,poly_val_mse,ffnn_val_mse,cnn_val_mse,mixed_val_mse), </span>
<span id="cb1067-29"><a href="ch-13.html#cb1067-29" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Test_MSE =</span> <span class="fu">c</span>(lm_test_mse,poly_test_mse,ffnn_test_mse,cnn_test_mse,mixed_test_mse))</span>
<span id="cb1067-30"><a href="ch-13.html#cb1067-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1067-31"><a href="ch-13.html#cb1067-31" aria-hidden="true" tabindex="-1"></a>results</span></code></pre></div>
<pre><code>##        Model Val_MSE Test_MSE
## 1     Linear    4.69     5.79
## 2 Polynomial    4.36     5.40
## 3       FFNN    4.05     4.57
## 4        CNN    2.50     2.85
## 5      Mixed    2.36     2.61</code></pre>
<div class="sourceCode" id="cb1069"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1069-1"><a href="ch-13.html#cb1069-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">%&gt;%</span></span>
<span id="cb1069-2"><a href="ch-13.html#cb1069-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rename</span>(<span class="at">Validation =</span> Val_MSE, <span class="at">Test =</span> Test_MSE)<span class="sc">%&gt;%</span></span>
<span id="cb1069-3"><a href="ch-13.html#cb1069-3" aria-hidden="true" tabindex="-1"></a><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>,<span class="at">names_to =</span> <span class="st">&#39;set&#39;</span>,<span class="at">values_to =</span> <span class="st">&#39;result&#39;</span>)<span class="sc">%&gt;%</span></span>
<span id="cb1069-4"><a href="ch-13.html#cb1069-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span> set, <span class="at">y=</span>result, <span class="at">fill=</span>Model)) <span class="sc">+</span> </span>
<span id="cb1069-5"><a href="ch-13.html#cb1069-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_bar</span>( <span class="at">stat=</span><span class="st">&quot;identity&quot;</span>, <span class="at">position =</span> <span class="st">&quot;dodge&quot;</span>) <span class="sc">+</span></span>
<span id="cb1069-6"><a href="ch-13.html#cb1069-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label=</span>result), <span class="at">vjust=</span><span class="fl">1.6</span>, <span class="at">color=</span><span class="st">&quot;white&quot;</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="fl">0.9</span>), <span class="at">size=</span><span class="dv">5</span>)<span class="sc">+</span></span>
<span id="cb1069-7"><a href="ch-13.html#cb1069-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">&#39;Set1&#39;</span>,<span class="at">breaks =</span> <span class="fu">c</span>(<span class="st">&quot;Linear&quot;</span>,<span class="st">&quot;Polynomial&quot;</span>,<span class="st">&quot;FFNN&quot;</span>,<span class="st">&quot;CNN&quot;</span>,<span class="st">&quot;Mixed&quot;</span>))<span class="sc">+</span></span>
<span id="cb1069-8"><a href="ch-13.html#cb1069-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">17</span>)<span class="sc">+</span></span>
<span id="cb1069-9"><a href="ch-13.html#cb1069-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&#39;SET&#39;</span>, <span class="at">y =</span> <span class="st">&#39;MSE&#39;</span>)</span></code></pre></div>
<p><img src="figures/output_63_0.png" /></p>
<p>What do you notice in the above bar chart?</p>
<p>Let’s make a plot with the MSE for each tower separately using the CNN and mixed model.</p>
<div class="sourceCode" id="cb1070"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1070-1"><a href="ch-13.html#cb1070-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find test MSE per Tower for cnn and mixed model</span></span>
<span id="cb1070-2"><a href="ch-13.html#cb1070-2" aria-hidden="true" tabindex="-1"></a>towers <span class="ot">=</span> <span class="fu">unique</span>(test<span class="sc">$</span>tower)</span>
<span id="cb1070-3"><a href="ch-13.html#cb1070-3" aria-hidden="true" tabindex="-1"></a>mse_tower_cnn <span class="ot">=</span> <span class="fu">rep</span>(<span class="cn">NA</span>,<span class="fu">length</span>(towers))</span>
<span id="cb1070-4"><a href="ch-13.html#cb1070-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(mse_tower_cnn) <span class="ot">=</span> towers</span>
<span id="cb1070-5"><a href="ch-13.html#cb1070-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1070-6"><a href="ch-13.html#cb1070-6" aria-hidden="true" tabindex="-1"></a>towers <span class="ot">=</span> <span class="fu">unique</span>(test<span class="sc">$</span>tower)</span>
<span id="cb1070-7"><a href="ch-13.html#cb1070-7" aria-hidden="true" tabindex="-1"></a>mse_tower_mixed <span class="ot">=</span> <span class="fu">rep</span>(<span class="cn">NA</span>,<span class="fu">length</span>(towers))</span>
<span id="cb1070-8"><a href="ch-13.html#cb1070-8" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(mse_tower_mixed) <span class="ot">=</span> towers</span>
<span id="cb1070-9"><a href="ch-13.html#cb1070-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1070-10"><a href="ch-13.html#cb1070-10" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(towers)){</span>
<span id="cb1070-11"><a href="ch-13.html#cb1070-11" aria-hidden="true" tabindex="-1"></a>     tow <span class="ot">=</span> towers[i]</span>
<span id="cb1070-12"><a href="ch-13.html#cb1070-12" aria-hidden="true" tabindex="-1"></a>     keep_ind <span class="ot">=</span> test<span class="sc">$</span>tower<span class="sc">==</span>tow</span>
<span id="cb1070-13"><a href="ch-13.html#cb1070-13" aria-hidden="true" tabindex="-1"></a>     tower_test <span class="ot">=</span> ndvi_test_pr[keep_ind,,,]</span>
<span id="cb1070-14"><a href="ch-13.html#cb1070-14" aria-hidden="true" tabindex="-1"></a>     tower_test <span class="ot">=</span> <span class="fu">array_reshape</span>(tower_test,<span class="at">dim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,IMAGE_SIZE))</span>
<span id="cb1070-15"><a href="ch-13.html#cb1070-15" aria-hidden="true" tabindex="-1"></a>     mse_tower_cnn[tow] <span class="ot">=</span> <span class="fu">mse</span>(model_cnn,tower_test,y_test[keep_ind])</span>
<span id="cb1070-16"><a href="ch-13.html#cb1070-16" aria-hidden="true" tabindex="-1"></a>     tower_test_tokens <span class="ot">=</span> test_tokens[keep_ind,]</span>
<span id="cb1070-17"><a href="ch-13.html#cb1070-17" aria-hidden="true" tabindex="-1"></a>     mse_tower_mixed[tow] <span class="ot">=</span> <span class="fu">mse</span>(model_mixed,<span class="fu">list</span>(tower_test,tower_test_tokens),y_test[keep_ind])</span>
<span id="cb1070-18"><a href="ch-13.html#cb1070-18" aria-hidden="true" tabindex="-1"></a> }</span></code></pre></div>
<div class="sourceCode" id="cb1071"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1071-1"><a href="ch-13.html#cb1071-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width =</span> <span class="dv">18</span>, <span class="at">repr.plot.height =</span> <span class="dv">10</span>)</span>
<span id="cb1071-2"><a href="ch-13.html#cb1071-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1071-3"><a href="ch-13.html#cb1071-3" aria-hidden="true" tabindex="-1"></a><span class="co">#mse per tower</span></span>
<span id="cb1071-4"><a href="ch-13.html#cb1071-4" aria-hidden="true" tabindex="-1"></a>MSE_Tower <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">mse_cnn =</span> mse_tower_cnn,<span class="at">mse_mixed =</span> mse_tower_mixed, <span class="at">tower =</span> <span class="fu">names</span>(mse_tower_cnn))<span class="sc">%&gt;%</span> <span class="fu">arrange</span>(mse_cnn)</span>
<span id="cb1071-5"><a href="ch-13.html#cb1071-5" aria-hidden="true" tabindex="-1"></a>MSE_Tower<span class="sc">$</span>tower <span class="ot">=</span> <span class="fu">factor</span>(MSE_Tower<span class="sc">$</span>tower,<span class="at">levels=</span>MSE_Tower<span class="sc">$</span>tower)</span>
<span id="cb1071-6"><a href="ch-13.html#cb1071-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1071-7"><a href="ch-13.html#cb1071-7" aria-hidden="true" tabindex="-1"></a><span class="co">#cnn</span></span>
<span id="cb1071-8"><a href="ch-13.html#cb1071-8" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">=</span>   MSE_Tower<span class="sc">%&gt;%</span></span>
<span id="cb1071-9"><a href="ch-13.html#cb1071-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> tower,<span class="at">y =</span> mse_cnn))<span class="sc">+</span></span>
<span id="cb1071-10"><a href="ch-13.html#cb1071-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_bar</span>( <span class="at">stat=</span><span class="st">&quot;identity&quot;</span>, <span class="at">position =</span> <span class="st">&quot;dodge&quot;</span>, <span class="at">fill=</span><span class="st">&quot;steelblue&quot;</span>)<span class="sc">+</span></span>
<span id="cb1071-11"><a href="ch-13.html#cb1071-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label=</span>mse_cnn), <span class="at">hjust=</span><span class="fl">1.3</span>, <span class="at">color=</span><span class="st">&quot;white&quot;</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="fl">0.9</span>), <span class="at">size=</span><span class="dv">4</span>)<span class="sc">+</span></span>
<span id="cb1071-12"><a href="ch-13.html#cb1071-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept =</span> cnn_test_mse,<span class="at">color=</span><span class="st">&#39;Total&#39;</span>),<span class="at">linetype=</span><span class="st">&#39;dashed&#39;</span>)<span class="sc">+</span></span>
<span id="cb1071-13"><a href="ch-13.html#cb1071-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">&#39;&#39;</span>,<span class="at">values =</span> <span class="fu">c</span>(<span class="at">Total=</span><span class="st">&#39;red&#39;</span>),<span class="at">labels=</span><span class="fu">paste</span>(<span class="st">&#39;Total Test MSE: &#39;</span>,<span class="fu">round</span>(cnn_test_mse,<span class="dv">3</span>)))<span class="sc">+</span></span>
<span id="cb1071-14"><a href="ch-13.html#cb1071-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;Test MSE&quot;</span>,<span class="at">x =</span> <span class="st">&quot;Tower&quot;</span>, <span class="at">title =</span> <span class="st">&#39;CNN Model&#39;</span>)<span class="sc">+</span></span>
<span id="cb1071-15"><a href="ch-13.html#cb1071-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme_minimal</span>(<span class="at">base_size=</span> <span class="dv">15</span>)<span class="sc">+</span></span>
<span id="cb1071-16"><a href="ch-13.html#cb1071-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&#39;top&#39;</span>)<span class="sc">+</span></span>
<span id="cb1071-17"><a href="ch-13.html#cb1071-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">coord_flip</span>()</span>
<span id="cb1071-18"><a href="ch-13.html#cb1071-18" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb1071-19"><a href="ch-13.html#cb1071-19" aria-hidden="true" tabindex="-1"></a><span class="co">#mixed</span></span>
<span id="cb1071-20"><a href="ch-13.html#cb1071-20" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">=</span>   MSE_Tower<span class="sc">%&gt;%</span></span>
<span id="cb1071-21"><a href="ch-13.html#cb1071-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> tower,<span class="at">y =</span> mse_mixed))<span class="sc">+</span></span>
<span id="cb1071-22"><a href="ch-13.html#cb1071-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_bar</span>( <span class="at">stat=</span><span class="st">&quot;identity&quot;</span>, <span class="at">position =</span> <span class="st">&quot;dodge&quot;</span>, <span class="at">fill=</span><span class="st">&quot;steelblue&quot;</span>)<span class="sc">+</span></span>
<span id="cb1071-23"><a href="ch-13.html#cb1071-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label=</span>mse_mixed), <span class="at">hjust=</span><span class="fl">1.3</span>, <span class="at">color=</span><span class="st">&quot;white&quot;</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="fl">0.9</span>), <span class="at">size=</span><span class="dv">4</span>)<span class="sc">+</span></span>
<span id="cb1071-24"><a href="ch-13.html#cb1071-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept =</span> mixed_test_mse,<span class="at">color=</span><span class="st">&#39;Total&#39;</span>),<span class="at">linetype=</span><span class="st">&#39;dashed&#39;</span>)<span class="sc">+</span></span>
<span id="cb1071-25"><a href="ch-13.html#cb1071-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> cnn_test_mse,<span class="at">color=</span><span class="st">&#39;red&#39;</span>,<span class="at">alpha =</span><span class="fl">0.3</span>,<span class="at">linetype=</span><span class="st">&#39;dashed&#39;</span>)<span class="sc">+</span></span>
<span id="cb1071-26"><a href="ch-13.html#cb1071-26" aria-hidden="true" tabindex="-1"></a>        <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="at">x =</span> <span class="dv">23</span>, <span class="at">y =</span> <span class="dv">3</span>, <span class="at">label =</span> <span class="st">&quot;CNN MSE&quot;</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">3</span>)<span class="sc">+</span></span>
<span id="cb1071-27"><a href="ch-13.html#cb1071-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">&#39;&#39;</span>,<span class="at">values =</span> <span class="fu">c</span>(<span class="at">Total=</span><span class="st">&#39;red&#39;</span>),<span class="at">labels=</span><span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">&#39;Total Test MSE: &#39;</span>, <span class="fu">round</span>(mixed_test_mse,<span class="dv">3</span>))))<span class="sc">+</span></span>
<span id="cb1071-28"><a href="ch-13.html#cb1071-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;Test MSE&quot;</span>,<span class="at">x =</span> <span class="st">&quot;Tower&quot;</span>,<span class="at">title =</span> <span class="st">&#39;Mixed Model&#39;</span>)<span class="sc">+</span></span>
<span id="cb1071-29"><a href="ch-13.html#cb1071-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme_minimal</span>(<span class="at">base_size=</span> <span class="dv">15</span>)<span class="sc">+</span></span>
<span id="cb1071-30"><a href="ch-13.html#cb1071-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&#39;top&#39;</span>)<span class="sc">+</span></span>
<span id="cb1071-31"><a href="ch-13.html#cb1071-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">coord_flip</span>()</span>
<span id="cb1071-32"><a href="ch-13.html#cb1071-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1071-33"><a href="ch-13.html#cb1071-33" aria-hidden="true" tabindex="-1"></a>g1 <span class="sc">+</span> g2</span></code></pre></div>
<p><img src="figures/output_66_0.png" /></p>
</div>
</div>
<div id="exercise-10" class="section level2" number="13.3">
<h2><span class="header-section-number">13.3</span> Exercise</h2>
<p>As you could see above, the mixed model - that also contains information on the tower location - improves the MSE for most towers in comparison to the CNN model. By providing the period in the year for each image in the mixed model, the result should greatly improve. This is because seasonality plays an important role in vegetation metabolism. This is the exercise for this week.</p>
<p>This exercise has two parts.</p>
<p>In the <strong>first</strong> part you will create a feed forward neural network using only the NDVI image as input. In this case each pixel of the image is considered as a feature.</p>
<p>In the <strong>second</strong> part you have to create a mixed model. As we have already seen in tutorial 13, categorical features can also be incorporated into a neural network model. Specifically, in tutorial 13, a mixed model combining the CNN features and the tower location (as a categorical feature) is created. The goal of this part is to also incorporate the corresponding month for each NDVI input image along with the tower location. The reason for such a refinement is that seasonality plays an important role in vegetation metabolism and therefore can affect the CO2 fluxes.</p>
<p>For the <strong>second</strong> part a skeleton code is provided. You have only to fill in the missing code where is necessary. Is there an improvement in the model performance on the validation and test set?</p>
<div id="import-libraries-2" class="section level3" number="13.3.1">
<h3><span class="header-section-number">13.3.1</span> Import libraries</h3>
<div class="sourceCode" id="cb1072"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1072-1"><a href="ch-13.html#cb1072-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(imputeTS) <span class="co"># Library for Imputation</span></span>
<span id="cb1072-2"><a href="ch-13.html#cb1072-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1072-3"><a href="ch-13.html#cb1072-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb1072-4"><a href="ch-13.html#cb1072-4" aria-hidden="true" tabindex="-1"></a><span class="fu">use_condaenv</span>()</span>
<span id="cb1072-5"><a href="ch-13.html#cb1072-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras) <span class="co"># Python library for deep learning</span></span>
<span id="cb1072-6"><a href="ch-13.html#cb1072-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow) </span></code></pre></div>
<p>IMPORTANT NOTE: READ CAREFULLY!</p>
<p>Do not skip this part or you’ll run into issues later on!
In a moment, after you’ve read the following instructions carefully, you should:
- run the code chunk immediately below this text (<code>keras_model_sequential()</code>).
- look down in the <em>Console</em> it asks if you want to install some packages: (“Would you like to install Miniconda? [Y/n]:”).
- write <em>n</em>and press enter. You should see the following code in the console: <code>Would you like to install Miniconda? [Y/n]: n</code>.
Now, you can normally continue with the exercise.</p>
<p>If you were too eager and already pressed <em>Y</em> (yes) and enter, don’t panic! Just close your environment, re-open it and make sure that next time you go with <em>n</em> (no).</p>
<div class="sourceCode" id="cb1073"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1073-1"><a href="ch-13.html#cb1073-1" aria-hidden="true" tabindex="-1"></a><span class="fu">keras_model_sequential</span>()</span></code></pre></div>
</div>
<div id="load-data" class="section level3" number="13.3.2">
<h3><span class="header-section-number">13.3.2</span> Load data</h3>
<div class="sourceCode" id="cb1074"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1074-1"><a href="ch-13.html#cb1074-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read in the data</span></span>
<span id="cb1074-2"><a href="ch-13.html#cb1074-2" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;./data/SDL_II/train/towers_feature/features.rds&quot;</span>)</span>
<span id="cb1074-3"><a href="ch-13.html#cb1074-3" aria-hidden="true" tabindex="-1"></a>val   <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;./data/SDL_II/validation/towers_feature/features.rds&quot;</span>)</span>
<span id="cb1074-4"><a href="ch-13.html#cb1074-4" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;./data/SDL_II/test/towers_feature/features.rds&quot;</span>)</span>
<span id="cb1074-5"><a href="ch-13.html#cb1074-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1074-6"><a href="ch-13.html#cb1074-6" aria-hidden="true" tabindex="-1"></a><span class="co"># have a look</span></span>
<span id="cb1074-7"><a href="ch-13.html#cb1074-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(train)</span></code></pre></div>
<div class="sourceCode" id="cb1075"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1075-1"><a href="ch-13.html#cb1075-1" aria-hidden="true" tabindex="-1"></a><span class="co">#  take CO2 flux</span></span>
<span id="cb1075-2"><a href="ch-13.html#cb1075-2" aria-hidden="true" tabindex="-1"></a>y_train <span class="ot">=</span> train<span class="sc">$</span>co2</span>
<span id="cb1075-3"><a href="ch-13.html#cb1075-3" aria-hidden="true" tabindex="-1"></a>y_val <span class="ot">=</span> val<span class="sc">$</span>co2</span>
<span id="cb1075-4"><a href="ch-13.html#cb1075-4" aria-hidden="true" tabindex="-1"></a>y_test <span class="ot">=</span>  test<span class="sc">$</span>co2</span>
<span id="cb1075-5"><a href="ch-13.html#cb1075-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ndvi images</span></span>
<span id="cb1075-6"><a href="ch-13.html#cb1075-6" aria-hidden="true" tabindex="-1"></a>ndvi_train <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;./data/SDL_II/train/NDVI/ndvi_train.rds&quot;</span>)</span>
<span id="cb1075-7"><a href="ch-13.html#cb1075-7" aria-hidden="true" tabindex="-1"></a>ndvi_val   <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;./data/SDL_II/validation/NDVI/ndvi_val.rds&quot;</span>)</span>
<span id="cb1075-8"><a href="ch-13.html#cb1075-8" aria-hidden="true" tabindex="-1"></a>ndvi_test  <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;./data/SDL_II/test/NDVI/ndvi_test.rds&quot;</span>)</span>
<span id="cb1075-9"><a href="ch-13.html#cb1075-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1075-10"><a href="ch-13.html#cb1075-10" aria-hidden="true" tabindex="-1"></a><span class="co"># print some statistics of the data</span></span>
<span id="cb1075-11"><a href="ch-13.html#cb1075-11" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">&quot;Size of training set is &quot;</span>,<span class="fu">length</span>(y_train))</span>
<span id="cb1075-12"><a href="ch-13.html#cb1075-12" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">&quot;Size of validation set is &quot;</span>,<span class="fu">length</span>(y_val))</span>
<span id="cb1075-13"><a href="ch-13.html#cb1075-13" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">&quot;Size of test set is &quot;</span>,<span class="fu">length</span>(y_test))</span></code></pre></div>
</div>
<div id="preprocess-ndvi-images" class="section level3" number="13.3.3">
<h3><span class="header-section-number">13.3.3</span> Preprocess NDVI images</h3>
<div class="sourceCode" id="cb1076"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1076-1"><a href="ch-13.html#cb1076-1" aria-hidden="true" tabindex="-1"></a><span class="co">#specify image size</span></span>
<span id="cb1076-2"><a href="ch-13.html#cb1076-2" aria-hidden="true" tabindex="-1"></a>IMAGE_WIDTH <span class="ot">=</span> <span class="fu">dim</span>(ndvi_train)[<span class="dv">2</span>]</span>
<span id="cb1076-3"><a href="ch-13.html#cb1076-3" aria-hidden="true" tabindex="-1"></a>IMAGE_HEIGHT <span class="ot">=</span> <span class="fu">dim</span>(ndvi_train)[<span class="dv">3</span>]</span>
<span id="cb1076-4"><a href="ch-13.html#cb1076-4" aria-hidden="true" tabindex="-1"></a>IMAGE_CHANNELS <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb1076-5"><a href="ch-13.html#cb1076-5" aria-hidden="true" tabindex="-1"></a>IMAGE_SIZE <span class="ot">=</span> <span class="fu">c</span>(IMAGE_WIDTH,IMAGE_HEIGHT,IMAGE_CHANNELS)</span>
<span id="cb1076-6"><a href="ch-13.html#cb1076-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1076-7"><a href="ch-13.html#cb1076-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1076-8"><a href="ch-13.html#cb1076-8" aria-hidden="true" tabindex="-1"></a><span class="co">#fill in the missing values, rescale images to [0,1] , reshape to be a valid input for a NN</span></span>
<span id="cb1076-9"><a href="ch-13.html#cb1076-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1076-10"><a href="ch-13.html#cb1076-10" aria-hidden="true" tabindex="-1"></a>preprocess_images <span class="ot">=</span> <span class="cf">function</span>(ndvi){</span>
<span id="cb1076-11"><a href="ch-13.html#cb1076-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1076-12"><a href="ch-13.html#cb1076-12" aria-hidden="true" tabindex="-1"></a>  min_ndvi <span class="ot">=</span> <span class="sc">-</span><span class="dv">2000</span></span>
<span id="cb1076-13"><a href="ch-13.html#cb1076-13" aria-hidden="true" tabindex="-1"></a>  max_ndvi <span class="ot">=</span> <span class="dv">10000</span></span>
<span id="cb1076-14"><a href="ch-13.html#cb1076-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1076-15"><a href="ch-13.html#cb1076-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#fill missing values</span></span>
<span id="cb1076-16"><a href="ch-13.html#cb1076-16" aria-hidden="true" tabindex="-1"></a>  nd <span class="ot">=</span> <span class="fu">apply</span>(ndvi,<span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>),<span class="cf">function</span>(i) <span class="fu">na_interpolation</span>(i))</span>
<span id="cb1076-17"><a href="ch-13.html#cb1076-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1076-18"><a href="ch-13.html#cb1076-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#rescale to [0,1]</span></span>
<span id="cb1076-19"><a href="ch-13.html#cb1076-19" aria-hidden="true" tabindex="-1"></a>  nd <span class="ot">=</span> (nd<span class="sc">-</span>min_ndvi)<span class="sc">/</span>(max_ndvi<span class="sc">-</span>min_ndvi)</span>
<span id="cb1076-20"><a href="ch-13.html#cb1076-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1076-21"><a href="ch-13.html#cb1076-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#reshape adding an extra dimension</span></span>
<span id="cb1076-22"><a href="ch-13.html#cb1076-22" aria-hidden="true" tabindex="-1"></a>  nd <span class="ot">=</span> <span class="fu">array_reshape</span>(nd,<span class="at">dim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,IMAGE_SIZE))</span>
<span id="cb1076-23"><a href="ch-13.html#cb1076-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1076-24"><a href="ch-13.html#cb1076-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (nd)</span>
<span id="cb1076-25"><a href="ch-13.html#cb1076-25" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb1076-26"><a href="ch-13.html#cb1076-26" aria-hidden="true" tabindex="-1"></a>             </span>
<span id="cb1076-27"><a href="ch-13.html#cb1076-27" aria-hidden="true" tabindex="-1"></a><span class="co">#take preprocessed images</span></span>
<span id="cb1076-28"><a href="ch-13.html#cb1076-28" aria-hidden="true" tabindex="-1"></a>ndvi_train_pr <span class="ot">=</span> <span class="fu">preprocess_images</span>(ndvi_train)</span>
<span id="cb1076-29"><a href="ch-13.html#cb1076-29" aria-hidden="true" tabindex="-1"></a>ndvi_val_pr <span class="ot">=</span> <span class="fu">preprocess_images</span>(ndvi_val)</span>
<span id="cb1076-30"><a href="ch-13.html#cb1076-30" aria-hidden="true" tabindex="-1"></a>ndvi_test_pr <span class="ot">=</span> <span class="fu">preprocess_images</span>(ndvi_test)</span></code></pre></div>
</div>
<div id="part-1" class="section level3" number="13.3.4">
<h3><span class="header-section-number">13.3.4</span> Part 1</h3>
<ol style="list-style-type: decimal">
<li>Create a feed forward neural network using only the NDVI image This model should be more complex than the one provided in tutorial 13.</li>
<li>Train the model. Hint: In tutorial 13 you can find some ideas on how to train the model and which are the proper callbacks to use</li>
<li>Plot the training history</li>
<li>Load the trained model and evaluate performance on validation and test set. Hint: In tutorial 13 we have already seen how to retrieve a trained model made by the checkpoint callback.</li>
</ol>
</div>
<div id="part-2" class="section level3" number="13.3.5">
<h3><span class="header-section-number">13.3.5</span> Part 2</h3>
<ol style="list-style-type: decimal">
<li>Create a mixed model: CNN features + tower location + month</li>
</ol>
<p>In this model we want to incorporate the month of the NDVI input image along with CNN features and the tower location. Our goal is to insert categorical features inside a neural network model and to examine if the performance can be further improved. Obviously, a model which can take into account extra information about the NDVI input image, such as the month that the image was taken, and the spatial location of it makes it more realistic. As a result, further improvement of the model performance can be expected.</p>
<p>Below, you’ll have to fill in some missing code in order to create the model.</p>
<div class="sourceCode" id="cb1077"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1077-1"><a href="ch-13.html#cb1077-1" aria-hidden="true" tabindex="-1"></a>create_mixed <span class="ot">=</span> <span class="cf">function</span>(){</span>
<span id="cb1077-2"><a href="ch-13.html#cb1077-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-3"><a href="ch-13.html#cb1077-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#input --&gt; ndvi images</span></span>
<span id="cb1077-4"><a href="ch-13.html#cb1077-4" aria-hidden="true" tabindex="-1"></a>  input_1 <span class="ot">=</span> <span class="fu">layer_input</span>(<span class="at">shape=</span>IMAGE_SIZE)</span>
<span id="cb1077-5"><a href="ch-13.html#cb1077-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-6"><a href="ch-13.html#cb1077-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#input --&gt; tower + month</span></span>
<span id="cb1077-7"><a href="ch-13.html#cb1077-7" aria-hidden="true" tabindex="-1"></a>  input_2 <span class="ot">=</span> <span class="fu">layer_input</span>(<span class="at">shape=</span><span class="co">#FILL IN THE SHAPE)</span></span>
<span id="cb1077-8"><a href="ch-13.html#cb1077-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-9"><a href="ch-13.html#cb1077-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cnn layer</span></span>
<span id="cb1077-10"><a href="ch-13.html#cb1077-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">cnn_layer =</span> <span class="fu">layer_conv_2d</span>(input_1,<span class="at">filters =</span> <span class="dv">4</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>), <span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>,<span class="at">padding =</span> <span class="st">&#39;same&#39;</span>)</span>
<span id="cb1077-11"><a href="ch-13.html#cb1077-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-12"><a href="ch-13.html#cb1077-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pool layer</span></span>
<span id="cb1077-13"><a href="ch-13.html#cb1077-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">pool =</span>  <span class="fu">layer_max_pooling_2d</span>(cnn_layer,<span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>)) </span>
<span id="cb1077-14"><a href="ch-13.html#cb1077-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-15"><a href="ch-13.html#cb1077-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cnn layer</span></span>
<span id="cb1077-16"><a href="ch-13.html#cb1077-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">cnn_layer_2 =</span> <span class="fu">layer_conv_2d</span>(pool,<span class="at">filters =</span> <span class="dv">16</span>,<span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>),<span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>, <span class="at">padding =</span> <span class="st">&#39;same&#39;</span>)</span>
<span id="cb1077-17"><a href="ch-13.html#cb1077-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-18"><a href="ch-13.html#cb1077-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pool layer</span></span>
<span id="cb1077-19"><a href="ch-13.html#cb1077-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">pool_2 =</span>  <span class="fu">layer_max_pooling_2d</span>(cnn_layer_2,<span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb1077-20"><a href="ch-13.html#cb1077-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-21"><a href="ch-13.html#cb1077-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># drop some features to avoid overfitting</span></span>
<span id="cb1077-22"><a href="ch-13.html#cb1077-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">drop_ft =</span> <span class="fu">layer_dropout</span>(pool_2,<span class="at">rate =</span> <span class="fl">0.2</span>)</span>
<span id="cb1077-23"><a href="ch-13.html#cb1077-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-24"><a href="ch-13.html#cb1077-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># flatten the features</span></span>
<span id="cb1077-25"><a href="ch-13.html#cb1077-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">flat =</span> <span class="fu">layer_flatten</span>(drop_ft)</span>
<span id="cb1077-26"><a href="ch-13.html#cb1077-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-27"><a href="ch-13.html#cb1077-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mlp of the features --&gt; project to dim 64</span></span>
<span id="cb1077-28"><a href="ch-13.html#cb1077-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">flat_proj =</span> <span class="fu">layer_dense</span>(flat,<span class="at">units =</span> <span class="dv">64</span>,<span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>)</span>
<span id="cb1077-29"><a href="ch-13.html#cb1077-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-30"><a href="ch-13.html#cb1077-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-31"><a href="ch-13.html#cb1077-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># features --&gt; tower , month</span></span>
<span id="cb1077-32"><a href="ch-13.html#cb1077-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-33"><a href="ch-13.html#cb1077-33" aria-hidden="true" tabindex="-1"></a>  <span class="co">#tower embedding --&gt; input_dim = 34 (number of discrete towers), output_dim = 10 (number of requested trainable weights)</span></span>
<span id="cb1077-34"><a href="ch-13.html#cb1077-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">tower_emb =</span> <span class="fu">layer_embedding</span>(input_2[,<span class="dv">1</span>],<span class="at">input_dim =</span> <span class="dv">34</span>,<span class="at">output_dim =</span> <span class="dv">10</span>)</span>
<span id="cb1077-35"><a href="ch-13.html#cb1077-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">#reshape</span></span>
<span id="cb1077-36"><a href="ch-13.html#cb1077-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">tower_emb =</span> <span class="fu">k_reshape</span>(tower_emb,<span class="at">shape =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">10</span>))</span>
<span id="cb1077-37"><a href="ch-13.html#cb1077-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-38"><a href="ch-13.html#cb1077-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">#month embedding --&gt; input_dim = 12 (number of discrete months), output_dim = 10 (number of requested trainable weights)</span></span>
<span id="cb1077-39"><a href="ch-13.html#cb1077-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-40"><a href="ch-13.html#cb1077-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">#FILL IN THE CODE</span></span>
<span id="cb1077-41"><a href="ch-13.html#cb1077-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">month_emb =</span> <span class="co">#create an embedding layer for the month </span></span>
<span id="cb1077-42"><a href="ch-13.html#cb1077-42" aria-hidden="true" tabindex="-1"></a>  <span class="co">#reshape</span></span>
<span id="cb1077-43"><a href="ch-13.html#cb1077-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">month_emb =</span> <span class="fu">k_reshape</span>(month_emb,<span class="at">shape =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">10</span>))</span>
<span id="cb1077-44"><a href="ch-13.html#cb1077-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-45"><a href="ch-13.html#cb1077-45" aria-hidden="true" tabindex="-1"></a>  <span class="co">#concatenate embeddings</span></span>
<span id="cb1077-46"><a href="ch-13.html#cb1077-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">emb_concat =</span> <span class="fu">k_concatenate</span>(<span class="fu">list</span>(tower_emb,month_emb))</span>
<span id="cb1077-47"><a href="ch-13.html#cb1077-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-48"><a href="ch-13.html#cb1077-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ffnn of embedings</span></span>
<span id="cb1077-49"><a href="ch-13.html#cb1077-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">emb_proj =</span> <span class="fu">layer_dense</span>(emb_concat,<span class="at">units =</span> <span class="dv">32</span>,<span class="at">activation =</span> <span class="st">&#39;relu&#39;</span>)</span>
<span id="cb1077-50"><a href="ch-13.html#cb1077-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-51"><a href="ch-13.html#cb1077-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># concatenate cnn feautures and embeddings of tower and months</span></span>
<span id="cb1077-52"><a href="ch-13.html#cb1077-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">ft_concat=</span> <span class="fu">k_concatenate</span>(<span class="fu">list</span>(flat_proj,emb_proj))</span>
<span id="cb1077-53"><a href="ch-13.html#cb1077-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-54"><a href="ch-13.html#cb1077-54" aria-hidden="true" tabindex="-1"></a>  <span class="co">#output</span></span>
<span id="cb1077-55"><a href="ch-13.html#cb1077-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">output =</span>  <span class="fu">layer_dense</span>(ft_concat,<span class="at">units =</span> <span class="dv">1</span>, <span class="at">activation =</span> <span class="st">&#39;linear&#39;</span>)</span>
<span id="cb1077-56"><a href="ch-13.html#cb1077-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-57"><a href="ch-13.html#cb1077-57" aria-hidden="true" tabindex="-1"></a>  <span class="co">#create model</span></span>
<span id="cb1077-58"><a href="ch-13.html#cb1077-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">model =</span> <span class="fu">keras_model</span>(<span class="fu">list</span>(input_1,input_2),output)</span>
<span id="cb1077-59"><a href="ch-13.html#cb1077-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1077-60"><a href="ch-13.html#cb1077-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(model)</span>
<span id="cb1077-61"><a href="ch-13.html#cb1077-61" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb1077-62"><a href="ch-13.html#cb1077-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1077-63"><a href="ch-13.html#cb1077-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1077-64"><a href="ch-13.html#cb1077-64" aria-hidden="true" tabindex="-1"></a><span class="at">model =</span> <span class="fu">create_mixed</span>()</span>
<span id="cb1077-65"><a href="ch-13.html#cb1077-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1077-66"><a href="ch-13.html#cb1077-66" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Tokenize tower location and month</li>
</ol>
<div class="sourceCode" id="cb1078"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1078-1"><a href="ch-13.html#cb1078-1" aria-hidden="true" tabindex="-1"></a><span class="co">#create function which tokenizes tower and month</span></span>
<span id="cb1078-2"><a href="ch-13.html#cb1078-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1078-3"><a href="ch-13.html#cb1078-3" aria-hidden="true" tabindex="-1"></a>tokenize_data <span class="ot">=</span> <span class="cf">function</span>(data){</span>
<span id="cb1078-4"><a href="ch-13.html#cb1078-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1078-5"><a href="ch-13.html#cb1078-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#tokenize tower</span></span>
<span id="cb1078-6"><a href="ch-13.html#cb1078-6" aria-hidden="true" tabindex="-1"></a>  tower_token <span class="ot">=</span> <span class="fu">rep</span>(<span class="cn">NA</span>,<span class="fu">length</span>(data<span class="sc">$</span>tower))</span>
<span id="cb1078-7"><a href="ch-13.html#cb1078-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1078-8"><a href="ch-13.html#cb1078-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> ( i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">unique</span>(data<span class="sc">$</span>tower))){</span>
<span id="cb1078-9"><a href="ch-13.html#cb1078-9" aria-hidden="true" tabindex="-1"></a>    ind_tow<span class="ot">=</span> <span class="fu">which</span>(data<span class="sc">$</span>tower<span class="sc">==</span><span class="fu">unique</span>(data<span class="sc">$</span>tower)[i])</span>
<span id="cb1078-10"><a href="ch-13.html#cb1078-10" aria-hidden="true" tabindex="-1"></a>    tower_token[ind_tow]<span class="ot">=</span>i<span class="dv">-1</span></span>
<span id="cb1078-11"><a href="ch-13.html#cb1078-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1078-12"><a href="ch-13.html#cb1078-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1078-13"><a href="ch-13.html#cb1078-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">#tokenize month</span></span>
<span id="cb1078-14"><a href="ch-13.html#cb1078-14" aria-hidden="true" tabindex="-1"></a>  month_token <span class="ot">=</span> data<span class="sc">$</span>month <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb1078-15"><a href="ch-13.html#cb1078-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1078-16"><a href="ch-13.html#cb1078-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (<span class="fu">as.matrix</span>(<span class="fu">data.frame</span>(<span class="at">tower_token =</span> tower_token,<span class="at">month_token =</span> month_token)))</span>
<span id="cb1078-17"><a href="ch-13.html#cb1078-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1078-18"><a href="ch-13.html#cb1078-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1078-19"><a href="ch-13.html#cb1078-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1078-20"><a href="ch-13.html#cb1078-20" aria-hidden="true" tabindex="-1"></a><span class="co"># take tokens of tower , year , month</span></span>
<span id="cb1078-21"><a href="ch-13.html#cb1078-21" aria-hidden="true" tabindex="-1"></a>train_tokens <span class="ot">=</span> <span class="fu">tokenize_data</span>(train)</span>
<span id="cb1078-22"><a href="ch-13.html#cb1078-22" aria-hidden="true" tabindex="-1"></a>val_tokens <span class="ot">=</span> <span class="fu">tokenize_data</span>(val)</span>
<span id="cb1078-23"><a href="ch-13.html#cb1078-23" aria-hidden="true" tabindex="-1"></a>test_tokens <span class="ot">=</span> <span class="fu">tokenize_data</span>(test)</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Train the model</li>
</ol>
<div class="sourceCode" id="cb1079"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1079-1"><a href="ch-13.html#cb1079-1" aria-hidden="true" tabindex="-1"></a><span class="co"># optimizer</span></span>
<span id="cb1079-2"><a href="ch-13.html#cb1079-2" aria-hidden="true" tabindex="-1"></a>opt<span class="ot">=</span><span class="fu">optimizer_adam</span>(<span class="at">lr=</span><span class="fl">0.01</span>) </span>
<span id="cb1079-3"><a href="ch-13.html#cb1079-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1079-4"><a href="ch-13.html#cb1079-4" aria-hidden="true" tabindex="-1"></a><span class="co">#file path for mixed</span></span>
<span id="cb1079-5"><a href="ch-13.html#cb1079-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="st">&#39;saved_models&#39;</span>)</span>
<span id="cb1079-6"><a href="ch-13.html#cb1079-6" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="fu">file.path</span>(<span class="st">&#39;saved_models&#39;</span>,<span class="st">&#39;Mixed&#39;</span>))</span>
<span id="cb1079-7"><a href="ch-13.html#cb1079-7" aria-hidden="true" tabindex="-1"></a>save_path_mixed <span class="ot">=</span> <span class="fu">file.path</span>(<span class="st">&#39;saved_models&#39;</span>,<span class="st">&#39;Mixed&#39;</span>)</span>
<span id="cb1079-8"><a href="ch-13.html#cb1079-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1079-9"><a href="ch-13.html#cb1079-9" aria-hidden="true" tabindex="-1"></a><span class="co"># callback for mixed</span></span>
<span id="cb1079-10"><a href="ch-13.html#cb1079-10" aria-hidden="true" tabindex="-1"></a>callbacks_mixed <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb1079-11"><a href="ch-13.html#cb1079-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">callback_model_checkpoint</span>(<span class="fu">file.path</span>(save_path_mixed,<span class="st">&quot;model_mixed.h5&quot;</span>),<span class="at">monitor=</span><span class="st">&#39;val_loss&#39;</span>,<span class="at">save_best_only =</span> T,<span class="at">mode =</span> <span class="st">&#39;min&#39;</span>),</span>
<span id="cb1079-12"><a href="ch-13.html#cb1079-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">callback_reduce_lr_on_plateau</span>(<span class="at">monitor =</span> <span class="st">&quot;val_loss&quot;</span>,<span class="at">patience =</span> <span class="dv">5</span> ,<span class="at">factor =</span> <span class="fl">0.1</span>),</span>
<span id="cb1079-13"><a href="ch-13.html#cb1079-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">callback_early_stopping</span>(<span class="at">monitor=</span><span class="st">&#39;val_loss&#39;</span>,<span class="at">patience =</span> <span class="dv">10</span>,<span class="at">mode =</span> <span class="st">&#39;min&#39;</span>)</span>
<span id="cb1079-14"><a href="ch-13.html#cb1079-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1079-15"><a href="ch-13.html#cb1079-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1079-16"><a href="ch-13.html#cb1079-16" aria-hidden="true" tabindex="-1"></a><span class="co">#compile</span></span>
<span id="cb1079-17"><a href="ch-13.html#cb1079-17" aria-hidden="true" tabindex="-1"></a><span class="fu">compile</span>(model,<span class="at">loss =</span> <span class="st">&#39;mse&#39;</span>,<span class="at">optimizer =</span> opt,<span class="at">metrics=</span><span class="fu">list</span>(<span class="st">&#39;mse&#39;</span>))</span>
<span id="cb1079-18"><a href="ch-13.html#cb1079-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1079-19"><a href="ch-13.html#cb1079-19" aria-hidden="true" tabindex="-1"></a><span class="co"># train the model</span></span>
<span id="cb1079-20"><a href="ch-13.html#cb1079-20" aria-hidden="true" tabindex="-1"></a>history_mixed <span class="ot">=</span> <span class="fu">fit</span>(model,<span class="at">x =</span> <span class="fu">list</span>(ndvi_train_pr,train_tokens),<span class="at">y =</span> y_train,<span class="at">batch_size =</span> <span class="dv">128</span>,</span>
<span id="cb1079-21"><a href="ch-13.html#cb1079-21" aria-hidden="true" tabindex="-1"></a>              <span class="at">epochs =</span> <span class="dv">200</span>,<span class="at">shuffle =</span> T,<span class="at">validation_data =</span> <span class="fu">list</span>(<span class="fu">list</span>(ndvi_val_pr,val_tokens),y_val),</span>
<span id="cb1079-22"><a href="ch-13.html#cb1079-22" aria-hidden="true" tabindex="-1"></a>             <span class="at">callbacks =</span> callbacks_mixed)</span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Plot the training history</li>
</ol>
<div class="sourceCode" id="cb1080"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1080-1"><a href="ch-13.html#cb1080-1" aria-hidden="true" tabindex="-1"></a><span class="co">#plot mixed history</span></span>
<span id="cb1080-2"><a href="ch-13.html#cb1080-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history_mixed)</span></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>Load the trained model and evaluate performance on the validation and test set</li>
</ol>
<div class="sourceCode" id="cb1081"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1081-1"><a href="ch-13.html#cb1081-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define mse</span></span>
<span id="cb1081-2"><a href="ch-13.html#cb1081-2" aria-hidden="true" tabindex="-1"></a>mse <span class="ot">=</span> <span class="cf">function</span>(model,x,y){</span>
<span id="cb1081-3"><a href="ch-13.html#cb1081-3" aria-hidden="true" tabindex="-1"></a>  pr <span class="ot">=</span> <span class="fu">predict</span>(model,x)</span>
<span id="cb1081-4"><a href="ch-13.html#cb1081-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (<span class="fu">round</span>(<span class="fu">mean</span>((pr<span class="sc">-</span>y)<span class="sc">^</span><span class="dv">2</span>),<span class="dv">2</span>))</span>
<span id="cb1081-5"><a href="ch-13.html#cb1081-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1081-6"><a href="ch-13.html#cb1081-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1081-7"><a href="ch-13.html#cb1081-7" aria-hidden="true" tabindex="-1"></a><span class="co">#load models</span></span>
<span id="cb1081-8"><a href="ch-13.html#cb1081-8" aria-hidden="true" tabindex="-1"></a>model_mixed <span class="ot">=</span> <span class="fu">load_model_hdf5</span>(<span class="fu">file.path</span>(save_path_mixed,<span class="st">&quot;model_mixed.h5&quot;</span>))</span>
<span id="cb1081-9"><a href="ch-13.html#cb1081-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1081-10"><a href="ch-13.html#cb1081-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Validation Mse</span></span>
<span id="cb1081-11"><a href="ch-13.html#cb1081-11" aria-hidden="true" tabindex="-1"></a>mixed_val_mse <span class="ot">=</span> <span class="fu">mse</span>(model_mixed,<span class="fu">list</span>(ndvi_val_pr,val_tokens),y_val)</span>
<span id="cb1081-12"><a href="ch-13.html#cb1081-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1081-13"><a href="ch-13.html#cb1081-13" aria-hidden="true" tabindex="-1"></a><span class="co">#test mse</span></span>
<span id="cb1081-14"><a href="ch-13.html#cb1081-14" aria-hidden="true" tabindex="-1"></a>mixed_test_mse <span class="ot">=</span> <span class="fu">mse</span>(model_mixed,<span class="fu">list</span>(ndvi_test_pr,test_tokens),y_test)</span>
<span id="cb1081-15"><a href="ch-13.html#cb1081-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1081-16"><a href="ch-13.html#cb1081-16" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1081-17"><a href="ch-13.html#cb1081-17" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&#39;Validation MSE: &#39;</span>,mixed_val_mse,<span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)</span>
<span id="cb1081-18"><a href="ch-13.html#cb1081-18" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&#39;Test MSE: &#39;</span>,mixed_test_mse,<span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)</span></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="ch-12.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
