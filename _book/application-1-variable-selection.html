<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 9 Application 1: Variable selection | Environmental Systems Data Science</title>
  <meta name="description" content="Text book and exercises. ETH Zürich" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 9 Application 1: Variable selection | Environmental Systems Data Science" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Text book and exercises. ETH Zürich" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 9 Application 1: Variable selection | Environmental Systems Data Science" />
  
  <meta name="twitter:description" content="Text book and exercises. ETH Zürich" />
  

<meta name="author" content="Loïc Pellissier, Joshua Payne, Benjamin Stocker" />


<meta name="date" content="2021-02-02" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="supervised-machine-learning-methods-ii.html"/>
<link rel="next" href="xxx.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0/anchor-sections.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Environmental Systems Data Science</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Prerequisites</a></li>
<li class="chapter" data-level="2" data-path="primers.html"><a href="primers.html"><i class="fa fa-check"></i><b>2</b> Primers</a></li>
<li class="chapter" data-level="3" data-path="data-wrangling.html"><a href="data-wrangling.html"><i class="fa fa-check"></i><b>3</b> Data wrangling</a></li>
<li class="chapter" data-level="4" data-path="data-variety.html"><a href="data-variety.html"><i class="fa fa-check"></i><b>4</b> Data variety</a><ul>
<li class="chapter" data-level="4.1" data-path="data-variety.html"><a href="data-variety.html#introduction"><i class="fa fa-check"></i><b>4.1</b> Introduction</a><ul>
<li class="chapter" data-level="4.1.1" data-path="data-variety.html"><a href="data-variety.html#overview"><i class="fa fa-check"></i><b>4.1.1</b> Overview</a></li>
<li class="chapter" data-level="4.1.2" data-path="data-variety.html"><a href="data-variety.html#learning-objectives"><i class="fa fa-check"></i><b>4.1.2</b> Learning objectives</a></li>
<li class="chapter" data-level="4.1.3" data-path="data-variety.html"><a href="data-variety.html#key-points-of-the-lecture"><i class="fa fa-check"></i><b>4.1.3</b> Key points of the lecture</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="data-variety.html"><a href="data-variety.html#tutorial"><i class="fa fa-check"></i><b>4.2</b> Tutorial</a><ul>
<li class="chapter" data-level="4.2.1" data-path="data-variety.html"><a href="data-variety.html#overview-1"><i class="fa fa-check"></i><b>4.2.1</b> Overview</a></li>
<li class="chapter" data-level="4.2.2" data-path="data-variety.html"><a href="data-variety.html#modis-remote-download"><i class="fa fa-check"></i><b>4.2.2</b> MODIS remote download</a></li>
<li class="chapter" data-level="4.2.3" data-path="data-variety.html"><a href="data-variety.html#points-on-the-globe"><i class="fa fa-check"></i><b>4.2.3</b> Points on the globe</a></li>
<li class="chapter" data-level="4.2.4" data-path="data-variety.html"><a href="data-variety.html#shapefiles"><i class="fa fa-check"></i><b>4.2.4</b> Shapefiles</a></li>
<li class="chapter" data-level="4.2.5" data-path="data-variety.html"><a href="data-variety.html#rasters"><i class="fa fa-check"></i><b>4.2.5</b> Rasters</a></li>
<li class="chapter" data-level="4.2.6" data-path="data-variety.html"><a href="data-variety.html#key-points-of-the-tutorial"><i class="fa fa-check"></i><b>4.2.6</b> Key points of the tutorial</a></li>
<li class="chapter" data-level="4.2.7" data-path="data-variety.html"><a href="data-variety.html#bonus-species-occurrence-trait-data-and-pcas"><i class="fa fa-check"></i><b>4.2.7</b> Bonus: Species Occurrence, Trait Data and PCAs</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="data-scraping.html"><a href="data-scraping.html"><i class="fa fa-check"></i><b>5</b> Data Scraping</a><ul>
<li class="chapter" data-level="5.1" data-path="data-scraping.html"><a href="data-scraping.html#introduction-1"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="data-scraping.html"><a href="data-scraping.html#theory"><i class="fa fa-check"></i><b>5.2</b> Theory</a></li>
<li class="chapter" data-level="5.3" data-path="data-scraping.html"><a href="data-scraping.html#web-scraping-applied"><i class="fa fa-check"></i><b>5.3</b> Web Scraping Applied</a><ul>
<li class="chapter" data-level="5.3.1" data-path="data-scraping.html"><a href="data-scraping.html#r-packages-and-functions"><i class="fa fa-check"></i><b>5.3.1</b> R-Packages and Functions</a></li>
<li class="chapter" data-level="5.3.2" data-path="data-scraping.html"><a href="data-scraping.html#the-fishbase-website"><i class="fa fa-check"></i><b>5.3.2</b> The FishBase website</a></li>
<li class="chapter" data-level="5.3.3" data-path="data-scraping.html"><a href="data-scraping.html#scraping-numbers"><i class="fa fa-check"></i><b>5.3.3</b> Scraping Numbers</a></li>
<li class="chapter" data-level="5.3.4" data-path="data-scraping.html"><a href="data-scraping.html#scraping-text-snippetrs"><i class="fa fa-check"></i><b>5.3.4</b> Scraping Text Snippetrs</a></li>
<li class="chapter" data-level="5.3.5" data-path="data-scraping.html"><a href="data-scraping.html#scraping-tables"><i class="fa fa-check"></i><b>5.3.5</b> Scraping Tables</a></li>
<li class="chapter" data-level="5.3.6" data-path="data-scraping.html"><a href="data-scraping.html#the-fishbase-package"><i class="fa fa-check"></i><b>5.3.6</b> The Fishbase Package</a></li>
<li class="chapter" data-level="5.3.7" data-path="data-scraping.html"><a href="data-scraping.html#summary"><i class="fa fa-check"></i><b>5.3.7</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="data-scraping.html"><a href="data-scraping.html#case-study-species-richness-and-red-list-species-proportions"><i class="fa fa-check"></i><b>5.4</b> Case Study: Species Richness and Red List species proportions</a><ul>
<li class="chapter" data-level="5.4.1" data-path="data-scraping.html"><a href="data-scraping.html#creating-list-of-species"><i class="fa fa-check"></i><b>5.4.1</b> Creating List of Species</a></li>
<li class="chapter" data-level="5.4.2" data-path="data-scraping.html"><a href="data-scraping.html#extracting-iucn-status-for-all-species"><i class="fa fa-check"></i><b>5.4.2</b> Extracting IUCN Status for all species</a></li>
<li class="chapter" data-level="5.4.3" data-path="data-scraping.html"><a href="data-scraping.html#proportion-of-species-in-netherlands"><i class="fa fa-check"></i><b>5.4.3</b> Proportion of species in Netherlands</a></li>
<li class="chapter" data-level="5.4.4" data-path="data-scraping.html"><a href="data-scraping.html#maps-of-species-richness-and-red-list-species-proportions"><i class="fa fa-check"></i><b>5.4.4</b> Maps of species richness and Red List species proportions</a></li>
<li class="chapter" data-level="5.4.5" data-path="data-scraping.html"><a href="data-scraping.html#relation-of-basin-size-and-species-richness"><i class="fa fa-check"></i><b>5.4.5</b> Relation of basin size and species richness</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="data-scraping.html"><a href="data-scraping.html#references"><i class="fa fa-check"></i><b>5.5</b> References</a></li>
<li class="chapter" data-level="5.6" data-path="data-scraping.html"><a href="data-scraping.html#exercise"><i class="fa fa-check"></i><b>5.6</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="catch-up.html"><a href="catch-up.html"><i class="fa fa-check"></i><b>6</b> Catch-up</a></li>
<li class="chapter" data-level="7" data-path="supervised-machine-learning-basics-i.html"><a href="supervised-machine-learning-basics-i.html"><i class="fa fa-check"></i><b>7</b> Supervised machine learning basics I</a><ul>
<li class="chapter" data-level="7.1" data-path="supervised-machine-learning-basics-i.html"><a href="supervised-machine-learning-basics-i.html#introduction-2"><i class="fa fa-check"></i><b>7.1</b> Introduction</a><ul>
<li class="chapter" data-level="7.1.1" data-path="supervised-machine-learning-basics-i.html"><a href="supervised-machine-learning-basics-i.html#learning-objectives-1"><i class="fa fa-check"></i><b>7.1.1</b> Learning objectives</a></li>
<li class="chapter" data-level="7.1.2" data-path="supervised-machine-learning-basics-i.html"><a href="supervised-machine-learning-basics-i.html#important-points-from-the-lecture"><i class="fa fa-check"></i><b>7.1.2</b> Important points from the lecture</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="supervised-machine-learning-basics-i.html"><a href="supervised-machine-learning-basics-i.html#tutorial-1"><i class="fa fa-check"></i><b>7.2</b> Tutorial</a><ul>
<li class="chapter" data-level="7.2.1" data-path="supervised-machine-learning-basics-i.html"><a href="supervised-machine-learning-basics-i.html#linear-regression"><i class="fa fa-check"></i><b>7.2.1</b> Linear regression</a></li>
<li class="chapter" data-level="7.2.2" data-path="supervised-machine-learning-basics-i.html"><a href="supervised-machine-learning-basics-i.html#k-nearest-neighbours"><i class="fa fa-check"></i><b>7.2.2</b> K-nearest neighbours</a></li>
<li class="chapter" data-level="7.2.3" data-path="supervised-machine-learning-basics-i.html"><a href="supervised-machine-learning-basics-i.html#essential-methods-for-the-modelling-process"><i class="fa fa-check"></i><b>7.2.3</b> Essential methods for the modelling process</a></li>
<li class="chapter" data-level="7.2.4" data-path="supervised-machine-learning-basics-i.html"><a href="supervised-machine-learning-basics-i.html#bonus"><i class="fa fa-check"></i><b>7.2.4</b> Bonus</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="supervised-machine-learning-methods-ii.html"><a href="supervised-machine-learning-methods-ii.html"><i class="fa fa-check"></i><b>8</b> Supervised machine learning methods II</a></li>
<li class="chapter" data-level="9" data-path="application-1-variable-selection.html"><a href="application-1-variable-selection.html"><i class="fa fa-check"></i><b>9</b> Application 1: Variable selection</a><ul>
<li class="chapter" data-level="9.1" data-path="application-1-variable-selection.html"><a href="application-1-variable-selection.html#introduction-3"><i class="fa fa-check"></i><b>9.1</b> Introduction</a></li>
<li class="chapter" data-level="9.2" data-path="application-1-variable-selection.html"><a href="application-1-variable-selection.html#warm-up-1-nested-for-loop"><i class="fa fa-check"></i><b>9.2</b> Warm-up 1: Nested for-loop</a></li>
<li class="chapter" data-level="9.3" data-path="application-1-variable-selection.html"><a href="application-1-variable-selection.html#warm-up-2-find-the-best-single-predictor"><i class="fa fa-check"></i><b>9.3</b> Warm-up 2: Find the best single predictor</a></li>
<li class="chapter" data-level="9.4" data-path="application-1-variable-selection.html"><a href="application-1-variable-selection.html#full-stepwise-regression"><i class="fa fa-check"></i><b>9.4</b> Full stepwise regression</a></li>
<li class="chapter" data-level="9.5" data-path="application-1-variable-selection.html"><a href="application-1-variable-selection.html#bonus-stepwise-regression-out-of-the-box"><i class="fa fa-check"></i><b>9.5</b> Bonus: Stepwise regression out-of-the-box</a></li>
<li class="chapter" data-level="9.6" data-path="application-1-variable-selection.html"><a href="application-1-variable-selection.html#warm-up-2-find-the-best-single-predictor-1"><i class="fa fa-check"></i><b>9.6</b> Warm-up 2: Find the best single predictor</a></li>
<li class="chapter" data-level="9.7" data-path="application-1-variable-selection.html"><a href="application-1-variable-selection.html#full-stepwise-regression-1"><i class="fa fa-check"></i><b>9.7</b> Full stepwise regression</a></li>
<li class="chapter" data-level="9.8" data-path="application-1-variable-selection.html"><a href="application-1-variable-selection.html#bonus-stepwise-regression-out-of-the-box-1"><i class="fa fa-check"></i><b>9.8</b> <span>BONUS</span> Stepwise regression out-of-the-box</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="xxx.html"><a href="xxx.html"><i class="fa fa-check"></i><b>10</b> XXX</a></li>
<li class="chapter" data-level="11" data-path="xxx-1.html"><a href="xxx-1.html"><i class="fa fa-check"></i><b>11</b> XXX</a></li>
<li class="chapter" data-level="12" data-path="xxx-2.html"><a href="xxx-2.html"><i class="fa fa-check"></i><b>12</b> XXX</a></li>
<li class="chapter" data-level="13" data-path="xxx-3.html"><a href="xxx-3.html"><i class="fa fa-check"></i><b>13</b> XXX</a></li>
<li class="chapter" data-level="14" data-path="xxx-4.html"><a href="xxx-4.html"><i class="fa fa-check"></i><b>14</b> XXX</a></li>
<li class="chapter" data-level="15" data-path="xxx-5.html"><a href="xxx-5.html"><i class="fa fa-check"></i><b>15</b> XXX</a></li>
<li class="chapter" data-level="" data-path="references-1.html"><a href="references-1.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Environmental Systems Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="application-1-variable-selection" class="section level1">
<h1><span class="header-section-number">Chapter 9</span> Application 1: Variable selection</h1>
<div id="introduction-3" class="section level2">
<h2><span class="header-section-number">9.1</span> Introduction</h2>
<p>In Chapter 7, we noted that the coefficient of determination <span class="math inline">\(R^2\)</span> may increase even when uninformative predictors are added to a model. This will ascribe some predictive power to an uninformative predictor that is in fact misguided by its (random) correlation with the target variable. Often, we start out formulating models, not knowing beforehand what predictors should be considered and we are tempted to use them all because the full model will always yield the best <span class="math inline">\(R^2\)</span>. In such cases, we’re prone to building overconfident models that perform well on the training set, but will not perform well when predicting to new data.</p>
<p>In this application session, we’ll implement an algorithm that sequentially searches the best additional predictor to be included in our model, starting from a single one. This is called <em>stepwise-forward</em> regression (see definition below). There is also <em>stepwise-backward</em> regression where predictors are sequentially removed from a model that includes them all. The challenge is that we often lack the possibility to confidently assess generalisability. The effect of spuriously increasing <span class="math inline">\(R^2\)</span> by adding uninformative predictors can be mitigated, as we noted in Chapter 7, by considering alternative metrics that penalize the number of predictors in a model. They balance the tradeoff between model complexity (number of variables in the linear regression case) and goodness of fit. Such metrics include the <em>adjusted-</em><span class="math inline">\(R^2\)</span>,the Akaike Information Criterion (AIC), or the Bayesian Information Criterion (BIC). In cases, where sufficient data is available, also cross-validation can be used for assessing the generalisability of alternative models. Here, we’ll assess how these different metrics behave for a sequence of linear regression models with an increasing number of predictors. You’ll learn to write code that implements an algorithm determining the order in which variables enter the model, starting from one and going up to fourteen predictors. You’ll write your own stepwise-forward regression code.</p>
<p>Let’s get started…</p>
<hr />
<p><strong>Forward stepwise regression</strong></p>
<ol style="list-style-type: decimal">
<li><p>Let <span class="math inline">\(\mathcal{M_0}\)</span> denote the null model, which contains no predictors.</p></li>
<li><p>For <span class="math inline">\(k=0,..,p-1\)</span>:</p>
<ol style="list-style-type: lower-alpha">
<li><p>Consider all <span class="math inline">\(p − k\)</span> models that augment <span class="math inline">\(\mathcal{M}_k\)</span> with one additional predictor.</p></li>
<li><p>Choose the best model among these <span class="math inline">\(p − k\)</span> models, and call it <span class="math inline">\(\mathcal{M}_{k+1}\)</span>. Here <em>best</em> is defined as having the highest <span class="math inline">\(R^2\)</span> .</p></li>
</ol></li>
<li><p>Select a single best model from among <span class="math inline">\(\mathcal{M}_0\)</span>, . . . , <span class="math inline">\(\mathcal{M}_p\)</span> using cross-validated prediction error, AIC, BIC, or adjusted <span class="math inline">\(R^2\)</span>.</p></li>
</ol>
<hr />
</div>
<div id="warm-up-1-nested-for-loop" class="section level2">
<h2><span class="header-section-number">9.2</span> Warm-up 1: Nested for-loop</h2>
<p>Given a matrix A and a vector B (see below), do the following tasks:</p>
<ul>
<li><p>Replace the missing values (<code>NA</code>) in the first row of A by the largest value of B. After using that element of B for imputing A, drop that element from the vector B and proceed with imputing the second row of A, using the (now) largest value of the updated vector B, and drop that element from B after using it for imputing A. Repeat the same procedure for all four rows in A.</p></li>
<li><p>After imputing (replacing) in each step, calculate the mean of the remaining values in B and record it as a single-row data frame with two columns <code>row_number</code> and <code>avg</code>, where <code>row_number</code> is the row number of A where the value was imputed, and <code>avg</code> is the mean of remaining values in B. As the algorithm proceeds through rows in A, sequentially bind the single-row data frame together so that after completion of the algorithm, the data frame contains four rows (corresponding to the number of rows in A).</p></li>
</ul>
<div class="sourceCode" id="cb332"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb332-1"><a href="application-1-variable-selection.html#cb332-1"></a>A &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">3</span>, <span class="ot">NA</span>, <span class="dv">15</span>, <span class="dv">6</span>, <span class="dv">7</span>, </span>
<span id="cb332-2"><a href="application-1-variable-selection.html#cb332-2"></a>              <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">12</span>, <span class="dv">6</span>, <span class="dv">11</span>, <span class="ot">NA</span>, <span class="dv">3</span>, </span>
<span id="cb332-3"><a href="application-1-variable-selection.html#cb332-3"></a>              <span class="dv">9</span>, <span class="dv">4</span>, <span class="dv">7</span>, <span class="dv">3</span>, <span class="dv">21</span>, <span class="ot">NA</span>, <span class="dv">6</span>, </span>
<span id="cb332-4"><a href="application-1-variable-selection.html#cb332-4"></a>              <span class="dv">7</span>, <span class="dv">19</span>, <span class="dv">6</span>, <span class="ot">NA</span>, <span class="dv">15</span>, <span class="dv">8</span>, <span class="dv">10</span>),</span>
<span id="cb332-5"><a href="application-1-variable-selection.html#cb332-5"></a>            <span class="dt">nrow =</span> <span class="dv">4</span>, <span class="dt">byrow =</span> <span class="ot">TRUE</span>)</span>
<span id="cb332-6"><a href="application-1-variable-selection.html#cb332-6"></a>B &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">8</span>, <span class="dv">4</span>, <span class="dv">12</span>, <span class="dv">9</span>, <span class="dv">15</span>, <span class="dv">6</span>)</span></code></pre></div>
<p>Before implementing these tasks, try to write down a pseudo code. This is code-like text that may not be executable, but describes the structure of real code and details where and how major steps are implemented. Next, you’ll need to write actual R code. For this, you will need to find answers to the following questions:</p>
<ul>
<li>How to go through each of the element in matrix?</li>
<li>How to detect NA value?</li>
<li>How to drop an element of a given value from a vector?</li>
<li>How to add a row to an existing data frame?</li>
</ul>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb333"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb333-1"><a href="application-1-variable-selection.html#cb333-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb333-2"><a href="application-1-variable-selection.html#cb333-2"></a></span>
<span id="cb333-3"><a href="application-1-variable-selection.html#cb333-3"></a>summ &lt;-<span class="st"> </span><span class="kw">data.frame</span>()</span>
<span id="cb333-4"><a href="application-1-variable-selection.html#cb333-4"></a></span>
<span id="cb333-5"><a href="application-1-variable-selection.html#cb333-5"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(A)){</span>
<span id="cb333-6"><a href="application-1-variable-selection.html#cb333-6"></a>  </span>
<span id="cb333-7"><a href="application-1-variable-selection.html#cb333-7"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(A)){</span>
<span id="cb333-8"><a href="application-1-variable-selection.html#cb333-8"></a>    </span>
<span id="cb333-9"><a href="application-1-variable-selection.html#cb333-9"></a>    <span class="cf">if</span> (<span class="kw">is.na</span>(A[i,j])){</span>
<span id="cb333-10"><a href="application-1-variable-selection.html#cb333-10"></a>      A[i,j] &lt;-<span class="st"> </span><span class="kw">max</span>(B)</span>
<span id="cb333-11"><a href="application-1-variable-selection.html#cb333-11"></a>    }</span>
<span id="cb333-12"><a href="application-1-variable-selection.html#cb333-12"></a>  }</span>
<span id="cb333-13"><a href="application-1-variable-selection.html#cb333-13"></a>  </span>
<span id="cb333-14"><a href="application-1-variable-selection.html#cb333-14"></a></span>
<span id="cb333-15"><a href="application-1-variable-selection.html#cb333-15"></a>  B &lt;-<span class="st"> </span>B[<span class="op">-</span><span class="kw">which</span>(B <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(B))] <span class="co"># update the B vector removing the biggest values</span></span>
<span id="cb333-16"><a href="application-1-variable-selection.html#cb333-16"></a>}</span>
<span id="cb333-17"><a href="application-1-variable-selection.html#cb333-17"></a></span>
<span id="cb333-18"><a href="application-1-variable-selection.html#cb333-18"></a>  summ &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(summ, <span class="kw">data.frame</span>(<span class="dt">row_number =</span> i, <span class="dt">avg =</span> <span class="kw">mean</span>(B)))</span>
<span id="cb333-19"><a href="application-1-variable-selection.html#cb333-19"></a>  </span>
<span id="cb333-20"><a href="application-1-variable-selection.html#cb333-20"></a>summ</span></code></pre></div>
<pre><code>##   row_number avg
## 1          4   5</code></pre>
</div>
<div id="warm-up-2-find-the-best-single-predictor" class="section level2">
<h2><span class="header-section-number">9.3</span> Warm-up 2: Find the best single predictor</h2>
<p>The first step of a stepwise forward regression is to find the single most powerful predictor in a univariate linear regression model for the target variable <code>GPP_NT_VUT_REF</code> among all fourteen available predictors in our data set (all except those of type <code>date</code> or <code>character</code>). Implement this first part of the search, using the definition of the stepwise-forward algorithm above. Remove all rows with at least one missing value before starting the predictor search.</p>
<ul>
<li>Which predictor achieves the highest <span class="math inline">\(R^2\)</span>?</li>
<li>What value is the <span class="math inline">\(R^2\)</span>?</li>
<li>Visualise <span class="math inline">\(R^2\)</span> for all univariate models, ordered by their respective <span class="math inline">\(R^2\)</span> values.</li>
<li>Do you note a particular pattern? Which variables yield similar <span class="math inline">\(R^2\)</span>? How do you expect them to be included in multivariate models of the subsequent steps in the stepwise forward regression?</li>
</ul>
<p><em>Hints</em>:</p>
<ul>
<li><p>Model structure:</p>
<ul>
<li>The “counter” variables in the for loop can be provided as a vector, and the counter will sequentially take on the value of each element in that vector. For example: <code>for (var in all_predictors){ ... }</code>.</li>
</ul></li>
<li><p>Algorithm:</p>
<ul>
<li><p>To record <span class="math inline">\(R^2\)</span> values for the different models, you may start by creating an empty vector (<code>vec &lt;- c()</code>) before the loop and then sequentially add elements to that vector inside the loop (<code>vec &lt;- c(vec, new_element)</code>). Alternatively, you can do something similar, but with a data frame (initialising with <code>df_rsq &lt;- data.frame()</code> before the loop, and adding rows by <code>df_rsq &lt;- bind_rows(df_rsq, data.frame(pred = predictor_name, rsq = rsq_result))</code> inside the loop).</p></li>
<li><p>A clever way how to construct formulas dynamically is described, for example in <a href="https://stackoverflow.com/questions/4951442/formula-with-dynamic-number-of-variables">this stackoverflow post</a>.</p></li>
</ul></li>
<li><p>Value retrieving:</p>
<ul>
<li>Extract the <span class="math inline">\(R^2\)</span> from the linear model object: <code>summary(fit_lin)[["r.squared"]]</code></li>
</ul></li>
<li><p>Visualising:</p>
<ul>
<li>Search for solutions for how to change the order of levels to be plotted yourself.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb335"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb335-1"><a href="application-1-variable-selection.html#cb335-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb335-2"><a href="application-1-variable-selection.html#cb335-2"></a><span class="co">## read CSV and drop missing values in one step</span></span>
<span id="cb335-3"><a href="application-1-variable-selection.html#cb335-3"></a>df &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;./data/ddf_for_08_application.csv&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb335-4"><a href="application-1-variable-selection.html#cb335-4"></a><span class="st">  </span><span class="kw">drop_na</span>()</span>
<span id="cb335-5"><a href="application-1-variable-selection.html#cb335-5"></a></span>
<span id="cb335-6"><a href="application-1-variable-selection.html#cb335-6"></a><span class="co">## specify target variable</span></span>
<span id="cb335-7"><a href="application-1-variable-selection.html#cb335-7"></a>target &lt;-<span class="st"> &#39;GPP_NT_VUT_REF&#39;</span></span>
<span id="cb335-8"><a href="application-1-variable-selection.html#cb335-8"></a></span>
<span id="cb335-9"><a href="application-1-variable-selection.html#cb335-9"></a><span class="co">## determine predictors as all except site ID, timestamp, and the target (should be 14)</span></span>
<span id="cb335-10"><a href="application-1-variable-selection.html#cb335-10"></a>preds &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb335-11"><a href="application-1-variable-selection.html#cb335-11"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span>siteid, <span class="op">-</span>TIMESTAMP, <span class="op">-</span>GPP_NT_VUT_REF) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb335-12"><a href="application-1-variable-selection.html#cb335-12"></a><span class="st">  </span><span class="kw">names</span>()</span>
<span id="cb335-13"><a href="application-1-variable-selection.html#cb335-13"></a></span>
<span id="cb335-14"><a href="application-1-variable-selection.html#cb335-14"></a><span class="co">## initialise an empty data frame (necessary, because otherwise we cannot use bind_rows() below)</span></span>
<span id="cb335-15"><a href="application-1-variable-selection.html#cb335-15"></a>df_rsq &lt;-<span class="st"> </span><span class="kw">data.frame</span>()</span>
<span id="cb335-16"><a href="application-1-variable-selection.html#cb335-16"></a><span class="co"># rsq_list &lt;- c()  # alternative for vector</span></span>
<span id="cb335-17"><a href="application-1-variable-selection.html#cb335-17"></a></span>
<span id="cb335-18"><a href="application-1-variable-selection.html#cb335-18"></a><span class="cf">for</span> (var <span class="cf">in</span> preds){</span>
<span id="cb335-19"><a href="application-1-variable-selection.html#cb335-19"></a>  </span>
<span id="cb335-20"><a href="application-1-variable-selection.html#cb335-20"></a>  <span class="co">## create formula dynamically</span></span>
<span id="cb335-21"><a href="application-1-variable-selection.html#cb335-21"></a>  forml &lt;-<span class="st"> </span><span class="kw">as.formula</span>(<span class="kw">paste</span>(target, <span class="st">&quot;~&quot;</span>, var))</span>
<span id="cb335-22"><a href="application-1-variable-selection.html#cb335-22"></a>  </span>
<span id="cb335-23"><a href="application-1-variable-selection.html#cb335-23"></a>  <span class="co">## fit linear model</span></span>
<span id="cb335-24"><a href="application-1-variable-selection.html#cb335-24"></a>  fit_lin &lt;-<span class="st"> </span><span class="kw">lm</span>(forml, <span class="dt">data =</span> df)</span>
<span id="cb335-25"><a href="application-1-variable-selection.html#cb335-25"></a>  </span>
<span id="cb335-26"><a href="application-1-variable-selection.html#cb335-26"></a>  <span class="co">## extract R2 from linear model</span></span>
<span id="cb335-27"><a href="application-1-variable-selection.html#cb335-27"></a>  rsq &lt;-<span class="st"> </span><span class="kw">summary</span>(fit_lin)[[<span class="st">&quot;r.squared&quot;</span>]]</span>
<span id="cb335-28"><a href="application-1-variable-selection.html#cb335-28"></a>  </span>
<span id="cb335-29"><a href="application-1-variable-selection.html#cb335-29"></a>  <span class="co">## add a row to the data frame that holds the results</span></span>
<span id="cb335-30"><a href="application-1-variable-selection.html#cb335-30"></a>  df_rsq &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(df_rsq, <span class="kw">data.frame</span>(<span class="dt">pred =</span> var, <span class="dt">rsq =</span> rsq))</span>
<span id="cb335-31"><a href="application-1-variable-selection.html#cb335-31"></a>  </span>
<span id="cb335-32"><a href="application-1-variable-selection.html#cb335-32"></a>  <span class="co"># rsq_list &lt;- c(rsq_list,rsq)  # alternative with vector</span></span>
<span id="cb335-33"><a href="application-1-variable-selection.html#cb335-33"></a>}</span>
<span id="cb335-34"><a href="application-1-variable-selection.html#cb335-34"></a></span>
<span id="cb335-35"><a href="application-1-variable-selection.html#cb335-35"></a><span class="co">## print best single predictor and its R2</span></span>
<span id="cb335-36"><a href="application-1-variable-selection.html#cb335-36"></a>df_rsq <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb335-37"><a href="application-1-variable-selection.html#cb335-37"></a><span class="st">  </span><span class="kw">arrange</span>(<span class="op">-</span>rsq) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># arrange by R2 in descending order (highest R2 on top)</span></span>
<span id="cb335-38"><a href="application-1-variable-selection.html#cb335-38"></a><span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span>)           <span class="co"># print only the first row (with highest R2)</span></span></code></pre></div>
<pre><code>##      pred       rsq
## 1 PPFD_IN 0.5276123</code></pre>
<div class="sourceCode" id="cb337"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb337-1"><a href="application-1-variable-selection.html#cb337-1"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb337-2"><a href="application-1-variable-selection.html#cb337-2"></a></span>
<span id="cb337-3"><a href="application-1-variable-selection.html#cb337-3"></a><span class="co">## alternative: determine the first variable to enter into our model</span></span>
<span id="cb337-4"><a href="application-1-variable-selection.html#cb337-4"></a><span class="co"># preds[which.max(rsq_list)]</span></span>
<span id="cb337-5"><a href="application-1-variable-selection.html#cb337-5"></a></span>
<span id="cb337-6"><a href="application-1-variable-selection.html#cb337-6"></a><span class="co">## use the data frame that holds the results for plotting</span></span>
<span id="cb337-7"><a href="application-1-variable-selection.html#cb337-7"></a>df_rsq <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb337-8"><a href="application-1-variable-selection.html#cb337-8"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">reorder</span>(pred, rsq), <span class="dt">y =</span> rsq)) <span class="op">+</span></span>
<span id="cb337-9"><a href="application-1-variable-selection.html#cb337-9"></a><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb337-10"><a href="application-1-variable-selection.html#cb337-10"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="kw">expression</span>(<span class="kw">italic</span>(R)<span class="op">^</span><span class="dv">2</span>), <span class="dt">x =</span> <span class="st">&quot;Variable&quot;</span>) <span class="op">+</span></span>
<span id="cb337-11"><a href="application-1-variable-selection.html#cb337-11"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-190-1.png" width="672" /></p>
<p><strong>Solution</strong>:</p>
<p><em><code>PPFD_IN</code> achieves the highest <span class="math inline">\(R^2\)</span> value, and the corresponding <span class="math inline">\(R^2\)</span> values is 0.5276123.</em></p>
<p><em>We could see from the above plot that <code>LW_IN_F_MDS</code> and <code>LW_IN_F</code>, <code>VPD_F</code> and <code>VPD_F_MDS</code>, <code>SW_IN_F</code> and <code>SW_IN_F_MDS</code> share basically the same <span class="math inline">\(R^2\)</span> values. Those variables are highly correlated and are explaining the same amount of variance in the target variable. In the subsequent steps of the stepwise forward regression, since each of the two variables are highly correlated with each other, it’s likely that only one of them will be selected into our final model.</em></p>
</div>
<div id="full-stepwise-regression" class="section level2">
<h2><span class="header-section-number">9.4</span> Full stepwise regression</h2>
<p>Now, we take it to the next level and implement a full stepwise forward regression as described above. For each step (number of predictors <span class="math inline">\(k\)</span>), record the following metrics: <span class="math inline">\(R^2\)</span>, <em>adjusted-</em><span class="math inline">\(R^2\)</span>, the Akaike Information Criterion (AIC), Bayesian Information Criterion (BIC), and the 5-fold cross-validation <span class="math inline">\(R^2\)</span> and RMSE.</p>
<ul>
<li><p>Write pseudo-code for how you plan to implement the algorithm first.</p></li>
<li><p>Implement the algorithm in R, run it and display the order in which predictors enter the model.</p></li>
<li><p>Display a table with the metrics of all <span class="math inline">\(k\)</span> steps, and the single variable, added at each step.</p></li>
</ul>
<p><em>Hints</em>:</p>
<ul>
<li><p>Model structure:</p>
<ul>
<li>Recall what you learned in the breakout session, you may use the same idea on this task. Try to think of the blueprint (<em>pseudo-code</em>) first: How to go through different models in each forward step? How to store predictors added to the model and how to update candidate predictors?</li>
</ul></li>
<li><p>Algorithm:</p>
<ul>
<li><p>A complication is that the set of predictors is sequentially complemented at each step of the search through <span class="math inline">\(k\)</span>. You may again use <code>vec &lt;- list()</code> to create an empty vector, and then add elements to that vector by <code>vec &lt;- c(vec, new_element)</code>.</p></li>
<li><p>It may be helpful to explicitly define a set of “candidate predictors” that may potentially be added to the model as a vector (e.g., <code>preds_candidate</code>), and define predictors retained in the model from the previous step in a separate vector (e.g., <code>preds_retained</code>). In each step, search through <code>preds_candidate</code>, select the best predictor, add it to <code>preds_retained</code> and remove it from <code>preds_candidate</code>.</p></li>
<li><p>At each step, record the metrics and store them in a data frame for later plots. As in the first “warm-up” exercise, you may record metrics at each step as a single-row data frame and sequentially stack (bind) them together.</p></li>
<li><p>(As above) A clever way how to construct formulas dynamically is described, for example in <a href="https://stackoverflow.com/questions/4951442/formula-with-dynamic-number-of-variables">this stackoverflow post</a>.</p></li>
<li><p>The metrics for the <span class="math inline">\(k\)</span> models are assessed <em>after</em> the order of added variables is determined. To be able to determine the metrics, the <span class="math inline">\(k\)</span> models can be saved by constructing a list of models and sequentially add elements to that list (<code>mylist[[ name_new_element ]] &lt;- new_element</code>). You can also fit the model again after determining which predictor worked best.</p></li>
<li><p>Your code will most certainly have bugs at first. To debug efficiently, write code first in a simple R script and use the debugging options in RStudio (see <a href="https://support.rstudio.com/hc/en-us/articles/205612627-Debugging-with-RStudio">here</a>).</p></li>
</ul></li>
<li><p>Value retriving</p>
<ul>
<li><p>To get AIC and BIC values for a given model, use the base-R functions <code>AIC()</code> and <code>BIC()</code>.</p></li>
<li><p>To get the cross-validated <span class="math inline">\(R^2\)</span> and RMSE, use the caret function <code>train()</code> with RMSE as the loss function, and <code>method = "lm"</code> (to fit a linear regression model). Then extract the values by <code>trained_model$results$Rsquared</code> and <code>trained_model$results$RMSE</code>.</p></li>
</ul></li>
<li><p>Displaying:</p>
<ul>
<li><p>To display a table nicely as part of the RMarkdown html output, use the function <code>knitr::kable()</code></p></li>
<li><p>To avoid reordering of the list of variable names in plotting, change the type of variable names from “character” to “factor” by <code>pred &lt;- factor(pred, levels = pred)</code></p></li>
</ul></li>
</ul>
<!-- - remove element by index number from a vector `vec[-2]` -->
<!-- - concatenate string vectors with certain separations:  `paste(c("predictor_1","predictor_2","predictor_3"),collapse = '+')` gives `"predictor_1 + predictor_2 + predictor_3"` -->
<!-- - fit a linear regression with three predictors: `fit_lin <- lm(target ~ predictor_1 + predictor_2 + predictor_3, data = df)` -->
<!-- - execute a string-like expression: `eval(parse(text = <string>))`, for example: `eval(parse(text='mean(c(2,3,4))'))=3` -->
<!-- - get AIC and BIC from a linear regression model object: `AIC(fit_lin)`, `BIC(fit_lin)` -->
<div class="sourceCode" id="cb338"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb338-1"><a href="application-1-variable-selection.html#cb338-1"></a><span class="kw">library</span>(caret)  <span class="co"># need train() for cross-validation</span></span>
<span id="cb338-2"><a href="application-1-variable-selection.html#cb338-2"></a></span>
<span id="cb338-3"><a href="application-1-variable-selection.html#cb338-3"></a><span class="co">## specify target variable (as above)</span></span>
<span id="cb338-4"><a href="application-1-variable-selection.html#cb338-4"></a>target &lt;-<span class="st"> &#39;GPP_NT_VUT_REF&#39;</span></span>
<span id="cb338-5"><a href="application-1-variable-selection.html#cb338-5"></a></span>
<span id="cb338-6"><a href="application-1-variable-selection.html#cb338-6"></a><span class="co">## determine predictors as all except site ID, timestamp, and the target (should be 14)  (as above)</span></span>
<span id="cb338-7"><a href="application-1-variable-selection.html#cb338-7"></a>preds &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb338-8"><a href="application-1-variable-selection.html#cb338-8"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span>siteid, <span class="op">-</span>TIMESTAMP, <span class="op">-</span>GPP_NT_VUT_REF) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb338-9"><a href="application-1-variable-selection.html#cb338-9"></a><span class="st">  </span><span class="kw">names</span>()</span>
<span id="cb338-10"><a href="application-1-variable-selection.html#cb338-10"></a></span>
<span id="cb338-11"><a href="application-1-variable-selection.html#cb338-11"></a><span class="co"># This is the vector of candidate predictors to be added in the model. To begin with, consider all as candidates.</span></span>
<span id="cb338-12"><a href="application-1-variable-selection.html#cb338-12"></a>preds_candidate &lt;-<span class="st"> </span>preds </span>
<span id="cb338-13"><a href="application-1-variable-selection.html#cb338-13"></a></span>
<span id="cb338-14"><a href="application-1-variable-selection.html#cb338-14"></a><span class="co"># predictors retained in the model from the previous step. To begin with, is empty.</span></span>
<span id="cb338-15"><a href="application-1-variable-selection.html#cb338-15"></a>preds_retained &lt;-<span class="st"> </span><span class="kw">c</span>()</span>
<span id="cb338-16"><a href="application-1-variable-selection.html#cb338-16"></a></span>
<span id="cb338-17"><a href="application-1-variable-selection.html#cb338-17"></a><span class="co">## work with lists as much as possible (more flexible!)</span></span>
<span id="cb338-18"><a href="application-1-variable-selection.html#cb338-18"></a>df_metrics &lt;-<span class="st"> </span><span class="kw">data.frame</span>()</span>
<span id="cb338-19"><a href="application-1-variable-selection.html#cb338-19"></a></span>
<span id="cb338-20"><a href="application-1-variable-selection.html#cb338-20"></a><span class="co">## outer loop for k predictors</span></span>
<span id="cb338-21"><a href="application-1-variable-selection.html#cb338-21"></a><span class="cf">for</span> (k_index <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(preds)){</span>
<span id="cb338-22"><a href="application-1-variable-selection.html#cb338-22"></a>  </span>
<span id="cb338-23"><a href="application-1-variable-selection.html#cb338-23"></a>  <span class="co"># rsq_candidates &lt;- c()</span></span>
<span id="cb338-24"><a href="application-1-variable-selection.html#cb338-24"></a>  df_rsq_candidates &lt;-<span class="st"> </span><span class="kw">data.frame</span>()</span>
<span id="cb338-25"><a href="application-1-variable-selection.html#cb338-25"></a>  linmod_candidates &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb338-26"><a href="application-1-variable-selection.html#cb338-26"></a>  </span>
<span id="cb338-27"><a href="application-1-variable-selection.html#cb338-27"></a>  <span class="co">## inner loop for single additional predictor</span></span>
<span id="cb338-28"><a href="application-1-variable-selection.html#cb338-28"></a>  <span class="cf">for</span> (ipred <span class="cf">in</span> preds_candidate){</span>
<span id="cb338-29"><a href="application-1-variable-selection.html#cb338-29"></a>    </span>
<span id="cb338-30"><a href="application-1-variable-selection.html#cb338-30"></a>    <span class="co"># variable vector (new variable + retained variables) used in regression</span></span>
<span id="cb338-31"><a href="application-1-variable-selection.html#cb338-31"></a>    pred_add &lt;-<span class="st"> </span><span class="kw">c</span>(preds_retained, ipred)</span>
<span id="cb338-32"><a href="application-1-variable-selection.html#cb338-32"></a>    </span>
<span id="cb338-33"><a href="application-1-variable-selection.html#cb338-33"></a>    <span class="co"># define formulate with newly-added predictor</span></span>
<span id="cb338-34"><a href="application-1-variable-selection.html#cb338-34"></a>    forml  &lt;-<span class="st"> </span><span class="kw">as.formula</span>(<span class="kw">paste</span>( target, <span class="st">&#39;~&#39;</span>, <span class="kw">paste</span>(pred_add, <span class="dt">collapse =</span> <span class="st">&#39;+&#39;</span>)))</span>
<span id="cb338-35"><a href="application-1-variable-selection.html#cb338-35"></a>    </span>
<span id="cb338-36"><a href="application-1-variable-selection.html#cb338-36"></a>    <span class="co"># fit linear model</span></span>
<span id="cb338-37"><a href="application-1-variable-selection.html#cb338-37"></a>    fit_lin &lt;-<span class="st"> </span><span class="kw">lm</span>(forml, <span class="dt">data =</span> df)</span>
<span id="cb338-38"><a href="application-1-variable-selection.html#cb338-38"></a>    </span>
<span id="cb338-39"><a href="application-1-variable-selection.html#cb338-39"></a>    <span class="co"># add model object to list, and name the element according to the added variable</span></span>
<span id="cb338-40"><a href="application-1-variable-selection.html#cb338-40"></a>    linmod_candidates[[ ipred ]] &lt;-<span class="st"> </span>fit_lin</span>
<span id="cb338-41"><a href="application-1-variable-selection.html#cb338-41"></a>    </span>
<span id="cb338-42"><a href="application-1-variable-selection.html#cb338-42"></a>    <span class="co"># record metrics for all candidates</span></span>
<span id="cb338-43"><a href="application-1-variable-selection.html#cb338-43"></a>    rsq &lt;-<span class="st"> </span><span class="kw">summary</span>(fit_lin)[[<span class="st">&quot;r.squared&quot;</span>]]</span>
<span id="cb338-44"><a href="application-1-variable-selection.html#cb338-44"></a>    df_rsq_candidates &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(df_rsq_candidates, <span class="kw">data.frame</span>(<span class="dt">pred =</span> ipred, <span class="dt">rsq =</span> rsq))  <span class="co"># when storing R2 in a data frame</span></span>
<span id="cb338-45"><a href="application-1-variable-selection.html#cb338-45"></a>    <span class="co"># rsq_candidates &lt;- c(rsq_candidates,  rsq)  # when storing R2 as a vector</span></span>
<span id="cb338-46"><a href="application-1-variable-selection.html#cb338-46"></a>    </span>
<span id="cb338-47"><a href="application-1-variable-selection.html#cb338-47"></a>  }</span>
<span id="cb338-48"><a href="application-1-variable-selection.html#cb338-48"></a>  </span>
<span id="cb338-49"><a href="application-1-variable-selection.html#cb338-49"></a>  <span class="co">## get name of candidate predictor that achieved the highest R2.</span></span>
<span id="cb338-50"><a href="application-1-variable-selection.html#cb338-50"></a>  pred_add &lt;-<span class="st"> </span>df_rsq_candidates <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># when storing R2 in a data frame</span></span>
<span id="cb338-51"><a href="application-1-variable-selection.html#cb338-51"></a><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(rsq)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb338-52"><a href="application-1-variable-selection.html#cb338-52"></a><span class="st">    </span><span class="kw">slice</span>(<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb338-53"><a href="application-1-variable-selection.html#cb338-53"></a><span class="st">    </span><span class="kw">pull</span>(pred) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb338-54"><a href="application-1-variable-selection.html#cb338-54"></a><span class="st">    </span><span class="kw">as.character</span>()</span>
<span id="cb338-55"><a href="application-1-variable-selection.html#cb338-55"></a>  </span>
<span id="cb338-56"><a href="application-1-variable-selection.html#cb338-56"></a>  <span class="co"># pred_add &lt;- preds_candidate[ which.max(rsq_candidates) ]   # when storing R2 as a vector</span></span>
<span id="cb338-57"><a href="application-1-variable-selection.html#cb338-57"></a>  </span>
<span id="cb338-58"><a href="application-1-variable-selection.html#cb338-58"></a>  <span class="co">## add best predictors to retained predictors </span></span>
<span id="cb338-59"><a href="application-1-variable-selection.html#cb338-59"></a>  preds_retained &lt;-<span class="st"> </span><span class="kw">c</span>(preds_retained, pred_add)</span>
<span id="cb338-60"><a href="application-1-variable-selection.html#cb338-60"></a>  </span>
<span id="cb338-61"><a href="application-1-variable-selection.html#cb338-61"></a>  <span class="co">## get the cross-validation R2</span></span>
<span id="cb338-62"><a href="application-1-variable-selection.html#cb338-62"></a>  forml  &lt;-<span class="st"> </span><span class="kw">as.formula</span>(<span class="kw">paste</span>( target, <span class="st">&#39;~&#39;</span>, <span class="kw">paste</span>(preds_retained, <span class="dt">collapse =</span> <span class="st">&#39;+&#39;</span>)))</span>
<span id="cb338-63"><a href="application-1-variable-selection.html#cb338-63"></a>  control &lt;-<span class="st"> </span><span class="kw">trainControl</span>(<span class="dt">method =</span> <span class="st">&quot;cv&quot;</span>, <span class="dt">number =</span> <span class="dv">5</span>)</span>
<span id="cb338-64"><a href="application-1-variable-selection.html#cb338-64"></a>  <span class="kw">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb338-65"><a href="application-1-variable-selection.html#cb338-65"></a>  <span class="co"># cv_modl &lt;- train(forml, data = df, method = &quot;lm&quot;, , metric = &quot;Rsquared&quot;, trControl = control)</span></span>
<span id="cb338-66"><a href="application-1-variable-selection.html#cb338-66"></a>  cv_modl &lt;-<span class="st"> </span><span class="kw">train</span>(forml, <span class="dt">data =</span> df, <span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="dt">metric =</span> <span class="st">&quot;RMSE&quot;</span>, <span class="dt">trControl =</span> control)</span>
<span id="cb338-67"><a href="application-1-variable-selection.html#cb338-67"></a></span>
<span id="cb338-68"><a href="application-1-variable-selection.html#cb338-68"></a>  <span class="co"># record AIC and BIC and adjusted-R2 of the respective model</span></span>
<span id="cb338-69"><a href="application-1-variable-selection.html#cb338-69"></a>  df_metrics &lt;-<span class="st"> </span>df_metrics <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb338-70"><a href="application-1-variable-selection.html#cb338-70"></a><span class="st">    </span><span class="kw">bind_rows</span>(</span>
<span id="cb338-71"><a href="application-1-variable-selection.html#cb338-71"></a>      <span class="kw">data.frame</span>( <span class="dt">pred =</span> pred_add,</span>
<span id="cb338-72"><a href="application-1-variable-selection.html#cb338-72"></a>                  <span class="dt">rsq =</span> <span class="kw">summary</span>(linmod_candidates[[ pred_add ]])[[<span class="st">&quot;r.squared&quot;</span>]],</span>
<span id="cb338-73"><a href="application-1-variable-selection.html#cb338-73"></a>                  <span class="dt">adj_rsq =</span> <span class="kw">summary</span>(linmod_candidates[[ pred_add ]])[[<span class="st">&quot;adj.r.squared&quot;</span>]],</span>
<span id="cb338-74"><a href="application-1-variable-selection.html#cb338-74"></a>                  <span class="dt">cv_rsq =</span> cv_modl<span class="op">$</span>results<span class="op">$</span>Rsquared,</span>
<span id="cb338-75"><a href="application-1-variable-selection.html#cb338-75"></a>                  <span class="dt">cv_rmse =</span> cv_modl<span class="op">$</span>results<span class="op">$</span>RMSE,</span>
<span id="cb338-76"><a href="application-1-variable-selection.html#cb338-76"></a>                  <span class="dt">aic =</span> <span class="kw">AIC</span>(linmod_candidates[[ pred_add ]]),</span>
<span id="cb338-77"><a href="application-1-variable-selection.html#cb338-77"></a>                  <span class="dt">bic =</span> <span class="kw">BIC</span>(linmod_candidates[[ pred_add ]])</span>
<span id="cb338-78"><a href="application-1-variable-selection.html#cb338-78"></a>      )</span>
<span id="cb338-79"><a href="application-1-variable-selection.html#cb338-79"></a>    )</span>
<span id="cb338-80"><a href="application-1-variable-selection.html#cb338-80"></a>  </span>
<span id="cb338-81"><a href="application-1-variable-selection.html#cb338-81"></a></span>
<span id="cb338-82"><a href="application-1-variable-selection.html#cb338-82"></a>  <span class="co"># remove the selected variable from the candidate variable list</span></span>
<span id="cb338-83"><a href="application-1-variable-selection.html#cb338-83"></a>  preds_candidate &lt;-<span class="st"> </span>preds_candidate[<span class="op">-</span><span class="kw">which</span>(preds_candidate <span class="op">==</span><span class="st"> </span>pred_add)]</span>
<span id="cb338-84"><a href="application-1-variable-selection.html#cb338-84"></a>  <span class="co"># preds_candidate &lt;- setdiff(preds_candidate,pred_add)  # alternative</span></span>
<span id="cb338-85"><a href="application-1-variable-selection.html#cb338-85"></a>  </span>
<span id="cb338-86"><a href="application-1-variable-selection.html#cb338-86"></a>}</span>
<span id="cb338-87"><a href="application-1-variable-selection.html#cb338-87"></a></span>
<span id="cb338-88"><a href="application-1-variable-selection.html#cb338-88"></a><span class="kw">data.frame</span>(df_metrics<span class="op">$</span>pred) <span class="co"># order in which variables enter the model</span></span></code></pre></div>
<pre><code>##    df_metrics.pred
## 1          PPFD_IN
## 2      LW_IN_F_MDS
## 3            VPD_F
## 4             WS_F
## 5      SW_IN_F_MDS
## 6        CO2_F_MDS
## 7             TA_F
## 8             PA_F
## 9         TA_F_MDS
## 10           USTAR
## 11             P_F
## 12       VPD_F_MDS
## 13         LW_IN_F
## 14         SW_IN_F</code></pre>
<div class="sourceCode" id="cb340"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb340-1"><a href="application-1-variable-selection.html#cb340-1"></a>df_metrics <span class="op">%&gt;%</span><span class="st"> </span>knitr<span class="op">::</span><span class="kw">kable</span>()</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">pred</th>
<th align="right">rsq</th>
<th align="right">adj_rsq</th>
<th align="right">cv_rsq</th>
<th align="right">cv_rmse</th>
<th align="right">aic</th>
<th align="right">bic</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">PPFD_IN</td>
<td align="right">0.5276123</td>
<td align="right">0.5274601</td>
<td align="right">0.5286098</td>
<td align="right">2.946732</td>
<td align="right">15529.18</td>
<td align="right">15547.30</td>
</tr>
<tr class="even">
<td align="left">LW_IN_F_MDS</td>
<td align="right">0.6237535</td>
<td align="right">0.6235110</td>
<td align="right">0.6244311</td>
<td align="right">2.631186</td>
<td align="right">14824.62</td>
<td align="right">14848.78</td>
</tr>
<tr class="odd">
<td align="left">VPD_F</td>
<td align="right">0.6482531</td>
<td align="right">0.6479128</td>
<td align="right">0.6488913</td>
<td align="right">2.544541</td>
<td align="right">14617.55</td>
<td align="right">14647.76</td>
</tr>
<tr class="even">
<td align="left">WS_F</td>
<td align="right">0.6640335</td>
<td align="right">0.6636000</td>
<td align="right">0.6644851</td>
<td align="right">2.486970</td>
<td align="right">14477.03</td>
<td align="right">14513.28</td>
</tr>
<tr class="odd">
<td align="left">SW_IN_F_MDS</td>
<td align="right">0.6669387</td>
<td align="right">0.6664013</td>
<td align="right">0.6672468</td>
<td align="right">2.476793</td>
<td align="right">14452.07</td>
<td align="right">14494.35</td>
</tr>
<tr class="even">
<td align="left">CO2_F_MDS</td>
<td align="right">0.6696209</td>
<td align="right">0.6689811</td>
<td align="right">0.6695521</td>
<td align="right">2.467823</td>
<td align="right">14428.96</td>
<td align="right">14477.28</td>
</tr>
<tr class="odd">
<td align="left">TA_F</td>
<td align="right">0.6708789</td>
<td align="right">0.6701350</td>
<td align="right">0.6703978</td>
<td align="right">2.464609</td>
<td align="right">14419.11</td>
<td align="right">14473.48</td>
</tr>
<tr class="even">
<td align="left">PA_F</td>
<td align="right">0.6726644</td>
<td align="right">0.6718185</td>
<td align="right">0.6718171</td>
<td align="right">2.459555</td>
<td align="right">14404.22</td>
<td align="right">14464.63</td>
</tr>
<tr class="odd">
<td align="left">TA_F_MDS</td>
<td align="right">0.6730699</td>
<td align="right">0.6721192</td>
<td align="right">0.6642220</td>
<td align="right">2.487336</td>
<td align="right">14402.37</td>
<td align="right">14468.82</td>
</tr>
<tr class="even">
<td align="left">USTAR</td>
<td align="right">0.6733802</td>
<td align="right">0.6723246</td>
<td align="right">0.6639334</td>
<td align="right">2.488412</td>
<td align="right">14401.42</td>
<td align="right">14473.91</td>
</tr>
<tr class="odd">
<td align="left">P_F</td>
<td align="right">0.6735098</td>
<td align="right">0.6723487</td>
<td align="right">0.6638548</td>
<td align="right">2.488747</td>
<td align="right">14402.19</td>
<td align="right">14480.72</td>
</tr>
<tr class="even">
<td align="left">VPD_F_MDS</td>
<td align="right">0.6735755</td>
<td align="right">0.6723086</td>
<td align="right">0.6624537</td>
<td align="right">2.493879</td>
<td align="right">14403.57</td>
<td align="right">14488.14</td>
</tr>
<tr class="odd">
<td align="left">LW_IN_F</td>
<td align="right">0.6736125</td>
<td align="right">0.6722398</td>
<td align="right">0.6623996</td>
<td align="right">2.494079</td>
<td align="right">14405.22</td>
<td align="right">14495.83</td>
</tr>
<tr class="even">
<td align="left">SW_IN_F</td>
<td align="right">0.6736372</td>
<td align="right">0.6721585</td>
<td align="right">0.6620120</td>
<td align="right">2.495602</td>
<td align="right">14406.98</td>
<td align="right">14503.63</td>
</tr>
</tbody>
</table>
<ul>
<li>Visualise all metrics as a function of the number of predictors (add labels for the variable names of the added predictor). Highlight the best-performing model based on the respective metric. How many predictors are in the best performing model, when assessed based on each metric?</li>
</ul>
<div class="sourceCode" id="cb341"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb341-1"><a href="application-1-variable-selection.html#cb341-1"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb341-2"><a href="application-1-variable-selection.html#cb341-2"></a></span>
<span id="cb341-3"><a href="application-1-variable-selection.html#cb341-3"></a>df_metrics<span class="op">$</span>pred &lt;-<span class="st">  </span><span class="kw">factor</span>(df_metrics<span class="op">$</span>pred, <span class="dt">levels =</span> df_metrics<span class="op">$</span>pred)</span>
<span id="cb341-4"><a href="application-1-variable-selection.html#cb341-4"></a></span>
<span id="cb341-5"><a href="application-1-variable-selection.html#cb341-5"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb341-6"><a href="application-1-variable-selection.html#cb341-6"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> rsq)) <span class="op">+</span></span>
<span id="cb341-7"><a href="application-1-variable-selection.html#cb341-7"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics, rsq <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(rsq)), <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> rsq), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb341-8"><a href="application-1-variable-selection.html#cb341-8"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">expression</span>(<span class="kw">italic</span>(R)<span class="op">^</span><span class="dv">2</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb341-9"><a href="application-1-variable-selection.html#cb341-9"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-192-1.png" width="672" /></p>
<div class="sourceCode" id="cb342"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb342-1"><a href="application-1-variable-selection.html#cb342-1"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb342-2"><a href="application-1-variable-selection.html#cb342-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> adj_rsq)) <span class="op">+</span></span>
<span id="cb342-3"><a href="application-1-variable-selection.html#cb342-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics, adj_rsq <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(adj_rsq)), <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> adj_rsq), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb342-4"><a href="application-1-variable-selection.html#cb342-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;Adjusted-&quot;</span>, <span class="kw">italic</span>(R)<span class="op">^</span><span class="dv">2</span>))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb342-5"><a href="application-1-variable-selection.html#cb342-5"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-192-2.png" width="672" /></p>
<div class="sourceCode" id="cb343"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb343-1"><a href="application-1-variable-selection.html#cb343-1"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb343-2"><a href="application-1-variable-selection.html#cb343-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> cv_rsq)) <span class="op">+</span></span>
<span id="cb343-3"><a href="application-1-variable-selection.html#cb343-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics, cv_rsq <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(cv_rsq)), <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> cv_rsq), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb343-4"><a href="application-1-variable-selection.html#cb343-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;Cross-validated &quot;</span>, <span class="kw">italic</span>(R)<span class="op">^</span><span class="dv">2</span>))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb343-5"><a href="application-1-variable-selection.html#cb343-5"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-192-3.png" width="672" /></p>
<div class="sourceCode" id="cb344"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb344-1"><a href="application-1-variable-selection.html#cb344-1"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb344-2"><a href="application-1-variable-selection.html#cb344-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> cv_rmse)) <span class="op">+</span></span>
<span id="cb344-3"><a href="application-1-variable-selection.html#cb344-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics, cv_rmse <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(cv_rmse)), <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> cv_rmse), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb344-4"><a href="application-1-variable-selection.html#cb344-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;Cross-validated &quot;</span>, RMSE))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb344-5"><a href="application-1-variable-selection.html#cb344-5"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-192-4.png" width="672" /></p>
<div class="sourceCode" id="cb345"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb345-1"><a href="application-1-variable-selection.html#cb345-1"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb345-2"><a href="application-1-variable-selection.html#cb345-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> aic)) <span class="op">+</span></span>
<span id="cb345-3"><a href="application-1-variable-selection.html#cb345-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics, aic <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(aic)), <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> aic), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb345-4"><a href="application-1-variable-selection.html#cb345-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;AIC&quot;</span>)<span class="op">+</span><span class="st"> </span></span>
<span id="cb345-5"><a href="application-1-variable-selection.html#cb345-5"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-192-5.png" width="672" /></p>
<div class="sourceCode" id="cb346"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb346-1"><a href="application-1-variable-selection.html#cb346-1"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb346-2"><a href="application-1-variable-selection.html#cb346-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> bic)) <span class="op">+</span></span>
<span id="cb346-3"><a href="application-1-variable-selection.html#cb346-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics, bic <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(bic)), <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> bic), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb346-4"><a href="application-1-variable-selection.html#cb346-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;BIC&quot;</span>)<span class="op">+</span><span class="st"> </span></span>
<span id="cb346-5"><a href="application-1-variable-selection.html#cb346-5"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-192-6.png" width="672" /></p>
<ul>
<li>Observe which predictors are selected into the final model and which not. Why?</li>
</ul>
<p><em>Solution:</em>
Take the best model selected by BIC as an example, <code>VPD_F</code> is selected into the model and <code>VPD_F_MDS</code> is not. They won’t enter the model both because they are highly correlated and when one is in, the other doesn’t add information, which proves our expectation in the previous question.</p>
<ul>
<li>Whether it matters to the order of variables entering into the model which metric (i.e. AIC, BIC or <span class="math inline">\(R^2\)</span>) is used? Why?</li>
</ul>
<p><em>Solution:</em>
No, it doesn’t matter. For each inner loop, when deciding which variable is sequentially chosen, we compare models of the same level (i.e. same number of variables). In this sense, model complexities for all the models are the same, and AIC/BIC only compares the goodness of fit part, which works the same as <span class="math inline">\(R^2\)</span>.</p>
<ul>
<li>Discuss your results. Which metric do you trust most? Why? Try out your algorithm without evaluating the cross-validated <span class="math inline">\(R^2\)</span>. Do you get a computational efficiency gain? Which metric comes closest to the cross-validated <span class="math inline">\(R^2\)</span> in terms of selecting the same number predictors?</li>
</ul>
<p><em>Solution:</em>
Cross-validated <span class="math inline">\(R^2\)</span> is the “gold-standard” for assessing generalisability. However, it is computationally costly and may not provide robust results when the data set is small. Since AIC and BIC both penalise additional predictors, they both don’t select the full model with 14 variables as the best model (However, it could happen that the best model selected by AIC/BIC is the full model). The BIC selects for the same number of predictors as the cross-validated <span class="math inline">\(R^2\)</span> and RMSE, but without the disadvantage of the computational costs. It provides a conservative and apparently robust estimate for the model generalisability. Note that the order of added predictors is determined by the simple <span class="math inline">\(R^2\)</span> and is therefore independent of the final metrics we use for choosing the best <span class="math inline">\(k\)</span>.</p>
</div>
<div id="bonus-stepwise-regression-out-of-the-box" class="section level2">
<h2><span class="header-section-number">9.5</span> Bonus: Stepwise regression out-of-the-box</h2>
<p>In R, you can also conduct the above variable selection procedures automatically. <code>regsubsets()</code> from leaps package provides a convenient way to do so. It does model selection by exhaustive search, including forward or backward stepwise regression.</p>
<ul>
<li>Do a stepwise forward regression using <code>regsubsets()</code>.</li>
<li>Create a data frame with the same metrics as above (except cross-validated <span class="math inline">\(R^2\)</span>).</li>
<li>Visualise metrics as above.</li>
<li>Are your result consistent?</li>
</ul>
<p><em>Hints</em>:</p>
<ul>
<li>Specify stepwise <em>forward</em> by setting <code>method = "forward"</code>.</li>
<li>Specify the number of predictors to examine, that is all fourteen, by setting <code>nvmax = 14</code>.</li>
<li>AIC values of each step are stored in <code>summary(regfit.fwd)$cp</code> and BIC values of each step are in <code>summary(regfit.fwd)$bic</code>, etc.</li>
<li>Get order in which predictors <span class="math inline">\(k\)</span> are added (which corresponds to values returned by <code>summary(regfit.fwd)$bic</code>), by <code>all_predictors[regfit.fwd$vorder[2:15]-1]</code>. <code>vorder</code> is the order of variables entering into model. Note that <code>Intercept</code> is counted here as the first to enter into the model and should be removed.</li>
<li>To avoid reordering of the list of variable names in plotting, change the type of variable names from “character” to “factor” by <code>preds_enter &lt;- factor(preds_enter, levels = preds_enter)</code></li>
</ul>
<div class="sourceCode" id="cb347"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb347-1"><a href="application-1-variable-selection.html#cb347-1"></a><span class="kw">library</span>(leaps)</span>
<span id="cb347-2"><a href="application-1-variable-selection.html#cb347-2"></a>regfit.fwd &lt;-<span class="st"> </span><span class="kw">regsubsets</span>(<span class="kw">as.formula</span>(<span class="kw">paste</span>(target, <span class="st">&quot;~&quot;</span>, <span class="kw">paste</span>(preds,<span class="dt">collapse=</span><span class="st">&quot; + &quot;</span>))), <span class="dt">data =</span> df, <span class="dt">method =</span> <span class="st">&quot;forward&quot;</span>, <span class="dt">nvmax =</span> <span class="dv">14</span>)</span>
<span id="cb347-3"><a href="application-1-variable-selection.html#cb347-3"></a>reg.summary &lt;-<span class="st"> </span><span class="kw">summary</span>(regfit.fwd)</span>
<span id="cb347-4"><a href="application-1-variable-selection.html#cb347-4"></a></span>
<span id="cb347-5"><a href="application-1-variable-selection.html#cb347-5"></a><span class="co"># get variables in their order added to the model</span></span>
<span id="cb347-6"><a href="application-1-variable-selection.html#cb347-6"></a>preds_enter &lt;-<span class="st"> </span>preds[regfit.fwd<span class="op">$</span>vorder[<span class="dv">2</span><span class="op">:</span><span class="dv">15</span>]<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb347-7"><a href="application-1-variable-selection.html#cb347-7"></a></span>
<span id="cb347-8"><a href="application-1-variable-selection.html#cb347-8"></a><span class="co">## create metrics data frame</span></span>
<span id="cb347-9"><a href="application-1-variable-selection.html#cb347-9"></a>df_metrics_auto &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb347-10"><a href="application-1-variable-selection.html#cb347-10"></a>  <span class="dt">preds =</span> <span class="kw">factor</span>(preds_enter, <span class="dt">levels =</span> preds_enter),</span>
<span id="cb347-11"><a href="application-1-variable-selection.html#cb347-11"></a>  <span class="dt">rsq =</span> reg.summary<span class="op">$</span>rsq, </span>
<span id="cb347-12"><a href="application-1-variable-selection.html#cb347-12"></a>  <span class="dt">adj_rsq =</span> reg.summary<span class="op">$</span>adjr2, </span>
<span id="cb347-13"><a href="application-1-variable-selection.html#cb347-13"></a>  <span class="dt">aic =</span> reg.summary<span class="op">$</span>cp, </span>
<span id="cb347-14"><a href="application-1-variable-selection.html#cb347-14"></a>  <span class="dt">bic =</span> reg.summary<span class="op">$</span>bic</span>
<span id="cb347-15"><a href="application-1-variable-selection.html#cb347-15"></a>  )</span>
<span id="cb347-16"><a href="application-1-variable-selection.html#cb347-16"></a></span>
<span id="cb347-17"><a href="application-1-variable-selection.html#cb347-17"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb347-18"><a href="application-1-variable-selection.html#cb347-18"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics_auto, <span class="kw">aes</span>(<span class="dt">x =</span> preds, <span class="dt">y =</span> rsq)) <span class="op">+</span></span>
<span id="cb347-19"><a href="application-1-variable-selection.html#cb347-19"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics_auto, rsq <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(rsq)), <span class="kw">aes</span>(<span class="dt">x =</span> preds, <span class="dt">y =</span> rsq), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb347-20"><a href="application-1-variable-selection.html#cb347-20"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">expression</span>(<span class="kw">italic</span>(R)<span class="op">^</span><span class="dv">2</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb347-21"><a href="application-1-variable-selection.html#cb347-21"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-193-1.png" width="672" /></p>
<div class="sourceCode" id="cb348"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb348-1"><a href="application-1-variable-selection.html#cb348-1"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb348-2"><a href="application-1-variable-selection.html#cb348-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics_auto, <span class="kw">aes</span>(<span class="dt">x =</span> preds, <span class="dt">y =</span> adj_rsq)) <span class="op">+</span></span>
<span id="cb348-3"><a href="application-1-variable-selection.html#cb348-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics_auto, adj_rsq <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(adj_rsq)), <span class="kw">aes</span>(<span class="dt">x =</span> preds, <span class="dt">y =</span> adj_rsq), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb348-4"><a href="application-1-variable-selection.html#cb348-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;Adjusted-&quot;</span>, <span class="kw">italic</span>(R)<span class="op">^</span><span class="dv">2</span>))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb348-5"><a href="application-1-variable-selection.html#cb348-5"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-193-2.png" width="672" /></p>
<div class="sourceCode" id="cb349"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb349-1"><a href="application-1-variable-selection.html#cb349-1"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb349-2"><a href="application-1-variable-selection.html#cb349-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics_auto, <span class="kw">aes</span>(<span class="dt">x =</span> preds, <span class="dt">y =</span> aic)) <span class="op">+</span></span>
<span id="cb349-3"><a href="application-1-variable-selection.html#cb349-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics_auto, aic <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(aic)), <span class="kw">aes</span>(<span class="dt">x =</span> preds, <span class="dt">y =</span> aic), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb349-4"><a href="application-1-variable-selection.html#cb349-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;AIC&quot;</span>)<span class="op">+</span><span class="st"> </span></span>
<span id="cb349-5"><a href="application-1-variable-selection.html#cb349-5"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-193-3.png" width="672" /></p>
<div class="sourceCode" id="cb350"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb350-1"><a href="application-1-variable-selection.html#cb350-1"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb350-2"><a href="application-1-variable-selection.html#cb350-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics_auto, <span class="kw">aes</span>(<span class="dt">x =</span> preds, <span class="dt">y =</span> bic)) <span class="op">+</span></span>
<span id="cb350-3"><a href="application-1-variable-selection.html#cb350-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics_auto, bic <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(bic)), <span class="kw">aes</span>(<span class="dt">x =</span> preds, <span class="dt">y =</span> bic), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb350-4"><a href="application-1-variable-selection.html#cb350-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;BIC&quot;</span>)<span class="op">+</span><span class="st"> </span></span>
<span id="cb350-5"><a href="application-1-variable-selection.html#cb350-5"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-193-4.png" width="672" /></p>
</div>
<div id="warm-up-2-find-the-best-single-predictor-1" class="section level2">
<h2><span class="header-section-number">9.6</span> Warm-up 2: Find the best single predictor</h2>
<p>The first step of a stepwise forward regression is to find the single most powerful predictor in a univariate linear regression model for the target variable <code>GPP_NT_VUT_REF</code> among all fourteen available predictors in our data set (all except those of type <code>date</code> or <code>character</code>). Implement this first part of the search, using the definition of the stepwise-forward algorithm above. Remove all rows with at least one missing value before starting the predictor search.</p>
<ul>
<li>Which predictor achieves the highest <span class="math inline">\(R^2\)</span>?</li>
<li>What value is the <span class="math inline">\(R^2\)</span>?</li>
<li>Visualise <span class="math inline">\(R^2\)</span> by predictors, ordered by their respective <span class="math inline">\(R^2\)</span> values.</li>
<li>Do you note a particular pattern? Which variables yield similar <span class="math inline">\(R^2\)</span>? How do you expect them to be included in multivariate models of the subsequent steps in the stepwise forward regression?</li>
</ul>
<p><em>Hints</em>:</p>
<ul>
<li><p>Model structure:</p>
<ul>
<li>The “counter” variables in the for loop can be provided as a vector, and the counter will sequentially take on the value of each element in that vector. For example: <code>for (var in all_predictors){ ... }</code>.</li>
</ul></li>
<li><p>Algorithm:</p>
<ul>
<li><p>To record <span class="math inline">\(R^2\)</span> values for the different models, you may start by creating an empty vector (<code>vec &lt;- c()</code>) before the loop and then sequentially add elements to that vector inside the loop (<code>vec &lt;- c(vec, new_element)</code>). Alternatively, you can do something similar, but with a data frame (initialising with <code>df_rsq &lt;- data.frame()</code> before the loop, and adding rows by <code>df_rsq &lt;- bind_rows(df_rsq, data.frame(pred = predictor_name, rsq = rsq_result))</code> inside the loop).</p></li>
<li><p>A clever way how to construct formulas dynamically is described, for example in <a href="https://stackoverflow.com/questions/4951442/formula-with-dynamic-number-of-variables">this stackoverflow post</a>.</p></li>
</ul></li>
<li><p>Value retriving:</p>
<ul>
<li>Extract the <span class="math inline">\(R^2\)</span> from the linear model object: <code>summary(fit_lin)[["r.squared"]]</code></li>
</ul></li>
<li><p>Displaying:</p>
<ul>
<li>Search for solutions for how to change the order of levels to be plotted yourself.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb351"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb351-1"><a href="application-1-variable-selection.html#cb351-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb351-2"><a href="application-1-variable-selection.html#cb351-2"></a><span class="co">## read CSV and drop missing values in one step</span></span>
<span id="cb351-3"><a href="application-1-variable-selection.html#cb351-3"></a>df &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;./data/ddf_for_08_application.csv&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb351-4"><a href="application-1-variable-selection.html#cb351-4"></a><span class="st">  </span><span class="kw">drop_na</span>()</span></code></pre></div>
<pre><code>## 
## ── Column specification ───────────────────────────────────────────────────────
## cols(
##   siteid = col_character(),
##   TIMESTAMP = col_date(format = &quot;&quot;),
##   TA_F = col_double(),
##   SW_IN_F = col_double(),
##   LW_IN_F = col_double(),
##   VPD_F = col_double(),
##   PA_F = col_double(),
##   P_F = col_double(),
##   WS_F = col_double(),
##   TA_F_MDS = col_double(),
##   SW_IN_F_MDS = col_double(),
##   LW_IN_F_MDS = col_double(),
##   VPD_F_MDS = col_double(),
##   CO2_F_MDS = col_double(),
##   PPFD_IN = col_double(),
##   GPP_NT_VUT_REF = col_double(),
##   USTAR = col_double()
## )</code></pre>
<div class="sourceCode" id="cb353"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb353-1"><a href="application-1-variable-selection.html#cb353-1"></a><span class="co">## specify target variable</span></span>
<span id="cb353-2"><a href="application-1-variable-selection.html#cb353-2"></a>target &lt;-<span class="st"> &#39;GPP_NT_VUT_REF&#39;</span></span>
<span id="cb353-3"><a href="application-1-variable-selection.html#cb353-3"></a></span>
<span id="cb353-4"><a href="application-1-variable-selection.html#cb353-4"></a><span class="co">## determine predictors as all except site ID, timestamp, and the target (should be 14)</span></span>
<span id="cb353-5"><a href="application-1-variable-selection.html#cb353-5"></a>preds &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb353-6"><a href="application-1-variable-selection.html#cb353-6"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span>siteid, <span class="op">-</span>TIMESTAMP, <span class="op">-</span>GPP_NT_VUT_REF) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb353-7"><a href="application-1-variable-selection.html#cb353-7"></a><span class="st">  </span><span class="kw">names</span>()</span>
<span id="cb353-8"><a href="application-1-variable-selection.html#cb353-8"></a></span>
<span id="cb353-9"><a href="application-1-variable-selection.html#cb353-9"></a><span class="co">## initialise an empty data frame (necessary, because otherwise we cannot use bind_rows() below)</span></span>
<span id="cb353-10"><a href="application-1-variable-selection.html#cb353-10"></a>df_rsq &lt;-<span class="st"> </span><span class="kw">data.frame</span>()</span>
<span id="cb353-11"><a href="application-1-variable-selection.html#cb353-11"></a><span class="co"># rsq_list &lt;- c()  # alternative for vector</span></span>
<span id="cb353-12"><a href="application-1-variable-selection.html#cb353-12"></a></span>
<span id="cb353-13"><a href="application-1-variable-selection.html#cb353-13"></a><span class="cf">for</span> (var <span class="cf">in</span> preds){</span>
<span id="cb353-14"><a href="application-1-variable-selection.html#cb353-14"></a>  </span>
<span id="cb353-15"><a href="application-1-variable-selection.html#cb353-15"></a>  <span class="co">## create formula dynamically</span></span>
<span id="cb353-16"><a href="application-1-variable-selection.html#cb353-16"></a>  forml &lt;-<span class="st"> </span><span class="kw">as.formula</span>(<span class="kw">paste</span>(target, <span class="st">&quot;~&quot;</span>, var))</span>
<span id="cb353-17"><a href="application-1-variable-selection.html#cb353-17"></a>  </span>
<span id="cb353-18"><a href="application-1-variable-selection.html#cb353-18"></a>  <span class="co">## fit linear model</span></span>
<span id="cb353-19"><a href="application-1-variable-selection.html#cb353-19"></a>  fit_lin &lt;-<span class="st"> </span><span class="kw">lm</span>(forml, <span class="dt">data =</span> df)</span>
<span id="cb353-20"><a href="application-1-variable-selection.html#cb353-20"></a>  </span>
<span id="cb353-21"><a href="application-1-variable-selection.html#cb353-21"></a>  <span class="co">## extract R2 from linear model</span></span>
<span id="cb353-22"><a href="application-1-variable-selection.html#cb353-22"></a>  rsq &lt;-<span class="st"> </span><span class="kw">summary</span>(fit_lin)[[<span class="st">&quot;r.squared&quot;</span>]]</span>
<span id="cb353-23"><a href="application-1-variable-selection.html#cb353-23"></a>  </span>
<span id="cb353-24"><a href="application-1-variable-selection.html#cb353-24"></a>  <span class="co">## add a row to the data frame that holds the results</span></span>
<span id="cb353-25"><a href="application-1-variable-selection.html#cb353-25"></a>  df_rsq &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(df_rsq, <span class="kw">data.frame</span>(<span class="dt">pred =</span> var, <span class="dt">rsq =</span> rsq))</span>
<span id="cb353-26"><a href="application-1-variable-selection.html#cb353-26"></a>  </span>
<span id="cb353-27"><a href="application-1-variable-selection.html#cb353-27"></a>  <span class="co"># rsq_list &lt;- c(rsq_list,rsq)  # alternative with vector</span></span>
<span id="cb353-28"><a href="application-1-variable-selection.html#cb353-28"></a>}</span>
<span id="cb353-29"><a href="application-1-variable-selection.html#cb353-29"></a></span>
<span id="cb353-30"><a href="application-1-variable-selection.html#cb353-30"></a><span class="co">## print best single predictor and its R2</span></span>
<span id="cb353-31"><a href="application-1-variable-selection.html#cb353-31"></a>df_rsq <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb353-32"><a href="application-1-variable-selection.html#cb353-32"></a><span class="st">  </span><span class="kw">arrange</span>(<span class="op">-</span>rsq) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># arrange by R2 in descending order (highest R2 on top)</span></span>
<span id="cb353-33"><a href="application-1-variable-selection.html#cb353-33"></a><span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span>)           <span class="co"># print only the first row (with highest R2)</span></span></code></pre></div>
<pre><code>##      pred       rsq
## 1 PPFD_IN 0.5276123</code></pre>
<div class="sourceCode" id="cb355"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb355-1"><a href="application-1-variable-selection.html#cb355-1"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb355-2"><a href="application-1-variable-selection.html#cb355-2"></a></span>
<span id="cb355-3"><a href="application-1-variable-selection.html#cb355-3"></a><span class="co">## alternative: determine the first variable to enter into our model</span></span>
<span id="cb355-4"><a href="application-1-variable-selection.html#cb355-4"></a><span class="co"># preds[which.max(rsq_list)]</span></span>
<span id="cb355-5"><a href="application-1-variable-selection.html#cb355-5"></a></span>
<span id="cb355-6"><a href="application-1-variable-selection.html#cb355-6"></a><span class="co">## use the data frame that holds the results for plotting</span></span>
<span id="cb355-7"><a href="application-1-variable-selection.html#cb355-7"></a>df_rsq <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb355-8"><a href="application-1-variable-selection.html#cb355-8"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">reorder</span>(pred, rsq), <span class="dt">y =</span> rsq)) <span class="op">+</span></span>
<span id="cb355-9"><a href="application-1-variable-selection.html#cb355-9"></a><span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb355-10"><a href="application-1-variable-selection.html#cb355-10"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="kw">expression</span>(<span class="kw">italic</span>(R)<span class="op">^</span><span class="dv">2</span>), <span class="dt">x =</span> <span class="st">&quot;Variable&quot;</span>) <span class="op">+</span></span>
<span id="cb355-11"><a href="application-1-variable-selection.html#cb355-11"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-195-1.png" width="672" /></p>
<p><strong>Solution</strong>:
PPFD_IN achieves the highest <span class="math inline">\(R^2\)</span> value, and the corresponding <span class="math inline">\(R^2\)</span> values is 0.5276123.</p>
<p>We could see from the above plot that <code>LW_IN_F_MDS</code> and <code>LW_IN_F</code>, <code>VPD_F</code> and <code>VPD_F_MDS</code>, <code>SW_IN_F</code> and <code>SW_IN_F_MDS</code> share basically the same <span class="math inline">\(R^2\)</span> values. Those variables are highly corrected and are explaining the same amount of variance in the target variable.</p>
<p>In the subsequent steps of the stepwise forward regression, since each of the two variables are highly correlated with each other, it’s likely that only one of them will be selected into our final model.</p>
</div>
<div id="full-stepwise-regression-1" class="section level2">
<h2><span class="header-section-number">9.7</span> Full stepwise regression</h2>
<p>Now, we take it to the next level and implement a full stepwise forward regression as described above. For each step (number of predictors <span class="math inline">\(k\)</span>), record the following metrics: <span class="math inline">\(R^2\)</span>, <em>adjusted-</em><span class="math inline">\(R^2\)</span>, the Akaike Information Criterion (AIC), (Bayesian Information Criterion) BIC, and the 5 time repeated 5-fold cross-validation <span class="math inline">\(R^2\)</span> and RMSE.</p>
<ul>
<li><p>Display the order in which predictors enter the model.</p></li>
<li><p>Display a table with the metrics of all <span class="math inline">\(k\)</span> steps, and the single variable, added at each step.</p></li>
</ul>
<p><em>Hints</em>:</p>
<ul>
<li><p>Model structure:</p>
<ul>
<li>Recall what you learned in the breakout session, you may use the same idea on this task. Try to think of the blueprint (<strong>pseudo-code</strong>) first: how to go through different models in each forward step? how to store predictors added to the model and how to update candidate predictors?</li>
</ul></li>
<li><p>Algorithm:</p>
<ul>
<li><p>A complication is that the set of predictors is sequentially complemented with each step of the outer loop. You may again use <code>vec &lt;- list()</code> to create an empty vector, and then add elements to that vector by <code>vec &lt;- c(vec, new_element)</code>.</p></li>
<li><p>It may be helpful to explicitly define a set of “candidate predictors” that may potentially be added to the model as a vector (e.g., <code>preds_candidate</code>), and define predictors retained in the model from the previous step in a separate vector (e.g., <code>preds_retained</code>). In each step, search through <code>preds_candidate</code>, select the best predictor, add it to <code>preds_retained</code> and remove it from <code>preds_candidate</code>.</p></li>
<li><p>At each step, record the metrics and store them in a data frame for later plots.</p></li>
<li><p>(As above) A clever way how to construct formulas dynamically is described, for example in <a href="https://stackoverflow.com/questions/4951442/formula-with-dynamic-number-of-variables">this stackoverflow post</a>.</p></li>
<li><p>The metrics for the <span class="math inline">\(k\)</span> models are assessed <em>after</em> the order of added variables is determined. To be able to determine the metrics, the <span class="math inline">\(k\)</span> models can be saved by constructing a list of models and sequentially add elements to that list (<code>mylist[[ name_new_element ]] &lt;- new_element</code>). You can also fit the model again after determining which predictor worked best.</p></li>
<li><p>Your code will most certainly have bugs at first. To debug efficiently, write code first in a simple R script and use the debugging options in RStudio (see <a href="https://support.rstudio.com/hc/en-us/articles/205612627-Debugging-with-RStudio">here</a>).</p></li>
</ul></li>
<li><p>Value retriving</p>
<ul>
<li><p>To get AIC and BIC value, use the base-R functions <code>AIC()</code> and <code>BIC()</code>.</p></li>
<li><p>To get the cross-validated <span class="math inline">\(R^2\)</span>, use the caret function <code>train()</code> with “Rsquared” as the loss function, and <code>method = "lm"</code> (to fit a linear regression model). Then extract the value by <code>trained_model$results$Rsquared</code>. The same applies for cross-validated RMSE.</p></li>
</ul></li>
<li><p>Displaying:</p>
<ul>
<li><p>To display a table nicely as part of the RMarkdown html output, use the function <code>knitr::kable()</code></p></li>
<li><p>To avoid reordering of the list of variable names in plotting, change the type of variable names from “character” to “factor” by <code>pred &lt;- factor(pred, levels = pred)</code></p></li>
</ul></li>
</ul>
<!-- - remove element by index number from a vector `vec[-2]` -->
<!-- - concatenate string vectors with certain separations:  `paste(c("predictor_1","predictor_2","predictor_3"),collapse = '+')` gives `"predictor_1 + predictor_2 + predictor_3"` -->
<!-- - fit a linear regression with three predictors: `fit_lin <- lm(target ~ predictor_1 + predictor_2 + predictor_3, data = df)` -->
<!-- - execute a string-like expression: `eval(parse(text = <string>))`, for example: `eval(parse(text='mean(c(2,3,4))'))=3` -->
<!-- - get AIC and BIC from a linear regression model object: `AIC(fit_lin)`, `BIC(fit_lin)` -->
<div class="sourceCode" id="cb356"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb356-1"><a href="application-1-variable-selection.html#cb356-1"></a><span class="kw">library</span>(caret)  <span class="co"># need train() for cross-validation</span></span>
<span id="cb356-2"><a href="application-1-variable-selection.html#cb356-2"></a></span>
<span id="cb356-3"><a href="application-1-variable-selection.html#cb356-3"></a><span class="co">## specify target variable (as above)</span></span>
<span id="cb356-4"><a href="application-1-variable-selection.html#cb356-4"></a>target &lt;-<span class="st"> &#39;GPP_NT_VUT_REF&#39;</span></span>
<span id="cb356-5"><a href="application-1-variable-selection.html#cb356-5"></a></span>
<span id="cb356-6"><a href="application-1-variable-selection.html#cb356-6"></a><span class="co">## determine predictors as all except site ID, timestamp, and the target (should be 14)  (as above)</span></span>
<span id="cb356-7"><a href="application-1-variable-selection.html#cb356-7"></a>preds &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb356-8"><a href="application-1-variable-selection.html#cb356-8"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span>siteid, <span class="op">-</span>TIMESTAMP, <span class="op">-</span>GPP_NT_VUT_REF) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb356-9"><a href="application-1-variable-selection.html#cb356-9"></a><span class="st">  </span><span class="kw">names</span>()</span>
<span id="cb356-10"><a href="application-1-variable-selection.html#cb356-10"></a></span>
<span id="cb356-11"><a href="application-1-variable-selection.html#cb356-11"></a><span class="co"># This is the vector of candidate predictors to be added in the model. To begin with, consider all as candidates.</span></span>
<span id="cb356-12"><a href="application-1-variable-selection.html#cb356-12"></a>preds_candidate &lt;-<span class="st"> </span>preds </span>
<span id="cb356-13"><a href="application-1-variable-selection.html#cb356-13"></a></span>
<span id="cb356-14"><a href="application-1-variable-selection.html#cb356-14"></a><span class="co"># predictors retained in the model from the previous step. To begin with, is empty.</span></span>
<span id="cb356-15"><a href="application-1-variable-selection.html#cb356-15"></a>preds_retained &lt;-<span class="st"> </span><span class="kw">c</span>()</span>
<span id="cb356-16"><a href="application-1-variable-selection.html#cb356-16"></a></span>
<span id="cb356-17"><a href="application-1-variable-selection.html#cb356-17"></a><span class="co">## work with lists as much as possible (more flexible!)</span></span>
<span id="cb356-18"><a href="application-1-variable-selection.html#cb356-18"></a>df_metrics &lt;-<span class="st"> </span><span class="kw">data.frame</span>()</span>
<span id="cb356-19"><a href="application-1-variable-selection.html#cb356-19"></a></span>
<span id="cb356-20"><a href="application-1-variable-selection.html#cb356-20"></a><span class="co">## outer loop for k predictors</span></span>
<span id="cb356-21"><a href="application-1-variable-selection.html#cb356-21"></a><span class="cf">for</span> (k_index <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(preds)){</span>
<span id="cb356-22"><a href="application-1-variable-selection.html#cb356-22"></a>  </span>
<span id="cb356-23"><a href="application-1-variable-selection.html#cb356-23"></a>  <span class="co"># rsq_candidates &lt;- c()</span></span>
<span id="cb356-24"><a href="application-1-variable-selection.html#cb356-24"></a>  df_rsq_candidates &lt;-<span class="st"> </span><span class="kw">data.frame</span>()</span>
<span id="cb356-25"><a href="application-1-variable-selection.html#cb356-25"></a>  linmod_candidates &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb356-26"><a href="application-1-variable-selection.html#cb356-26"></a>  </span>
<span id="cb356-27"><a href="application-1-variable-selection.html#cb356-27"></a>  <span class="co">## inner loop for single additional predictor</span></span>
<span id="cb356-28"><a href="application-1-variable-selection.html#cb356-28"></a>  <span class="cf">for</span> (ipred <span class="cf">in</span> preds_candidate){</span>
<span id="cb356-29"><a href="application-1-variable-selection.html#cb356-29"></a>    </span>
<span id="cb356-30"><a href="application-1-variable-selection.html#cb356-30"></a>    <span class="co"># variable vector (new variable + retained variables) used in regression</span></span>
<span id="cb356-31"><a href="application-1-variable-selection.html#cb356-31"></a>    pred_add &lt;-<span class="st"> </span><span class="kw">c</span>(preds_retained, ipred)</span>
<span id="cb356-32"><a href="application-1-variable-selection.html#cb356-32"></a>    </span>
<span id="cb356-33"><a href="application-1-variable-selection.html#cb356-33"></a>    <span class="co"># define formulate with newly-added predictor</span></span>
<span id="cb356-34"><a href="application-1-variable-selection.html#cb356-34"></a>    forml  &lt;-<span class="st"> </span><span class="kw">as.formula</span>(<span class="kw">paste</span>( target, <span class="st">&#39;~&#39;</span>, <span class="kw">paste</span>(pred_add, <span class="dt">collapse =</span> <span class="st">&#39;+&#39;</span>)))</span>
<span id="cb356-35"><a href="application-1-variable-selection.html#cb356-35"></a>    </span>
<span id="cb356-36"><a href="application-1-variable-selection.html#cb356-36"></a>    <span class="co"># fit linear model</span></span>
<span id="cb356-37"><a href="application-1-variable-selection.html#cb356-37"></a>    fit_lin &lt;-<span class="st"> </span><span class="kw">lm</span>(forml, <span class="dt">data =</span> df)</span>
<span id="cb356-38"><a href="application-1-variable-selection.html#cb356-38"></a>    </span>
<span id="cb356-39"><a href="application-1-variable-selection.html#cb356-39"></a>    <span class="co"># add model object to list, and name the element according to the added variable</span></span>
<span id="cb356-40"><a href="application-1-variable-selection.html#cb356-40"></a>    linmod_candidates[[ ipred ]] &lt;-<span class="st"> </span>fit_lin</span>
<span id="cb356-41"><a href="application-1-variable-selection.html#cb356-41"></a>    </span>
<span id="cb356-42"><a href="application-1-variable-selection.html#cb356-42"></a>    <span class="co"># record metrics for all candidates</span></span>
<span id="cb356-43"><a href="application-1-variable-selection.html#cb356-43"></a>    rsq &lt;-<span class="st"> </span><span class="kw">summary</span>(fit_lin)[[<span class="st">&quot;r.squared&quot;</span>]]</span>
<span id="cb356-44"><a href="application-1-variable-selection.html#cb356-44"></a>    df_rsq_candidates &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(df_rsq_candidates, <span class="kw">data.frame</span>(<span class="dt">pred =</span> ipred, <span class="dt">rsq =</span> rsq))  <span class="co"># when storing R2 in a data frame</span></span>
<span id="cb356-45"><a href="application-1-variable-selection.html#cb356-45"></a>    <span class="co"># rsq_candidates &lt;- c(rsq_candidates,  rsq)  # when storing R2 as a vector</span></span>
<span id="cb356-46"><a href="application-1-variable-selection.html#cb356-46"></a>    </span>
<span id="cb356-47"><a href="application-1-variable-selection.html#cb356-47"></a>  }</span>
<span id="cb356-48"><a href="application-1-variable-selection.html#cb356-48"></a>  </span>
<span id="cb356-49"><a href="application-1-variable-selection.html#cb356-49"></a>  <span class="co">## get name of candidate predictor that achieved the highest R2.</span></span>
<span id="cb356-50"><a href="application-1-variable-selection.html#cb356-50"></a>  pred_add &lt;-<span class="st"> </span>df_rsq_candidates <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># when storing R2 in a data frame</span></span>
<span id="cb356-51"><a href="application-1-variable-selection.html#cb356-51"></a><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(rsq)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb356-52"><a href="application-1-variable-selection.html#cb356-52"></a><span class="st">    </span><span class="kw">slice</span>(<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb356-53"><a href="application-1-variable-selection.html#cb356-53"></a><span class="st">    </span><span class="kw">pull</span>(pred) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb356-54"><a href="application-1-variable-selection.html#cb356-54"></a><span class="st">    </span><span class="kw">as.character</span>()</span>
<span id="cb356-55"><a href="application-1-variable-selection.html#cb356-55"></a>  </span>
<span id="cb356-56"><a href="application-1-variable-selection.html#cb356-56"></a>  <span class="co"># pred_add &lt;- preds_candidate[ which.max(rsq_candidates) ]   # when storing R2 as a vector</span></span>
<span id="cb356-57"><a href="application-1-variable-selection.html#cb356-57"></a>  </span>
<span id="cb356-58"><a href="application-1-variable-selection.html#cb356-58"></a>  <span class="co">## add best predictors to retained predictors </span></span>
<span id="cb356-59"><a href="application-1-variable-selection.html#cb356-59"></a>  preds_retained &lt;-<span class="st"> </span><span class="kw">c</span>(preds_retained, pred_add)</span>
<span id="cb356-60"><a href="application-1-variable-selection.html#cb356-60"></a>  </span>
<span id="cb356-61"><a href="application-1-variable-selection.html#cb356-61"></a>  <span class="co">## get the cross-validation R2</span></span>
<span id="cb356-62"><a href="application-1-variable-selection.html#cb356-62"></a>  forml  &lt;-<span class="st"> </span><span class="kw">as.formula</span>(<span class="kw">paste</span>( target, <span class="st">&#39;~&#39;</span>, <span class="kw">paste</span>(preds_retained, <span class="dt">collapse =</span> <span class="st">&#39;+&#39;</span>)))</span>
<span id="cb356-63"><a href="application-1-variable-selection.html#cb356-63"></a>  control &lt;-<span class="st"> </span><span class="kw">trainControl</span>(<span class="dt">method =</span> <span class="st">&quot;cv&quot;</span>, <span class="dt">number =</span> <span class="dv">5</span>)</span>
<span id="cb356-64"><a href="application-1-variable-selection.html#cb356-64"></a>  <span class="kw">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb356-65"><a href="application-1-variable-selection.html#cb356-65"></a>  cv_modl &lt;-<span class="st"> </span><span class="kw">train</span>(forml, <span class="dt">data =</span> df, <span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="dt">metric =</span> <span class="st">&quot;Rsquared&quot;</span>, <span class="dt">trControl =</span> control)</span>
<span id="cb356-66"><a href="application-1-variable-selection.html#cb356-66"></a>  <span class="co"># record AIC and BIC and adjusted-R2 of the respective model</span></span>
<span id="cb356-67"><a href="application-1-variable-selection.html#cb356-67"></a>  df_metrics &lt;-<span class="st"> </span>df_metrics <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb356-68"><a href="application-1-variable-selection.html#cb356-68"></a><span class="st">    </span><span class="kw">bind_rows</span>(</span>
<span id="cb356-69"><a href="application-1-variable-selection.html#cb356-69"></a>      <span class="kw">data.frame</span>( <span class="dt">pred =</span> pred_add,</span>
<span id="cb356-70"><a href="application-1-variable-selection.html#cb356-70"></a>                  <span class="dt">rsq =</span> <span class="kw">summary</span>(linmod_candidates[[ pred_add ]])[[<span class="st">&quot;r.squared&quot;</span>]],</span>
<span id="cb356-71"><a href="application-1-variable-selection.html#cb356-71"></a>                  <span class="dt">adj_rsq =</span> <span class="kw">summary</span>(linmod_candidates[[ pred_add ]])[[<span class="st">&quot;adj.r.squared&quot;</span>]],</span>
<span id="cb356-72"><a href="application-1-variable-selection.html#cb356-72"></a>                  <span class="dt">cv_rsq =</span> cv_modl<span class="op">$</span>results<span class="op">$</span>Rsquared,</span>
<span id="cb356-73"><a href="application-1-variable-selection.html#cb356-73"></a>                  <span class="dt">cv_rmse =</span> cv_modl<span class="op">$</span>results<span class="op">$</span>RMSE,</span>
<span id="cb356-74"><a href="application-1-variable-selection.html#cb356-74"></a>                  <span class="dt">aic =</span> <span class="kw">AIC</span>(linmod_candidates[[ pred_add ]]),</span>
<span id="cb356-75"><a href="application-1-variable-selection.html#cb356-75"></a>                  <span class="dt">bic =</span> <span class="kw">BIC</span>(linmod_candidates[[ pred_add ]])</span>
<span id="cb356-76"><a href="application-1-variable-selection.html#cb356-76"></a>      )</span>
<span id="cb356-77"><a href="application-1-variable-selection.html#cb356-77"></a>    )</span>
<span id="cb356-78"><a href="application-1-variable-selection.html#cb356-78"></a>  </span>
<span id="cb356-79"><a href="application-1-variable-selection.html#cb356-79"></a></span>
<span id="cb356-80"><a href="application-1-variable-selection.html#cb356-80"></a>  <span class="co"># remove the selected variable from the candidate variable list</span></span>
<span id="cb356-81"><a href="application-1-variable-selection.html#cb356-81"></a>  preds_candidate &lt;-<span class="st"> </span>preds_candidate[<span class="op">-</span><span class="kw">which</span>(preds_candidate <span class="op">==</span><span class="st"> </span>pred_add)]</span>
<span id="cb356-82"><a href="application-1-variable-selection.html#cb356-82"></a>  <span class="co"># preds_candidate &lt;- setdiff(preds_candidate,pred_add)  # alternative</span></span>
<span id="cb356-83"><a href="application-1-variable-selection.html#cb356-83"></a>  </span>
<span id="cb356-84"><a href="application-1-variable-selection.html#cb356-84"></a>}</span>
<span id="cb356-85"><a href="application-1-variable-selection.html#cb356-85"></a></span>
<span id="cb356-86"><a href="application-1-variable-selection.html#cb356-86"></a><span class="kw">data.frame</span>(df_metrics<span class="op">$</span>pred) <span class="co"># order in which variables enter the model</span></span></code></pre></div>
<pre><code>##    df_metrics.pred
## 1          PPFD_IN
## 2      LW_IN_F_MDS
## 3            VPD_F
## 4             WS_F
## 5      SW_IN_F_MDS
## 6        CO2_F_MDS
## 7             TA_F
## 8             PA_F
## 9         TA_F_MDS
## 10           USTAR
## 11             P_F
## 12       VPD_F_MDS
## 13         LW_IN_F
## 14         SW_IN_F</code></pre>
<div class="sourceCode" id="cb358"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb358-1"><a href="application-1-variable-selection.html#cb358-1"></a>df_metrics <span class="op">%&gt;%</span><span class="st"> </span>knitr<span class="op">::</span><span class="kw">kable</span>()</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">pred</th>
<th align="right">rsq</th>
<th align="right">adj_rsq</th>
<th align="right">cv_rsq</th>
<th align="right">cv_rmse</th>
<th align="right">aic</th>
<th align="right">bic</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">PPFD_IN</td>
<td align="right">0.5276123</td>
<td align="right">0.5274601</td>
<td align="right">0.5286098</td>
<td align="right">2.946732</td>
<td align="right">15529.18</td>
<td align="right">15547.30</td>
</tr>
<tr class="even">
<td align="left">LW_IN_F_MDS</td>
<td align="right">0.6237535</td>
<td align="right">0.6235110</td>
<td align="right">0.6244311</td>
<td align="right">2.631186</td>
<td align="right">14824.62</td>
<td align="right">14848.78</td>
</tr>
<tr class="odd">
<td align="left">VPD_F</td>
<td align="right">0.6482531</td>
<td align="right">0.6479128</td>
<td align="right">0.6488913</td>
<td align="right">2.544541</td>
<td align="right">14617.55</td>
<td align="right">14647.76</td>
</tr>
<tr class="even">
<td align="left">WS_F</td>
<td align="right">0.6640335</td>
<td align="right">0.6636000</td>
<td align="right">0.6644851</td>
<td align="right">2.486970</td>
<td align="right">14477.03</td>
<td align="right">14513.28</td>
</tr>
<tr class="odd">
<td align="left">SW_IN_F_MDS</td>
<td align="right">0.6669387</td>
<td align="right">0.6664013</td>
<td align="right">0.6672468</td>
<td align="right">2.476793</td>
<td align="right">14452.07</td>
<td align="right">14494.35</td>
</tr>
<tr class="even">
<td align="left">CO2_F_MDS</td>
<td align="right">0.6696209</td>
<td align="right">0.6689811</td>
<td align="right">0.6695521</td>
<td align="right">2.467823</td>
<td align="right">14428.96</td>
<td align="right">14477.28</td>
</tr>
<tr class="odd">
<td align="left">TA_F</td>
<td align="right">0.6708789</td>
<td align="right">0.6701350</td>
<td align="right">0.6703978</td>
<td align="right">2.464609</td>
<td align="right">14419.11</td>
<td align="right">14473.48</td>
</tr>
<tr class="even">
<td align="left">PA_F</td>
<td align="right">0.6726644</td>
<td align="right">0.6718185</td>
<td align="right">0.6718171</td>
<td align="right">2.459555</td>
<td align="right">14404.22</td>
<td align="right">14464.63</td>
</tr>
<tr class="odd">
<td align="left">TA_F_MDS</td>
<td align="right">0.6730699</td>
<td align="right">0.6721192</td>
<td align="right">0.6642220</td>
<td align="right">2.487336</td>
<td align="right">14402.37</td>
<td align="right">14468.82</td>
</tr>
<tr class="even">
<td align="left">USTAR</td>
<td align="right">0.6733802</td>
<td align="right">0.6723246</td>
<td align="right">0.6639334</td>
<td align="right">2.488412</td>
<td align="right">14401.42</td>
<td align="right">14473.91</td>
</tr>
<tr class="odd">
<td align="left">P_F</td>
<td align="right">0.6735098</td>
<td align="right">0.6723487</td>
<td align="right">0.6638548</td>
<td align="right">2.488747</td>
<td align="right">14402.19</td>
<td align="right">14480.72</td>
</tr>
<tr class="even">
<td align="left">VPD_F_MDS</td>
<td align="right">0.6735755</td>
<td align="right">0.6723086</td>
<td align="right">0.6624537</td>
<td align="right">2.493879</td>
<td align="right">14403.57</td>
<td align="right">14488.14</td>
</tr>
<tr class="odd">
<td align="left">LW_IN_F</td>
<td align="right">0.6736125</td>
<td align="right">0.6722398</td>
<td align="right">0.6623996</td>
<td align="right">2.494079</td>
<td align="right">14405.22</td>
<td align="right">14495.83</td>
</tr>
<tr class="even">
<td align="left">SW_IN_F</td>
<td align="right">0.6736372</td>
<td align="right">0.6721585</td>
<td align="right">0.6620120</td>
<td align="right">2.495602</td>
<td align="right">14406.98</td>
<td align="right">14503.63</td>
</tr>
</tbody>
</table>
<ul>
<li>Visualise all metrics as a function of the number of predictors (add labels for the variable names of the added predictor). Highlight the best-performing model based on the respective metric. How many predictors are in the best performing model, when assessed based on each metric?</li>
</ul>
<div class="sourceCode" id="cb359"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb359-1"><a href="application-1-variable-selection.html#cb359-1"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb359-2"><a href="application-1-variable-selection.html#cb359-2"></a></span>
<span id="cb359-3"><a href="application-1-variable-selection.html#cb359-3"></a>df_metrics<span class="op">$</span>pred &lt;-<span class="st">  </span><span class="kw">factor</span>(df_metrics<span class="op">$</span>pred, <span class="dt">levels =</span> df_metrics<span class="op">$</span>pred)</span>
<span id="cb359-4"><a href="application-1-variable-selection.html#cb359-4"></a></span>
<span id="cb359-5"><a href="application-1-variable-selection.html#cb359-5"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb359-6"><a href="application-1-variable-selection.html#cb359-6"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> rsq)) <span class="op">+</span></span>
<span id="cb359-7"><a href="application-1-variable-selection.html#cb359-7"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics, rsq <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(rsq)), <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> rsq), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb359-8"><a href="application-1-variable-selection.html#cb359-8"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">expression</span>(<span class="kw">italic</span>(R)<span class="op">^</span><span class="dv">2</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb359-9"><a href="application-1-variable-selection.html#cb359-9"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-197-1.png" width="672" /></p>
<div class="sourceCode" id="cb360"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb360-1"><a href="application-1-variable-selection.html#cb360-1"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb360-2"><a href="application-1-variable-selection.html#cb360-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> adj_rsq)) <span class="op">+</span></span>
<span id="cb360-3"><a href="application-1-variable-selection.html#cb360-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics, adj_rsq <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(adj_rsq)), <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> adj_rsq), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb360-4"><a href="application-1-variable-selection.html#cb360-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;Adjusted-&quot;</span>, <span class="kw">italic</span>(R)<span class="op">^</span><span class="dv">2</span>))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb360-5"><a href="application-1-variable-selection.html#cb360-5"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-197-2.png" width="672" /></p>
<div class="sourceCode" id="cb361"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb361-1"><a href="application-1-variable-selection.html#cb361-1"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb361-2"><a href="application-1-variable-selection.html#cb361-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> cv_rsq)) <span class="op">+</span></span>
<span id="cb361-3"><a href="application-1-variable-selection.html#cb361-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics, cv_rsq <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(cv_rsq)), <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> cv_rsq), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb361-4"><a href="application-1-variable-selection.html#cb361-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;Cross-validated &quot;</span>, <span class="kw">italic</span>(R)<span class="op">^</span><span class="dv">2</span>))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb361-5"><a href="application-1-variable-selection.html#cb361-5"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-197-3.png" width="672" /></p>
<div class="sourceCode" id="cb362"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb362-1"><a href="application-1-variable-selection.html#cb362-1"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb362-2"><a href="application-1-variable-selection.html#cb362-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> cv_rmse)) <span class="op">+</span></span>
<span id="cb362-3"><a href="application-1-variable-selection.html#cb362-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics, cv_rmse <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(cv_rmse)), <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> cv_rmse), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb362-4"><a href="application-1-variable-selection.html#cb362-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;Cross-validated &quot;</span>, RMSE))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb362-5"><a href="application-1-variable-selection.html#cb362-5"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-197-4.png" width="672" /></p>
<div class="sourceCode" id="cb363"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb363-1"><a href="application-1-variable-selection.html#cb363-1"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb363-2"><a href="application-1-variable-selection.html#cb363-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> aic)) <span class="op">+</span></span>
<span id="cb363-3"><a href="application-1-variable-selection.html#cb363-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics, aic <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(aic)), <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> aic), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb363-4"><a href="application-1-variable-selection.html#cb363-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;AIC&quot;</span>)<span class="op">+</span><span class="st"> </span></span>
<span id="cb363-5"><a href="application-1-variable-selection.html#cb363-5"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-197-5.png" width="672" /></p>
<div class="sourceCode" id="cb364"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb364-1"><a href="application-1-variable-selection.html#cb364-1"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb364-2"><a href="application-1-variable-selection.html#cb364-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics, <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> bic)) <span class="op">+</span></span>
<span id="cb364-3"><a href="application-1-variable-selection.html#cb364-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics, bic <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(bic)), <span class="kw">aes</span>(<span class="dt">x =</span> pred, <span class="dt">y =</span> bic), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb364-4"><a href="application-1-variable-selection.html#cb364-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;BIC&quot;</span>)<span class="op">+</span><span class="st"> </span></span>
<span id="cb364-5"><a href="application-1-variable-selection.html#cb364-5"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-197-6.png" width="672" /></p>
<ul>
<li>Observe which predictors are selected into the final model and which not. Why?</li>
</ul>
<p><em>Solution:</em>
Take the best model selected by BIC as an example, <code>VPD_F</code> is selected into the model and <code>VPD_F_MDS</code> is not. They won’t enter the model both because they are highly correlated and when one is in, the other doesn’t add information, which proves our expectation in the previous question.</p>
<ul>
<li>Whether it matters to the order of variables entering into the model which metric (i.e. AIC, BIC or <span class="math inline">\(R^2\)</span>) is used? Why?</li>
</ul>
<p><em>Solution:</em>
No, it doesn’t matter. For each inner loop, when deciding which variable is sequentially chosen, we compare models of the same level (i.e. same number of variables). In this sense, model complexities for all the models are the same, and AIC/BIC only compares the goodness of fit part, which works the same as <span class="math inline">\(R^2\)</span>.</p>
<ul>
<li>Discuss your results. Which metric do you trust most? Why? Try out your algorithm without evaluating the cross-validated <span class="math inline">\(R^2\)</span>. Do you get a computational efficiency gain? Which metric comes closest to the cross-validated <span class="math inline">\(R^2\)</span> in terms of selecting the same number predictors?</li>
</ul>
<p><em>Solution:</em>
Cross-validated <span class="math inline">\(R^2\)</span> is the “gold-standard” for assessing generalisability. However, it is computationally costly and may not provide robust results when the data set is small. Since AIC and BIC both penalise additional predictors, they both don’t select the full model with 14 variables as the best model (However, it could happen that the best model selected by AIC/BIC is the full model). The BIC selects for the same number of predictors as the cross-validated <span class="math inline">\(R^2\)</span> and RMSE, but without the disadvantage of the computational costs. It provides a conservative and apparently robust estimate for the model generalisability. Note that the order of added predictors is determined by the simple <span class="math inline">\(R^2\)</span> and is therefore independent of the final metrics we use for choosing the best <span class="math inline">\(k\)</span>.</p>
</div>
<div id="bonus-stepwise-regression-out-of-the-box-1" class="section level2">
<h2><span class="header-section-number">9.8</span> <a href="supervised-machine-learning-basics-i.html#bonus">BONUS</a> Stepwise regression out-of-the-box</h2>
<p>In R, you can also conduct the above variable selection procedures automatically. <code>regsubsets()</code> from leaps package provides a convenient way to do so. It does model selection by exhaustive search, including forward or backward stepwise regression.</p>
<ul>
<li>Do a stepwise forward regression using <code>regsubsets()</code>.</li>
<li>Create a data frame with the same metrics as above (except cross-validated <span class="math inline">\(R^2\)</span>).</li>
<li>Visualise metrics as above.</li>
<li>Are your result consistent?</li>
</ul>
<p><em>Hints</em>:</p>
<ul>
<li>Specify stepwise <em>forward</em> by setting <code>method = "forward"</code>.</li>
<li>Specify the number of predictors to examine, that is all fourteen, by setting <code>nvmax = 14</code>.</li>
<li>AIC values of each step are stored in <code>summary(regfit.fwd)$cp</code> and BIC values of each step are in <code>summary(regfit.fwd)$bic</code>, etc.</li>
<li>Get order in which predictors <span class="math inline">\(k\)</span> are added (which corresponds to values returned by <code>summary(regfit.fwd)$bic</code>), by <code>all_predictors[regfit.fwd$vorder[2:15]-1]</code>. <code>vorder</code> is the order of variables entering into model. Note that <code>Intercept</code> is counted here as the first to enter into the model and should be removed.</li>
<li>To avoid reordering of the list of variable names in plotting, change the type of variable names from “character” to “factor” by <code>preds_enter &lt;- factor(preds_enter, levels = preds_enter)</code></li>
</ul>
<div class="sourceCode" id="cb365"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb365-1"><a href="application-1-variable-selection.html#cb365-1"></a><span class="kw">library</span>(leaps)</span>
<span id="cb365-2"><a href="application-1-variable-selection.html#cb365-2"></a>regfit.fwd &lt;-<span class="st"> </span><span class="kw">regsubsets</span>(<span class="kw">as.formula</span>(<span class="kw">paste</span>(target, <span class="st">&quot;~&quot;</span>, <span class="kw">paste</span>(preds,<span class="dt">collapse=</span><span class="st">&quot; + &quot;</span>))), <span class="dt">data =</span> df, <span class="dt">method =</span> <span class="st">&quot;forward&quot;</span>, <span class="dt">nvmax =</span> <span class="dv">14</span>)</span>
<span id="cb365-3"><a href="application-1-variable-selection.html#cb365-3"></a>reg.summary &lt;-<span class="st"> </span><span class="kw">summary</span>(regfit.fwd)</span>
<span id="cb365-4"><a href="application-1-variable-selection.html#cb365-4"></a></span>
<span id="cb365-5"><a href="application-1-variable-selection.html#cb365-5"></a><span class="co"># get variables in their order added to the model</span></span>
<span id="cb365-6"><a href="application-1-variable-selection.html#cb365-6"></a>preds_enter &lt;-<span class="st"> </span>preds[regfit.fwd<span class="op">$</span>vorder[<span class="dv">2</span><span class="op">:</span><span class="dv">15</span>]<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb365-7"><a href="application-1-variable-selection.html#cb365-7"></a></span>
<span id="cb365-8"><a href="application-1-variable-selection.html#cb365-8"></a><span class="co">## create metrics data frame</span></span>
<span id="cb365-9"><a href="application-1-variable-selection.html#cb365-9"></a>df_metrics_auto &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb365-10"><a href="application-1-variable-selection.html#cb365-10"></a>  <span class="dt">preds =</span> <span class="kw">factor</span>(preds_enter, <span class="dt">levels =</span> preds_enter),</span>
<span id="cb365-11"><a href="application-1-variable-selection.html#cb365-11"></a>  <span class="dt">rsq =</span> reg.summary<span class="op">$</span>rsq, </span>
<span id="cb365-12"><a href="application-1-variable-selection.html#cb365-12"></a>  <span class="dt">adj_rsq =</span> reg.summary<span class="op">$</span>adjr2, </span>
<span id="cb365-13"><a href="application-1-variable-selection.html#cb365-13"></a>  <span class="dt">aic =</span> reg.summary<span class="op">$</span>cp, </span>
<span id="cb365-14"><a href="application-1-variable-selection.html#cb365-14"></a>  <span class="dt">bic =</span> reg.summary<span class="op">$</span>bic</span>
<span id="cb365-15"><a href="application-1-variable-selection.html#cb365-15"></a>  )</span>
<span id="cb365-16"><a href="application-1-variable-selection.html#cb365-16"></a></span>
<span id="cb365-17"><a href="application-1-variable-selection.html#cb365-17"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb365-18"><a href="application-1-variable-selection.html#cb365-18"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics_auto, <span class="kw">aes</span>(<span class="dt">x =</span> preds, <span class="dt">y =</span> rsq)) <span class="op">+</span></span>
<span id="cb365-19"><a href="application-1-variable-selection.html#cb365-19"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics_auto, rsq <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(rsq)), <span class="kw">aes</span>(<span class="dt">x =</span> preds, <span class="dt">y =</span> rsq), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb365-20"><a href="application-1-variable-selection.html#cb365-20"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">expression</span>(<span class="kw">italic</span>(R)<span class="op">^</span><span class="dv">2</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb365-21"><a href="application-1-variable-selection.html#cb365-21"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-198-1.png" width="672" /></p>
<div class="sourceCode" id="cb366"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb366-1"><a href="application-1-variable-selection.html#cb366-1"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb366-2"><a href="application-1-variable-selection.html#cb366-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics_auto, <span class="kw">aes</span>(<span class="dt">x =</span> preds, <span class="dt">y =</span> adj_rsq)) <span class="op">+</span></span>
<span id="cb366-3"><a href="application-1-variable-selection.html#cb366-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics_auto, adj_rsq <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(adj_rsq)), <span class="kw">aes</span>(<span class="dt">x =</span> preds, <span class="dt">y =</span> adj_rsq), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb366-4"><a href="application-1-variable-selection.html#cb366-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;Adjusted-&quot;</span>, <span class="kw">italic</span>(R)<span class="op">^</span><span class="dv">2</span>))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb366-5"><a href="application-1-variable-selection.html#cb366-5"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-198-2.png" width="672" /></p>
<div class="sourceCode" id="cb367"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb367-1"><a href="application-1-variable-selection.html#cb367-1"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb367-2"><a href="application-1-variable-selection.html#cb367-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics_auto, <span class="kw">aes</span>(<span class="dt">x =</span> preds, <span class="dt">y =</span> aic)) <span class="op">+</span></span>
<span id="cb367-3"><a href="application-1-variable-selection.html#cb367-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics_auto, aic <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(aic)), <span class="kw">aes</span>(<span class="dt">x =</span> preds, <span class="dt">y =</span> aic), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb367-4"><a href="application-1-variable-selection.html#cb367-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;AIC&quot;</span>)<span class="op">+</span><span class="st"> </span></span>
<span id="cb367-5"><a href="application-1-variable-selection.html#cb367-5"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-198-3.png" width="672" /></p>
<div class="sourceCode" id="cb368"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb368-1"><a href="application-1-variable-selection.html#cb368-1"></a><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb368-2"><a href="application-1-variable-selection.html#cb368-2"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> df_metrics_auto, <span class="kw">aes</span>(<span class="dt">x =</span> preds, <span class="dt">y =</span> bic)) <span class="op">+</span></span>
<span id="cb368-3"><a href="application-1-variable-selection.html#cb368-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">filter</span>(df_metrics_auto, bic <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(bic)), <span class="kw">aes</span>(<span class="dt">x =</span> preds, <span class="dt">y =</span> bic), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span></span>
<span id="cb368-4"><a href="application-1-variable-selection.html#cb368-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;BIC&quot;</span>)<span class="op">+</span><span class="st"> </span></span>
<span id="cb368-5"><a href="application-1-variable-selection.html#cb368-5"></a><span class="st">  </span><span class="kw">coord_flip</span>()</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-198-4.png" width="672" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="supervised-machine-learning-methods-ii.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="xxx.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["esds_book.pdf", "esds_book.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
