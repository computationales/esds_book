<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 10 Supervised Neural Networks II | Environmental Systems Data Science</title>
  <meta name="description" content="Tutorial and exercises for Environmental System Data Science, ETH Zürich." />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 10 Supervised Neural Networks II | Environmental Systems Data Science" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Tutorial and exercises for Environmental System Data Science, ETH Zürich." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 10 Supervised Neural Networks II | Environmental Systems Data Science" />
  
  <meta name="twitter:description" content="Tutorial and exercises for Environmental System Data Science, ETH Zürich." />
  

<meta name="author" content="Loïc Pellissier, Joshua Payne, Benjamin Stocker" />


<meta name="date" content="2021-12-30" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="ch-09.html"/>
<link rel="next" href="ch-11.html"/>
<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Prerequisites</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#course-description"><i class="fa fa-check"></i>Course Description</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#course-objectives"><i class="fa fa-check"></i>Course Objectives</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#content"><i class="fa fa-check"></i>Content</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#useful-prerequisites"><i class="fa fa-check"></i>Useful Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="ch-01.html"><a href="ch-01.html"><i class="fa fa-check"></i><b>1</b> Primers</a>
<ul>
<li class="chapter" data-level="1.1" data-path="ch-01.html"><a href="ch-01.html#introduction"><i class="fa fa-check"></i><b>1.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="ch-01.html"><a href="ch-01.html#key-points-from-the-lecture"><i class="fa fa-check"></i><b>1.1.1</b> Key Points from the lecture</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="ch-01.html"><a href="ch-01.html#tutorial"><i class="fa fa-check"></i><b>1.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="ch-01.html"><a href="ch-01.html#working-with-rstudio-on-renku"><i class="fa fa-check"></i><b>1.2.1</b> Working with RStudio on Renku</a></li>
<li class="chapter" data-level="1.2.2" data-path="ch-01.html"><a href="ch-01.html#git"><i class="fa fa-check"></i><b>1.2.2</b> Git</a></li>
<li class="chapter" data-level="1.2.3" data-path="ch-01.html"><a href="ch-01.html#libraries"><i class="fa fa-check"></i><b>1.2.3</b> Libraries</a></li>
<li class="chapter" data-level="1.2.4" data-path="ch-01.html"><a href="ch-01.html#r-scripts"><i class="fa fa-check"></i><b>1.2.4</b> R scripts</a></li>
<li class="chapter" data-level="1.2.5" data-path="ch-01.html"><a href="ch-01.html#rmarkdown"><i class="fa fa-check"></i><b>1.2.5</b> RMarkdown</a></li>
<li class="chapter" data-level="1.2.6" data-path="ch-01.html"><a href="ch-01.html#functions"><i class="fa fa-check"></i><b>1.2.6</b> Functions</a></li>
<li class="chapter" data-level="1.2.7" data-path="ch-01.html"><a href="ch-01.html#tidy-data"><i class="fa fa-check"></i><b>1.2.7</b> Tidy data</a></li>
<li class="chapter" data-level="1.2.8" data-path="ch-01.html"><a href="ch-01.html#r-projects"><i class="fa fa-check"></i><b>1.2.8</b> R projects</a></li>
<li class="chapter" data-level="1.2.9" data-path="ch-01.html"><a href="ch-01.html#working-with-data-frames"><i class="fa fa-check"></i><b>1.2.9</b> Working with data frames</a></li>
<li class="chapter" data-level="1.2.10" data-path="ch-01.html"><a href="ch-01.html#r-objects"><i class="fa fa-check"></i><b>1.2.10</b> R objects</a></li>
<li class="chapter" data-level="1.2.11" data-path="ch-01.html"><a href="ch-01.html#data-visualisation"><i class="fa fa-check"></i><b>1.2.11</b> Data visualisation</a></li>
<li class="chapter" data-level="1.2.12" data-path="ch-01.html"><a href="ch-01.html#conditionals"><i class="fa fa-check"></i><b>1.2.12</b> Conditionals</a></li>
<li class="chapter" data-level="1.2.13" data-path="ch-01.html"><a href="ch-01.html#loops"><i class="fa fa-check"></i><b>1.2.13</b> Loops</a></li>
<li class="chapter" data-level="1.2.14" data-path="ch-01.html"><a href="ch-01.html#where-to-find-help"><i class="fa fa-check"></i><b>1.2.14</b> Where to find help</a></li>
<li class="chapter" data-level="1.2.15" data-path="ch-01.html"><a href="ch-01.html#key-points-from-the-tutorial"><i class="fa fa-check"></i><b>1.2.15</b> Key points from the tutorial</a></li>
<li class="chapter" data-level="1.2.16" data-path="ch-01.html"><a href="ch-01.html#further-reading"><i class="fa fa-check"></i><b>1.2.16</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="ch-01.html"><a href="ch-01.html#exercise"><i class="fa fa-check"></i><b>1.3</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="ch-02.html"><a href="ch-02.html"><i class="fa fa-check"></i><b>2</b> Data wrangling</a>
<ul>
<li class="chapter" data-level="2.1" data-path="ch-02.html"><a href="ch-02.html#introduction-1"><i class="fa fa-check"></i><b>2.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="ch-02.html"><a href="ch-02.html#learning-objectives"><i class="fa fa-check"></i><b>2.1.1</b> Learning objectives</a></li>
<li class="chapter" data-level="2.1.2" data-path="ch-02.html"><a href="ch-02.html#key-points-from-the-lecture-1"><i class="fa fa-check"></i><b>2.1.2</b> Key points from the lecture</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="ch-02.html"><a href="ch-02.html#tutorial-1"><i class="fa fa-check"></i><b>2.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="ch-02.html"><a href="ch-02.html#libraries-1"><i class="fa fa-check"></i><b>2.2.1</b> Libraries</a></li>
<li class="chapter" data-level="2.2.2" data-path="ch-02.html"><a href="ch-02.html#variables-in-a-data-frame"><i class="fa fa-check"></i><b>2.2.2</b> Variables in a data frame</a></li>
<li class="chapter" data-level="2.2.3" data-path="ch-02.html"><a href="ch-02.html#time-objects"><i class="fa fa-check"></i><b>2.2.3</b> Time objects</a></li>
<li class="chapter" data-level="2.2.4" data-path="ch-02.html"><a href="ch-02.html#variable-re--definition"><i class="fa fa-check"></i><b>2.2.4</b> Variable (re-) definition</a></li>
<li class="chapter" data-level="2.2.5" data-path="ch-02.html"><a href="ch-02.html#selecting-cleaning-and-gap-filling"><i class="fa fa-check"></i><b>2.2.5</b> Selecting, cleaning and gap-filling</a></li>
<li class="chapter" data-level="2.2.6" data-path="ch-02.html"><a href="ch-02.html#functions-1"><i class="fa fa-check"></i><b>2.2.6</b> Functions</a></li>
<li class="chapter" data-level="2.2.7" data-path="ch-02.html"><a href="ch-02.html#data-overview"><i class="fa fa-check"></i><b>2.2.7</b> Data overview</a></li>
<li class="chapter" data-level="2.2.8" data-path="ch-02.html"><a href="ch-02.html#data-visualisation-i"><i class="fa fa-check"></i><b>2.2.8</b> Data visualisation I</a></li>
<li class="chapter" data-level="2.2.9" data-path="ch-02.html"><a href="ch-02.html#aggregating"><i class="fa fa-check"></i><b>2.2.9</b> Aggregating</a></li>
<li class="chapter" data-level="2.2.10" data-path="ch-02.html"><a href="ch-02.html#data-visualisation-ii"><i class="fa fa-check"></i><b>2.2.10</b> Data visualisation II</a></li>
<li class="chapter" data-level="2.2.11" data-path="ch-02.html"><a href="ch-02.html#functional-programming-i"><i class="fa fa-check"></i><b>2.2.11</b> Functional programming I</a></li>
<li class="chapter" data-level="2.2.12" data-path="ch-02.html"><a href="ch-02.html#strings"><i class="fa fa-check"></i><b>2.2.12</b> Strings</a></li>
<li class="chapter" data-level="2.2.13" data-path="ch-02.html"><a href="ch-02.html#combining-relational-data"><i class="fa fa-check"></i><b>2.2.13</b> Combining relational data</a></li>
<li class="chapter" data-level="2.2.14" data-path="ch-02.html"><a href="ch-02.html#key-points-from-the-tutorial-1"><i class="fa fa-check"></i><b>2.2.14</b> Key points from the tutorial</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="ch-02.html"><a href="ch-02.html#exercise-1"><i class="fa fa-check"></i><b>2.3</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="ch-03.html"><a href="ch-03.html"><i class="fa fa-check"></i><b>3</b> Data variety</a>
<ul>
<li class="chapter" data-level="3.1" data-path="ch-03.html"><a href="ch-03.html#introduction-2"><i class="fa fa-check"></i><b>3.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="ch-03.html"><a href="ch-03.html#overview"><i class="fa fa-check"></i><b>3.1.1</b> Overview</a></li>
<li class="chapter" data-level="3.1.2" data-path="ch-03.html"><a href="ch-03.html#learning-objectives-1"><i class="fa fa-check"></i><b>3.1.2</b> Learning objectives</a></li>
<li class="chapter" data-level="3.1.3" data-path="ch-03.html"><a href="ch-03.html#key-points-from-the-lecture-2"><i class="fa fa-check"></i><b>3.1.3</b> Key points from the lecture</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="ch-03.html"><a href="ch-03.html#tutorial-2"><i class="fa fa-check"></i><b>3.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="ch-03.html"><a href="ch-03.html#overview-1"><i class="fa fa-check"></i><b>3.2.1</b> Overview</a></li>
<li class="chapter" data-level="3.2.2" data-path="ch-03.html"><a href="ch-03.html#modis-remote-download"><i class="fa fa-check"></i><b>3.2.2</b> MODIS remote download</a></li>
<li class="chapter" data-level="3.2.3" data-path="ch-03.html"><a href="ch-03.html#points-on-the-globe"><i class="fa fa-check"></i><b>3.2.3</b> Points on the globe</a></li>
<li class="chapter" data-level="3.2.4" data-path="ch-03.html"><a href="ch-03.html#shapefiles"><i class="fa fa-check"></i><b>3.2.4</b> Shapefiles</a></li>
<li class="chapter" data-level="3.2.5" data-path="ch-03.html"><a href="ch-03.html#rasters"><i class="fa fa-check"></i><b>3.2.5</b> Rasters</a></li>
<li class="chapter" data-level="3.2.6" data-path="ch-03.html"><a href="ch-03.html#key-points-from-the-tutorial-2"><i class="fa fa-check"></i><b>3.2.6</b> Key points from the tutorial</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="ch-03.html"><a href="ch-03.html#exercise-2"><i class="fa fa-check"></i><b>3.3</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="ch-04.html"><a href="ch-04.html"><i class="fa fa-check"></i><b>4</b> Data Scraping</a>
<ul>
<li class="chapter" data-level="4.1" data-path="ch-04.html"><a href="ch-04.html#introduction-3"><i class="fa fa-check"></i><b>4.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="ch-04.html"><a href="ch-04.html#key-points-from-the-lecture-3"><i class="fa fa-check"></i><b>4.1.1</b> Key points from the lecture</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="ch-04.html"><a href="ch-04.html#tutorial-3"><i class="fa fa-check"></i><b>4.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="ch-04.html"><a href="ch-04.html#r-packages-and-functions"><i class="fa fa-check"></i><b>4.2.1</b> R-Packages and Functions</a></li>
<li class="chapter" data-level="4.2.2" data-path="ch-04.html"><a href="ch-04.html#the-fishbase-website"><i class="fa fa-check"></i><b>4.2.2</b> The FishBase website</a></li>
<li class="chapter" data-level="4.2.3" data-path="ch-04.html"><a href="ch-04.html#accessing-fishbase"><i class="fa fa-check"></i><b>4.2.3</b> Accessing FishBase</a></li>
<li class="chapter" data-level="4.2.4" data-path="ch-04.html"><a href="ch-04.html#scraping-numbers"><i class="fa fa-check"></i><b>4.2.4</b> Scraping Numbers</a></li>
<li class="chapter" data-level="4.2.5" data-path="ch-04.html"><a href="ch-04.html#scraping-text-snippetrs"><i class="fa fa-check"></i><b>4.2.5</b> Scraping Text Snippetrs</a></li>
<li class="chapter" data-level="4.2.6" data-path="ch-04.html"><a href="ch-04.html#scraping-tables"><i class="fa fa-check"></i><b>4.2.6</b> Scraping Tables</a></li>
<li class="chapter" data-level="4.2.7" data-path="ch-04.html"><a href="ch-04.html#the-fishbase-package"><i class="fa fa-check"></i><b>4.2.7</b> The Fishbase Package</a></li>
<li class="chapter" data-level="4.2.8" data-path="ch-04.html"><a href="ch-04.html#summary"><i class="fa fa-check"></i><b>4.2.8</b> Summary</a></li>
<li class="chapter" data-level="4.2.9" data-path="ch-04.html"><a href="ch-04.html#case-study"><i class="fa fa-check"></i><b>4.2.9</b> Case Study</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="ch-04.html"><a href="ch-04.html#exercise-3"><i class="fa fa-check"></i><b>4.3</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="ch-05.html"><a href="ch-05.html"><i class="fa fa-check"></i><b>5</b> Catch-up</a>
<ul>
<li class="chapter" data-level="5.1" data-path="ch-05.html"><a href="ch-05.html#loops-in-r"><i class="fa fa-check"></i><b>5.1</b> Loops in R</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="ch-05.html"><a href="ch-05.html#some-simple-examples"><i class="fa fa-check"></i><b>5.1.1</b> Some simple examples</a></li>
<li class="chapter" data-level="5.1.2" data-path="ch-05.html"><a href="ch-05.html#nested-loops"><i class="fa fa-check"></i><b>5.1.2</b> Nested loops</a></li>
<li class="chapter" data-level="5.1.3" data-path="ch-05.html"><a href="ch-05.html#exercise-4"><i class="fa fa-check"></i><b>5.1.3</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="ch-05.html"><a href="ch-05.html#functional-programming-using-purr"><i class="fa fa-check"></i><b>5.2</b> Functional programming using purr</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="ch-05.html"><a href="ch-05.html#shortcuts-in-a-purrr-function"><i class="fa fa-check"></i><b>5.2.1</b> Shortcuts in a <code>purrr</code> function</a></li>
<li class="chapter" data-level="5.2.2" data-path="ch-05.html"><a href="ch-05.html#workflow-nested-data-map-and-mutate"><i class="fa fa-check"></i><b>5.2.2</b> Workflow: nested data, map and mutate</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="ch-05.html"><a href="ch-05.html#string-manipulations"><i class="fa fa-check"></i><b>5.3</b> String Manipulations</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="ch-05.html"><a href="ch-05.html#introduction-to-strings"><i class="fa fa-check"></i><b>5.3.1</b> Introduction to strings</a></li>
<li class="chapter" data-level="5.3.2" data-path="ch-05.html"><a href="ch-05.html#matching-and-extracting-patterns"><i class="fa fa-check"></i><b>5.3.2</b> Matching and extracting patterns</a></li>
<li class="chapter" data-level="5.3.3" data-path="ch-05.html"><a href="ch-05.html#advanced-example"><i class="fa fa-check"></i><b>5.3.3</b> Advanced example</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="ch-05.html"><a href="ch-05.html#web-scraping-in-a-nut-shell"><i class="fa fa-check"></i><b>5.4</b> Web-scraping in a nut-shell</a></li>
<li class="chapter" data-level="5.5" data-path="ch-05.html"><a href="ch-05.html#tidyverses-filter-and-select"><i class="fa fa-check"></i><b>5.5</b> Tidyverse’s filter and select</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="ch-05.html"><a href="ch-05.html#introduction-4"><i class="fa fa-check"></i><b>5.5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.5.2" data-path="ch-05.html"><a href="ch-05.html#select"><i class="fa fa-check"></i><b>5.5.2</b> Select()</a></li>
<li class="chapter" data-level="5.5.3" data-path="ch-05.html"><a href="ch-05.html#filter"><i class="fa fa-check"></i><b>5.5.3</b> Filter()</a></li>
<li class="chapter" data-level="5.5.4" data-path="ch-05.html"><a href="ch-05.html#exercises"><i class="fa fa-check"></i><b>5.5.4</b> Exercises</a></li>
<li class="chapter" data-level="5.5.5" data-path="ch-05.html"><a href="ch-05.html#solutions"><i class="fa fa-check"></i><b>5.5.5</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="ch-05.html"><a href="ch-05.html#preparing-data-for-ggplot"><i class="fa fa-check"></i><b>5.6</b> Preparing data for ggplot()</a></li>
<li class="chapter" data-level="5.7" data-path="ch-05.html"><a href="ch-05.html#base-r-functions"><i class="fa fa-check"></i><b>5.7</b> Base R functions</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="ch-06.html"><a href="ch-06.html"><i class="fa fa-check"></i><b>6</b> Supervised Machine Learning I</a>
<ul>
<li class="chapter" data-level="6.1" data-path="ch-06.html"><a href="ch-06.html#introduction-5"><i class="fa fa-check"></i><b>6.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="ch-06.html"><a href="ch-06.html#learning-objectives-2"><i class="fa fa-check"></i><b>6.1.1</b> Learning objectives</a></li>
<li class="chapter" data-level="6.1.2" data-path="ch-06.html"><a href="ch-06.html#important-points-from-the-lecture"><i class="fa fa-check"></i><b>6.1.2</b> Important points from the lecture</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="ch-06.html"><a href="ch-06.html#tutorial-4"><i class="fa fa-check"></i><b>6.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="ch-06.html"><a href="ch-06.html#overfitting"><i class="fa fa-check"></i><b>6.2.1</b> Overfitting</a></li>
<li class="chapter" data-level="6.2.2" data-path="ch-06.html"><a href="ch-06.html#motivation"><i class="fa fa-check"></i><b>6.2.2</b> Modelling challenge</a></li>
<li class="chapter" data-level="6.2.3" data-path="ch-06.html"><a href="ch-06.html#a-selection-of-model-types"><i class="fa fa-check"></i><b>6.2.3</b> A selection of model types</a></li>
<li class="chapter" data-level="6.2.4" data-path="ch-06.html"><a href="ch-06.html#data-splitting"><i class="fa fa-check"></i><b>6.2.4</b> Data splitting</a></li>
<li class="chapter" data-level="6.2.5" data-path="ch-06.html"><a href="ch-06.html#preprocessing"><i class="fa fa-check"></i><b>6.2.5</b> Pre-processing</a></li>
<li class="chapter" data-level="6.2.6" data-path="ch-06.html"><a href="ch-06.html#model-formulation"><i class="fa fa-check"></i><b>6.2.6</b> Model formulation</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="ch-06.html"><a href="ch-06.html#exercise-5"><i class="fa fa-check"></i><b>6.3</b> Exercise</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="ch-06.html"><a href="ch-06.html#reading-and-cleaning"><i class="fa fa-check"></i><b>6.3.1</b> Reading and cleaning</a></li>
<li class="chapter" data-level="6.3.2" data-path="ch-06.html"><a href="ch-06.html#data-splitting-1"><i class="fa fa-check"></i><b>6.3.2</b> Data splitting</a></li>
<li class="chapter" data-level="6.3.3" data-path="ch-06.html"><a href="ch-06.html#linear-model"><i class="fa fa-check"></i><b>6.3.3</b> Linear model</a></li>
<li class="chapter" data-level="6.3.4" data-path="ch-06.html"><a href="ch-06.html#pre-processing"><i class="fa fa-check"></i><b>6.3.4</b> Pre-processing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="ch-07.html"><a href="ch-07.html"><i class="fa fa-check"></i><b>7</b> Supervised Machine Learning II</a>
<ul>
<li class="chapter" data-level="7.1" data-path="ch-07.html"><a href="ch-07.html#introduction-6"><i class="fa fa-check"></i><b>7.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="ch-07.html"><a href="ch-07.html#learning-objectives-3"><i class="fa fa-check"></i><b>7.1.1</b> Learning objectives</a></li>
<li class="chapter" data-level="7.1.2" data-path="ch-07.html"><a href="ch-07.html#key-points-from-the-lecture-4"><i class="fa fa-check"></i><b>7.1.2</b> Key points from the lecture</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="ch-07.html"><a href="ch-07.html#tutorial-5"><i class="fa fa-check"></i><b>7.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="ch-07.html"><a href="ch-07.html#model-formulation-using-train"><i class="fa fa-check"></i><b>7.2.1</b> Model formulation using <code>train()</code></a></li>
<li class="chapter" data-level="7.2.2" data-path="ch-07.html"><a href="ch-07.html#model-training"><i class="fa fa-check"></i><b>7.2.2</b> Model training</a></li>
<li class="chapter" data-level="7.2.3" data-path="ch-07.html"><a href="ch-07.html#model-evaluation"><i class="fa fa-check"></i><b>7.2.3</b> Model evaluation</a></li>
<li class="chapter" data-level="7.2.4" data-path="ch-07.html"><a href="ch-07.html#bonus-model-interpretation"><i class="fa fa-check"></i><b>7.2.4</b> Bonus: Model interpretation</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="ch-07.html"><a href="ch-07.html#exercise-6"><i class="fa fa-check"></i><b>7.3</b> Exercise</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="ch-07.html"><a href="ch-07.html#setup"><i class="fa fa-check"></i><b>7.3.1</b> Setup</a></li>
<li class="chapter" data-level="7.3.2" data-path="ch-07.html"><a href="ch-07.html#linear-model-1"><i class="fa fa-check"></i><b>7.3.2</b> Linear Model</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="ch-07.html"><a href="ch-07.html#knn"><i class="fa fa-check"></i><b>7.4</b> KNN</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="ch-07.html"><a href="ch-07.html#check-data"><i class="fa fa-check"></i><b>7.4.1</b> Check data</a></li>
<li class="chapter" data-level="7.4.2" data-path="ch-07.html"><a href="ch-07.html#training-1"><i class="fa fa-check"></i><b>7.4.2</b> Training</a></li>
<li class="chapter" data-level="7.4.3" data-path="ch-07.html"><a href="ch-07.html#prediction-1"><i class="fa fa-check"></i><b>7.4.3</b> Prediction</a></li>
<li class="chapter" data-level="7.4.4" data-path="ch-07.html"><a href="ch-07.html#sample-hyperparameters"><i class="fa fa-check"></i><b>7.4.4</b> Sample hyperparameters</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="ch-07.html"><a href="ch-07.html#random-forest-1"><i class="fa fa-check"></i><b>7.5</b> Random forest</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="ch-07.html"><a href="ch-07.html#training-2"><i class="fa fa-check"></i><b>7.5.1</b> Training</a></li>
<li class="chapter" data-level="7.5.2" data-path="ch-07.html"><a href="ch-07.html#prediction-2"><i class="fa fa-check"></i><b>7.5.2</b> Prediction</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="ch-08.html"><a href="ch-08.html"><i class="fa fa-check"></i><b>8</b> Application 1: Variable selection</a>
<ul>
<li class="chapter" data-level="8.1" data-path="ch-08.html"><a href="ch-08.html#introduction-7"><i class="fa fa-check"></i><b>8.1</b> Introduction</a></li>
<li class="chapter" data-level="8.2" data-path="ch-08.html"><a href="ch-08.html#application"><i class="fa fa-check"></i><b>8.2</b> Application</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="ch-08.html"><a href="ch-08.html#warm-up-1-nested-for-loop"><i class="fa fa-check"></i><b>8.2.1</b> Warm-up 1: Nested for-loop</a></li>
<li class="chapter" data-level="8.2.2" data-path="ch-08.html"><a href="ch-08.html#warm-up-2-find-the-best-single-predictor"><i class="fa fa-check"></i><b>8.2.2</b> Warm-up 2: Find the best single predictor</a></li>
<li class="chapter" data-level="8.2.3" data-path="ch-08.html"><a href="ch-08.html#full-stepwise-regression"><i class="fa fa-check"></i><b>8.2.3</b> Full stepwise regression</a></li>
<li class="chapter" data-level="8.2.4" data-path="ch-08.html"><a href="ch-08.html#bonus-stepwise-regression-out-of-the-box"><i class="fa fa-check"></i><b>8.2.4</b> Bonus: Stepwise regression out-of-the-box</a></li>
<li class="chapter" data-level="8.2.5" data-path="ch-08.html"><a href="ch-08.html#bonus-best-subset-selection---not-included-in-application-for-students-too-long"><i class="fa fa-check"></i><b>8.2.5</b> Bonus: Best Subset Selection - Not included in application for students (too long…)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="ch-09.html"><a href="ch-09.html"><i class="fa fa-check"></i><b>9</b> Supervised Neural Networks I</a>
<ul>
<li class="chapter" data-level="9.1" data-path="ch-09.html"><a href="ch-09.html#introduction-8"><i class="fa fa-check"></i><b>9.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="ch-09.html"><a href="ch-09.html#learning-objectives-4"><i class="fa fa-check"></i><b>9.1.1</b> Learning objectives</a></li>
<li class="chapter" data-level="9.1.2" data-path="ch-09.html"><a href="ch-09.html#important-points-from-the-lecture-1"><i class="fa fa-check"></i><b>9.1.2</b> Important points from the lecture</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="ch-09.html"><a href="ch-09.html#tutorial-6"><i class="fa fa-check"></i><b>9.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="ch-09.html"><a href="ch-09.html#set-up"><i class="fa fa-check"></i><b>9.2.1</b> Set-up</a></li>
<li class="chapter" data-level="9.2.2" data-path="ch-09.html"><a href="ch-09.html#keras-for-linear-models"><i class="fa fa-check"></i><b>9.2.2</b> Keras for linear models</a></li>
<li class="chapter" data-level="9.2.3" data-path="ch-09.html"><a href="ch-09.html#tuning-learning-rate"><i class="fa fa-check"></i><b>9.2.3</b> Tuning learning rate</a></li>
<li class="chapter" data-level="9.2.4" data-path="ch-09.html"><a href="ch-09.html#logistic-regression"><i class="fa fa-check"></i><b>9.2.4</b> Logistic Regression</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="ch-09.html"><a href="ch-09.html#exercise-7"><i class="fa fa-check"></i><b>9.3</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="ch-10.html"><a href="ch-10.html"><i class="fa fa-check"></i><b>10</b> Supervised Neural Networks II</a>
<ul>
<li class="chapter" data-level="10.1" data-path="ch-10.html"><a href="ch-10.html#introduction-9"><i class="fa fa-check"></i><b>10.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="ch-10.html"><a href="ch-10.html#learning-objectives-5"><i class="fa fa-check"></i><b>10.1.1</b> Learning objectives</a></li>
<li class="chapter" data-level="10.1.2" data-path="ch-10.html"><a href="ch-10.html#important-points-from-the-lecture-2"><i class="fa fa-check"></i><b>10.1.2</b> Important points from the lecture</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="ch-10.html"><a href="ch-10.html#tutorial-7"><i class="fa fa-check"></i><b>10.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="ch-10.html"><a href="ch-10.html#import-libraries-1"><i class="fa fa-check"></i><b>10.2.1</b> Import libraries</a></li>
<li class="chapter" data-level="10.2.2" data-path="ch-10.html"><a href="ch-10.html#construct-a-toy-dataset"><i class="fa fa-check"></i><b>10.2.2</b> Construct a toy dataset</a></li>
<li class="chapter" data-level="10.2.3" data-path="ch-10.html"><a href="ch-10.html#build-and-train-nn"><i class="fa fa-check"></i><b>10.2.3</b> Build and train NN</a></li>
<li class="chapter" data-level="10.2.4" data-path="ch-10.html"><a href="ch-10.html#model-performance"><i class="fa fa-check"></i><b>10.2.4</b> Model performance</a></li>
<li class="chapter" data-level="10.2.5" data-path="ch-10.html"><a href="ch-10.html#influence-of-nn-architecture"><i class="fa fa-check"></i><b>10.2.5</b> Influence of NN architecture</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="ch-10.html"><a href="ch-10.html#exercise-8"><i class="fa fa-check"></i><b>10.3</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="ch-11.html"><a href="ch-11.html"><i class="fa fa-check"></i><b>11</b> Application 2: Neural Networks and Hyperparameter Tuning</a>
<ul>
<li class="chapter" data-level="11.1" data-path="ch-11.html"><a href="ch-11.html#introduction-10"><i class="fa fa-check"></i><b>11.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="ch-11.html"><a href="ch-11.html#learning-goals"><i class="fa fa-check"></i><b>11.1.1</b> Learning Goals</a></li>
<li class="chapter" data-level="11.1.2" data-path="ch-11.html"><a href="ch-11.html#key-points-from-previous-lectures"><i class="fa fa-check"></i><b>11.1.2</b> Key Points from Previous Lectures</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="ch-11.html"><a href="ch-11.html#application-1"><i class="fa fa-check"></i><b>11.2</b> Application</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="ch-11.html"><a href="ch-11.html#problem-statement"><i class="fa fa-check"></i><b>11.2.1</b> Problem Statement</a></li>
<li class="chapter" data-level="11.2.2" data-path="ch-11.html"><a href="ch-11.html#data-preparation"><i class="fa fa-check"></i><b>11.2.2</b> Data preparation</a></li>
<li class="chapter" data-level="11.2.3" data-path="ch-11.html"><a href="ch-11.html#center-and-scale"><i class="fa fa-check"></i><b>11.2.3</b> Center and scale</a></li>
<li class="chapter" data-level="11.2.4" data-path="ch-11.html"><a href="ch-11.html#building-a-simple-model-with-keras-subtask-1"><i class="fa fa-check"></i><b>11.2.4</b> Building a simple model with keras ( SubTask 1)</a></li>
<li class="chapter" data-level="11.2.5" data-path="ch-11.html"><a href="ch-11.html#cross-validation"><i class="fa fa-check"></i><b>11.2.5</b> Cross validation</a></li>
<li class="chapter" data-level="11.2.6" data-path="ch-11.html"><a href="ch-11.html#parameter-tuning"><i class="fa fa-check"></i><b>11.2.6</b> Parameter Tuning</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="ch-12.html"><a href="ch-12.html"><i class="fa fa-check"></i><b>12</b> Supervised Deep Learning I</a>
<ul>
<li class="chapter" data-level="12.1" data-path="ch-12.html"><a href="ch-12.html#introduction-11"><i class="fa fa-check"></i><b>12.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="ch-12.html"><a href="ch-12.html#learning-objectives-6"><i class="fa fa-check"></i><b>12.1.1</b> Learning objectives</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="ch-12.html"><a href="ch-12.html#tutorial-8"><i class="fa fa-check"></i><b>12.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="ch-12.html"><a href="ch-12.html#building-blocks-of-cnns"><i class="fa fa-check"></i><b>12.2.1</b> Building Blocks of CNNs</a></li>
<li class="chapter" data-level="12.2.2" data-path="ch-12.html"><a href="ch-12.html#build-the-model"><i class="fa fa-check"></i><b>12.2.2</b> Build the model</a></li>
<li class="chapter" data-level="12.2.3" data-path="ch-12.html"><a href="ch-12.html#compile-and-train-the-model"><i class="fa fa-check"></i><b>12.2.3</b> Compile and train the model</a></li>
<li class="chapter" data-level="12.2.4" data-path="ch-12.html"><a href="ch-12.html#reduce-overfitting"><i class="fa fa-check"></i><b>12.2.4</b> Reduce Overfitting</a></li>
<li class="chapter" data-level="12.2.5" data-path="ch-12.html"><a href="ch-12.html#visualizing-a-cnn"><i class="fa fa-check"></i><b>12.2.5</b> Visualizing a CNN</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="ch-12.html"><a href="ch-12.html#exercise-9"><i class="fa fa-check"></i><b>12.3</b> Exercise</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="ch-12.html"><a href="ch-12.html#import-libraries-and-data"><i class="fa fa-check"></i><b>12.3.1</b> Import libraries and data</a></li>
<li class="chapter" data-level="12.3.2" data-path="ch-12.html"><a href="ch-12.html#tasks"><i class="fa fa-check"></i><b>12.3.2</b> Tasks</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="ch-13.html"><a href="ch-13.html"><i class="fa fa-check"></i><b>13</b> Supervised Deep Learning II - <em>A Scenario of Environmental Systems</em></a>
<ul>
<li class="chapter" data-level="13.1" data-path="ch-13.html"><a href="ch-13.html#introduction-12"><i class="fa fa-check"></i><b>13.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="ch-13.html"><a href="ch-13.html#learning-objectives-7"><i class="fa fa-check"></i><b>13.1.1</b> Learning objectives</a></li>
<li class="chapter" data-level="13.1.2" data-path="ch-13.html"><a href="ch-13.html#content-operations"><i class="fa fa-check"></i><b>13.1.2</b> Content &amp; Operations</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="ch-13.html"><a href="ch-13.html#tutorial-9"><i class="fa fa-check"></i><b>13.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="ch-13.html"><a href="ch-13.html#description-of-the-modelling-task"><i class="fa fa-check"></i><b>13.2.1</b> Description of the modelling task</a></li>
<li class="chapter" data-level="13.2.2" data-path="ch-13.html"><a href="ch-13.html#goal-of-the-tutorial"><i class="fa fa-check"></i><b>13.2.2</b> Goal of the tutorial</a></li>
<li class="chapter" data-level="13.2.3" data-path="ch-13.html"><a href="ch-13.html#dataset"><i class="fa fa-check"></i><b>13.2.3</b> Dataset</a></li>
<li class="chapter" data-level="13.2.4" data-path="ch-13.html"><a href="ch-13.html#lets-dive-into-the-code"><i class="fa fa-check"></i><b>13.2.4</b> Let’s dive into the code</a></li>
<li class="chapter" data-level="13.2.5" data-path="ch-13.html"><a href="ch-13.html#read-in-the-data"><i class="fa fa-check"></i><b>13.2.5</b> Read in the Data</a></li>
<li class="chapter" data-level="13.2.6" data-path="ch-13.html"><a href="ch-13.html#naive-models-old-world-linear-models"><i class="fa fa-check"></i><b>13.2.6</b> Naive models (Old World): Linear Models</a></li>
<li class="chapter" data-level="13.2.7" data-path="ch-13.html"><a href="ch-13.html#neural-networks-new-world"><i class="fa fa-check"></i><b>13.2.7</b> Neural Networks (New World)</a></li>
<li class="chapter" data-level="13.2.8" data-path="ch-13.html"><a href="ch-13.html#convolutional-neural-network"><i class="fa fa-check"></i><b>13.2.8</b> Convolutional Neural Network</a></li>
</ul></li>
<li class="chapter" data-level="13.3" data-path="ch-13.html"><a href="ch-13.html#exercise-10"><i class="fa fa-check"></i><b>13.3</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Environmental Systems Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ch-10" class="section level1" number="10">
<h1><span class="header-section-number">Chapter 10</span> Supervised Neural Networks II</h1>
<div id="introduction-9" class="section level2" number="10.1">
<h2><span class="header-section-number">10.1</span> Introduction</h2>
<div id="learning-objectives-5" class="section level3" number="10.1.1">
<h3><span class="header-section-number">10.1.1</span> Learning objectives</h3>
<ul>
<li>Build and train neural networks for binary classification</li>
<li>Observe the influence of network architecture on model performance</li>
<li>Assess model performance using the following metrics
<ul>
<li>Accuracy</li>
<li>Precision</li>
<li>Recall</li>
<li>F-Score</li>
<li>Receiver operating characteristic (ROC) curves</li>
<li>Area under the ROC curve</li>
</ul></li>
<li>Account for the stochasticity of model training when assessing model performance</li>
</ul>
</div>
<div id="important-points-from-the-lecture-2" class="section level3" number="10.1.2">
<h3><span class="header-section-number">10.1.2</span> Important points from the lecture</h3>
<ul>
<li>For binary classification problems, the output node often uses a <em>sigmoid activation function</em>.</li>
<li>A <em>classification threshold</em> is applied to the output of the sigmoid activation function to determine which label is predicted.</li>
<li><em>Accuracy</em> is a popular measure of model performance, but it is not useful for class-imbalanced data.</li>
<li>The area under the <em>ROC curve </em> is a measure of model performance that considers the full range of possible classification thresholds.</li>
<li>Like accuracy, the area under the ROC curve can also be misleading in datasets with strong class imbalance</li>
<li>Regression and classification problems require different measures of model performance.</li>
</ul>
</div>
</div>
<div id="tutorial-7" class="section level2" number="10.2">
<h2><span class="header-section-number">10.2</span> Tutorial</h2>
<div id="import-libraries-1" class="section level3" number="10.2.1">
<h3><span class="header-section-number">10.2.1</span> Import libraries</h3>
<p>We first need to import some libraries. You have seen all of these in previous tutorials. Keras will play an especially prominent role in this tutorial.</p>
<div class="sourceCode" id="cb794"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb794-1"><a href="ch-10.html#cb794-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb794-2"><a href="ch-10.html#cb794-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsample)</span>
<span id="cb794-3"><a href="ch-10.html#cb794-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb794-4"><a href="ch-10.html#cb794-4" aria-hidden="true" tabindex="-1"></a><span class="co"># use_condaenv()</span></span>
<span id="cb794-5"><a href="ch-10.html#cb794-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb794-6"><a href="ch-10.html#cb794-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC)</span>
<span id="cb794-7"><a href="ch-10.html#cb794-7" aria-hidden="true" tabindex="-1"></a><span class="co"># plot size </span></span>
<span id="cb794-8"><a href="ch-10.html#cb794-8" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width =</span> <span class="dv">10</span>, <span class="at">repr.plot.height =</span> <span class="dv">7</span>)</span></code></pre></div>
</div>
<div id="construct-a-toy-dataset" class="section level3" number="10.2.2">
<h3><span class="header-section-number">10.2.2</span> Construct a toy dataset</h3>
<p>For this exercise we will create a toy dataset that illusrates some of the vagaries (unexpected changes that cannot be controlled but can influence a situation) of classification, as well as some of the pros and cons of model performance measures.</p>
<p>In this toy dataset, each example has two real-valued features on the unit interval (i.e., these values are between 0 and 1). Each example has one of two labels, <span class="math inline">\(\color{green}{\text{green}}\)</span> or <span class="math inline">\(\color{blue}{\text{blue}}\)</span>. The dataset is constructed such that those examples <em>within</em> a specified radius of the point (0.5, 0.5) are assigned a <span class="math inline">\(\color{green}{\text{green}}\)</span> label and those <em>outside</em> this radius are assigned a <span class="math inline">\(\color{blue}{\text{blue}}\)</span> label.</p>
<div class="sourceCode" id="cb795"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb795-1"><a href="ch-10.html#cb795-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Seed the random number generator for reproducible results</span></span>
<span id="cb795-2"><a href="ch-10.html#cb795-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">41</span>)</span>
<span id="cb795-3"><a href="ch-10.html#cb795-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb795-4"><a href="ch-10.html#cb795-4" aria-hidden="true" tabindex="-1"></a><span class="co">#  Number of examples</span></span>
<span id="cb795-5"><a href="ch-10.html#cb795-5" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">10000</span> </span>
<span id="cb795-6"><a href="ch-10.html#cb795-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb795-7"><a href="ch-10.html#cb795-7" aria-hidden="true" tabindex="-1"></a><span class="co">#  Square radius  of inner circle</span></span>
<span id="cb795-8"><a href="ch-10.html#cb795-8" aria-hidden="true" tabindex="-1"></a>radius_2 <span class="ot">&lt;-</span> <span class="fl">0.125</span> </span>
<span id="cb795-9"><a href="ch-10.html#cb795-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb795-10"><a href="ch-10.html#cb795-10" aria-hidden="true" tabindex="-1"></a><span class="co">#  Noise applied to the boundary separating green and blue examples</span></span>
<span id="cb795-11"><a href="ch-10.html#cb795-11" aria-hidden="true" tabindex="-1"></a>noise <span class="ot">&lt;-</span> <span class="fl">0.025</span> </span>
<span id="cb795-12"><a href="ch-10.html#cb795-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb795-13"><a href="ch-10.html#cb795-13" aria-hidden="true" tabindex="-1"></a><span class="co">#  Place N points on the unit square. </span></span>
<span id="cb795-14"><a href="ch-10.html#cb795-14" aria-hidden="true" tabindex="-1"></a><span class="co">#  Label those within some radius 0, and those outside 1.</span></span>
<span id="cb795-15"><a href="ch-10.html#cb795-15" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="at">n =</span> N, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>) </span>
<span id="cb795-16"><a href="ch-10.html#cb795-16" aria-hidden="true" tabindex="-1"></a>x2 <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="at">n =</span> N, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>) </span>
<span id="cb795-17"><a href="ch-10.html#cb795-17" aria-hidden="true" tabindex="-1"></a>y  <span class="ot">&lt;-</span> ((x1<span class="fl">-0.5</span>)<span class="sc">**</span><span class="dv">2</span> <span class="sc">+</span> (x2<span class="fl">-0.5</span>)<span class="sc">**</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="at">n =</span> N,<span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> noise) <span class="sc">&gt;</span> radius_2</span>
<span id="cb795-18"><a href="ch-10.html#cb795-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb795-19"><a href="ch-10.html#cb795-19" aria-hidden="true" tabindex="-1"></a><span class="co">#  Create a data frame</span></span>
<span id="cb795-20"><a href="ch-10.html#cb795-20" aria-hidden="true" tabindex="-1"></a>df_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x1 =</span> x1, <span class="at">x2 =</span> x2, <span class="at">y =</span> y<span class="sc">*</span><span class="dv">1</span>)</span>
<span id="cb795-21"><a href="ch-10.html#cb795-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb795-22"><a href="ch-10.html#cb795-22" aria-hidden="true" tabindex="-1"></a><span class="co">#  Split the data into training (80%) and test (20%) sets</span></span>
<span id="cb795-23"><a href="ch-10.html#cb795-23" aria-hidden="true" tabindex="-1"></a><span class="co">#  Make a breakpoint at 80%</span></span>
<span id="cb795-24"><a href="ch-10.html#cb795-24" aria-hidden="true" tabindex="-1"></a>breakpoint <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fl">0.8</span> <span class="sc">*</span> <span class="fu">nrow</span>(df_data))</span>
<span id="cb795-25"><a href="ch-10.html#cb795-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb795-26"><a href="ch-10.html#cb795-26" aria-hidden="true" tabindex="-1"></a><span class="co">#  training data</span></span>
<span id="cb795-27"><a href="ch-10.html#cb795-27" aria-hidden="true" tabindex="-1"></a>df_train <span class="ot">&lt;-</span> df_data[<span class="dv">1</span><span class="sc">:</span>breakpoint,]</span>
<span id="cb795-28"><a href="ch-10.html#cb795-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb795-29"><a href="ch-10.html#cb795-29" aria-hidden="true" tabindex="-1"></a><span class="co">#  testing data</span></span>
<span id="cb795-30"><a href="ch-10.html#cb795-30" aria-hidden="true" tabindex="-1"></a>df_test <span class="ot">&lt;-</span> df_data[(breakpoint <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(df_data),]</span></code></pre></div>
<p>Let’s visualize our data to get a feel for the classification task at hand. Let’s also visualize the true decision boundary used to delineate the <span class="math inline">\(\color{green}{\text{green}}\)</span> from the <span class="math inline">\(\color{blue}{\text{blue}}\)</span> labels, and print the number of examples per label.</p>
<p><em>Notice</em> that there are more examples labeled <span class="math inline">\(\color{blue}{\text{blue}}\)</span> than there are examples labeled <span class="math inline">\(\color{green}{\text{green}}\)</span>.</p>
<p>This means the data are <strong>class imbalanced</strong> (but not heavily).</p>
<div class="sourceCode" id="cb796"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb796-1"><a href="ch-10.html#cb796-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize our data</span></span>
<span id="cb796-2"><a href="ch-10.html#cb796-2" aria-hidden="true" tabindex="-1"></a>df_data <span class="sc">%&gt;%</span> </span>
<span id="cb796-3"><a href="ch-10.html#cb796-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb796-4"><a href="ch-10.html#cb796-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1 , <span class="at">y =</span> x2, <span class="at">color  =</span>  <span class="fu">as.factor</span>(y))) <span class="sc">+</span></span>
<span id="cb796-5"><a href="ch-10.html#cb796-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb796-6"><a href="ch-10.html#cb796-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb796-7"><a href="ch-10.html#cb796-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb796-8"><a href="ch-10.html#cb796-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">x =</span>  <span class="fl">0.5</span> <span class="sc">+</span> <span class="fu">sqrt</span>(radius_2) <span class="sc">*</span> <span class="fu">cos</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">2</span> <span class="sc">*</span> pi, <span class="at">length.out =</span>  N)),</span>
<span id="cb796-9"><a href="ch-10.html#cb796-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span>  <span class="fl">0.5</span> <span class="sc">+</span> <span class="fu">sqrt</span>(radius_2) <span class="sc">*</span> <span class="fu">sin</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">2</span> <span class="sc">*</span> pi, <span class="at">length.out =</span>  N)),</span>
<span id="cb796-10"><a href="ch-10.html#cb796-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> <span class="st">&#39; True </span><span class="sc">\n</span><span class="st"> Decision </span><span class="sc">\n</span><span class="st"> Boundary&#39;</span>),</span>
<span id="cb796-11"><a href="ch-10.html#cb796-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">&#39;black&#39;</span>,</span>
<span id="cb796-12"><a href="ch-10.html#cb796-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb796-13"><a href="ch-10.html#cb796-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb796-14"><a href="ch-10.html#cb796-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">&#39;Class&#39;</span>, </span>
<span id="cb796-15"><a href="ch-10.html#cb796-15" aria-hidden="true" tabindex="-1"></a>                       <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;0&#39;</span> <span class="ot">=</span> <span class="st">&quot;green&quot;</span>, <span class="st">&#39;1&#39;</span> <span class="ot">=</span> <span class="st">&#39;blue&#39;</span>)) <span class="sc">+</span></span>
<span id="cb796-16"><a href="ch-10.html#cb796-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb796-17"><a href="ch-10.html#cb796-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">linetype =</span> <span class="st">&#39;&#39;</span>) <span class="sc">+</span></span>
<span id="cb796-18"><a href="ch-10.html#cb796-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb796-19"><a href="ch-10.html#cb796-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_grey</span>(<span class="at">base_size =</span> <span class="dv">15</span>)</span></code></pre></div>
<p><img src="esds_book_files/figure-html/unnamed-chunk-379-1.png" width="50%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb797"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb797-1"><a href="ch-10.html#cb797-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print some summary statistics about these data</span></span>
<span id="cb797-2"><a href="ch-10.html#cb797-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&#39;Proportion of data in class blue: &#39;</span> , <span class="fu">sum</span>(df_data<span class="sc">$</span>y) <span class="sc">/</span> <span class="fu">length</span>(df_data<span class="sc">$</span>y), <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>,</span>
<span id="cb797-3"><a href="ch-10.html#cb797-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Proportion of data in class green: &#39;</span> , <span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(df_data<span class="sc">$</span>y) <span class="sc">/</span> <span class="fu">length</span>(df_data<span class="sc">$</span>y), <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)</span></code></pre></div>
<pre><code>## Proportion of data in class blue:  0.6018 
##  Proportion of data in class green:  0.3982</code></pre>
<p>A more appropriate way to split the data into training and test sets is to take care such that each label is represented to its proportion in both sets (<em>stratified splitting</em>). To this end, we use the <code>rsample</code> package and we choose <code>strata = y</code>. That is crucial especially for heavily class imbalanced data sets. In essence, what we want to avoid is to have an over representation of one class in the training data set and an under representation of this class in the the test data set.</p>
<div class="sourceCode" id="cb799"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb799-1"><a href="ch-10.html#cb799-1" aria-hidden="true" tabindex="-1"></a><span class="co"># split with r sample and strata = y</span></span>
<span id="cb799-2"><a href="ch-10.html#cb799-2" aria-hidden="true" tabindex="-1"></a>split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(df_data, <span class="at">prop =</span> <span class="fl">0.8</span>, <span class="at">strata =</span> <span class="st">&#39;y&#39;</span>)</span>
<span id="cb799-3"><a href="ch-10.html#cb799-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb799-4"><a href="ch-10.html#cb799-4" aria-hidden="true" tabindex="-1"></a><span class="co">#train set</span></span>
<span id="cb799-5"><a href="ch-10.html#cb799-5" aria-hidden="true" tabindex="-1"></a>df_train <span class="ot">&lt;-</span> <span class="fu">training</span>(split)</span>
<span id="cb799-6"><a href="ch-10.html#cb799-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb799-7"><a href="ch-10.html#cb799-7" aria-hidden="true" tabindex="-1"></a><span class="co">#test set</span></span>
<span id="cb799-8"><a href="ch-10.html#cb799-8" aria-hidden="true" tabindex="-1"></a>df_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(split)</span>
<span id="cb799-9"><a href="ch-10.html#cb799-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb799-10"><a href="ch-10.html#cb799-10" aria-hidden="true" tabindex="-1"></a><span class="co">#print statistics for each set</span></span>
<span id="cb799-11"><a href="ch-10.html#cb799-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb799-12"><a href="ch-10.html#cb799-12" aria-hidden="true" tabindex="-1"></a><span class="do">## training set</span></span>
<span id="cb799-13"><a href="ch-10.html#cb799-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb799-14"><a href="ch-10.html#cb799-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Training set: </span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb799-15"><a href="ch-10.html#cb799-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Proportion of data in class blue: &#39;</span> , <span class="fu">sum</span>(df_train<span class="sc">$</span>y) <span class="sc">/</span> <span class="fu">length</span>(df_train<span class="sc">$</span>y), <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>,</span>
<span id="cb799-16"><a href="ch-10.html#cb799-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Proportion of data in class green: &#39;</span> , <span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(df_train<span class="sc">$</span>y) <span class="sc">/</span> <span class="fu">length</span>(df_train<span class="sc">$</span>y), <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)</span></code></pre></div>
<pre><code>## Training set: 
##  Proportion of data in class blue:  0.6018252 
##  Proportion of data in class green:  0.3981748</code></pre>
<div class="sourceCode" id="cb801"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb801-1"><a href="ch-10.html#cb801-1" aria-hidden="true" tabindex="-1"></a><span class="do">##test set</span></span>
<span id="cb801-2"><a href="ch-10.html#cb801-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb801-3"><a href="ch-10.html#cb801-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">Test set: </span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb801-4"><a href="ch-10.html#cb801-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Proportion of data in class blue: &#39;</span> , <span class="fu">sum</span>(df_test<span class="sc">$</span>y) <span class="sc">/</span> <span class="fu">length</span>(df_test<span class="sc">$</span>y), <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>,</span>
<span id="cb801-5"><a href="ch-10.html#cb801-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Proportion of data in class green: &#39;</span> , <span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(df_test<span class="sc">$</span>y) <span class="sc">/</span> <span class="fu">length</span>(df_test<span class="sc">$</span>y), <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)</span></code></pre></div>
<pre><code>## 
## Test set: 
##  Proportion of data in class blue:  0.6016992 
##  Proportion of data in class green:  0.3983008</code></pre>
<p>As it is obvious now, each label is represented to its initial proportion in training and test set.</p>
</div>
<div id="build-and-train-nn" class="section level3" number="10.2.3">
<h3><span class="header-section-number">10.2.3</span> Build and train NN</h3>
<p>As you saw in your previous tutorial, Keras is a powerful API for building, training, and evaluating artificial neural networks. In that lecture, you used Keras to construct, train, and analyze extremely simple neural networks, comprising just a single layer of a single node.</p>
<p>Here we’ll build and consider more complex network architectures. To do so, we’ll generalize the <code>build_and_train_model</code> function from our previous tutorial. Specifically, we’ll change the function such that it builds and trains a network with an arbitrary number of layers and nodes per layer, such that the number of nodes per layer is the same for all layers, except the output layer, which will contain just a single node with a sigmoid activation function.</p>
<p><em>Neural Networks: A closer look</em></p>
<p>Before we proceed further let’s have a closer look on neural networks and what keras hides from the user. To this end, we will manually create a neural network with 1 hidden layer with 5 units and an output layer (with 1 unit).</p>
<p>Let ’s assume that we have d features (x) and therefore <span class="math inline">\(W_1\)</span>(weights) is a matrix with dimension <span class="math inline">\(d\times 5\)</span> and <span class="math inline">\(b_1\)</span> has a dimension <span class="math inline">\(5\times 1\)</span>(biases). Then the output of the 1st hidden layer is</p>
<p><span class="math display">\[1st\_hidden = xW_1 + b_1\]</span></p>
<p>The dimension of the <span class="math inline">\(1st\_hidden\)</span> is 5 (equals the number of units or more intuitively 5 different linear models output). On top of this we apply an activation function such as relu,sigmoid etc.</p>
<p>So,</p>
<p><span class="math display">\[1st\_hidden\_out = activation(1st\_hidden)\]</span></p>
<p>For the output layer we just take the values of 1st_hidden_out (now those are our new ‘features’) and we apply a matrix multiplication as we did with our features.</p>
<p><span class="math display">\[ output\_layer = 1st\_hidden\_out W_2 + b_2\]</span></p>
<p>where <span class="math inline">\(W_2\)</span> has dimension <span class="math inline">\(5\times 1\)</span>(equals the dimension of the previous layer output) and b_2 a dimension of 1 . Therefore</p>
<p><span class="math display">\[ y = activation(output\_layer)\]</span></p>
<p>where the output activation for a binary classification problem is the sigmoid.</p>
<p>In total, <span class="math display">\[y = activation(activation(xW_1 + b_1)*W_2 +b_2)\]</span></p>
<p>As it is obvious a neural network is a collection of connected linear models with an activation function on top of each. We can stack several hidden layers (each of those has its own number of units) following the same procedure as above.</p>
<div class="sourceCode" id="cb803"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb803-1"><a href="ch-10.html#cb803-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Learning rate</span></span>
<span id="cb803-2"><a href="ch-10.html#cb803-2" aria-hidden="true" tabindex="-1"></a>lr <span class="ot">&lt;-</span> <span class="fl">0.01</span></span>
<span id="cb803-3"><a href="ch-10.html#cb803-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb803-4"><a href="ch-10.html#cb803-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of epochs</span></span>
<span id="cb803-5"><a href="ch-10.html#cb803-5" aria-hidden="true" tabindex="-1"></a>ne <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb803-6"><a href="ch-10.html#cb803-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb803-7"><a href="ch-10.html#cb803-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Batch size</span></span>
<span id="cb803-8"><a href="ch-10.html#cb803-8" aria-hidden="true" tabindex="-1"></a>bs <span class="ot">&lt;-</span>  <span class="dv">512</span></span>
<span id="cb803-9"><a href="ch-10.html#cb803-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb803-10"><a href="ch-10.html#cb803-10" aria-hidden="true" tabindex="-1"></a>build_and_train_model <span class="ot">&lt;-</span> <span class="cf">function</span> (<span class="at">data =</span> df_train,</span>
<span id="cb803-11"><a href="ch-10.html#cb803-11" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">learning_rate =</span> lr, </span>
<span id="cb803-12"><a href="ch-10.html#cb803-12" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">num_epochs =</span> ne, </span>
<span id="cb803-13"><a href="ch-10.html#cb803-13" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">batch_size =</span> bs, </span>
<span id="cb803-14"><a href="ch-10.html#cb803-14" aria-hidden="true" tabindex="-1"></a>                                  num_layers, </span>
<span id="cb803-15"><a href="ch-10.html#cb803-15" aria-hidden="true" tabindex="-1"></a>                                  num_units_per_layer,</span>
<span id="cb803-16"><a href="ch-10.html#cb803-16" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">print_model_summary =</span> F</span>
<span id="cb803-17"><a href="ch-10.html#cb803-17" aria-hidden="true" tabindex="-1"></a>                                 ){</span>
<span id="cb803-18"><a href="ch-10.html#cb803-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb803-19"><a href="ch-10.html#cb803-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Most models are so-called &#39;sequential&#39; models</span></span>
<span id="cb803-20"><a href="ch-10.html#cb803-20" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>()</span>
<span id="cb803-21"><a href="ch-10.html#cb803-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb803-22"><a href="ch-10.html#cb803-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keras makes building neural networks as simple as adding layer upon layer with simple sequential </span></span>
<span id="cb803-23"><a href="ch-10.html#cb803-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calls to the function &quot;layer_dense&quot;. Take a moment to appreciate how easy that makes things.</span></span>
<span id="cb803-24"><a href="ch-10.html#cb803-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb803-25"><a href="ch-10.html#cb803-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The input layer is the only layer that requires the user to specify its shape. The shape of all</span></span>
<span id="cb803-26"><a href="ch-10.html#cb803-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># subsequent layers is automatically determined based on the output of the preceding layer. Let&#39;s</span></span>
<span id="cb803-27"><a href="ch-10.html#cb803-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># use a ReLU activation function in each node in the input and hidden layers.</span></span>
<span id="cb803-28"><a href="ch-10.html#cb803-28" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">layer_dense</span>(<span class="at">units =</span> num_units_per_layer, </span>
<span id="cb803-29"><a href="ch-10.html#cb803-29" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">input_shape =</span> (<span class="fu">ncol</span>(data) <span class="sc">-</span> <span class="dv">1</span>), </span>
<span id="cb803-30"><a href="ch-10.html#cb803-30" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>)</span>
<span id="cb803-31"><a href="ch-10.html#cb803-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb803-32"><a href="ch-10.html#cb803-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the hidden layers. Note this requires just a simple for loop that calls the function &quot;layer_dense&quot;</span></span>
<span id="cb803-33"><a href="ch-10.html#cb803-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># again and again.</span></span>
<span id="cb803-34"><a href="ch-10.html#cb803-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (num_layers<span class="sc">&gt;</span><span class="dv">1</span>){</span>
<span id="cb803-35"><a href="ch-10.html#cb803-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(num_layers<span class="dv">-1</span>)){</span>
<span id="cb803-36"><a href="ch-10.html#cb803-36" aria-hidden="true" tabindex="-1"></a>            model <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">layer_dense</span>(<span class="at">units =</span> num_units_per_layer, </span>
<span id="cb803-37"><a href="ch-10.html#cb803-37" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">activation =</span> <span class="st">&quot;relu&quot;</span>)</span>
<span id="cb803-38"><a href="ch-10.html#cb803-38" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb803-39"><a href="ch-10.html#cb803-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb803-40"><a href="ch-10.html#cb803-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb803-41"><a href="ch-10.html#cb803-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add the output layer. Note that it uses a sigmoid activation function. Make sure you know why.</span></span>
<span id="cb803-42"><a href="ch-10.html#cb803-42" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">1</span>, <span class="at">activation =</span> <span class="st">&quot;sigmoid&quot;</span>)    </span>
<span id="cb803-43"><a href="ch-10.html#cb803-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb803-44"><a href="ch-10.html#cb803-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print the model description</span></span>
<span id="cb803-45"><a href="ch-10.html#cb803-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (print_model_summary){</span>
<span id="cb803-46"><a href="ch-10.html#cb803-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb803-47"><a href="ch-10.html#cb803-47" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summary</span>(model)        </span>
<span id="cb803-48"><a href="ch-10.html#cb803-48" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb803-49"><a href="ch-10.html#cb803-49" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb803-50"><a href="ch-10.html#cb803-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  Specify the learning rate for stochastic gradient descent</span></span>
<span id="cb803-51"><a href="ch-10.html#cb803-51" aria-hidden="true" tabindex="-1"></a>    opt <span class="ot">&lt;-</span> <span class="fu">optimizer_adam</span>(<span class="at">lr =</span> learning_rate)</span>
<span id="cb803-52"><a href="ch-10.html#cb803-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb803-53"><a href="ch-10.html#cb803-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compile the model, using binary cross-entropy to define loss. Measure accuracy during training.</span></span>
<span id="cb803-54"><a href="ch-10.html#cb803-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note how easy Keras makes this. Did you have to write any functions for loss or for measuring model</span></span>
<span id="cb803-55"><a href="ch-10.html#cb803-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># performance during training? No, Keras takes care of all of this for you.</span></span>
<span id="cb803-56"><a href="ch-10.html#cb803-56" aria-hidden="true" tabindex="-1"></a>    model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(<span class="at">optimizer =</span> opt, </span>
<span id="cb803-57"><a href="ch-10.html#cb803-57" aria-hidden="true" tabindex="-1"></a>                      <span class="at">loss =</span><span class="st">&#39;binary_crossentropy&#39;</span>, </span>
<span id="cb803-58"><a href="ch-10.html#cb803-58" aria-hidden="true" tabindex="-1"></a>                      <span class="at">metrics =</span> <span class="fu">list</span>(<span class="st">&#39;accuracy&#39;</span>))         </span>
<span id="cb803-59"><a href="ch-10.html#cb803-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb803-60"><a href="ch-10.html#cb803-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit the model</span></span>
<span id="cb803-61"><a href="ch-10.html#cb803-61" aria-hidden="true" tabindex="-1"></a>    history <span class="ot">&lt;-</span> model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(<span class="at">x =</span> <span class="fu">as.matrix</span>(data[, <span class="fu">c</span>(<span class="st">&#39;x1&#39;</span>, <span class="st">&#39;x2&#39;</span>)]),</span>
<span id="cb803-62"><a href="ch-10.html#cb803-62" aria-hidden="true" tabindex="-1"></a>                            <span class="at">y =</span> data<span class="sc">$</span>y,</span>
<span id="cb803-63"><a href="ch-10.html#cb803-63" aria-hidden="true" tabindex="-1"></a>                            <span class="at">epochs =</span> num_epochs,</span>
<span id="cb803-64"><a href="ch-10.html#cb803-64" aria-hidden="true" tabindex="-1"></a>                            <span class="at">batch_size =</span> batch_size,</span>
<span id="cb803-65"><a href="ch-10.html#cb803-65" aria-hidden="true" tabindex="-1"></a>                            )</span>
<span id="cb803-66"><a href="ch-10.html#cb803-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb803-67"><a href="ch-10.html#cb803-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the model and the training history</span></span>
<span id="cb803-68"><a href="ch-10.html#cb803-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">model =</span> model, <span class="at">history =</span> history))                                      </span>
<span id="cb803-69"><a href="ch-10.html#cb803-69" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Checkpoint</strong></p>
<p>Why does the output layer use a sigmoid activation function rather than a linear activation function? Can you think of a case where you’d want the output layer to use a linear activation function?</p>
<p><strong>Solution</strong></p>
<p>For a continuous response y then the output activation should be linear.</p>
<p>Can we train an accurate classifier with just a single layer of a single node?</p>
<p>Let’s try. And let’s assess model performance using a metric called <strong>Accuracy</strong>. This is simply the number of correct predictions divided by the number of predictions.</p>
<p>In the context of this toy dataset, it’s the number of examples predicted to be blue that actually are blue plus the number of examples predicted to be green that actually are green, divided by the number of predictions.</p>
<pre class="eval"><code>c(model, history) %&lt;-% build_and_train_model(data = df_train,
                                            learning_rate = 0.01,
                                            batch_size = 512,
                                            num_epochs = 100,
                                            num_layers = 1,
                                            num_units_per_layer =  1,
                                            print_model_summary = T)

cat(&#39;Final training accuracy: &#39;, round(history$metrics$acc[ne], 3), &#39;\n&#39;)</code></pre>
<div class="sourceCode" id="cb805"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb805-1"><a href="ch-10.html#cb805-1" aria-hidden="true" tabindex="-1"></a><span class="do">##    Model: &quot;sequential&quot;</span></span>
<span id="cb805-2"><a href="ch-10.html#cb805-2" aria-hidden="true" tabindex="-1"></a><span class="do">##    ________________________________________________________________________________</span></span>
<span id="cb805-3"><a href="ch-10.html#cb805-3" aria-hidden="true" tabindex="-1"></a><span class="do">##    Layer (type)                        Output Shape                    Param #     </span></span>
<span id="cb805-4"><a href="ch-10.html#cb805-4" aria-hidden="true" tabindex="-1"></a><span class="do">##    ================================================================================</span></span>
<span id="cb805-5"><a href="ch-10.html#cb805-5" aria-hidden="true" tabindex="-1"></a><span class="do">##    dense (Dense)                       (None, 1)                       3           </span></span>
<span id="cb805-6"><a href="ch-10.html#cb805-6" aria-hidden="true" tabindex="-1"></a><span class="do">##    ________________________________________________________________________________</span></span>
<span id="cb805-7"><a href="ch-10.html#cb805-7" aria-hidden="true" tabindex="-1"></a><span class="do">##    dense_1 (Dense)                     (None, 1)                       2           </span></span>
<span id="cb805-8"><a href="ch-10.html#cb805-8" aria-hidden="true" tabindex="-1"></a><span class="do">##    ================================================================================</span></span>
<span id="cb805-9"><a href="ch-10.html#cb805-9" aria-hidden="true" tabindex="-1"></a><span class="do">##    Total params: 5</span></span>
<span id="cb805-10"><a href="ch-10.html#cb805-10" aria-hidden="true" tabindex="-1"></a><span class="do">##    Trainable params: 5</span></span>
<span id="cb805-11"><a href="ch-10.html#cb805-11" aria-hidden="true" tabindex="-1"></a><span class="do">##    Non-trainable params: 0</span></span>
<span id="cb805-12"><a href="ch-10.html#cb805-12" aria-hidden="true" tabindex="-1"></a><span class="do">##    ________________________________________________________________________________</span></span>
<span id="cb805-13"><a href="ch-10.html#cb805-13" aria-hidden="true" tabindex="-1"></a><span class="do">##    Final training accuracy:  0.602 </span></span></code></pre></div>
<p>Note the final training accuracy.</p>
<p>Let’s have a look at how accuracy and loss change during model training.</p>
<div class="sourceCode" id="cb806"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb806-1"><a href="ch-10.html#cb806-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history)</span></code></pre></div>
<p><img src="figures/SLNN_II-output2.png" /></p>
<p>Observe how quickly accuracy converges to the final value. And note the final value - wow, we’re doing better than a coin flip (a coin flip choice would have an accuracy of 0.5) during training, using just a single layer of a single node! How is this possible? Take a moment to think about how this might be happening. Think about what you already know about these data (What is the percentage of each class? Is it possible a classifier that only predicts the largest class to seems better than a coin flip?).</p>
<p>To see if you’re intuition is correct, let’s plot our model predictions on the test data. Note that in making these predictions, we need to choose a classification threshold. The reason is that the output layer yields a real value between 0 and 1, which needs to be discretized for the purpose of binary classification. For now, let’s just set this threshold at 0.5. We’ll see how changing the threshold impacts model performance later.</p>
<div class="sourceCode" id="cb807"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb807-1"><a href="ch-10.html#cb807-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict on test data. Note how easy this is to do in Keras.</span></span>
<span id="cb807-2"><a href="ch-10.html#cb807-2" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="fu">as.matrix</span>(df_test[, <span class="fu">c</span>(<span class="st">&#39;x1&#39;</span>, <span class="st">&#39;x2&#39;</span>)]))</span>
<span id="cb807-3"><a href="ch-10.html#cb807-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb807-4"><a href="ch-10.html#cb807-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the classification threshold to 0.5</span></span>
<span id="cb807-5"><a href="ch-10.html#cb807-5" aria-hidden="true" tabindex="-1"></a>threshold <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb807-6"><a href="ch-10.html#cb807-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb807-7"><a href="ch-10.html#cb807-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Make label predictions based on the classification threshold</span></span>
<span id="cb807-8"><a href="ch-10.html#cb807-8" aria-hidden="true" tabindex="-1"></a>y_pred <span class="ot">&lt;-</span> (pred <span class="sc">&gt;=</span> threshold) <span class="sc">*</span> <span class="dv">1</span></span>
<span id="cb807-9"><a href="ch-10.html#cb807-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb807-10"><a href="ch-10.html#cb807-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the predictions</span></span>
<span id="cb807-11"><a href="ch-10.html#cb807-11" aria-hidden="true" tabindex="-1"></a>df_test <span class="sc">%&gt;%</span></span>
<span id="cb807-12"><a href="ch-10.html#cb807-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2)) <span class="sc">+</span></span>
<span id="cb807-13"><a href="ch-10.html#cb807-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="fu">ifelse</span>(y_pred <span class="sc">==</span> <span class="dv">1</span>, <span class="st">&#39;blue&#39;</span>, <span class="st">&#39;green&#39;</span>))</span>
<span id="cb807-14"><a href="ch-10.html#cb807-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb807-15"><a href="ch-10.html#cb807-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate and print model performance on test data</span></span>
<span id="cb807-16"><a href="ch-10.html#cb807-16" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(loss, acc) <span class="sc">%&lt;-%</span> <span class="fu">evaluate</span>(model, <span class="fu">as.matrix</span>(df_test[,<span class="fu">c</span>(<span class="st">&#39;x1&#39;</span>, <span class="st">&#39;x2&#39;</span>)]), df_test<span class="sc">$</span>y)</span>
<span id="cb807-17"><a href="ch-10.html#cb807-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb807-18"><a href="ch-10.html#cb807-18" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&#39;Accuracy on held-out test data: &#39;</span> , <span class="fu">round</span>(acc, <span class="dv">3</span>), <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)</span></code></pre></div>
<pre><code>## Accuracy on held-out test data:  0.602</code></pre>
<p>Aha, the model is always predicting blue! Why is this simple trick effective? It’s because the data are class imbalanced, meaning that one class is more prevalent than the other in our dataset. Specifically, there are more blue examples than green examples. So by simply using the rule “<span class="math inline">\(\color{blue}{\text{always blue}}\)</span>”, we can obtain an accuracy that’s better than a coin toss.</p>
<p>This shows that <em>accuracy</em> has its limitations as a model performance metric and reveals the need for more nuanced metrics, such as the following:</p>
<ul>
<li><code>True positives</code>: The number of positive examples predicted to be positive <strong>(+ / +)</strong></li>
<li><code>True negatives</code>: The number of negative examples predicted to be negative <strong>(- / -)</strong></li>
<li><code>False positives</code>: The number of negative examples predicted to be positive <strong>(+ / -)</strong></li>
<li><code>False negatives</code>: The number of positive examples predicted to be negative <strong>(- / +)</strong></li>
</ul>
<p>These metrics can be summarized in the so-called <strong><em>confusion matrix</em></strong> displayed in Figure <a href="ch-10.html#fig:confusion">10.1</a>.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:confusion"></span>
<img src="figures/confusion-matrix.png" alt="Visualization of a confusion matrix" width="50%" />
<p class="caption">
Figure 10.1: Visualization of a confusion matrix
</p>
</div>
<p>In this toy dataset, we’ll call the <span class="math inline">\(\color{blue}{\text{blue}}\)</span> examples <span class="math inline">\(\color{blue}{\text{&#39;positive&#39;}}\)</span> and the <span class="math inline">\(\color{green}{\text{green}}\)</span> examples <span class="math inline">\(\color{green}{\text{&#39;negative&#39;}}\)</span>. This terminology makes more sense in more realistic classification problems, such as delineating spam email from non-spam.</p>
</div>
<div id="model-performance" class="section level3" number="10.2.4">
<h3><span class="header-section-number">10.2.4</span> Model performance</h3>
<p>Let’s write a function that calculates the building blocks of the confusion matrix.</p>
<div class="sourceCode" id="cb809"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb809-1"><a href="ch-10.html#cb809-1" aria-hidden="true" tabindex="-1"></a>confusion <span class="ot">&lt;-</span> <span class="cf">function</span>(y_true, pred_out, <span class="at">threshold =</span> <span class="fl">0.5</span>, <span class="at">verbose =</span> T){</span>
<span id="cb809-2"><a href="ch-10.html#cb809-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb809-3"><a href="ch-10.html#cb809-3" aria-hidden="true" tabindex="-1"></a>  true_positives  <span class="ot">=</span> <span class="fu">sum</span>((pred_out <span class="sc">&gt;=</span> threshold) <span class="sc">&amp;</span> (y_true <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb809-4"><a href="ch-10.html#cb809-4" aria-hidden="true" tabindex="-1"></a>  true_negatives  <span class="ot">=</span> <span class="fu">sum</span>((pred_out <span class="sc">&lt;</span> threshold)  <span class="sc">&amp;</span> (y_true <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb809-5"><a href="ch-10.html#cb809-5" aria-hidden="true" tabindex="-1"></a>  false_positives <span class="ot">=</span> <span class="fu">sum</span>((pred_out <span class="sc">&gt;=</span> threshold) <span class="sc">&amp;</span> (y_true <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb809-6"><a href="ch-10.html#cb809-6" aria-hidden="true" tabindex="-1"></a>  false_negatives <span class="ot">=</span> <span class="fu">sum</span>((pred_out <span class="sc">&lt;</span> threshold)  <span class="sc">&amp;</span> (y_true <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb809-7"><a href="ch-10.html#cb809-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb809-8"><a href="ch-10.html#cb809-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (verbose) {</span>
<span id="cb809-9"><a href="ch-10.html#cb809-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&#39;true positives: &#39;</span>,  true_positives,  <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>,</span>
<span id="cb809-10"><a href="ch-10.html#cb809-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;true negatives: &#39;</span>,  true_negatives,  <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>,</span>
<span id="cb809-11"><a href="ch-10.html#cb809-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;false positives: &#39;</span>, false_positives, <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>,</span>
<span id="cb809-12"><a href="ch-10.html#cb809-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;false negatives: &#39;</span>, false_negatives, <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)</span>
<span id="cb809-13"><a href="ch-10.html#cb809-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb809-14"><a href="ch-10.html#cb809-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (<span class="fu">list</span>(<span class="at">tp =</span> true_positives, <span class="at">tn =</span> true_negatives, <span class="at">fp =</span> false_positives, <span class="at">fn =</span> false_negatives))</span>
<span id="cb809-15"><a href="ch-10.html#cb809-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Note that we can also define <em>accuracy</em> in terms of true/false positives/negatives</p>
<ul>
<li>Accuracy: <span class="math inline">\(\frac{\mbox{TP} + \mbox{TN}}{\mbox{TP + TN + FP + FN}}\)</span></li>
</ul>
<p>where <code>TP + FN</code> is the number of <em>positive cases (P)</em> while <code>TN + FP</code> is the number of <em>negative cases (N)</em>.</p>
<p>Let’s apply this function to our model predictions.</p>
<div class="sourceCode" id="cb810"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb810-1"><a href="ch-10.html#cb810-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(true_positives, true_negatives, false_positives, false_negatives) <span class="sc">%&lt;-%</span> <span class="fu">confusion</span>(df_test<span class="sc">$</span>y,  pred, threshold)</span></code></pre></div>
<pre><code>## true positives: 1203 
##  true negatives: 0 
##  false positives: 796 
##  false negatives: 0</code></pre>
<p>This reveals a more nuanced picture of model performance. Sure, accuracy is better than a coin toss, but we now see that we do not correctly predict <em>a single negative example</em>. These four metrics are the basis for two additional, commonly used performance metrics (see Figure <a href="ch-10.html#fig:cf-metrics">10.2</a>:</p>
<ul>
<li><strong>Precision</strong>: <span class="math inline">\(\frac{\mbox{TP}}{\mbox{TP + FP}}\)</span>
tells us the proportion of positive predictions that were actually correct.</li>
<li><strong>Recall</strong>: <span class="math inline">\(\frac{\mbox{TP}}{\mbox{TP + FN}} = \frac{\mbox{TP}}{\mbox{P}}\)</span>
tells us the proportion of positive examples that were correctly predicted to be positive.</li>
</ul>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:cf-metrics"></span>
<img src="figures/1200px-Precisionrecall.svg.png" alt="Difference of Precision and Recall in classification problems." width="50%" />
<p class="caption">
Figure 10.2: Difference of Precision and Recall in classification problems.
</p>
</div>
<p>Let’s define a function that calculates precision and recall.</p>
<div class="sourceCode" id="cb812"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb812-1"><a href="ch-10.html#cb812-1" aria-hidden="true" tabindex="-1"></a>precision_and_recall <span class="ot">&lt;-</span> <span class="cf">function</span>(true_positives, true_negatives,false_positives, false_negatives, <span class="at">verbose=</span>T){</span>
<span id="cb812-2"><a href="ch-10.html#cb812-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb812-3"><a href="ch-10.html#cb812-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Protect against division by zero</span></span>
<span id="cb812-4"><a href="ch-10.html#cb812-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((true_positives <span class="sc">+</span> false_positives) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb812-5"><a href="ch-10.html#cb812-5" aria-hidden="true" tabindex="-1"></a>    precision <span class="ot">=</span> true_positives <span class="sc">/</span> (true_positives <span class="sc">+</span> false_positives)</span>
<span id="cb812-6"><a href="ch-10.html#cb812-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb812-7"><a href="ch-10.html#cb812-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb812-8"><a href="ch-10.html#cb812-8" aria-hidden="true" tabindex="-1"></a>    precision <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb812-9"><a href="ch-10.html#cb812-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb812-10"><a href="ch-10.html#cb812-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb812-11"><a href="ch-10.html#cb812-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((true_positives <span class="sc">+</span> false_negatives) <span class="sc">&gt;</span> <span class="dv">0</span>){    </span>
<span id="cb812-12"><a href="ch-10.html#cb812-12" aria-hidden="true" tabindex="-1"></a>    recall <span class="ot">=</span> true_positives <span class="sc">/</span> (true_positives <span class="sc">+</span> false_negatives)</span>
<span id="cb812-13"><a href="ch-10.html#cb812-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb812-14"><a href="ch-10.html#cb812-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb812-15"><a href="ch-10.html#cb812-15" aria-hidden="true" tabindex="-1"></a>      recall <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb812-16"><a href="ch-10.html#cb812-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb812-17"><a href="ch-10.html#cb812-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb812-18"><a href="ch-10.html#cb812-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (verbose){</span>
<span id="cb812-19"><a href="ch-10.html#cb812-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;Precision: &quot;</span>, precision, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb812-20"><a href="ch-10.html#cb812-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Recall: &quot;</span>, recall, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb812-21"><a href="ch-10.html#cb812-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb812-22"><a href="ch-10.html#cb812-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb812-23"><a href="ch-10.html#cb812-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (<span class="fu">list</span>(<span class="at">precision =</span> precision, <span class="at">recall =</span> recall))</span>
<span id="cb812-24"><a href="ch-10.html#cb812-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Let’s apply this function to our model predictions.</p>
<div class="sourceCode" id="cb813"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb813-1"><a href="ch-10.html#cb813-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(precision, recall) <span class="sc">%&lt;-%</span> <span class="fu">precision_and_recall</span>(true_positives, </span>
<span id="cb813-2"><a href="ch-10.html#cb813-2" aria-hidden="true" tabindex="-1"></a>                                               true_negatives, </span>
<span id="cb813-3"><a href="ch-10.html#cb813-3" aria-hidden="true" tabindex="-1"></a>                                               false_positives, </span>
<span id="cb813-4"><a href="ch-10.html#cb813-4" aria-hidden="true" tabindex="-1"></a>                                               false_negatives)</span></code></pre></div>
<pre><code>## Precision: 0.6018009 
##  Recall: 1</code></pre>
<p>Now we see that the model <span class="math inline">\(\color{blue}{\text{always blue}}\)</span> does a great job at correctly predicting positive examples (<em>recall</em>), but many of its positive predictions are incorrect (<em>precision</em>).</p>
<p>Wouldn’t it be nice if we could combine <em>precision</em> and <em>recall</em> into a single metric?
Ideally, this metric would take on a high value when both <em>precision</em> and <em>recall</em> are large and a low value when either <em>precision</em> or <em>recall</em> is small.</p>
<p>The <strong>F-score</strong> does exactly that:</p>
<ul>
<li><code>F-score</code> : <span class="math inline">\(2 \cdot \frac{\mbox{precision} \cdot \mbox{recall}}{\mbox{precision + recall}}\)</span></li>
</ul>
<p>The <em>F-score</em> takes values on the interval [0,1]. An F-score of 1 indicates that both precision and recall are 1 and an F-score of 0 corresponds to a value of 0 for either precision or recall.</p>
<p>So now let’s also define a function for the F-score and apply it to the previous example.</p>
<div class="sourceCode" id="cb815"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb815-1"><a href="ch-10.html#cb815-1" aria-hidden="true" tabindex="-1"></a>f_score <span class="ot">&lt;-</span> <span class="cf">function</span>(precision, recall, <span class="at">verbose =</span> T){</span>
<span id="cb815-2"><a href="ch-10.html#cb815-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb815-3"><a href="ch-10.html#cb815-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Calculate F</span></span>
<span id="cb815-4"><a href="ch-10.html#cb815-4" aria-hidden="true" tabindex="-1"></a>    f <span class="ot">=</span> <span class="dv">2</span> <span class="sc">*</span> precision <span class="sc">*</span> recall <span class="sc">/</span> (precision <span class="sc">+</span> recall)</span>
<span id="cb815-5"><a href="ch-10.html#cb815-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb815-6"><a href="ch-10.html#cb815-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the user has requested verbose output, provide it</span></span>
<span id="cb815-7"><a href="ch-10.html#cb815-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(verbose){</span>
<span id="cb815-8"><a href="ch-10.html#cb815-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">&quot;F-score: &quot;</span>, f)</span>
<span id="cb815-9"><a href="ch-10.html#cb815-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb815-10"><a href="ch-10.html#cb815-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb815-11"><a href="ch-10.html#cb815-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return F</span></span>
<span id="cb815-12"><a href="ch-10.html#cb815-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(f)</span>
<span id="cb815-13"><a href="ch-10.html#cb815-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb815-14"><a href="ch-10.html#cb815-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb815-15"><a href="ch-10.html#cb815-15" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">f_score</span>(precision, recall)</span></code></pre></div>
<pre><code>## F-score: 0.7514054</code></pre>
</div>
<div id="influence-of-nn-architecture" class="section level3" number="10.2.5">
<h3><span class="header-section-number">10.2.5</span> Influence of NN architecture</h3>
<p>Might more complex network architectures allow us to make better predictions?</p>
<p>Let’s try a single layer of two nodes.</p>
<div class="sourceCode" id="cb817"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb817-1"><a href="ch-10.html#cb817-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(model, history) <span class="sc">%&lt;-%</span> <span class="fu">build_and_train_model</span>(<span class="at">num_layers =</span> <span class="dv">1</span>, </span>
<span id="cb817-2"><a href="ch-10.html#cb817-2" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">num_units_per_layer =</span>  <span class="dv">2</span>, </span>
<span id="cb817-3"><a href="ch-10.html#cb817-3" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">print_model_summary =</span> T)</span>
<span id="cb817-4"><a href="ch-10.html#cb817-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb817-5"><a href="ch-10.html#cb817-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&#39;Final training accuracy: &#39;</span>, <span class="fu">round</span>(history<span class="sc">$</span>metrics<span class="sc">$</span>acc[ne], <span class="dv">3</span>), <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb818"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb818-1"><a href="ch-10.html#cb818-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Model: &quot;sequential&quot;</span></span>
<span id="cb818-2"><a href="ch-10.html#cb818-2" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb818-3"><a href="ch-10.html#cb818-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Layer (type)                        Output Shape                    Param #     </span></span>
<span id="cb818-4"><a href="ch-10.html#cb818-4" aria-hidden="true" tabindex="-1"></a><span class="do">## ================================================================================</span></span>
<span id="cb818-5"><a href="ch-10.html#cb818-5" aria-hidden="true" tabindex="-1"></a><span class="do">## dense (Dense)                       (None, 1)                       3           </span></span>
<span id="cb818-6"><a href="ch-10.html#cb818-6" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb818-7"><a href="ch-10.html#cb818-7" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_1 (Dense)                     (None, 1)                       2           </span></span>
<span id="cb818-8"><a href="ch-10.html#cb818-8" aria-hidden="true" tabindex="-1"></a><span class="do">## ================================================================================</span></span>
<span id="cb818-9"><a href="ch-10.html#cb818-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Total params: 5</span></span>
<span id="cb818-10"><a href="ch-10.html#cb818-10" aria-hidden="true" tabindex="-1"></a><span class="do">## Trainable params: 5</span></span>
<span id="cb818-11"><a href="ch-10.html#cb818-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Non-trainable params: 0</span></span>
<span id="cb818-12"><a href="ch-10.html#cb818-12" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb818-13"><a href="ch-10.html#cb818-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Final training accuracy:  0.602 </span></span></code></pre></div>
<p>Do you observe an improvement in training accuracy?</p>
<p>If not, keep trying until you do. This may take several attempts. <em>Note</em> the reason you can obtain different results each time you train your model is that training is stochastic, meaning that certain steps, such as the initialization of the edge weights, depend on the generation of random numbers. Each time you construct and train a model, new random numbers are generated, and this makes each training session unique. We’ll come back to this later.</p>
<p>Now that you’ve obtained a model with improved training accuracy, let’s see how it achieves this improvement:</p>
<div class="sourceCode" id="cb819"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb819-1"><a href="ch-10.html#cb819-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict on test data</span></span>
<span id="cb819-2"><a href="ch-10.html#cb819-2" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="fu">as.matrix</span>(df_test[, <span class="fu">c</span>(<span class="st">&#39;x1&#39;</span>, <span class="st">&#39;x2&#39;</span>)]))</span>
<span id="cb819-3"><a href="ch-10.html#cb819-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb819-4"><a href="ch-10.html#cb819-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the classification threshold</span></span>
<span id="cb819-5"><a href="ch-10.html#cb819-5" aria-hidden="true" tabindex="-1"></a>threshold <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb819-6"><a href="ch-10.html#cb819-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb819-7"><a href="ch-10.html#cb819-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Make label predictions based on the classification threshold</span></span>
<span id="cb819-8"><a href="ch-10.html#cb819-8" aria-hidden="true" tabindex="-1"></a>y_pred <span class="ot">&lt;-</span> (pred <span class="sc">&gt;=</span> threshold) <span class="sc">*</span> <span class="dv">1</span></span>
<span id="cb819-9"><a href="ch-10.html#cb819-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb819-10"><a href="ch-10.html#cb819-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot our predictions</span></span>
<span id="cb819-11"><a href="ch-10.html#cb819-11" aria-hidden="true" tabindex="-1"></a>df_test <span class="sc">%&gt;%</span></span>
<span id="cb819-12"><a href="ch-10.html#cb819-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2)) <span class="sc">+</span></span>
<span id="cb819-13"><a href="ch-10.html#cb819-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="fu">ifelse</span>(y_pred <span class="sc">==</span> <span class="dv">1</span>, <span class="st">&#39;blue&#39;</span>, <span class="st">&#39;red&#39;</span>))</span>
<span id="cb819-14"><a href="ch-10.html#cb819-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb819-15"><a href="ch-10.html#cb819-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate model performance on test data</span></span>
<span id="cb819-16"><a href="ch-10.html#cb819-16" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(loss,acc) <span class="sc">%&lt;-%</span> <span class="fu">evaluate</span>(model, <span class="fu">as.matrix</span>(df_test[, <span class="fu">c</span>(<span class="st">&#39;x1&#39;</span>, <span class="st">&#39;x2&#39;</span>)]), df_test<span class="sc">$</span>y)</span>
<span id="cb819-17"><a href="ch-10.html#cb819-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb819-18"><a href="ch-10.html#cb819-18" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&#39;Accuracy on held-out test data: &#39;</span>, <span class="fu">round</span>(acc, <span class="dv">3</span>), <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)</span>
<span id="cb819-19"><a href="ch-10.html#cb819-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb819-20"><a href="ch-10.html#cb819-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Print precision,recall and F-score</span></span>
<span id="cb819-21"><a href="ch-10.html#cb819-21" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(true_positives, true_negatives, false_positives, false_negatives) <span class="sc">%&lt;-%</span> <span class="fu">confusion</span>(df_test<span class="sc">$</span>y, </span>
<span id="cb819-22"><a href="ch-10.html#cb819-22" aria-hidden="true" tabindex="-1"></a>                                                                                   pred, </span>
<span id="cb819-23"><a href="ch-10.html#cb819-23" aria-hidden="true" tabindex="-1"></a>                                                                                   threshold, </span>
<span id="cb819-24"><a href="ch-10.html#cb819-24" aria-hidden="true" tabindex="-1"></a>                                                                                   <span class="at">verbose =</span> F)</span>
<span id="cb819-25"><a href="ch-10.html#cb819-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb819-26"><a href="ch-10.html#cb819-26" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(precision, recall) <span class="sc">%&lt;-%</span> <span class="fu">precision_and_recall</span>(true_positives, </span>
<span id="cb819-27"><a href="ch-10.html#cb819-27" aria-hidden="true" tabindex="-1"></a>                                               true_negatives, </span>
<span id="cb819-28"><a href="ch-10.html#cb819-28" aria-hidden="true" tabindex="-1"></a>                                               false_positives, </span>
<span id="cb819-29"><a href="ch-10.html#cb819-29" aria-hidden="true" tabindex="-1"></a>                                               false_negatives)</span>
<span id="cb819-30"><a href="ch-10.html#cb819-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb819-31"><a href="ch-10.html#cb819-31" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">f_score</span>(precision, recall)</span></code></pre></div>
<pre><code>## Accuracy on held-out test data: 0.75  Precision: 0.8490566  Recall: 0.7107232  F-score: 0.7737557</code></pre>
<p>What do you observe?</p>
<p>A few points to note:
* Accuracy is <em>improved</em>.
* The improvement in accuracy comes at the cost of <em>reduced recall</em>, but with the benefit of <em>increased precision</em>.
* The decision boundary learned by the model <em>differs substantially from the true decision boundary</em>.</p>
<p>Now let’s consider more complex network architecture. Specifically, consider:</p>
<ul>
<li>Four layers of eight nodes</li>
</ul>
<p>To do so, simply alter the input arguments to <code>build_and_train_model</code>.</p>
<p>Do we see improvements?</p>
<p>Again, you may have to train the model several times due to the stochastic nature of the training process.</p>
<div class="sourceCode" id="cb821"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb821-1"><a href="ch-10.html#cb821-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(model, history) <span class="sc">%&lt;-%</span> <span class="fu">build_and_train_model</span>(<span class="at">num_layers =</span> <span class="dv">4</span>, </span>
<span id="cb821-2"><a href="ch-10.html#cb821-2" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">num_units_per_layer =</span>  <span class="dv">8</span>, </span>
<span id="cb821-3"><a href="ch-10.html#cb821-3" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">print_model_summary =</span> T)</span>
<span id="cb821-4"><a href="ch-10.html#cb821-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb821-5"><a href="ch-10.html#cb821-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&#39;Final training accuracy: &#39;</span>, <span class="fu">round</span>(history<span class="sc">$</span>metrics<span class="sc">$</span>acc[ne],<span class="dv">3</span>),<span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)</span>
<span id="cb821-6"><a href="ch-10.html#cb821-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb821-7"><a href="ch-10.html#cb821-7" aria-hidden="true" tabindex="-1"></a><span class="co"># predict on test data </span></span>
<span id="cb821-8"><a href="ch-10.html#cb821-8" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="fu">as.matrix</span>(df_test[, <span class="fu">c</span>(<span class="st">&#39;x1&#39;</span>, <span class="st">&#39;x2&#39;</span>)]))</span>
<span id="cb821-9"><a href="ch-10.html#cb821-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb821-10"><a href="ch-10.html#cb821-10" aria-hidden="true" tabindex="-1"></a><span class="co"># set the classification threshold</span></span>
<span id="cb821-11"><a href="ch-10.html#cb821-11" aria-hidden="true" tabindex="-1"></a>threshold <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb821-12"><a href="ch-10.html#cb821-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb821-13"><a href="ch-10.html#cb821-13" aria-hidden="true" tabindex="-1"></a><span class="co"># make predictions</span></span>
<span id="cb821-14"><a href="ch-10.html#cb821-14" aria-hidden="true" tabindex="-1"></a>y_pred <span class="ot">&lt;-</span> (pred <span class="sc">&gt;=</span> threshold) <span class="sc">*</span> <span class="dv">1</span></span>
<span id="cb821-15"><a href="ch-10.html#cb821-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb821-16"><a href="ch-10.html#cb821-16" aria-hidden="true" tabindex="-1"></a><span class="co"># plot our predictions</span></span>
<span id="cb821-17"><a href="ch-10.html#cb821-17" aria-hidden="true" tabindex="-1"></a>df_test <span class="sc">%&gt;%</span></span>
<span id="cb821-18"><a href="ch-10.html#cb821-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2)) <span class="sc">+</span></span>
<span id="cb821-19"><a href="ch-10.html#cb821-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="fu">ifelse</span>(y_pred <span class="sc">==</span> <span class="dv">1</span>, <span class="st">&#39;blue&#39;</span>, <span class="st">&#39;red&#39;</span>))</span>
<span id="cb821-20"><a href="ch-10.html#cb821-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb821-21"><a href="ch-10.html#cb821-21" aria-hidden="true" tabindex="-1"></a><span class="co">#evaluate model performance on test data</span></span>
<span id="cb821-22"><a href="ch-10.html#cb821-22" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(loss, acc) <span class="sc">%&lt;-%</span> <span class="fu">evaluate</span>(model, <span class="fu">as.matrix</span>(df_test[, <span class="fu">c</span>(<span class="st">&#39;x1&#39;</span>, <span class="st">&#39;x2&#39;</span>)]), df_test<span class="sc">$</span>y)</span>
<span id="cb821-23"><a href="ch-10.html#cb821-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb821-24"><a href="ch-10.html#cb821-24" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&#39;Accuracy on held-out test data: &#39;</span>, <span class="fu">round</span>(acc, <span class="dv">3</span>), <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)</span>
<span id="cb821-25"><a href="ch-10.html#cb821-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb821-26"><a href="ch-10.html#cb821-26" aria-hidden="true" tabindex="-1"></a><span class="co">#print precision, recall and F-score</span></span>
<span id="cb821-27"><a href="ch-10.html#cb821-27" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(true_positives, true_negatives, false_positives, false_negatives) <span class="sc">%&lt;-%</span> <span class="fu">confusion</span>(df_test<span class="sc">$</span>y, </span>
<span id="cb821-28"><a href="ch-10.html#cb821-28" aria-hidden="true" tabindex="-1"></a>                                                                                   pred, </span>
<span id="cb821-29"><a href="ch-10.html#cb821-29" aria-hidden="true" tabindex="-1"></a>                                                                                   threshold, </span>
<span id="cb821-30"><a href="ch-10.html#cb821-30" aria-hidden="true" tabindex="-1"></a>                                                                                   <span class="at">verbose =</span> F)</span>
<span id="cb821-31"><a href="ch-10.html#cb821-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb821-32"><a href="ch-10.html#cb821-32" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(precision, recall) <span class="sc">%&lt;-%</span> <span class="fu">precision_and_recall</span>(true_positives, </span>
<span id="cb821-33"><a href="ch-10.html#cb821-33" aria-hidden="true" tabindex="-1"></a>                                               true_negatives, </span>
<span id="cb821-34"><a href="ch-10.html#cb821-34" aria-hidden="true" tabindex="-1"></a>                                               false_positives, </span>
<span id="cb821-35"><a href="ch-10.html#cb821-35" aria-hidden="true" tabindex="-1"></a>                                               false_negatives)</span>
<span id="cb821-36"><a href="ch-10.html#cb821-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb821-37"><a href="ch-10.html#cb821-37" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">f_score</span>(precision, recall)</span></code></pre></div>
<div class="sourceCode" id="cb822"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb822-1"><a href="ch-10.html#cb822-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Model: &quot;sequential_2&quot;</span></span>
<span id="cb822-2"><a href="ch-10.html#cb822-2" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb822-3"><a href="ch-10.html#cb822-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Layer (type)                        Output Shape                    Param #     </span></span>
<span id="cb822-4"><a href="ch-10.html#cb822-4" aria-hidden="true" tabindex="-1"></a><span class="do">## ================================================================================</span></span>
<span id="cb822-5"><a href="ch-10.html#cb822-5" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_4 (Dense)                     (None, 8)                       24          </span></span>
<span id="cb822-6"><a href="ch-10.html#cb822-6" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb822-7"><a href="ch-10.html#cb822-7" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_5 (Dense)                     (None, 8)                       72          </span></span>
<span id="cb822-8"><a href="ch-10.html#cb822-8" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb822-9"><a href="ch-10.html#cb822-9" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_6 (Dense)                     (None, 8)                       72          </span></span>
<span id="cb822-10"><a href="ch-10.html#cb822-10" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb822-11"><a href="ch-10.html#cb822-11" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_7 (Dense)                     (None, 8)                       72          </span></span>
<span id="cb822-12"><a href="ch-10.html#cb822-12" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb822-13"><a href="ch-10.html#cb822-13" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_8 (Dense)                     (None, 1)                       9           </span></span>
<span id="cb822-14"><a href="ch-10.html#cb822-14" aria-hidden="true" tabindex="-1"></a><span class="do">## ================================================================================</span></span>
<span id="cb822-15"><a href="ch-10.html#cb822-15" aria-hidden="true" tabindex="-1"></a><span class="do">## Total params: 249</span></span>
<span id="cb822-16"><a href="ch-10.html#cb822-16" aria-hidden="true" tabindex="-1"></a><span class="do">## Trainable params: 249</span></span>
<span id="cb822-17"><a href="ch-10.html#cb822-17" aria-hidden="true" tabindex="-1"></a><span class="do">## Non-trainable params: 0</span></span>
<span id="cb822-18"><a href="ch-10.html#cb822-18" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb822-19"><a href="ch-10.html#cb822-19" aria-hidden="true" tabindex="-1"></a><span class="do">## Final training accuracy:  0.934 </span></span>
<span id="cb822-20"><a href="ch-10.html#cb822-20" aria-hidden="true" tabindex="-1"></a><span class="do">## Accuracy on held-out test data:  0.936 </span></span>
<span id="cb822-21"><a href="ch-10.html#cb822-21" aria-hidden="true" tabindex="-1"></a><span class="do">## Precision:  0.9453642 </span></span>
<span id="cb822-22"><a href="ch-10.html#cb822-22" aria-hidden="true" tabindex="-1"></a><span class="do">## Recall:  0.9492934 </span></span>
<span id="cb822-23"><a href="ch-10.html#cb822-23" aria-hidden="true" tabindex="-1"></a><span class="do">## F-score:  0.9473248</span></span></code></pre></div>
<p>What do you observe? Does model performance improve with model complexity? If so, is this always the case?</p>
<p><strong>Checkpoint</strong></p>
<p>Compare the number of trainable parameters of this model with the previous one. Comment on this.</p>
<p><strong>Solution</strong></p>
<p>The number of trainable parameters for the 1st model is 9 while for the last is 249. This increase is huge (almost 28 times the previous one).</p>
<p>Something we’ve glossed over so far is the dependence of model performance metrics on the classification threshold, which we’ve held fixed at 0.5.</p>
<p>Let’s see what happens when we change this threshold.</p>
<p>First, calculate precision and recall for thresholds between 0.05 and 0.95.</p>
<div class="sourceCode" id="cb823"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb823-1"><a href="ch-10.html#cb823-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Consider 100 thresholds between 0 and 1</span></span>
<span id="cb823-2"><a href="ch-10.html#cb823-2" aria-hidden="true" tabindex="-1"></a>num_thresholds <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb823-3"><a href="ch-10.html#cb823-3" aria-hidden="true" tabindex="-1"></a>thresholds <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> num_thresholds)</span>
<span id="cb823-4"><a href="ch-10.html#cb823-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb823-5"><a href="ch-10.html#cb823-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Allocate space for the four metrics of the confusion matrix, as well as for precision and recall</span></span>
<span id="cb823-6"><a href="ch-10.html#cb823-6" aria-hidden="true" tabindex="-1"></a>fp <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, num_thresholds)</span>
<span id="cb823-7"><a href="ch-10.html#cb823-7" aria-hidden="true" tabindex="-1"></a>fn <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, num_thresholds)</span>
<span id="cb823-8"><a href="ch-10.html#cb823-8" aria-hidden="true" tabindex="-1"></a>tp <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, num_thresholds)</span>
<span id="cb823-9"><a href="ch-10.html#cb823-9" aria-hidden="true" tabindex="-1"></a>tn <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, num_thresholds)</span>
<span id="cb823-10"><a href="ch-10.html#cb823-10" aria-hidden="true" tabindex="-1"></a>precision <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, num_thresholds)</span>
<span id="cb823-11"><a href="ch-10.html#cb823-11" aria-hidden="true" tabindex="-1"></a>recall <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, num_thresholds)</span>
<span id="cb823-12"><a href="ch-10.html#cb823-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb823-13"><a href="ch-10.html#cb823-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop over the thresholds, calculate the confusion matrix as well as precision and recall</span></span>
<span id="cb823-14"><a href="ch-10.html#cb823-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_thresholds){</span>
<span id="cb823-15"><a href="ch-10.html#cb823-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb823-16"><a href="ch-10.html#cb823-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(tp[i], tn[i], fp[i], fn[i]) <span class="sc">%&lt;-%</span> <span class="fu">confusion</span>(df_test<span class="sc">$</span>y, pred, thresholds[i], <span class="at">verbose =</span> F)</span>
<span id="cb823-17"><a href="ch-10.html#cb823-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb823-18"><a href="ch-10.html#cb823-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(precision[i], recall[i]) <span class="sc">%&lt;-%</span> <span class="fu">precision_and_recall</span>(tp[i], </span>
<span id="cb823-19"><a href="ch-10.html#cb823-19" aria-hidden="true" tabindex="-1"></a>                                                         tn[i], </span>
<span id="cb823-20"><a href="ch-10.html#cb823-20" aria-hidden="true" tabindex="-1"></a>                                                         fp[i], </span>
<span id="cb823-21"><a href="ch-10.html#cb823-21" aria-hidden="true" tabindex="-1"></a>                                                         fn[i], <span class="at">verbose =</span> F)</span>
<span id="cb823-22"><a href="ch-10.html#cb823-22" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div>
<p>Plot precision and recall as a function of the classification threshold.</p>
<div class="sourceCode" id="cb824"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb824-1"><a href="ch-10.html#cb824-1" aria-hidden="true" tabindex="-1"></a>df_pre_rec <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> thresholds, </span>
<span id="cb824-2"><a href="ch-10.html#cb824-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">metrics =</span> <span class="fu">c</span>(precision, recall), </span>
<span id="cb824-3"><a href="ch-10.html#cb824-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;precision&#39;</span>,<span class="st">&#39;recall&#39;</span>), <span class="at">each =</span> num_thresholds))</span>
<span id="cb824-4"><a href="ch-10.html#cb824-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb824-5"><a href="ch-10.html#cb824-5" aria-hidden="true" tabindex="-1"></a>df_pre_rec <span class="sc">%&gt;%</span></span>
<span id="cb824-6"><a href="ch-10.html#cb824-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb824-7"><a href="ch-10.html#cb824-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, </span>
<span id="cb824-8"><a href="ch-10.html#cb824-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">y =</span> metrics, </span>
<span id="cb824-9"><a href="ch-10.html#cb824-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> type)) <span class="sc">+</span></span>
<span id="cb824-10"><a href="ch-10.html#cb824-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb824-11"><a href="ch-10.html#cb824-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">lwd =</span> <span class="fl">1.5</span>, </span>
<span id="cb824-12"><a href="ch-10.html#cb824-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb824-13"><a href="ch-10.html#cb824-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb824-14"><a href="ch-10.html#cb824-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">&#39;&#39;</span>, </span>
<span id="cb824-15"><a href="ch-10.html#cb824-15" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&#39;Precision&#39;</span>,<span class="st">&#39;Recall&#39;</span>), </span>
<span id="cb824-16"><a href="ch-10.html#cb824-16" aria-hidden="true" tabindex="-1"></a>                       <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;Red&#39;</span>,<span class="st">&#39;Blue&#39;</span>)) <span class="sc">+</span></span>
<span id="cb824-17"><a href="ch-10.html#cb824-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb824-18"><a href="ch-10.html#cb824-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&#39;Classification Threshold&#39;</span>, <span class="at">y =</span> <span class="st">&#39;&#39;</span>) <span class="sc">+</span></span>
<span id="cb824-19"><a href="ch-10.html#cb824-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb824-20"><a href="ch-10.html#cb824-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_grey</span>(<span class="at">base_size =</span> <span class="dv">15</span>)</span></code></pre></div>
<p><img src="figures/SLNN_II-output5.png" /></p>
<p>As it is obvious from the graph, precision and recall experience an opposite behaivor as the classification threshold varies.</p>
<p>Namely, precision increases as the classification threshold gets larger while recall drops. In contrast, for a low classification threshold precision decreases and recall reaches a high value.</p>
<p>Intuitively, this behavior was expected since if the model predict very easily the positive class (low classification threshold) then we have a lot of false positives and thus a low precision. However in this case, we identify most of the positives instances and therefore we achieve a high recall.</p>
<p>On the other hand, if we desire our model to be very confident while predicting the positive class (high classification threshold) we expect a high precision. But in this case, we are eager to misclassify a lot of positive examples and therefore a low recall is anticipated.</p>
<p><strong>Checkpoint</strong></p>
<ol style="list-style-type: decimal">
<li><p>Can you think of a real world examples where it’s neccessary to have a high precision model (and potentially low recall)?</p></li>
<li><p>Can you think of a real world example where it’s necassary to have a high recall model (and potentially low precision)?</p></li>
</ol>
<p><strong>Solution</strong></p>
<ol style="list-style-type: decimal">
<li><p>Consider that you create a model for company X where the aim is to decide who is allowed to pass the company’s office entrance. The input of the model is a real time face photo and the prediction is Yes or No. You do not want to allow strangers to get inside the offices. You only want company’s related people. In this case your model should not have false positives. So you demand a high classification threshold and therefore a high precision.</p></li>
<li><p>Let ’s say that you are working on a hospital helping doctors to predict if a patient has a specific illness. Your model takes as input a value of a test and predicts if the patient is positive or negative. In this case, you care more about to find all those patients who are indeed positives. So you want a low classification threshold and thus a high recall model. In case you have some false positives you can just inform the patient to make some other different health tests.</p></li>
</ol>
<p>This plot reveals a tradeoff between precision and recall, which is often the case. To understand this tradeoff, remember how precision and recall are calculated:</p>
<ul>
<li><p><strong>precision</strong>: <span class="math inline">\(\frac{\mbox{TP}}{\mbox{TP + FP}}\)</span></p></li>
<li><p><strong>recall</strong>: <span class="math inline">\(\frac{\mbox{TP}}{\mbox{TP + FN}} = \frac{\mbox{TP}}{\mbox{P}}\)</span></p></li>
</ul>
<p>All that differs between them is one term in the denominator - <em>false positives</em> vs. <em>false negatives</em>. Precision approaches 1 as the number of false positives approaches 0, and recall approaches 1 as the number of false negatives approaches 0.</p>
<p>So why the tradeoff? Because the number of false positives and the number of false negatives depends on the classification threshold. For example, when the threshold is low, the model will often predict positive, yielding many false positives, but few false negatives. When the threshold is high, the model will often predict negative, yielding many false negatives, but few false positives.</p>
<p>The model performance under various thresholds is often assessed by the <strong>AUC-ROC</strong> (Area Under the Receiver Operating Characteristic curve) which plots Recall as a function of False Positive Rate.</p>
<ul>
<li><strong>False Positive Rate</strong> : <span class="math inline">\(\frac{\mbox{FP}}{\mbox{TN + FP}} = \frac{\mbox{FP}}{\mbox{N}}\)</span></li>
</ul>
<p>The False Positive Rate and the Precision have an opposite behavior for the various threshold. Namely, a high threshold results in low False Positive Rate, whereas a small threshold leads to large False Positive Rate</p>
<p>Let’s write a function to calculate the ROC curve and the area under it.</p>
<div class="sourceCode" id="cb825"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb825-1"><a href="ch-10.html#cb825-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Area Under Curve</span></span>
<span id="cb825-2"><a href="ch-10.html#cb825-2" aria-hidden="true" tabindex="-1"></a>simple_auc <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y){</span>
<span id="cb825-3"><a href="ch-10.html#cb825-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb825-4"><a href="ch-10.html#cb825-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Revert order</span></span>
<span id="cb825-5"><a href="ch-10.html#cb825-5" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rev</span>(x)</span>
<span id="cb825-6"><a href="ch-10.html#cb825-6" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">rev</span>(y)  </span>
<span id="cb825-7"><a href="ch-10.html#cb825-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb825-8"><a href="ch-10.html#cb825-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define rectangles, calculate area and add those</span></span>
<span id="cb825-9"><a href="ch-10.html#cb825-9" aria-hidden="true" tabindex="-1"></a>  dx <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">diff</span>(x), <span class="dv">0</span>)</span>
<span id="cb825-10"><a href="ch-10.html#cb825-10" aria-hidden="true" tabindex="-1"></a>  dy <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">diff</span>(y), <span class="dv">0</span>)</span>
<span id="cb825-11"><a href="ch-10.html#cb825-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(y <span class="sc">*</span> dx) <span class="sc">+</span> <span class="fu">sum</span>(dy <span class="sc">*</span> dx) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb825-12"><a href="ch-10.html#cb825-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb825-13"><a href="ch-10.html#cb825-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb825-14"><a href="ch-10.html#cb825-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ROC CURVE</span></span>
<span id="cb825-15"><a href="ch-10.html#cb825-15" aria-hidden="true" tabindex="-1"></a>ROC <span class="ot">&lt;-</span> <span class="cf">function</span>(fpr, recall, <span class="at">viz =</span> T){</span>
<span id="cb825-16"><a href="ch-10.html#cb825-16" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb825-17"><a href="ch-10.html#cb825-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the area under the ROC</span></span>
<span id="cb825-18"><a href="ch-10.html#cb825-18" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">=</span> <span class="fu">simple_auc</span>(fpr, recall)</span>
<span id="cb825-19"><a href="ch-10.html#cb825-19" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb825-20"><a href="ch-10.html#cb825-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualize the ROC</span></span>
<span id="cb825-21"><a href="ch-10.html#cb825-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (viz){</span>
<span id="cb825-22"><a href="ch-10.html#cb825-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb825-23"><a href="ch-10.html#cb825-23" aria-hidden="true" tabindex="-1"></a>        x <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb825-24"><a href="ch-10.html#cb825-24" aria-hidden="true" tabindex="-1"></a>        g <span class="ot">=</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb825-25"><a href="ch-10.html#cb825-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> fpr, <span class="at">y =</span> recall,  <span class="at">color =</span> <span class="st">&#39;Model&#39;</span>) , </span>
<span id="cb825-26"><a href="ch-10.html#cb825-26" aria-hidden="true" tabindex="-1"></a>                  <span class="at">lty =</span> <span class="dv">2</span>, </span>
<span id="cb825-27"><a href="ch-10.html#cb825-27" aria-hidden="true" tabindex="-1"></a>                  <span class="at">lwd =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb825-28"><a href="ch-10.html#cb825-28" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb825-29"><a href="ch-10.html#cb825-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> x, <span class="at">color =</span> <span class="st">&#39;Baseline&#39;</span>), </span>
<span id="cb825-30"><a href="ch-10.html#cb825-30" aria-hidden="true" tabindex="-1"></a>                  <span class="at">inherit.aes =</span> F, </span>
<span id="cb825-31"><a href="ch-10.html#cb825-31" aria-hidden="true" tabindex="-1"></a>                  <span class="at">lty =</span> <span class="dv">2</span>, </span>
<span id="cb825-32"><a href="ch-10.html#cb825-32" aria-hidden="true" tabindex="-1"></a>                  <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb825-33"><a href="ch-10.html#cb825-33" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb825-34"><a href="ch-10.html#cb825-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&#39;False Positive Rate&#39;</span>,</span>
<span id="cb825-35"><a href="ch-10.html#cb825-35" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> <span class="st">&#39;Recall&#39;</span>,</span>
<span id="cb825-36"><a href="ch-10.html#cb825-36" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span><span class="st">&#39;&#39;</span>,</span>
<span id="cb825-37"><a href="ch-10.html#cb825-37" aria-hidden="true" tabindex="-1"></a>             <span class="at">title =</span><span class="st">&#39;Area Under The curve ROC&#39;</span>,</span>
<span id="cb825-38"><a href="ch-10.html#cb825-38" aria-hidden="true" tabindex="-1"></a>            <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">&quot;AUC : &quot;</span>, <span class="fu">round</span>(auc, <span class="dv">2</span>))) <span class="sc">+</span></span>
<span id="cb825-39"><a href="ch-10.html#cb825-39" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb825-40"><a href="ch-10.html#cb825-40" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme_grey</span>(<span class="at">base_size =</span> <span class="dv">20</span>)</span>
<span id="cb825-41"><a href="ch-10.html#cb825-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb825-42"><a href="ch-10.html#cb825-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>{</span>
<span id="cb825-43"><a href="ch-10.html#cb825-43" aria-hidden="true" tabindex="-1"></a>        g <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb825-44"><a href="ch-10.html#cb825-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb825-45"><a href="ch-10.html#cb825-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb825-46"><a href="ch-10.html#cb825-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> (<span class="fu">list</span>(<span class="at">plot =</span> g, <span class="at">value =</span> auc))</span>
<span id="cb825-47"><a href="ch-10.html#cb825-47" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now let’s apply this function to our model predictions.</p>
<div class="sourceCode" id="cb826"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb826-1"><a href="ch-10.html#cb826-1" aria-hidden="true" tabindex="-1"></a>fpr <span class="ot">&lt;-</span> fp <span class="sc">/</span> (fp <span class="sc">+</span> tn)</span>
<span id="cb826-2"><a href="ch-10.html#cb826-2" aria-hidden="true" tabindex="-1"></a>auc <span class="ot">&lt;-</span> <span class="fu">ROC</span>(fpr, recall, <span class="at">viz =</span> T)</span>
<span id="cb826-3"><a href="ch-10.html#cb826-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;AUC Value: &quot;</span>, auc<span class="sc">$</span>value)</span>
<span id="cb826-4"><a href="ch-10.html#cb826-4" aria-hidden="true" tabindex="-1"></a>auc<span class="sc">$</span>plot</span></code></pre></div>
<pre><code>## AUC Value: 0.986246172675514</code></pre>
<p><img src="figures/SLNN_II-output6.png" /></p>
<p>Models with ROC curves that lie on the identity line (here the ‘Baseline’ in red-ish) are no better than a random guess. As the ROC curve approaches the upper left corner of the plot, the model is improving (<em>Total Recall!</em>).</p>
<p>What is crucial to understand here is that for a low classification threshold (resulting in a model that often predicts positive) the false positive rate and recall will approach 1. In contrast, for a high classification threshold (resulting in a model that rarely predicts positive), we would like to have a high value of recall, which means that our model is very confident in predicting positive cases (even with a high classification threshold). Indeed, the best model is one with perfect recall for all false positive rates. In such a case, the ROC curve would trace the left border and top border of the plot above.</p>
<p>As we’ve seen, a simple statistic that summarizes an ROC curve is the area under the ROC curve. You can think of this as the probability that a model ranks a random positive example more highly than a random negative example. A model whose predictions are always wrong has an area under the ROC curve of 0, whereas a model whose predictions are always right has an area under the ROC curve of 1.</p>
<p>We note here that instead of building the <code>ROC</code> function from scratch we can alternatively use the package <code>pROC</code></p>
<div class="sourceCode" id="cb828"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb828-1"><a href="ch-10.html#cb828-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ROC Curve - pROC package</span></span>
<span id="cb828-2"><a href="ch-10.html#cb828-2" aria-hidden="true" tabindex="-1"></a>roc_object <span class="ot">&lt;-</span> <span class="fu">roc</span>(df_test<span class="sc">$</span>y <span class="sc">~</span> <span class="fu">c</span>(pred), </span>
<span id="cb828-3"><a href="ch-10.html#cb828-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">plot =</span> <span class="cn">TRUE</span>, </span>
<span id="cb828-4"><a href="ch-10.html#cb828-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">print.auc =</span> <span class="cn">TRUE</span>, </span>
<span id="cb828-5"><a href="ch-10.html#cb828-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, </span>
<span id="cb828-6"><a href="ch-10.html#cb828-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">lwd  =</span> <span class="dv">4</span>, </span>
<span id="cb828-7"><a href="ch-10.html#cb828-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">legacy.axes =</span> <span class="cn">TRUE</span>, </span>
<span id="cb828-8"><a href="ch-10.html#cb828-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">main =</span> <span class="st">&quot;ROC Curve&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb829"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb829-1"><a href="ch-10.html#cb829-1" aria-hidden="true" tabindex="-1"></a><span class="co"># AUC - pROC package</span></span>
<span id="cb829-2"><a href="ch-10.html#cb829-2" aria-hidden="true" tabindex="-1"></a><span class="fu">auc</span>(roc_object)</span></code></pre></div>
<pre><code>## [1] 0.9863073</code></pre>
<p>Let’s put these metrics into practice by comparing different network architectures. To do so, we need to remember that model training is stochastic. Different random initializations can lead to different outcomes, and for some model architectures, some outcomes are more likely than others. For example, we’ve seen that the “<span class="math inline">\(\color{blue}{\text{always blue}}\)</span>” outcome is particularly seducing. To account for this stochasticity, we need to train our models multiple times, and take the average performance across random initializations.</p>
<p>Let’s compare four model architectures:
* One layer with two nodes
* Two layers with two nodes
* Four layers with four nodes
* Eight layers with eight nodes</p>
<p>Because we’re averaging over 10 random initializations per model, this script will take a bit of time - just enough for you to go prepare a cup of tea.</p>
<div class="sourceCode" id="cb831"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb831-1"><a href="ch-10.html#cb831-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Consider 100 thresholds between 0 and 1</span></span>
<span id="cb831-2"><a href="ch-10.html#cb831-2" aria-hidden="true" tabindex="-1"></a>num_thresholds <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb831-3"><a href="ch-10.html#cb831-3" aria-hidden="true" tabindex="-1"></a>thresholds <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> num_thresholds)</span>
<span id="cb831-4"><a href="ch-10.html#cb831-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb831-5"><a href="ch-10.html#cb831-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Consider 10 random initializations of the model</span></span>
<span id="cb831-6"><a href="ch-10.html#cb831-6" aria-hidden="true" tabindex="-1"></a>num_initializations <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb831-7"><a href="ch-10.html#cb831-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb831-8"><a href="ch-10.html#cb831-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Consider 4 model architectures</span></span>
<span id="cb831-9"><a href="ch-10.html#cb831-9" aria-hidden="true" tabindex="-1"></a>num_layers <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>)</span>
<span id="cb831-10"><a href="ch-10.html#cb831-10" aria-hidden="true" tabindex="-1"></a>num_units_per_layer <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>)</span>
<span id="cb831-11"><a href="ch-10.html#cb831-11" aria-hidden="true" tabindex="-1"></a>num_models <span class="ot">&lt;-</span> <span class="fu">length</span>(num_layers)</span>
<span id="cb831-12"><a href="ch-10.html#cb831-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb831-13"><a href="ch-10.html#cb831-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Allocate space for model performance metrics</span></span>
<span id="cb831-14"><a href="ch-10.html#cb831-14" aria-hidden="true" tabindex="-1"></a>fp <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(num_thresholds, num_initializations, num_models))</span>
<span id="cb831-15"><a href="ch-10.html#cb831-15" aria-hidden="true" tabindex="-1"></a>fn <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(num_thresholds, num_initializations, num_models))</span>
<span id="cb831-16"><a href="ch-10.html#cb831-16" aria-hidden="true" tabindex="-1"></a>tp <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(num_thresholds, num_initializations, num_models))</span>
<span id="cb831-17"><a href="ch-10.html#cb831-17" aria-hidden="true" tabindex="-1"></a>tn <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(num_thresholds, num_initializations, num_models))</span>
<span id="cb831-18"><a href="ch-10.html#cb831-18" aria-hidden="true" tabindex="-1"></a>precision <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(num_thresholds, num_initializations, num_models))</span>
<span id="cb831-19"><a href="ch-10.html#cb831-19" aria-hidden="true" tabindex="-1"></a>recall <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(num_thresholds, num_initializations, num_models))</span>
<span id="cb831-20"><a href="ch-10.html#cb831-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb831-21"><a href="ch-10.html#cb831-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop over the four network architectures</span></span>
<span id="cb831-22"><a href="ch-10.html#cb831-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_models){</span>
<span id="cb831-23"><a href="ch-10.html#cb831-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb831-24"><a href="ch-10.html#cb831-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop over the 10 random initializations</span></span>
<span id="cb831-25"><a href="ch-10.html#cb831-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_initializations){</span>
<span id="cb831-26"><a href="ch-10.html#cb831-26" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb831-27"><a href="ch-10.html#cb831-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print some satisfying output    </span></span>
<span id="cb831-28"><a href="ch-10.html#cb831-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">&quot;You look nice today. Model configuration &quot;</span> , <span class="fu">as.character</span>(i) , <span class="st">&quot; initialization &quot;</span> , <span class="fu">as.character</span>(k),<span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)</span>
<span id="cb831-29"><a href="ch-10.html#cb831-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb831-30"><a href="ch-10.html#cb831-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Build and train the model</span></span>
<span id="cb831-31"><a href="ch-10.html#cb831-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(model, history) <span class="sc">%&lt;-%</span> <span class="fu">build_and_train_model</span>(<span class="at">num_layers =</span> num_layers[i],</span>
<span id="cb831-32"><a href="ch-10.html#cb831-32" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">num_units_per_layer =</span> num_units_per_layer[i], </span>
<span id="cb831-33"><a href="ch-10.html#cb831-33" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">print_model_summary =</span> F)</span>
<span id="cb831-34"><a href="ch-10.html#cb831-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb831-35"><a href="ch-10.html#cb831-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Predict on test data</span></span>
<span id="cb831-36"><a href="ch-10.html#cb831-36" aria-hidden="true" tabindex="-1"></a>        pred <span class="ot">=</span> <span class="fu">predict</span>(model, <span class="fu">as.matrix</span>(df_test[,<span class="fu">c</span>(<span class="st">&#39;x1&#39;</span>,<span class="st">&#39;x2&#39;</span>)]))</span>
<span id="cb831-37"><a href="ch-10.html#cb831-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb831-38"><a href="ch-10.html#cb831-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Loop over thresholds to assess model performance</span></span>
<span id="cb831-39"><a href="ch-10.html#cb831-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_thresholds){</span>
<span id="cb831-40"><a href="ch-10.html#cb831-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb831-41"><a href="ch-10.html#cb831-41" aria-hidden="true" tabindex="-1"></a>            <span class="fu">c</span>(tp[j,k,i], tn[j,k,i],fp[j,k,i], fn[j,k,i]) <span class="sc">%&lt;-%</span> <span class="fu">confusion</span>(df_test<span class="sc">$</span>y, </span>
<span id="cb831-42"><a href="ch-10.html#cb831-42" aria-hidden="true" tabindex="-1"></a>                                                                        pred, </span>
<span id="cb831-43"><a href="ch-10.html#cb831-43" aria-hidden="true" tabindex="-1"></a>                                                                        thresholds[j],</span>
<span id="cb831-44"><a href="ch-10.html#cb831-44" aria-hidden="true" tabindex="-1"></a>                                                                        <span class="at">verbose =</span> F)</span>
<span id="cb831-45"><a href="ch-10.html#cb831-45" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb831-46"><a href="ch-10.html#cb831-46" aria-hidden="true" tabindex="-1"></a>            <span class="fu">c</span>(precision[j,k,i], recall[j,k,i]) <span class="sc">%&lt;-%</span> <span class="fu">precision_and_recall</span>(tp[j,k,i], </span>
<span id="cb831-47"><a href="ch-10.html#cb831-47" aria-hidden="true" tabindex="-1"></a>                                                                         tn[j,k,i], </span>
<span id="cb831-48"><a href="ch-10.html#cb831-48" aria-hidden="true" tabindex="-1"></a>                                                                         fp[j,k,i], </span>
<span id="cb831-49"><a href="ch-10.html#cb831-49" aria-hidden="true" tabindex="-1"></a>                                                                         fn[j,k,i], <span class="at">verbose =</span> F)</span>
<span id="cb831-50"><a href="ch-10.html#cb831-50" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb831-51"><a href="ch-10.html#cb831-51" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb831-52"><a href="ch-10.html#cb831-52" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb831-53"><a href="ch-10.html#cb831-53" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now let’s average our measures of model performance across the 10 random initializations. By now it should be clear why we do this, but to drive the point home we’ll say it again: Model training is stochastic, so every time you train a model with a different random initialization, you may get a different final model, even for models based with the same network architectures.</p>
<div class="sourceCode" id="cb832"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb832-1"><a href="ch-10.html#cb832-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Average over the 10 random initializations        </span></span>
<span id="cb832-2"><a href="ch-10.html#cb832-2" aria-hidden="true" tabindex="-1"></a>average_precision <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> num_thresholds, <span class="at">ncol =</span>  num_models)</span>
<span id="cb832-3"><a href="ch-10.html#cb832-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb832-4"><a href="ch-10.html#cb832-4" aria-hidden="true" tabindex="-1"></a>average_fpr <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> num_thresholds, <span class="at">ncol =</span>  num_models)</span>
<span id="cb832-5"><a href="ch-10.html#cb832-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb832-6"><a href="ch-10.html#cb832-6" aria-hidden="true" tabindex="-1"></a>average_recall <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> num_thresholds, <span class="at">ncol =</span>  num_models)</span>
<span id="cb832-7"><a href="ch-10.html#cb832-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb832-8"><a href="ch-10.html#cb832-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Allocate space for the area under the ROC curves</span></span>
<span id="cb832-9"><a href="ch-10.html#cb832-9" aria-hidden="true" tabindex="-1"></a>aucs <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, num_models)</span>
<span id="cb832-10"><a href="ch-10.html#cb832-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb832-11"><a href="ch-10.html#cb832-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop over the models</span></span>
<span id="cb832-12"><a href="ch-10.html#cb832-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_models){</span>
<span id="cb832-13"><a href="ch-10.html#cb832-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb832-14"><a href="ch-10.html#cb832-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Loop over the thresholds</span></span>
<span id="cb832-15"><a href="ch-10.html#cb832-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_thresholds){</span>
<span id="cb832-16"><a href="ch-10.html#cb832-16" aria-hidden="true" tabindex="-1"></a>        average_fpr[j,i] <span class="ot">=</span> <span class="fu">mean</span>(fp[j,,i] <span class="sc">/</span> (fp[j,,i] <span class="sc">+</span> tn[j,,i]))</span>
<span id="cb832-17"><a href="ch-10.html#cb832-17" aria-hidden="true" tabindex="-1"></a>        average_recall[j,i] <span class="ot">=</span> <span class="fu">mean</span>(recall[j,,i])</span>
<span id="cb832-18"><a href="ch-10.html#cb832-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb832-19"><a href="ch-10.html#cb832-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb832-20"><a href="ch-10.html#cb832-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the ROC curve and the area under it     </span></span>
<span id="cb832-21"><a href="ch-10.html#cb832-21" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">=</span> <span class="fu">ROC</span>(average_fpr[,i], average_recall[,i])</span>
<span id="cb832-22"><a href="ch-10.html#cb832-22" aria-hidden="true" tabindex="-1"></a>    aucs[i] <span class="ot">=</span> auc<span class="sc">$</span>value</span>
<span id="cb832-23"><a href="ch-10.html#cb832-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb832-24"><a href="ch-10.html#cb832-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print the area under the ROC curve</span></span>
<span id="cb832-25"><a href="ch-10.html#cb832-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;Auc for model &quot;</span>, <span class="fu">as.character</span>(i), <span class="st">&quot; is &quot;</span>, <span class="fu">as.character</span>(<span class="fu">round</span>(auc<span class="sc">$</span>value, <span class="dv">3</span>)), <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)</span>
<span id="cb832-26"><a href="ch-10.html#cb832-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Auc for model  1  is  0.677 Auc for model  2  is  0.611 Auc for model  3  is  0.929 Auc for model  4  is  0.981</code></pre>
<p>What do you observe?</p>
<p>The most complex model (8 layers, each with 8 nodes) clearly outperforms its competitors. Let’s see this in more detail by visualizing the ROC curves.</p>
<div class="sourceCode" id="cb834"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb834-1"><a href="ch-10.html#cb834-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a vector of points between 0 and 1</span></span>
<span id="cb834-2"><a href="ch-10.html#cb834-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">101</span>)</span>
<span id="cb834-3"><a href="ch-10.html#cb834-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb834-4"><a href="ch-10.html#cb834-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Name the different models</span></span>
<span id="cb834-5"><a href="ch-10.html#cb834-5" aria-hidden="true" tabindex="-1"></a>model_name <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Layers: 1 , Units : 2&#39;</span>,<span class="st">&#39;Layers: 2 , Units : 2&#39;</span>,<span class="st">&#39;Layers: 4 , Units : 4&#39;</span>,<span class="st">&#39;Layers: 8 , Units : 8&#39;</span>)</span>
<span id="cb834-6"><a href="ch-10.html#cb834-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb834-7"><a href="ch-10.html#cb834-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Build a data frame</span></span>
<span id="cb834-8"><a href="ch-10.html#cb834-8" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">avg_fpr =</span> <span class="fu">c</span>(average_fpr[,<span class="dv">1</span>], </span>
<span id="cb834-9"><a href="ch-10.html#cb834-9" aria-hidden="true" tabindex="-1"></a>                             average_fpr[,<span class="dv">2</span>], </span>
<span id="cb834-10"><a href="ch-10.html#cb834-10" aria-hidden="true" tabindex="-1"></a>                             average_fpr[,<span class="dv">3</span>], </span>
<span id="cb834-11"><a href="ch-10.html#cb834-11" aria-hidden="true" tabindex="-1"></a>                             average_fpr[,<span class="dv">4</span>]),</span>
<span id="cb834-12"><a href="ch-10.html#cb834-12" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb834-13"><a href="ch-10.html#cb834-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">avg_recall =</span> <span class="fu">c</span>(average_recall[,<span class="dv">1</span>], </span>
<span id="cb834-14"><a href="ch-10.html#cb834-14" aria-hidden="true" tabindex="-1"></a>                                average_recall[,<span class="dv">2</span>], </span>
<span id="cb834-15"><a href="ch-10.html#cb834-15" aria-hidden="true" tabindex="-1"></a>                                average_recall[,<span class="dv">3</span>], </span>
<span id="cb834-16"><a href="ch-10.html#cb834-16" aria-hidden="true" tabindex="-1"></a>                                average_recall[,<span class="dv">4</span>]),</span>
<span id="cb834-17"><a href="ch-10.html#cb834-17" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb834-18"><a href="ch-10.html#cb834-18" aria-hidden="true" tabindex="-1"></a>               <span class="at">Model =</span> <span class="fu">rep</span>(model_name, </span>
<span id="cb834-19"><a href="ch-10.html#cb834-19" aria-hidden="true" tabindex="-1"></a>                           <span class="at">each =</span> num_thresholds))</span>
<span id="cb834-20"><a href="ch-10.html#cb834-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb834-21"><a href="ch-10.html#cb834-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the results</span></span>
<span id="cb834-22"><a href="ch-10.html#cb834-22" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> avg_fpr, </span>
<span id="cb834-23"><a href="ch-10.html#cb834-23" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> avg_recall, </span>
<span id="cb834-24"><a href="ch-10.html#cb834-24" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> Model)) <span class="sc">+</span></span>
<span id="cb834-25"><a href="ch-10.html#cb834-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb834-26"><a href="ch-10.html#cb834-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb834-27"><a href="ch-10.html#cb834-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb834-28"><a href="ch-10.html#cb834-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">x =</span> x), </span>
<span id="cb834-29"><a href="ch-10.html#cb834-29" aria-hidden="true" tabindex="-1"></a>                <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> x), </span>
<span id="cb834-30"><a href="ch-10.html#cb834-30" aria-hidden="true" tabindex="-1"></a>                <span class="at">inherit.aes =</span> F, </span>
<span id="cb834-31"><a href="ch-10.html#cb834-31" aria-hidden="true" tabindex="-1"></a>                <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb834-32"><a href="ch-10.html#cb834-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb834-33"><a href="ch-10.html#cb834-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title=</span><span class="st">&#39;Area Under the Curve ROC&#39;</span>, </span>
<span id="cb834-34"><a href="ch-10.html#cb834-34" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> <span class="st">&#39;False Positive Rate&#39;</span>, </span>
<span id="cb834-35"><a href="ch-10.html#cb834-35" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> <span class="st">&#39;Recall&#39;</span>) <span class="sc">+</span></span>
<span id="cb834-36"><a href="ch-10.html#cb834-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb834-37"><a href="ch-10.html#cb834-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">xlim</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb834-38"><a href="ch-10.html#cb834-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb834-39"><a href="ch-10.html#cb834-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_color_discrete</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="fu">paste</span>(model_name,<span class="st">&#39; AUC: &#39;</span>,</span>
<span id="cb834-40"><a href="ch-10.html#cb834-40" aria-hidden="true" tabindex="-1"></a>                                          <span class="fu">c</span>(<span class="fu">round</span>(aucs[<span class="dv">1</span>], <span class="dv">3</span>),</span>
<span id="cb834-41"><a href="ch-10.html#cb834-41" aria-hidden="true" tabindex="-1"></a>                                            <span class="fu">round</span>(aucs[<span class="dv">2</span>], <span class="dv">3</span>),</span>
<span id="cb834-42"><a href="ch-10.html#cb834-42" aria-hidden="true" tabindex="-1"></a>                                            <span class="fu">round</span>(aucs[<span class="dv">3</span>], <span class="dv">3</span>),</span>
<span id="cb834-43"><a href="ch-10.html#cb834-43" aria-hidden="true" tabindex="-1"></a>                                            <span class="fu">round</span>(aucs[<span class="dv">4</span>], <span class="dv">3</span>))))) <span class="sc">+</span></span>
<span id="cb834-44"><a href="ch-10.html#cb834-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_grey</span>(<span class="at">base_size =</span> <span class="dv">20</span>)</span></code></pre></div>
<p><img src="figures/SLNN_II-output7.png" /></p>
<p>Again you can see the most complex model (<span class="math inline">\(\color{purple}{\text{8 layers, each with 8 nodes}}\)</span>) clearly outperforms the less complex ones.</p>
<p>It is important to point out that the area under the ROC curve is not always an appropriate performance metric. Specifically, this measure can be misleading when the data are heavily class-imbalanced.</p>
<p>To see this, let’s create a toy dataset that is even more class imbalanced.</p>
<div class="sourceCode" id="cb835"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb835-1"><a href="ch-10.html#cb835-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Seed the random number generator for reproducible results</span></span>
<span id="cb835-2"><a href="ch-10.html#cb835-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">41</span>)</span>
<span id="cb835-3"><a href="ch-10.html#cb835-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb835-4"><a href="ch-10.html#cb835-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of examples</span></span>
<span id="cb835-5"><a href="ch-10.html#cb835-5" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">10000</span> </span>
<span id="cb835-6"><a href="ch-10.html#cb835-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb835-7"><a href="ch-10.html#cb835-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Square radius  of inner circle</span></span>
<span id="cb835-8"><a href="ch-10.html#cb835-8" aria-hidden="true" tabindex="-1"></a>radius_2 <span class="ot">&lt;-</span> <span class="fl">0.055</span> </span>
<span id="cb835-9"><a href="ch-10.html#cb835-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb835-10"><a href="ch-10.html#cb835-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Noise applied to the boundary separating green and blue examples</span></span>
<span id="cb835-11"><a href="ch-10.html#cb835-11" aria-hidden="true" tabindex="-1"></a>noise <span class="ot">&lt;-</span> <span class="fl">0.045</span> </span>
<span id="cb835-12"><a href="ch-10.html#cb835-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb835-13"><a href="ch-10.html#cb835-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Place N points on the unit square. </span></span>
<span id="cb835-14"><a href="ch-10.html#cb835-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Label those within some radius 0, and those outside 1.</span></span>
<span id="cb835-15"><a href="ch-10.html#cb835-15" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="at">n =</span> N, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>) </span>
<span id="cb835-16"><a href="ch-10.html#cb835-16" aria-hidden="true" tabindex="-1"></a>x2 <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="at">n =</span> N, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>) </span>
<span id="cb835-17"><a href="ch-10.html#cb835-17" aria-hidden="true" tabindex="-1"></a>y  <span class="ot">&lt;-</span> ((x1 <span class="sc">-</span> <span class="fl">0.5</span>)<span class="sc">**</span><span class="dv">2</span> <span class="sc">+</span> (x2 <span class="sc">-</span> <span class="fl">0.5</span>)<span class="sc">**</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="at">n =</span> N, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> noise) <span class="sc">&lt;=</span> radius_2</span>
<span id="cb835-18"><a href="ch-10.html#cb835-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb835-19"><a href="ch-10.html#cb835-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a data frame</span></span>
<span id="cb835-20"><a href="ch-10.html#cb835-20" aria-hidden="true" tabindex="-1"></a>df_new <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x1 =</span> x1, <span class="at">x2 =</span> x2, <span class="at">y =</span> y<span class="sc">*</span><span class="dv">1</span>)</span>
<span id="cb835-21"><a href="ch-10.html#cb835-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb835-22"><a href="ch-10.html#cb835-22" aria-hidden="true" tabindex="-1"></a><span class="co"># split with r sample and strata = y</span></span>
<span id="cb835-23"><a href="ch-10.html#cb835-23" aria-hidden="true" tabindex="-1"></a>split  <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(df_new, <span class="at">prop =</span> <span class="fl">0.8</span>, <span class="at">strata =</span> <span class="st">&#39;y&#39;</span>)</span>
<span id="cb835-24"><a href="ch-10.html#cb835-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb835-25"><a href="ch-10.html#cb835-25" aria-hidden="true" tabindex="-1"></a><span class="co"># train set</span></span>
<span id="cb835-26"><a href="ch-10.html#cb835-26" aria-hidden="true" tabindex="-1"></a>df_train_new <span class="ot">&lt;-</span> <span class="fu">training</span>(split)</span>
<span id="cb835-27"><a href="ch-10.html#cb835-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb835-28"><a href="ch-10.html#cb835-28" aria-hidden="true" tabindex="-1"></a><span class="co"># test set</span></span>
<span id="cb835-29"><a href="ch-10.html#cb835-29" aria-hidden="true" tabindex="-1"></a>df_test_new  <span class="ot">&lt;-</span> <span class="fu">testing</span>(split)</span>
<span id="cb835-30"><a href="ch-10.html#cb835-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb835-31"><a href="ch-10.html#cb835-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Print some summary statistics about these new data</span></span>
<span id="cb835-32"><a href="ch-10.html#cb835-32" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&#39;Proportion of data in class blue: &#39;</span> , <span class="fu">sum</span>(df_new<span class="sc">$</span>y) <span class="sc">/</span> <span class="fu">length</span>(df_new<span class="sc">$</span>y), <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>,</span>
<span id="cb835-33"><a href="ch-10.html#cb835-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Proportion of data in class green: &#39;</span> , <span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>(df_new<span class="sc">$</span>y) <span class="sc">/</span> <span class="fu">length</span>(df_new<span class="sc">$</span>y),<span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)</span></code></pre></div>
<pre><code>## Proportion of data in class blue:   0.1817 
##  Proportion of data in class green:  0.8183</code></pre>
<p>Our data now are now heavily imbalanced with 82% of examples in the negative class.</p>
<p>Let’s build and train the most complex model considered above (8 layers, each with 8 nodes) to classify these data and calculate several performance metrics of our trained model.</p>
<div class="sourceCode" id="cb837"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb837-1"><a href="ch-10.html#cb837-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build and train the model</span></span>
<span id="cb837-2"><a href="ch-10.html#cb837-2" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(model, history) <span class="sc">%&lt;-%</span> <span class="fu">build_and_train_model</span>(<span class="at">data =</span> df_train_new , </span>
<span id="cb837-3"><a href="ch-10.html#cb837-3" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">num_layers =</span> <span class="dv">8</span>, </span>
<span id="cb837-4"><a href="ch-10.html#cb837-4" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">num_units_per_layer =</span>  <span class="dv">8</span>, </span>
<span id="cb837-5"><a href="ch-10.html#cb837-5" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">print_model_summary =</span> T)</span>
<span id="cb837-6"><a href="ch-10.html#cb837-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb837-7"><a href="ch-10.html#cb837-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the final training accuracy</span></span>
<span id="cb837-8"><a href="ch-10.html#cb837-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&#39;Final training accuracy: &#39;</span>, <span class="fu">round</span>(history<span class="sc">$</span>metrics<span class="sc">$</span>acc[ne], <span class="dv">3</span>), <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)</span>
<span id="cb837-9"><a href="ch-10.html#cb837-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb837-10"><a href="ch-10.html#cb837-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict on test data</span></span>
<span id="cb837-11"><a href="ch-10.html#cb837-11" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">=</span> <span class="fu">predict</span>(model, <span class="fu">as.matrix</span>(df_test_new[, <span class="fu">c</span>(<span class="st">&#39;x1&#39;</span>, <span class="st">&#39;x2&#39;</span>)]))</span>
<span id="cb837-12"><a href="ch-10.html#cb837-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb837-13"><a href="ch-10.html#cb837-13" aria-hidden="true" tabindex="-1"></a><span class="co"># set decisions threshold</span></span>
<span id="cb837-14"><a href="ch-10.html#cb837-14" aria-hidden="true" tabindex="-1"></a>threshold <span class="ot">=</span> <span class="fl">0.5</span></span>
<span id="cb837-15"><a href="ch-10.html#cb837-15" aria-hidden="true" tabindex="-1"></a>y_pred <span class="ot">=</span> (pred <span class="sc">&gt;=</span> threshold)<span class="sc">*</span><span class="dv">1</span></span>
<span id="cb837-16"><a href="ch-10.html#cb837-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb837-17"><a href="ch-10.html#cb837-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Print precision,recall, and F-score</span></span>
<span id="cb837-18"><a href="ch-10.html#cb837-18" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(true_positives, true_negatives, false_positives, false_negatives) <span class="sc">%&lt;-%</span> <span class="fu">confusion</span>(df_test_new<span class="sc">$</span>y, </span>
<span id="cb837-19"><a href="ch-10.html#cb837-19" aria-hidden="true" tabindex="-1"></a>                                                                                   pred, </span>
<span id="cb837-20"><a href="ch-10.html#cb837-20" aria-hidden="true" tabindex="-1"></a>                                                                                   threshold, </span>
<span id="cb837-21"><a href="ch-10.html#cb837-21" aria-hidden="true" tabindex="-1"></a>                                                                                   <span class="at">verbose =</span> F)</span>
<span id="cb837-22"><a href="ch-10.html#cb837-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb837-23"><a href="ch-10.html#cb837-23" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(precision, recall) <span class="sc">%&lt;-%</span> <span class="fu">precision_and_recall</span>(true_positives, </span>
<span id="cb837-24"><a href="ch-10.html#cb837-24" aria-hidden="true" tabindex="-1"></a>                                               true_negatives, </span>
<span id="cb837-25"><a href="ch-10.html#cb837-25" aria-hidden="true" tabindex="-1"></a>                                               false_positives, </span>
<span id="cb837-26"><a href="ch-10.html#cb837-26" aria-hidden="true" tabindex="-1"></a>                                               false_negatives)</span>
<span id="cb837-27"><a href="ch-10.html#cb837-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb837-28"><a href="ch-10.html#cb837-28" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">f_score</span>(precision, recall)</span></code></pre></div>
<div class="sourceCode" id="cb838"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb838-1"><a href="ch-10.html#cb838-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Model: &quot;sequential_87&quot;</span></span>
<span id="cb838-2"><a href="ch-10.html#cb838-2" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb838-3"><a href="ch-10.html#cb838-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Layer (type)                        Output Shape                    Param #     </span></span>
<span id="cb838-4"><a href="ch-10.html#cb838-4" aria-hidden="true" tabindex="-1"></a><span class="do">## ================================================================================</span></span>
<span id="cb838-5"><a href="ch-10.html#cb838-5" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_407 (Dense)                   (None, 8)                       24          </span></span>
<span id="cb838-6"><a href="ch-10.html#cb838-6" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb838-7"><a href="ch-10.html#cb838-7" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_408 (Dense)                   (None, 8)                       72          </span></span>
<span id="cb838-8"><a href="ch-10.html#cb838-8" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb838-9"><a href="ch-10.html#cb838-9" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_409 (Dense)                   (None, 8)                       72          </span></span>
<span id="cb838-10"><a href="ch-10.html#cb838-10" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb838-11"><a href="ch-10.html#cb838-11" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_410 (Dense)                   (None, 8)                       72          </span></span>
<span id="cb838-12"><a href="ch-10.html#cb838-12" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb838-13"><a href="ch-10.html#cb838-13" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_411 (Dense)                   (None, 8)                       72          </span></span>
<span id="cb838-14"><a href="ch-10.html#cb838-14" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb838-15"><a href="ch-10.html#cb838-15" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_412 (Dense)                   (None, 8)                       72          </span></span>
<span id="cb838-16"><a href="ch-10.html#cb838-16" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb838-17"><a href="ch-10.html#cb838-17" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_413 (Dense)                   (None, 8)                       72          </span></span>
<span id="cb838-18"><a href="ch-10.html#cb838-18" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb838-19"><a href="ch-10.html#cb838-19" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_414 (Dense)                   (None, 8)                       72          </span></span>
<span id="cb838-20"><a href="ch-10.html#cb838-20" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb838-21"><a href="ch-10.html#cb838-21" aria-hidden="true" tabindex="-1"></a><span class="do">## dense_415 (Dense)                   (None, 1)                       9           </span></span>
<span id="cb838-22"><a href="ch-10.html#cb838-22" aria-hidden="true" tabindex="-1"></a><span class="do">## ================================================================================</span></span>
<span id="cb838-23"><a href="ch-10.html#cb838-23" aria-hidden="true" tabindex="-1"></a><span class="do">## Total params: 537</span></span>
<span id="cb838-24"><a href="ch-10.html#cb838-24" aria-hidden="true" tabindex="-1"></a><span class="do">## Trainable params: 537</span></span>
<span id="cb838-25"><a href="ch-10.html#cb838-25" aria-hidden="true" tabindex="-1"></a><span class="do">## Non-trainable params: 0</span></span>
<span id="cb838-26"><a href="ch-10.html#cb838-26" aria-hidden="true" tabindex="-1"></a><span class="do">## ________________________________________________________________________________</span></span>
<span id="cb838-27"><a href="ch-10.html#cb838-27" aria-hidden="true" tabindex="-1"></a><span class="do">## Final training accuracy:  0.887 </span></span>
<span id="cb838-28"><a href="ch-10.html#cb838-28" aria-hidden="true" tabindex="-1"></a><span class="do">## Precision:  0.7365079 </span></span>
<span id="cb838-29"><a href="ch-10.html#cb838-29" aria-hidden="true" tabindex="-1"></a><span class="do">## Recall:  0.6391185 </span></span>
<span id="cb838-30"><a href="ch-10.html#cb838-30" aria-hidden="true" tabindex="-1"></a><span class="do">## F-score:  0.6843658</span></span></code></pre></div>
<p>Observe that training accuracy is high, whereas precision, recall, and the F-score are all relatively low.</p>
<p>Let’s also have a look at the confusion matrix.</p>
<div class="sourceCode" id="cb839"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb839-1"><a href="ch-10.html#cb839-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(y_pred, df_test_new<span class="sc">$</span>y)</span></code></pre></div>
<p>So let’s also calculate the areas under the ROC curve.</p>
<div class="sourceCode" id="cb840"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb840-1"><a href="ch-10.html#cb840-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create 100 threhsolds between 0 and 1</span></span>
<span id="cb840-2"><a href="ch-10.html#cb840-2" aria-hidden="true" tabindex="-1"></a>num_thresholds <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb840-3"><a href="ch-10.html#cb840-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb840-4"><a href="ch-10.html#cb840-4" aria-hidden="true" tabindex="-1"></a>thresholds <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> num_thresholds)</span>
<span id="cb840-5"><a href="ch-10.html#cb840-5" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb840-6"><a href="ch-10.html#cb840-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Allocate space for the performance metrics</span></span>
<span id="cb840-7"><a href="ch-10.html#cb840-7" aria-hidden="true" tabindex="-1"></a>fp <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, num_thresholds)</span>
<span id="cb840-8"><a href="ch-10.html#cb840-8" aria-hidden="true" tabindex="-1"></a>fn <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, num_thresholds)</span>
<span id="cb840-9"><a href="ch-10.html#cb840-9" aria-hidden="true" tabindex="-1"></a>tp <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, num_thresholds)</span>
<span id="cb840-10"><a href="ch-10.html#cb840-10" aria-hidden="true" tabindex="-1"></a>tn <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, num_thresholds)</span>
<span id="cb840-11"><a href="ch-10.html#cb840-11" aria-hidden="true" tabindex="-1"></a>precision <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, num_thresholds)</span>
<span id="cb840-12"><a href="ch-10.html#cb840-12" aria-hidden="true" tabindex="-1"></a>recall <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, num_thresholds)</span>
<span id="cb840-13"><a href="ch-10.html#cb840-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb840-14"><a href="ch-10.html#cb840-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop over the thresholds and measure model performance</span></span>
<span id="cb840-15"><a href="ch-10.html#cb840-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_thresholds){</span>
<span id="cb840-16"><a href="ch-10.html#cb840-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb840-17"><a href="ch-10.html#cb840-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(tp[i], tn[i],fp[i], fn[i]) <span class="sc">%&lt;-%</span> <span class="fu">confusion</span>(df_test_new<span class="sc">$</span>y, </span>
<span id="cb840-18"><a href="ch-10.html#cb840-18" aria-hidden="true" tabindex="-1"></a>                                                pred, </span>
<span id="cb840-19"><a href="ch-10.html#cb840-19" aria-hidden="true" tabindex="-1"></a>                                                thresholds[i], </span>
<span id="cb840-20"><a href="ch-10.html#cb840-20" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">verbose =</span> F)</span>
<span id="cb840-21"><a href="ch-10.html#cb840-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb840-22"><a href="ch-10.html#cb840-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(precision[i], recall[i]) <span class="sc">%&lt;-%</span> <span class="fu">precision_and_recall</span>(tp[i], </span>
<span id="cb840-23"><a href="ch-10.html#cb840-23" aria-hidden="true" tabindex="-1"></a>                                                         tn[i], </span>
<span id="cb840-24"><a href="ch-10.html#cb840-24" aria-hidden="true" tabindex="-1"></a>                                                         fp[i], </span>
<span id="cb840-25"><a href="ch-10.html#cb840-25" aria-hidden="true" tabindex="-1"></a>                                                         fn[i], </span>
<span id="cb840-26"><a href="ch-10.html#cb840-26" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">verbose =</span> F)</span>
<span id="cb840-27"><a href="ch-10.html#cb840-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb840-28"><a href="ch-10.html#cb840-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb840-29"><a href="ch-10.html#cb840-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb840-30"><a href="ch-10.html#cb840-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate and plot the ROC curve</span></span>
<span id="cb840-31"><a href="ch-10.html#cb840-31" aria-hidden="true" tabindex="-1"></a>auc <span class="ot">&lt;-</span> <span class="fu">ROC</span>(fp <span class="sc">/</span> (fp <span class="sc">+</span> tn), recall, <span class="at">viz =</span> T)</span>
<span id="cb840-32"><a href="ch-10.html#cb840-32" aria-hidden="true" tabindex="-1"></a>auc<span class="sc">$</span>plot</span></code></pre></div>
<p><img src="figures/SLNN_II-output10.png" /></p>
<p>The area under the ROC curve indicates an adequate model, whereas the precision and recall are relatively low. This is misleading!</p>
<p>To understand why this occurs, remember that the denominator of the false positive rate includes the number of negative examples. Because the proportion of the negative class is high (82%), the false positive rate tends to be low when recall is high, pushing the ROC curve away from the diagonal line and toward the upper left corner. As such, when the data are heavily class imbalanced, precision, recall, and the F1 score are more informative measures of model performance.</p>
</div>
</div>
<div id="exercise-8" class="section level2" number="10.3">
<h2><span class="header-section-number">10.3</span> Exercise</h2>
<p>For this exercise your task is to create 3 neural network models and to compare their performance. The provided data contains 2 classes (0 and 1). Our aim is to compare those models using the majority of the metrics we have seen in tutorial 10.</p>
<p><strong>Tasks:</strong></p>
<ol style="list-style-type: decimal">
<li>Read in the data.</li>
<li>Visualize the data and print the proportion of data belonging to each class.</li>
<li>Split into training and test set using Stratified split.</li>
<li>Create 3 different neural network models of your taste ranging from a simple to a very complex one.</li>
<li>For each model calculate accuracy, precision, recall and f-score on the test data.</li>
<li>For each model plot the decisions on the test data.</li>
<li>For the best performing model make the ROC curve and calculate the corresponding AUC.</li>
<li>Train the best performing model 5 times. For each time calculate the probability output on the test data. Average the probabilities over the 5 models and then make decisions. Print accuracy, precision, recall and f-score on the test data.</li>
</ol>
<p>The required libraries and some useful functions are already imported in the following chunks. For the ROC curve you can also use the <code>pROC</code> package.</p>
<p><strong>Import libraries</strong></p>
<div class="sourceCode" id="cb841"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb841-1"><a href="ch-10.html#cb841-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb841-2"><a href="ch-10.html#cb841-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb841-3"><a href="ch-10.html#cb841-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC)</span>
<span id="cb841-4"><a href="ch-10.html#cb841-4" aria-hidden="true" tabindex="-1"></a><span class="co"># use_condaenv()</span></span>
<span id="cb841-5"><a href="ch-10.html#cb841-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span>
<span id="cb841-6"><a href="ch-10.html#cb841-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsample)</span></code></pre></div>
<p><strong>Import functions</strong></p>
<div class="sourceCode" id="cb842"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb842-1"><a href="ch-10.html#cb842-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Area Under Curve</span></span>
<span id="cb842-2"><a href="ch-10.html#cb842-2" aria-hidden="true" tabindex="-1"></a>simple_auc <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y){</span>
<span id="cb842-3"><a href="ch-10.html#cb842-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb842-4"><a href="ch-10.html#cb842-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Revert order</span></span>
<span id="cb842-5"><a href="ch-10.html#cb842-5" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rev</span>(x)</span>
<span id="cb842-6"><a href="ch-10.html#cb842-6" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">rev</span>(y)  </span>
<span id="cb842-7"><a href="ch-10.html#cb842-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb842-8"><a href="ch-10.html#cb842-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Define rectangles, calculate area and add those</span></span>
<span id="cb842-9"><a href="ch-10.html#cb842-9" aria-hidden="true" tabindex="-1"></a>  dx <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">diff</span>(x), <span class="dv">0</span>)</span>
<span id="cb842-10"><a href="ch-10.html#cb842-10" aria-hidden="true" tabindex="-1"></a>  dy <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">diff</span>(y), <span class="dv">0</span>)</span>
<span id="cb842-11"><a href="ch-10.html#cb842-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(y <span class="sc">*</span> dx) <span class="sc">+</span> <span class="fu">sum</span>(dy <span class="sc">*</span> dx) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb842-12"><a href="ch-10.html#cb842-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb842-13"><a href="ch-10.html#cb842-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb842-14"><a href="ch-10.html#cb842-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ROC CURVE</span></span>
<span id="cb842-15"><a href="ch-10.html#cb842-15" aria-hidden="true" tabindex="-1"></a>ROC <span class="ot">&lt;-</span> <span class="cf">function</span>(fpr, recall, <span class="at">viz =</span> T){</span>
<span id="cb842-16"><a href="ch-10.html#cb842-16" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb842-17"><a href="ch-10.html#cb842-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the area under the ROC</span></span>
<span id="cb842-18"><a href="ch-10.html#cb842-18" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">=</span> <span class="fu">simple_auc</span>(fpr, recall)</span>
<span id="cb842-19"><a href="ch-10.html#cb842-19" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb842-20"><a href="ch-10.html#cb842-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualize the ROC</span></span>
<span id="cb842-21"><a href="ch-10.html#cb842-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (viz){</span>
<span id="cb842-22"><a href="ch-10.html#cb842-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb842-23"><a href="ch-10.html#cb842-23" aria-hidden="true" tabindex="-1"></a>        x <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb842-24"><a href="ch-10.html#cb842-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb842-25"><a href="ch-10.html#cb842-25" aria-hidden="true" tabindex="-1"></a>        g <span class="ot">=</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb842-26"><a href="ch-10.html#cb842-26" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb842-27"><a href="ch-10.html#cb842-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> fpr, <span class="at">y =</span> recall, <span class="at">color =</span> <span class="st">&#39;Model&#39;</span>), </span>
<span id="cb842-28"><a href="ch-10.html#cb842-28" aria-hidden="true" tabindex="-1"></a>                  <span class="at">lty =</span> <span class="dv">2</span>, </span>
<span id="cb842-29"><a href="ch-10.html#cb842-29" aria-hidden="true" tabindex="-1"></a>                  <span class="at">lwd =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb842-30"><a href="ch-10.html#cb842-30" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb842-31"><a href="ch-10.html#cb842-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> x, <span class="at">color =</span> <span class="st">&#39;Baseline&#39;</span>), </span>
<span id="cb842-32"><a href="ch-10.html#cb842-32" aria-hidden="true" tabindex="-1"></a>                  <span class="at">inherit.aes =</span> F, </span>
<span id="cb842-33"><a href="ch-10.html#cb842-33" aria-hidden="true" tabindex="-1"></a>                  <span class="at">lty =</span> <span class="dv">2</span>, </span>
<span id="cb842-34"><a href="ch-10.html#cb842-34" aria-hidden="true" tabindex="-1"></a>                  <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb842-35"><a href="ch-10.html#cb842-35" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb842-36"><a href="ch-10.html#cb842-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&#39;False Positive Rate&#39;</span>,</span>
<span id="cb842-37"><a href="ch-10.html#cb842-37" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> <span class="st">&#39;Recall&#39;</span>,</span>
<span id="cb842-38"><a href="ch-10.html#cb842-38" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">&#39;&#39;</span>,</span>
<span id="cb842-39"><a href="ch-10.html#cb842-39" aria-hidden="true" tabindex="-1"></a>             <span class="at">title =</span> <span class="st">&#39;Area Under The curve ROC&#39;</span>,</span>
<span id="cb842-40"><a href="ch-10.html#cb842-40" aria-hidden="true" tabindex="-1"></a>            <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">&quot;AUC : &quot;</span>, <span class="fu">round</span>(auc, <span class="dv">2</span>))) <span class="sc">+</span></span>
<span id="cb842-41"><a href="ch-10.html#cb842-41" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb842-42"><a href="ch-10.html#cb842-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme_grey</span>(<span class="at">base_size =</span> <span class="dv">20</span>)</span>
<span id="cb842-43"><a href="ch-10.html#cb842-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb842-44"><a href="ch-10.html#cb842-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>{</span>
<span id="cb842-45"><a href="ch-10.html#cb842-45" aria-hidden="true" tabindex="-1"></a>        g <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb842-46"><a href="ch-10.html#cb842-46" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb842-47"><a href="ch-10.html#cb842-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb842-48"><a href="ch-10.html#cb842-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> (<span class="fu">list</span>(<span class="at">plot =</span> g, <span class="at">value =</span> auc))</span>
<span id="cb842-49"><a href="ch-10.html#cb842-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb842-50"><a href="ch-10.html#cb842-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb842-51"><a href="ch-10.html#cb842-51" aria-hidden="true" tabindex="-1"></a>confusion <span class="ot">&lt;-</span> <span class="cf">function</span>(y_true, pred_out, <span class="at">threshold =</span> <span class="fl">0.5</span>, <span class="at">verbose =</span> T){</span>
<span id="cb842-52"><a href="ch-10.html#cb842-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb842-53"><a href="ch-10.html#cb842-53" aria-hidden="true" tabindex="-1"></a>  true_positives  <span class="ot">=</span> <span class="fu">sum</span>((pred_out <span class="sc">&gt;=</span> threshold) <span class="sc">&amp;</span> (y_true <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb842-54"><a href="ch-10.html#cb842-54" aria-hidden="true" tabindex="-1"></a>  true_negatives  <span class="ot">=</span> <span class="fu">sum</span>((pred_out <span class="sc">&lt;</span> threshold)  <span class="sc">&amp;</span> (y_true <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb842-55"><a href="ch-10.html#cb842-55" aria-hidden="true" tabindex="-1"></a>  false_positives <span class="ot">=</span> <span class="fu">sum</span>((pred_out <span class="sc">&gt;=</span> threshold) <span class="sc">&amp;</span> (y_true <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb842-56"><a href="ch-10.html#cb842-56" aria-hidden="true" tabindex="-1"></a>  false_negatives <span class="ot">=</span> <span class="fu">sum</span>((pred_out <span class="sc">&lt;</span> threshold)  <span class="sc">&amp;</span> (y_true <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb842-57"><a href="ch-10.html#cb842-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb842-58"><a href="ch-10.html#cb842-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (verbose) {</span>
<span id="cb842-59"><a href="ch-10.html#cb842-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&#39;true positives: &#39;</span>,  true_positives,  <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>,</span>
<span id="cb842-60"><a href="ch-10.html#cb842-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;true negatives: &#39;</span>,  true_negatives,  <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>,</span>
<span id="cb842-61"><a href="ch-10.html#cb842-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;false positives: &#39;</span>, false_positives, <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>,</span>
<span id="cb842-62"><a href="ch-10.html#cb842-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;false negatives: &#39;</span>, false_negatives, <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)</span>
<span id="cb842-63"><a href="ch-10.html#cb842-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb842-64"><a href="ch-10.html#cb842-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (<span class="fu">list</span>(<span class="at">tp =</span> true_positives, <span class="at">tn =</span> true_negatives, <span class="at">fp =</span> false_positives, <span class="at">fn =</span> false_negatives))</span>
<span id="cb842-65"><a href="ch-10.html#cb842-65" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb842-66"><a href="ch-10.html#cb842-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb842-67"><a href="ch-10.html#cb842-67" aria-hidden="true" tabindex="-1"></a>precision_and_recall <span class="ot">&lt;-</span> <span class="cf">function</span>(true_positives, true_negatives,false_positives, false_negatives, <span class="at">verbose =</span> T){</span>
<span id="cb842-68"><a href="ch-10.html#cb842-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb842-69"><a href="ch-10.html#cb842-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Protect against division by zero</span></span>
<span id="cb842-70"><a href="ch-10.html#cb842-70" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((true_positives <span class="sc">+</span> false_positives) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb842-71"><a href="ch-10.html#cb842-71" aria-hidden="true" tabindex="-1"></a>    precision <span class="ot">=</span> true_positives <span class="sc">/</span> (true_positives <span class="sc">+</span> false_positives)</span>
<span id="cb842-72"><a href="ch-10.html#cb842-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb842-73"><a href="ch-10.html#cb842-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb842-74"><a href="ch-10.html#cb842-74" aria-hidden="true" tabindex="-1"></a>    precision <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb842-75"><a href="ch-10.html#cb842-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb842-76"><a href="ch-10.html#cb842-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb842-77"><a href="ch-10.html#cb842-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((true_positives <span class="sc">+</span> false_negatives) <span class="sc">&gt;</span> <span class="dv">0</span>){    </span>
<span id="cb842-78"><a href="ch-10.html#cb842-78" aria-hidden="true" tabindex="-1"></a>    recall <span class="ot">=</span> true_positives <span class="sc">/</span> (true_positives <span class="sc">+</span> false_negatives)</span>
<span id="cb842-79"><a href="ch-10.html#cb842-79" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb842-80"><a href="ch-10.html#cb842-80" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb842-81"><a href="ch-10.html#cb842-81" aria-hidden="true" tabindex="-1"></a>      recall <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb842-82"><a href="ch-10.html#cb842-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb842-83"><a href="ch-10.html#cb842-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb842-84"><a href="ch-10.html#cb842-84" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (verbose){</span>
<span id="cb842-85"><a href="ch-10.html#cb842-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;Precision: &quot;</span>, precision, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>,</span>
<span id="cb842-86"><a href="ch-10.html#cb842-86" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Recall: &quot;</span>, recall, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb842-87"><a href="ch-10.html#cb842-87" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb842-88"><a href="ch-10.html#cb842-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb842-89"><a href="ch-10.html#cb842-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (<span class="fu">list</span>(<span class="at">precision =</span> precision, <span class="at">recall =</span> recall))</span>
<span id="cb842-90"><a href="ch-10.html#cb842-90" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb842-91"><a href="ch-10.html#cb842-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb842-92"><a href="ch-10.html#cb842-92" aria-hidden="true" tabindex="-1"></a>f_score <span class="ot">&lt;-</span> <span class="cf">function</span>(precision, recall, <span class="at">verbose =</span> T){</span>
<span id="cb842-93"><a href="ch-10.html#cb842-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb842-94"><a href="ch-10.html#cb842-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate F</span></span>
<span id="cb842-95"><a href="ch-10.html#cb842-95" aria-hidden="true" tabindex="-1"></a>    f <span class="ot">=</span> <span class="dv">2</span> <span class="sc">*</span> precision <span class="sc">*</span> recall <span class="sc">/</span> (precision <span class="sc">+</span> recall)</span>
<span id="cb842-96"><a href="ch-10.html#cb842-96" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb842-97"><a href="ch-10.html#cb842-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the user has requested verbose output, provide it</span></span>
<span id="cb842-98"><a href="ch-10.html#cb842-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(verbose){</span>
<span id="cb842-99"><a href="ch-10.html#cb842-99" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">&quot;F-score: &quot;</span>,f,<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb842-100"><a href="ch-10.html#cb842-100" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb842-101"><a href="ch-10.html#cb842-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb842-102"><a href="ch-10.html#cb842-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return F</span></span>
<span id="cb842-103"><a href="ch-10.html#cb842-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(f)</span>
<span id="cb842-104"><a href="ch-10.html#cb842-104" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>IMPORTANT NOTE: READ CAREFULLY!
Do not skip this part or you’ll run into issues later on!
In a moment, after you’ve read the following instructions carefully, you should:
- run the code chunk immediately below this text (<code>keras_model_sequential()</code>).
- look down in the <em>Console</em> it asks if you want to install some packages: (“Would you like to install Miniconda? [Y/n]:”).
- write <em>n</em> and press enter. You should see the following code in the console: <code>Would you like to install Miniconda? [Y/n]: n</code>.
Now, you can normally continue with the exercise.</p>
<p>If you were too eager and already pressed <em>Y</em> (yes) and enter, don’t panic! Just close your environment, re-open it and make sure that next time you go with <em>n</em> (no).</p>
<div class="sourceCode" id="cb843"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb843-1"><a href="ch-10.html#cb843-1" aria-hidden="true" tabindex="-1"></a><span class="fu">keras_model_sequential</span>()</span></code></pre></div>
<p><strong>Turn the pseudo-code into real code!</strong></p>
<div class="sourceCode" id="cb844"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb844-1"><a href="ch-10.html#cb844-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Read in the data</span></span>
<span id="cb844-2"><a href="ch-10.html#cb844-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Visualize data and print proportion of data belongs to each class.</span></span>
<span id="cb844-3"><a href="ch-10.html#cb844-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Split into training and test set (Stratified split).</span></span>
<span id="cb844-4"><a href="ch-10.html#cb844-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Create models</span></span>
<span id="cb844-5"><a href="ch-10.html#cb844-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Calculate output and make decisions for each model on test set.</span></span>
<span id="cb844-6"><a href="ch-10.html#cb844-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Visualize test predictions for each model.</span></span>
<span id="cb844-7"><a href="ch-10.html#cb844-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Calculate metrics for each model on test set.</span></span>
<span id="cb844-8"><a href="ch-10.html#cb844-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Calculate ROC and AUC for the best model.</span></span>
<span id="cb844-9"><a href="ch-10.html#cb844-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. ROC Curve</span></span>
<span id="cb844-10"><a href="ch-10.html#cb844-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 10. Train 5 times the best model, take probability outputs on test set for each time. </span></span>
<span id="cb844-11"><a href="ch-10.html#cb844-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 11. Average over the models output and then make decisions. Print Metrics.</span></span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="ch-09.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="ch-11.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
